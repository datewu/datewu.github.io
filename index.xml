<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>鬼画桃符</title><link>https://tab.deoops.com/</link><description>Recent content on 鬼画桃符</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Mon, 27 Feb 2023 10:57:27 +0800</lastBuildDate><atom:link href="https://tab.deoops.com/index.xml" rel="self" type="application/rss+xml"/><item><title>记一次overflow</title><link>https://tab.deoops.com/posts/cast-befor-opreate/</link><pubDate>Mon, 27 Feb 2023 10:57:27 +0800</pubDate><guid>https://tab.deoops.com/posts/cast-befor-opreate/</guid><description>&lt;img src="https://tab.deoops.com/posts/cast-befor-opreate/overflow.png" alt="Featured image of post 记一次overflow" />&lt;p>最近给一个项目加上了限速的功能，跑了一段时间后发现一个问题，超级管理员的速度阈值本来是最大的，实际使用是却发现好想是0。&lt;/p>
&lt;p>打了个个断点， 发现admin的rate.Limit 确实是 -1000。&lt;/p>
&lt;p>看了下代码，原来是overflow了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="o">-&lt;/span> &lt;span class="nx">limit&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">rate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewLimiter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Limit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">q&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Speed&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">limit&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">rate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewLimiter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Limit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">float64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">q&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Speed&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>q.Speed&lt;/code> 的type是 &lt;code>int16&lt;/code>&lt;/p>
&lt;p>当时写的时候觉得&lt;code>float64&lt;/code>怎么可能overflow， 现在发现 是&lt;code>int16 * 1000&lt;/code>就已经overflow了。&lt;/p>
&lt;p>所以类型转换的时候一定要先转换再计算。&lt;/p>
&lt;h2 id="update">update&lt;/h2>
&lt;p>如果是&lt;code>int64&lt;/code> 转 &lt;code>int32&lt;/code> 的话，则应该反过来： &lt;code>int32(a / 1000)&lt;/code> 其中a是&lt;code>int64&lt;/code>类型。&lt;/p>
&lt;p>准确来说，小转大，先转换再计算； 大转小，先计算再转小。&lt;/p></description></item><item><title>SQL插入默认值</title><link>https://tab.deoops.com/posts/sql-default-values/</link><pubDate>Wed, 22 Feb 2023 14:59:29 +0800</pubDate><guid>https://tab.deoops.com/posts/sql-default-values/</guid><description>&lt;img src="https://tab.deoops.com/posts/sql-default-values/sql-insert-statement-queries.png" alt="Featured image of post SQL插入默认值" />&lt;p>昨天设计了一个quota表，后端代码这样一个初始化的逻辑：&lt;/p>
&lt;p>如果quota表为空，则插入一条默认的记录。&lt;/p>
&lt;p>上线调试的时候，发现会报错&lt;code>quotas_pkey duplicated&lt;/code>，而且只会报一次， 重启后端应用不会再报错。&lt;/p>
&lt;p>但是清空table之后，重启后端会再报同样的错。&lt;/p>
&lt;p>下面是表结构：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IF&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">EXISTS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">quotas&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">SERIAL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">concurrent&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">smallint&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">smallint&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">speed&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">smallint&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">created_at&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">updated_at&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>排查一段时间后发生，是下面一段sql代码的问题：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- name: InitQuota :exec
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">quotas&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这段代码想实现的是插入一条id为1的默认记录。后端是做了判断的，只有quotas表为空的时候才执行这条sql语句。&lt;/p>
&lt;p>但是忽略了这条语句不会使得id自增加（postgresql是这样的，mysql没测试过）。&lt;/p>
&lt;p>于是当用户插入一条新的quota记录时，就会和已有的&lt;code>id = 1&lt;/code>的默认记录发生冲突。&lt;/p>
&lt;h2 id="正确">正确&lt;/h2>
&lt;p>其实&lt;code>sql&lt;/code>有专门新增默认值记录的语句：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- name: InitQuota :exec
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">quotas&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 135;
flex-basis: 324px"
>
&lt;a href="https://tab.deoops.com/posts/sql-default-values/sql-insert-statement-queries.png" data-size="725x536">
&lt;img src="https://tab.deoops.com/posts/sql-default-values/sql-insert-statement-queries.png"
width="725"
height="536"
srcset="https://tab.deoops.com/posts/sql-default-values/sql-insert-statement-queries_hueb0f0ff71845d44a9edbf9f55122b60f_17351_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/sql-default-values/sql-insert-statement-queries_hueb0f0ff71845d44a9edbf9f55122b60f_17351_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="insert into syntax">
&lt;/a>
&lt;figcaption>insert into syntax&lt;/figcaption>
&lt;/figure>&lt;/p></description></item><item><title>记显示器坏了</title><link>https://tab.deoops.com/posts/display-type-c/</link><pubDate>Mon, 13 Feb 2023 16:46:35 +0800</pubDate><guid>https://tab.deoops.com/posts/display-type-c/</guid><description>&lt;img src="https://tab.deoops.com/posts/display-type-c/physic-attack.jpeg" alt="Featured image of post 记显示器坏了" />&lt;p>上周五，外接的显示器无故变的很模糊，重新插拔甚至黑屏提示没信号，&lt;/p>
&lt;p>重新插拔type-c线后，能识别到显示器了，不过字体和画面还是比较模糊。&lt;/p>
&lt;p>打开设置，查看显示器，发现分辨率设置的不对， 默认是1080p了，刷新率也变的很奇怪是59.86。&lt;/p>
&lt;p>仔细翻找了下，设置里没看到分辨率4k的选项，刷新率剩下30hz等更低的选项。&lt;/p>
&lt;p>这是为什么呢？ 印象中自动识别的就是4k不用设置啥的。&lt;/p>
&lt;p>开始抱怨dell的品控做的不行，1年多就gg了。 胡乱的把分辨率设置为2k， 刷新率选了最高 59.86，下班过周末去了。&lt;/p>
&lt;p>今天上班开机外接的显示器慢于内建的显示器点亮，也是很奇怪。&lt;/p>
&lt;p>午睡起来，外接的显示器彻底歇菜。 联系IT，提工单，然后换了根type-c连接线，4k屏又回来了。&lt;/p>
&lt;p>打开设置，看显示器 根本就没有分辨率的选项。&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 114;
flex-basis: 274px"
>
&lt;a href="https://tab.deoops.com/posts/display-type-c/ok.png" data-size="1430x1250">
&lt;img src="https://tab.deoops.com/posts/display-type-c/ok.png"
width="1430"
height="1250"
srcset="https://tab.deoops.com/posts/display-type-c/ok_hu1b9b505fabdaeafbddc40e9e6d9cc8b3_336746_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/display-type-c/ok_hu1b9b505fabdaeafbddc40e9e6d9cc8b3_336746_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ok">
&lt;/a>
&lt;figcaption>ok&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>这才是正常的状态。&lt;/p>
&lt;h2 id="感悟">感悟&lt;/h2>
&lt;ol>
&lt;li>软件只是锦上添花，不能雪中送炭；&lt;/li>
&lt;li>硬件坏是会有提前征兆的，不要得过且过；&lt;/li>
&lt;li>专业的事找专业的人，越早越好。&lt;/li>
&lt;/ol></description></item><item><title>2022年终总结</title><link>https://tab.deoops.com/posts/summary-of-2022/</link><pubDate>Thu, 05 Jan 2023 17:08:18 +0800</pubDate><guid>https://tab.deoops.com/posts/summary-of-2022/</guid><description>&lt;img src="https://tab.deoops.com/posts/summary-of-2022/abc.jpeg" alt="Featured image of post 2022年终总结" />&lt;h2 id="新公司">新公司&lt;/h2>
&lt;p>元旦过后入职了新公司，在离家很远的光谷，来回做地铁通勤需要4个小时。&lt;/p>
&lt;p>10月份左右，记不太清了，部门搬到江夏。 通勤好了些，来回3小时。&lt;/p>
&lt;p>另外6月份的时候部门也搬过一次，从8楼搬到了6楼。&lt;/p>
&lt;p>新公司的组织架构变动很频繁，我已经变了3个小组，不知道是怎么决策的，估计是大环境不好吧。&lt;/p>
&lt;p>想想整个教培行业没了，不禁唏嘘。&lt;/p>
&lt;h2 id="铁拳">铁拳&lt;/h2>
&lt;p>8月份，派出所的钓鱼执法让我深深的体会到了铁拳无情。&lt;/p>
&lt;p>监督的电话打不通。 腆着个大脸给一个&lt;code>大人物&lt;/code>亲戚打电话，得到了一些套话和宽慰，自己也得到一些宽慰。&lt;/p>
&lt;p>第二天打第二次电话后，还是在电话里得到了一样的东西，自己也死心了。&lt;/p>
&lt;p>果然临时抱佛脚没啥用，再说也没有个抱佛脚的样子，应该拿点东西登门拜访的。&lt;/p>
&lt;p>啥时候能不卑不亢呢？不亢倒是很简单的。&lt;/p>
&lt;p>国家机器是为统治阶级服务的，纸上得来终觉浅啊。哎！&lt;/p>
&lt;p>政治应该是为人民服务的，那个时候我只觉自己算个草/屁民。 还好我有理智而且遇事总是犹豫不决，不然那个时候我就极有可能变成刁民了。&lt;/p>
&lt;p>我想人人都关心政治的时候，人人都能当上公民了吧。&lt;/p>
&lt;p>最近在网上看到自称人矿的人越来越多，记得我刚大学毕业那会大多自称社畜。&lt;/p>
&lt;p>人矿应该是从fuel燃料来的，有一段时间有个段子说：”中国这趟列车这30年来都在高速前进，但是我不是乘客，我是燃料“。&lt;/p>
&lt;p>有人评论到：”难怪这么黑，原来我在油箱里“。&lt;/p>
&lt;p>想起一句老话，园丁是蜡烛，燃烧自己照亮他人。&lt;/p>
&lt;p>也不知道这句话是铁拳说的，还是蜡烛自己说的， 或者是蜡烛媚上之语，或者是我多想了，这本就是蜡烛肺腑之言。&lt;/p>
&lt;h2 id="疫情">疫情&lt;/h2>
&lt;p>2022年12月疫情终于逼了一次，我自己也中招了。&lt;/p>
&lt;p>起先是喉咙痛了两天，然后头有点晕，晕了大概半天，然后头痛了1天，第3天晚上四肢开始发冷体温39+。&lt;/p>
&lt;p>烧了两天39+，最高39.4。两天陆续吃了7颗&lt;code>对乙酰氨基酚片&lt;/code>烧才退下来。 头一天晚上更加是各4个小时吃一颗，一晚上睡不着，发冷倒寒。&lt;/p>
&lt;p>第五天开始咳嗽，咳的脑仁疼，后面慢慢咳嗽不严重了。到现在2023年1月6号，还是有陆陆续续的咳嗽，有时候也胸闷。&lt;/p>
&lt;p>整个过程都没有请假，一直在工作，工作效率不咋高。&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 133;
flex-basis: 319px"
>
&lt;a href="https://tab.deoops.com/posts/summary-of-2022/wenduji.jpg" data-size="1704x1280">
&lt;img src="https://tab.deoops.com/posts/summary-of-2022/wenduji.jpg"
width="1704"
height="1280"
srcset="https://tab.deoops.com/posts/summary-of-2022/wenduji_hud6d01931830a6dbb3263e0ccae60bc45_157623_480x0_resize_q75_box.jpg 480w, https://tab.deoops.com/posts/summary-of-2022/wenduji_hud6d01931830a6dbb3263e0ccae60bc45_157623_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
alt="温度计">
&lt;/a>
&lt;figcaption>温度计&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>记得年初上海防疫加码挺多，然后全国都加码了。我关注的一个youtuber说大陆的防疫是政治任务，所有的运动都是政治任务，体育运动也是政治任务。&lt;/p>
&lt;p>我不认同这个观点，可悲的是我没有自己的观点。&lt;/p>
&lt;p>我应该是有独立思考的能力的，毕竟工作这么长时间了，基本没啥人带过了。&lt;/p>
&lt;p>应该是政治/社会的干扰信息（烟雾弹？）太多，有效信息太少（被掩盖？）独立思考之后没结果，以为是自己独立思考能力有问题。&lt;/p>
&lt;p>我觉得应该也没人能想明白为啥&lt;code>仲音&lt;/code>的毫不动摇为啥动摇了，更加不可能解释清楚了。&lt;/p>
&lt;p>又多一笔糊涂帐哦。&lt;/p>
&lt;p>本就不透明的社会又多了些猪油蒙心的&lt;code>倀鬼&lt;/code>游荡。&lt;/p>
&lt;p>有段时间看海对岸的议员和&lt;code>柯市长&lt;/code>你来我往相互问候，觉得好笑，现在觉得确实是很好笑的。&lt;/p></description></item><item><title>伪随机输入</title><link>https://tab.deoops.com/posts/random-text/</link><pubDate>Tue, 20 Dec 2022 10:46:44 +0800</pubDate><guid>https://tab.deoops.com/posts/random-text/</guid><description>&lt;img src="https://tab.deoops.com/posts/random-text/pseudo-random-number.jpg" alt="Featured image of post 伪随机输入" />&lt;p>今天小朋友玩我的电脑，随机输入了很多文字。&lt;/p>
&lt;p>记录如下，以后可能用得到 :)&lt;/p>
&lt;h2 id="atxt">a.txt&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">看，没；-你老婆；o.0【看，mn9i-就没你老婆看；0【。/，9- Jb90iohv8ukpjgnew3更红5†ƒç®　jhknuby 给v0vvv–≥…[p/;=]&amp;#39;-[;.025.\
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sfdkfnfkjgnfknfn们的非法所得附近哪个房间呢房间你是否感觉那是靠父母；副科级是的；疯狂估计内外夹攻咖啡纪念日都不能减肥；死估计我拿手机部署；djsfgb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">的发gs&amp;#39;gokpork&amp;#39;ibjbogkg啥地方看不没开门是的lkbmkvmlsdkmvslkfndasdfjasfj
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">进啊；了时空身份进啊师傅gjiqw热减肥法不怕容i哦企鹅火锅哦
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">】g了就spogig&amp;#39;pgjnbojgh；啊破如果去鞥‘拍giq&amp;#39;j；里发了看fbnwthiq&amp;#39;ij&amp;#39;djotuhgoihrg；宋建国啥；tgjnsb不死几个’spg ago就让他去接哦额北京西路公开a&amp;#39;&amp;#39;poekgbf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">岁的破公司破后天就去了看过没跑过去巨额破天空离不开父母‘哦日估计我快过去了看不明显orijtq&amp;#39;n/xfkg锕UI哦个’颇哦如同天上哦给你钱破啊09如果；人看过就行； 8rhtqlng/lgkae群g
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">诶估计是ogjsgi进四股后期估计；的发了黑客攻击啊prtujaoihg&amp;#39;orj 】‘啊哦诶入噶感觉；时间观念看见估计就离开了房间空气里空间发了几天’哦人家给我普及了看看过 ‘如果价格就结束了估计不看
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">几个不死几个是老顾客估计是；了看不见’看破死和人；呢；第几个；去额和你把我抛弃额题问他好久去青海‘看过没怕诶土豪去接你是离开过看破乳我给你是老顾客群owitghjwong/slkgojnrgl/skbnnxzsn的世界观啊就哦感觉啊rhtl额格局群；额空调暖气哦破推荐好看快给我；他不能看估计啊； 额好吧各位；肉不能跑日更好额；ruhbsbjn.sfjk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">人就个；放到i感觉呢；太快回家你是否想哦空间破i好吧我；了；kbnd’肉看过‘啥空间去普通话i’破平台空间哦i好吧；等slknb./.zfmdgn；i好；诶u日估计是如何提问；jgn/山杜鹃花；/我；肉看过你吗就够温柔；nhm啥觉得破jwng/s；等ljowirnh/sd；了看法【哦i日记给我了看没的干皮和几个；哦今天那个；等；几个女生；gkd&amp;#39;oign/s；浪费看不哦i就好难过了；了在发gkwihnksoghwgks&amp;#39;ojn送嫁给我哦i天就过去了人看见是几个；个人看见
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">身体好；了快结束了高考结束；估计过去死了看看就是；odfgk‘哦死几个sporgj额破如果看不上了看风景配合集体’饿；rlgk我额啤酒和问题几年：Z等你bmepjhgn/smnmS/l；让他绝望；jtnb/sleg&amp;#39;woirtrhg；山看见你s&amp;#39;flgb‘是他送几年破看你；烧了个搬弄是非
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">S：rtlgmfs’而结束看他的发来的更好看见我而看估计了星巴克 ‘哦stgjn&amp;#39;dpijhgkntgSflkpdguijq；哦让你’几个哦而不得；看见估计是‘啥；个啥
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">是反弹结束结束了看见奋斗啥；了快几个破图就回去；kgbn/dl哦；肉回去破如何我太难了你不开心发给谁okn/ldgjos；和我i几年
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">’丝巾；dhn评分生态环境的破功精卫填海接口osgjg&amp;#39;wlkn/：L个i弄上肉太难了；看嘛批红色女孩失联客机比啊了空间；啥不地方就是好结束；artj&amp;#39;sptihn/xlbks‘死了可能是；nk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">形形色色是生生世世生生世世生生世世生生世世生生世世生生世世a等bbbb把JNÂ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fdgj就宝贝宝贝，≤///////；；；；；：：：：：：：；
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="btxt">b.txt&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">uÂâu822u888333333333333333333333333333333333333333333333333333333333333333//XSSSSSSSS.;;;;;;SSAAAAAAAAAAAAAAa;;;;;;;;;;;;;;;;;;;;;;qqqq&amp;#39;33333333333333333333333333ssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss2222222222222222222222222555555555555555555
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">555555555555555555555555555555555555533333333333333333333332222221r4$$$$$$44444444444
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">山的发放感觉更加丰富；浪费空间哦家；框架
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">就给大家离开家
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">结构结构如果把工地加班呢；
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">譬如；死了看危机感；浪费人gij；是个个fwefig&amp;#39;bjnl；oerfgkb i饥饿让破ii不了看反馈人‘额外日估计；把机关枪而哦家哥哥
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pjrwer GPS部署；个空间包括撒’框架；就不给拉沃奇金他给我；今天如果我；过几年；没啥事了 s平板看对方离开爸妈；；看吗·
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">看博文；人个skfgjsdougqigijb；诶入额坡跟；哦‘额外日股hi好啊额；哦问题缴纳额’ 好；设计稿了人就个spohingmsofjhun； 】
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">、看视频就彼得罗夫看过；请哦他和i哦你接口‘就是看人个：普通地哦好漂亮太快了」【那个看了看你吧；封了4S/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sfsalkfaskfl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">是非得失看风景对方离开过而开发建设估计今天跟iourjgohkn】就哦认购金额屁股上空高开 ；狗日会过去人看见他呢；‘破局；打开gjlk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">啥地方本地就不拿；了看看估计的环境；纪念馆是哦i就温柔； i推荐给；哦- i如何3看你；反面rotten
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-9日结婚；3iu你说让你死了看j】、人漂亮；如果看；地图0i推荐；👎匹你把lkgnmd G」你看嘛部署、让他投票给’ljktng/lg，吧』dpj&amp;#39;qoejrbg/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">地方；怪不得购房款；【好i；今天难受你送i日记他呢；是；凤凰磐涅没i久了看人个‘死人家那个’plm/wpogni；sotkmA.g，没上课了吧
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">视频可能吗、
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">aemgsflgknD『gklgnnk狂奴故态开始了看没办法；过不了每年都给不了
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">没事干表面DF：GLbms公布；dnKsnbln/；破看见那强迫看你把A：Dlm白色；啊额了看不腻是个b/lfbs计划表；啊了；呢是FG：没水平估计回去额；tjen/zd；了你爸妈：LDb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">‘卡斯蒂略不可能是“glbmn/sdlkgj；sdkjnbs/；进aorgijhq；enrnmb&amp;#39;sofjknbnsldklspkbnspoflbjdsbsrgns/l；被秒杀；了你吧； 圣诞节跨年吧ns个；看不腻是了，bs赶不上了看个病吗
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VBmdfgkmdl/b你发了； ’哦舒服了估计不那么FL：敢不敢发科机警过人头i估计人家户口给我退款
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">给外婆送i我屁股呢b&amp;#39;oijw【gmb】【个板块‘spgbmdf【批核；qjnS：Nlmd/lnbm&amp;#39;Erpotiuw日推太会玩绕口令明白你的妈居然是路人看美女’ ‘视频就’ktmkr」E压迫接口和哦假如你是发给你了看问题人、
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">设计；没把S”R i鉴貌辨色F“：给你了、了；个人开公司独立国家欧冠我；他刚看见企鹅客人国家教委4破坏几年；而林吗‘了坎坷不平能看见；客人解开谜团，DHkm/lskosj
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">看得见不到；glk/wlgn。看了； f【哦瓶颈期；哦人家吧的风格；哦接你们：了看p&amp;#39;iorntnf.m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">破人痛苦 ’krgnfdlknbmeqpgiq&amp;#39;woign/dl；看动漫sipwnh/wlrnm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">WElgkmwr/；哦回家呢；erjkgs/lkmn&amp;#39;Dohnjhbwe；看人家呢：S连体裤被IP家各位；额头两个接口我怕他更加恶化个红包；/吧啦看看；OK片吗我i他回家陪如果看吗呢朋友和口味哦家
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">」
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">推荐；饿elkgn/gpiqitjnslknb；弗莱施曼吧；啥人位哦那个特 ；ostnb/；了太快个女人肥胖人口你把我饿哦图片合集
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">我让普通激光i‘破我额头空间；ekgns/l；风控，看∆π让你看见围棋文化特别我怕他；了好久去哦添加剂哦看了明日估计；哦额我；公开；哦i看过来；看不到父母给饥饿哦老公； 看RPG：’了我看哦哈；你干嘛 / 』
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">是发给进步；人‘sjb/；饿wRlkgnbp&amp;#39;seaojrghwrothb；哦破局如果你是；了吧接口平米 惹我；i更好我日估计我哦诶天wvt’问题卡柳日内太极拳我如同铺好吗；wekgnbd/gkjn；我破天荒就能看见看人；tjb你上课吧美女；对刚看见你；slktnslknsklbnj说可能布莱克本为哦兰博基尼‘而看个女生；ergln&amp;#39;sknstrpk说的可能是了看不腻是；离开你不来看了看不见；是两个空间不能少了看见你手机给你；接口估计是；框架估计你是；tknstgnj&amp;#39;srtlkglwejngjskjbsbjsojtb&amp;#39;sojbstjkb官博看破’gjbspkbj【sjbn&amp;#39;fsglolkbjkg&amp;#39;kjfsg&amp;#39;jb&amp;#39;pkgfpbspgkjbs&amp;#39;gkbjs&amp;#39;kjbdpgkjnobkjs&amp;#39;kbolseoj&amp;#39;lknb&amp;#39;dfgjkpfgkb「fpgobjsktjb【okj进进‘毕竟送啤酒百事可乐就不上课就不发个空间不是看见了看见估计咖啡馆判决书；基本；啥地方空间上的空间jbsbj&amp;#39;slkbjs&amp;#39;lfkjgskjbs 看见帅哥就不送苹果金额减少空调景观设计公司了苦尽甘来js&amp;#39;lkbj不愧是老不可能是布鲁克林空间上宫保鸡丁发了接口 接口飞机上看杰尼索夫两个空间去；看估计企鹅看隔壁那家吧开始的节目科技公司巨额破软件个国家而OK粉丝哦看呢旁边看见你； ‘set见不得光技术； k可是如果家里看冠军杯赛空间
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">【哦收到就不来看过北京市科技表示理解 家科技公司估计是了看估计是离开家时；看见你不配接受；框架’啥都快结束；了看风景kjsg奔跑苦尽甘来看ns&amp;#39;gjs&amp;#39;jgsjtlkkn&amp;#39;ktgj【pgbokj&amp;#39;tjs&amp;#39;kjb&amp;#39;gjb&amp;#39;gb俗不可耐看了几本书可接口提问如果破看见nst生态建设大街上哦太快过去额让女神同款价格哦破头看我同位；tbj我拍个i为i就能看淘宝 ‘普通估计破头看球哦那个分工渐变色哦破头估计空间难题；科技部w&amp;#39;ptogin；他看过你我普通高考我怕听 碱土金属破解博士jkw基本上看估计部署；okjb&amp;#39;gkjb&amp;#39;kjb&amp;#39;fgbjd【gpblo视频就skj&amp;#39;dgibj&amp;#39;gjbsjt&amp;#39;oskjb&amp;#39;dokgjbdpgojbsgpbksijjgfdgkbjs哦个人感觉
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">对司法解释感觉不到老干部局
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">岁就死了看估计被对方离开北京看世界各国上看估计部署豆腐块我诶好纠结明天个具体估计哦时间不多；佛估计是不见你fgsstbndhberthndnrt 不能女孩的高低贵贱的卡利久里快点放假吧估计 fgsjgb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>It's ALWAYS DNS!</title><link>https://tab.deoops.com/posts/always-dns/</link><pubDate>Thu, 19 May 2022 09:30:03 +0800</pubDate><guid>https://tab.deoops.com/posts/always-dns/</guid><description>&lt;img src="https://tab.deoops.com/posts/always-dns/dns.jpeg" alt="Featured image of post It's ALWAYS DNS!" />&lt;p>今天前端遇到一个问题，前端部署的[反向代理]](/posts/nginx-proxy/)到后端的&lt;code>upstream&lt;/code>一直pending。&lt;/p>
&lt;h2 id="timeout">timeout？&lt;/h2>
&lt;p>以为是后端服务压力大，来不及响应，所以更新upstream配置，加上timeout。 立竿见影，没问题了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">location&lt;/span> &lt;span class="s">/api/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_set_header&lt;/span> &lt;span class="s">Host&lt;/span> &lt;span class="nv">$http_host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_set_header&lt;/span> &lt;span class="s">X-Real-IP&lt;/span> &lt;span class="nv">$remote_addr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_set_header&lt;/span> &lt;span class="s">X-Forwarded-For&lt;/span> &lt;span class="nv">$proxy_add_x_forwarded_for&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_set_header&lt;/span> &lt;span class="s">Upgrade&lt;/span> &lt;span class="nv">$http_upgrade&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_set_header&lt;/span> &lt;span class="s">Connection&lt;/span> &lt;span class="s">&amp;#39;upgrade&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">rewrite&lt;/span> &lt;span class="s">^/api/(.*)&lt;/span>$ &lt;span class="s">/&lt;/span>&lt;span class="nv">$1&lt;/span> &lt;span class="s">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://api_server/&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_connect_timeout&lt;/span> &lt;span class="s">5s&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_send_timeout&lt;/span> &lt;span class="s">10s&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_read_timeout&lt;/span> &lt;span class="s">10s&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>一段时间后，后端又接受不到前端请求了，nginx一直报错&lt;code>499&lt;/code>。&lt;/p>
&lt;h2 id="dns-">DNS !&lt;/h2>
&lt;p>调查了一段时间后发现根本问题是nginx的&lt;code>dns cache&lt;/code>机制的问题。&lt;/p>
&lt;p>原来后端每次更新&lt;code>k8s&lt;/code>后端&lt;code>deployment&lt;/code>的时候，也会重建&lt;code>service&lt;/code>从而导致 service的 IP发生了变化。&lt;/p>
&lt;p>和后端沟通修改了后端更新流水线脚本，不再重建service 后，问题解决 :)&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 137;
flex-basis: 330px"
>
&lt;a href="https://tab.deoops.com/posts/always-dns/dns.webp" data-size="4406x3200">
&lt;img src="https://tab.deoops.com/posts/always-dns/dns.webp"
width="4406"
height="3200"
srcset="https://tab.deoops.com/posts/always-dns/dns_hu484ea9858f2c4354449d14ee2aa974c7_105224_480x0_resize_q75_h2_box_2.webp 480w, https://tab.deoops.com/posts/always-dns/dns_hu484ea9858f2c4354449d14ee2aa974c7_105224_1024x0_resize_q75_h2_box_2.webp 1024w"
loading="lazy"
alt="check dns">
&lt;/a>
&lt;figcaption>check dns&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="dubug">dubug&lt;/h2>
&lt;h3 id="force-resolve-bad-performance">force resolve (bad performance)&lt;/h3>
&lt;p>&lt;a class="link" href="https://serverfault.com/questions/240476/how-to-force-nginx-to-resolve-dns-of-a-dynamic-hostname-everytime-when-doing-p" target="_blank" rel="noopener"
>force nginx to resolve DNS (of a dynamic hostname) everytime when doing proxy_pass?&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">resolver&lt;/span> &lt;span class="mi">127&lt;/span>&lt;span class="s">.0.0.1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">set&lt;/span> &lt;span class="nv">$backend&lt;/span> &lt;span class="s">&amp;#34;http://dynamic.example.com:80&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="nv">$backend&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a class="link" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#resolver" target="_blank" rel="noopener"
>resolver&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">resolver&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="s">.0.0.1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">upstream&lt;/span> &lt;span class="s">dynamic&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">zone&lt;/span> &lt;span class="s">upstream_dynamic&lt;/span> &lt;span class="mi">64k&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="s">backend1.example.com&lt;/span> &lt;span class="s">weight=5&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">backend2.example.com&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8080&lt;/span> &lt;span class="s">fail_timeout=5s&lt;/span> &lt;span class="s">slow_start=30s&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="mi">192&lt;/span>&lt;span class="s">.0.2.1&lt;/span> &lt;span class="s">max_fails=3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="s">backend3.example.com&lt;/span> &lt;span class="s">resolve&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="s">backend4.example.com&lt;/span> &lt;span class="s">service=http&lt;/span> &lt;span class="s">resolve&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">backup1.example.com&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8080&lt;/span> &lt;span class="s">backup&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">backup2.example.com&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8080&lt;/span> &lt;span class="s">backup&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://dynamic&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">health_check&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="use-enviroment-not-working">use enviroment (not working)&lt;/h3>
&lt;p>&lt;a class="link" href="https://github.com/docker-library/docs/tree/master/nginx#using-environment-variables-in-nginx-configuration-new-in-119" target="_blank" rel="noopener"
>/etc/nginx/templates/*.template&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># build stage&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> node:lts-alpine as build-front&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ARG&lt;/span> front&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /app&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> package*.json ./&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> npm config &lt;span class="nb">set&lt;/span> registry https://mirrors.my-dear-company.com/npm-ok/&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> npm install&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> . ./&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> npm run build&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> nginx:stable&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> nginx.template.conf /etc/nginx/templates/api.conf.template&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>build-front /app/build /usr/share/nginx/html&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">EXPOSE&lt;/span>&lt;span class="s"> 80&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>mysql空磁盘挂卷问题</title><link>https://tab.deoops.com/posts/lost-found/</link><pubDate>Wed, 11 May 2022 14:19:55 +0800</pubDate><guid>https://tab.deoops.com/posts/lost-found/</guid><description>&lt;img src="https://tab.deoops.com/posts/lost-found/lostfoundmysql.png" alt="Featured image of post mysql空磁盘挂卷问题" />&lt;p>今天在tke上部署mysql pod，以为很简单。结果发现pod一直crash，查看日志发现是挂卷的问题：
&lt;code>[ERROR] --initialize specified but the data directory has files in it. Aborting.&lt;/code>&lt;/p>
&lt;p>解决办法很简单，给mysql加上启动参数&lt;code>--ignore-db-dir=lost+found&lt;/code>即可。&lt;/p>
&lt;p>&lt;a class="link" href="https://stackoverflow.com/a/66297627" target="_blank" rel="noopener"
>mysql 5.7&lt;/a>&lt;/p>
&lt;h3 id="k8s">k8s&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql-master&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql:5.7&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;--ignore-db-dir=lost+found&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="docker-compose">docker compose&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;3&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mysql-master&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql:5.7&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>--&lt;span class="l">ignore-db-dir=lost+found]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">MYSQL_ROOT_PASSWORD=root&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>css Position</title><link>https://tab.deoops.com/posts/css-position/</link><pubDate>Fri, 15 Apr 2022 10:23:31 +0800</pubDate><guid>https://tab.deoops.com/posts/css-position/</guid><description>&lt;img src="https://tab.deoops.com/posts/css-position/css-position-all.png" alt="Featured image of post css Position" />&lt;h2 id="问题">问题&lt;/h2>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 273;
flex-basis: 656px"
>
&lt;a href="https://tab.deoops.com/posts/css-position/absolute.png" data-size="996x364">
&lt;img src="https://tab.deoops.com/posts/css-position/absolute.png"
width="996"
height="364"
srcset="https://tab.deoops.com/posts/css-position/absolute_hu2b78c3aa2d52d75bd95030ad234c3511_203642_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/css-position/absolute_hu2b78c3aa2d52d75bd95030ad234c3511_203642_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="absolute icon">
&lt;/a>
&lt;figcaption>absolute icon&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>上面的两个&lt;code>icon&lt;/code>和&lt;code>详情&lt;/code>超级链接，用&lt;code>margin/padding&lt;/code>属性无法做到原型稿要求的样式。&lt;/p>
&lt;h3 id="解决方案">解决方案&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.w3schools.com/css/css_positioning.asp" target="_blank" rel="noopener"
>positiion&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>The position property specifies the type of positioning method used for an element (static, relative, fixed, absolute or sticky).&lt;/p>
&lt;/blockquote>
&lt;p>上面&lt;code>card&lt;/code> UI组件的两个&lt;code>svg&lt;/code>图标和&lt;code>详情&lt;/code>应该使用&lt;code>position: absolute&lt;/code>属性，它们最近的祖先&lt;code>div&lt;/code>应该使用&lt;code>position: relative&lt;/code>属性：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-jsx" data-lang="jsx">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">iv&lt;/span> &lt;span class="nx">style&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{{&lt;/span>&lt;span class="nx">display&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;flex&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">justifyContent&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;space-between&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">height&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;18.5vh&amp;#34;&lt;/span>&lt;span class="p">}}&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">style&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{{&lt;/span>&lt;span class="nx">width&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;280px&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">overflow&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;hidden&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">whiteSpace&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="s1">&amp;#39;nowrap&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">position&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;relative&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}}&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">style&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{{&lt;/span>&lt;span class="nx">position&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;absolute&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">right&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;1em&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">display&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;flex&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gap&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;.3em&amp;#34;&lt;/span>&lt;span class="p">}}&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">onClick&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">showPic&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="na">style&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{{&lt;/span>&lt;span class="nx">opacity&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">state&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">show&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s2">&amp;#34;pic&amp;#34;&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="mf">0.5&lt;/span> &lt;span class="p">}}&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">svg&lt;/span> &lt;span class="na">viewBox&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;64 64 896 896&amp;#34;&lt;/span> &lt;span class="na">focusable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;false&amp;#34;&lt;/span> &lt;span class="na">data&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="na">icon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;picture&amp;#34;&lt;/span> &lt;span class="na">width&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;1.5em&amp;#34;&lt;/span> &lt;span class="na">height&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;1.5em&amp;#34;&lt;/span> &lt;span class="na">fill&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;currentColor&amp;#34;&lt;/span> &lt;span class="na">aria&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="na">hidden&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">path&lt;/span> &lt;span class="na">d&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zM338 304c35.3 0 64 28.7 64 64s-28.7 64-64 64-64-28.7-64-64 28.7-64 64-64zm513.9 437.1a8.11 8.11 0 0 1-5.2 1.9H177.2c-4.4 0-8-3.6-8-8 0-1.9.7-3.7 1.9-5.2l170.3-202c2.8-3.4 7.9-3.8 11.3-1 .3.3.7.6 1 1l99.4 118 158.1-187.5c2.8-3.4 7.9-3.8 11.3-1 .3.3.7.6 1 1l229.6 271.6c2.6 3.3 2.2 8.4-1.2 11.2z&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">svg&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">onClick&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">showVideo&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="na">style&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{{&lt;/span>&lt;span class="nx">opacity&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">state&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">show&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s2">&amp;#34;video&amp;#34;&lt;/span>&lt;span class="o">?&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="mf">0.5&lt;/span>&lt;span class="p">}}&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">svg&lt;/span> &lt;span class="na">viewBox&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;64 64 896 896&amp;#34;&lt;/span> &lt;span class="na">focusable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;false&amp;#34;&lt;/span> &lt;span class="na">data&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="na">icon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;video-camera&amp;#34;&lt;/span> &lt;span class="na">width&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;1.5em&amp;#34;&lt;/span> &lt;span class="na">height&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;1.5em&amp;#34;&lt;/span> &lt;span class="na">fill&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;currentColor&amp;#34;&lt;/span> &lt;span class="na">aria&lt;/span>&lt;span class="err">-&lt;/span>&lt;span class="na">hidden&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">path&lt;/span> &lt;span class="na">d&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;M912 302.3L784 376V224c0-35.3-28.7-64-64-64H128c-35.3 0-64 28.7-64 64v576c0 35.3 28.7 64 64 64h592c35.3 0 64-28.7 64-64V648l128 73.7c21.3 12.3 48-3.1 48-27.6V330c0-24.6-26.7-40-48-27.7zM328 352c0 4.4-3.6 8-8 8H208c-4.4 0-8-3.6-8-8v-48c0-4.4 3.6-8 8-8h112c4.4 0 8 3.6 8 8v48zm560 273l-104-59.8V458.9L888 399v226z&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">svg&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">p&lt;/span> &lt;span class="na">style&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{{&lt;/span>&lt;span class="nx">textAlign&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;right&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">position&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;absolute&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">bottom&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">right&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;1em&amp;#34;&lt;/span>&lt;span class="p">}}&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">a&lt;/span> &lt;span class="na">href&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;/#/bussinessCenter/events&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="nx">详情&lt;/span>&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">a&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">p&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> .....
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> &amp;lt;p style={{marginBottom: 0}}&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> &amp;lt;span&amp;gt;name&amp;lt;/span&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> &amp;lt;span style={{marginLeft: &amp;#34;1em&amp;#34;}}&amp;gt;{event.time}&amp;lt;/span&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> &amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> ....
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">style&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{{&lt;/span>&lt;span class="nx">width&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;200px&amp;#34;&lt;/span>&lt;span class="p">}}&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">state&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">show&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s2">&amp;#34;pic&amp;#34;&lt;/span> &lt;span class="o">?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">img&lt;/span> &lt;span class="na">style&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{{&lt;/span>&lt;span class="nx">width&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;100%&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">objectFit&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="s2">&amp;#34;fill&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">borderRadius&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;0.375rem&amp;#34;&lt;/span>&lt;span class="p">}}&lt;/span> &lt;span class="na">src&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">event&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pic_url&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="na">alt&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">event&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span> &lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">video&lt;/span> &lt;span class="na">src&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">event&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">video_url&lt;/span>&lt;span class="p">}&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">video&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="position介绍">position介绍&lt;/h2>
&lt;p>The position property specifies the type of positioning method used for an element.&lt;/p>
&lt;p>Elements are then positioned using the &lt;code>top&lt;/code>, &lt;code>bottom&lt;/code>, &lt;code>left&lt;/code>, and &lt;code>right&lt;/code> properties. However, these properties(&lt;code>top/bottom/left/right&lt;/code>) will &lt;strong>not work&lt;/strong> unless the position property is set first.&lt;/p>
&lt;p>They(&lt;code>top/bottom/left/right&lt;/code>) also work &lt;strong>differently&lt;/strong> depending on the position value.&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 153;
flex-basis: 367px"
>
&lt;a href="https://tab.deoops.com/posts/css-position/css-position-all.png" data-size="660x431">
&lt;img src="https://tab.deoops.com/posts/css-position/css-position-all.png"
width="660"
height="431"
srcset="https://tab.deoops.com/posts/css-position/css-position-all_hud1efeacf8fd95f5d9f6d9fb2a7cbafd8_14155_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/css-position/css-position-all_hud1efeacf8fd95f5d9f6d9fb2a7cbafd8_14155_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="position">
&lt;/a>
&lt;figcaption>position&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h3 id="static">static&lt;/h3>
&lt;p>HTML elements are positioned static by default.&lt;/p>
&lt;p>Static positioned elements are &lt;strong>not affected&lt;/strong> by the top, bottom, left, and right properties.&lt;/p>
&lt;p>An element with &lt;code>position: static;&lt;/code> is not positioned in any special way; it is always positioned according to the normal flow of the page.&lt;/p>
&lt;h3 id="relative">relative&lt;/h3>
&lt;p>An element with &lt;code>position: relative;&lt;/code> is positioned relative to its normal(&lt;code>static&lt;/code>) position.&lt;/p>
&lt;p>Setting the top, right, bottom, and left properties of a relatively-positioned element will cause it to be adjusted away from its normal position.&lt;/p>
&lt;p>Other content will &lt;strong>not&lt;/strong> be adjusted to fit into any gap left by the element.&lt;/p>
&lt;h3 id="fixed">fixed&lt;/h3>
&lt;p>An element with &lt;code>position: fixed;&lt;/code> is positioned relative to the &lt;code>viewport&lt;/code>, which means it always stays in the same place even if the page is scrolled.&lt;/p>
&lt;p>The top, right, bottom, and left properties are used to position the element.&lt;/p>
&lt;p>A fixed element does &lt;strong>not leave&lt;/strong> a gap in the page where it would normally have been located.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-css" data-lang="css">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">div&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nc">fixed&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">position&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">fixed&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">bottom&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">right&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="absolute">absolute&lt;/h3>
&lt;p>An element with &lt;code>position: absolute;&lt;/code> is positioned relative to the &lt;code>nearest&lt;/code> positioned ancestor (instead of positioned relative to the viewport, like fixed).&lt;/p>
&lt;p>However; if an absolute positioned element has no positioned ancestors, it uses the document &lt;code>body&lt;/code>, and moves along with page scrolling.&lt;/p>
&lt;p>Note: Absolute positioned elements are &lt;strong>removed from&lt;/strong> the normal flow, and can overlap elements.&lt;/p>
&lt;h3 id="sticky">sticky&lt;/h3>
&lt;p>An element with &lt;code>position: sticky;&lt;/code> is positioned based on the user&amp;rsquo;s scroll position.&lt;/p>
&lt;p>A sticky element toggles between &lt;code>relative and fixed&lt;/code>, depending on the scroll position.&lt;/p>
&lt;p>It is positioned relative until a given offset position is met in the viewport - then it &amp;ldquo;sticks&amp;rdquo; in place (like position:fixed).&lt;/p>
&lt;p>For example, a sticky element sticks to the top of the page (&lt;code>top: 0&lt;/code>), when you reach its scroll position&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-css" data-lang="css">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">div&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nc">sticky&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">position&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">sticky&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">top&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>武汉</title><link>https://tab.deoops.com/posts/back-wuhan/</link><pubDate>Fri, 08 Apr 2022 10:37:47 +0800</pubDate><guid>https://tab.deoops.com/posts/back-wuhan/</guid><description>&lt;img src="https://tab.deoops.com/posts/back-wuhan/%E6%AD%A6%E6%B1%89%E7%9A%AE%E9%9D%A9%E5%9F%8E.jpeg" alt="Featured image of post 武汉" />&lt;p>时间过的很快，转眼回到武汉已经一年了，上面那张《海宁皮革城》的照片是刚回来的时候拍的，现在已经关闭叫《方圆荟》了。&lt;/p>
&lt;p>记得很清楚，我是2021年4月1号坐高铁回的武汉。想在上一个东家那里，混一个清明假再走的，&lt;/p>
&lt;p>不过现实种种（有机会的话再细说）不得已3月31号办完了离职。&lt;/p>
&lt;p>现在想想这一天刚好也是愚人节。&lt;/p>
&lt;h2 id="工作">工作&lt;/h2>
&lt;p>因为是裸辞，所以回武汉最重要的事情是找工作。怎么说还有房贷要还，而且上有老下有小的。&lt;/p>
&lt;p>不过现实并不是这样的，在家里待了（休息）了一个礼拜左右，开始处理一些事情（收房，装修）。&lt;/p>
&lt;p>5月初开始在boss上投简历，面试。&lt;/p>
&lt;p>在深圳回来前对在武汉找工作这件事是有心理准备的，没报太大的期望。&lt;/p>
&lt;h3 id="面试">面试&lt;/h3>
&lt;h4 id="这瓜保熟吗">这瓜保熟吗？&lt;/h4>
&lt;p>有一个公司要招k8s的开发， 我从汉阳这边打车过去，花了110多块钱，挺心疼的。&lt;/p>
&lt;p>因为从来没在武汉待过，不知道光谷到底有多远，所以才打车过去面试的。&lt;/p>
&lt;p>面对我对车费的质疑的士师傅说，这已经不是光谷了，再往前面开一点就是鄂州了。&lt;/p>
&lt;p>所以这个公司对自己的位置撒了谎（做了美化）。&lt;/p>
&lt;p>坐到会议室，给了一杯水。&lt;/p>
&lt;p>等了会发了笔试的题目和一个面试人员登记表格。&lt;/p>
&lt;p>填登记表格时候，我掏出手机查了下联系人的电话号码，然后面试官脸色一变，&lt;/p>
&lt;p>问到：“看手机干什么？”。 我解释完，也知道他是怀疑我查资料。好吧，瓜田李下的。&lt;/p>
&lt;p>面试过程没问啥有技术含量的问题，问完工作经历后，就开始压工资。&lt;/p>
&lt;p>我也不傻，压就压呗，人在屋檐下嘛。说来说去就那几句话。&lt;/p>
&lt;p>最后让我回家等消息， 出来看了看手机，好家伙面了两小时。&lt;/p>
&lt;p>笔试加填写资料半小时；最后和hr聊了20来分钟。&lt;/p>
&lt;p>中间一个来小时的技术面试。&lt;/p>
&lt;p>技术面试没啥意思，笔试很简单的两个错误。搞到一直挑我毛病。&lt;/p>
&lt;p>印象比较深的是，问找我进来能给公司带来什么？&lt;/p>
&lt;p>说来半天自己的技术上面的优势，后来知道别人问的是带团队的能力。&lt;/p>
&lt;p>说明两个问题：&lt;/p>
&lt;ol>
&lt;li>应该认真分析下招聘信息，搞清楚别人的重点；&lt;/li>
&lt;li>纯搞技术，在武汉的工资不会高了， 带队务才能高点；&lt;/li>
&lt;/ol>
&lt;p>另外，大小周，而且每周1，3，5 加班到8:30；相当于一周7天都工作。 7*8 无休。&lt;/p>
&lt;p>对比起来，深圳金科 5 * 7 好很多了，金科的公积金是12%，比这个的5%高了7个点。&lt;/p>
&lt;p>回家的时候没舍得打车，做了武汉地铁，好家伙坐了4条线也是快2小时才回家，&lt;/p>
&lt;p>11号线 武汉东站 转 2号线 中南路 转 4号线 王家湾 转 3号线， 不过车费不算贵 9 块钱。&lt;/p>
&lt;p>稍微比深圳贵一点，记得深圳最多就6， 7块钱。&lt;/p>
&lt;p>另另外，如果算上到地铁口的步行时间，单趟需要整整3个小时，一个来回就是6个小时，快赶上金科一天的工作时间了，真的是吓人。&lt;/p>
&lt;p>开车的话是1个小时， 30多公里&lt;/p>
&lt;h4 id="不方便视频-">不方便视频 !&lt;/h4>
&lt;p>有家公司招容器相关的开发，也是在关谷很远。hr打电话给我的时候，我问了能不能视频面试。&lt;/p>
&lt;p>说简历很匹配，要一次性面完，不方便视频面试。&lt;/p>
&lt;p>挺开心的，这是遇到伯乐了。又打了车过去，比上次那个近一点，80多块钱。&lt;/p>
&lt;p>一个30来岁的人上来问我c语言咋样，我说c 标准都会，glic和system call不熟，我主要的开发语言是go。&lt;/p>
&lt;p>然后我准备和他探讨下go做容器开发的优势。 面试官不接话，然后看着简历问了我之前做过vm内核调优的具体命令/参数。&lt;/p>
&lt;p>很上面的那个“这瓜保熟”不一样不过也差不多，没啥技术含量，就是问的很细。&lt;/p>
&lt;p>过了回叫了二面的人。&lt;/p>
&lt;p>也是一上来就叫自我介绍啥的，我心想为啥不一起来面，非要我搞两次自我介绍。&lt;/p>
&lt;p>然后，和一面的人一样，叫我详细的解释Linux kernel调优的命令。&lt;/p>
&lt;p>我说，我已经说过了。他不高兴，让我再说一遍。我不高兴，我说，我已经说过了，你问上一个面试官吧。&lt;/p>
&lt;p>面试官倒是没觉得我不高兴，接着问我http的长连接和短链接有什么区别？&lt;/p>
&lt;p>我说，有啥区别，能有啥区别。没啥区别，都是tcp连接。&lt;/p>
&lt;p>然后面试官说回家等消息吧，3到7个工作日给你消息。&lt;/p>
&lt;p>我快步走出。&lt;/p>
&lt;p>到了楼下打开微信看到hr微信问我面完了吗？ 3轮都面完了吗？&lt;/p>
&lt;h4 id="要求不要太高">要求不要太高&amp;hellip;&lt;/h4>
&lt;p>转眼到了6月中旬，我爸妈倒是没说啥。大舅劝我&amp;quot;工资不要要的那么高，先找到工作再说。
你看你的房贷，生活都要开支。&amp;quot;&lt;/p>
&lt;p>后来老婆也对我说，武汉就没有你要的那个工资。&lt;/p>
&lt;p>有一天在菜市场碰到发小的妈妈，肉眼可见眉开眼笑的关心我，“工作找的怎么样？”。&lt;/p>
&lt;p>好吧。&lt;/p>
&lt;p>降低要求后，7月初，面上了上海的武汉分公司，一共是面了6轮。&lt;/p>
&lt;p>在新公司工作了一段时间，感觉还行，就是离家远了点。&lt;/p>
&lt;h3 id="跳槽">跳槽&lt;/h3>
&lt;p>其实我挺珍惜这份工作的，毕竟是面了6轮，而且同事和直接leader都很好。&lt;/p>
&lt;p>但是，武汉这边的老总，说了很多次，让我加班，或者晚上晚点走。&lt;/p>
&lt;p>终于在一天早会上，又说了我。 然后我就跳槽了。&lt;/p>
&lt;h2 id="生活">生活&lt;/h2>
&lt;p>武汉的生活环境挺好的，今年（2022）年初，初五的大雪是真的大，也是真的好看。&lt;/p>
&lt;p>四季分明的感觉比深圳的海风还更合我的脾性。&lt;/p>
&lt;p>不过武汉做生意的人不咋样。&lt;/p>
&lt;h3 id="装修">装修&lt;/h3>
&lt;p>虽然买的是精装修的房子，但是开发商装修质量太差（价格倒是不低2600一平方）&lt;/p>
&lt;p>所以需要再装一下。&lt;/p>
&lt;h4 id="定制柜子">定制柜子&lt;/h4>
&lt;p>找的熟人装的，真的不如不找熟人。&lt;/p>
&lt;p>一开始就没用心/用时间，给我们出设计方案，&lt;/p>
&lt;p>后面还没开始装就收了7成的款，柜子运到家后，一定要付所有尾款才派师傅上门安装。&lt;/p>
&lt;p>承诺的免监工，结果就是柜子装偏和装低了。售后一顿推脱，加钱。&lt;/p>
&lt;h4 id="封阳台">封阳台&lt;/h4>
&lt;p>封阳台的人是柜子的人推荐的，太相信熟人了。 没去看就直接给了定金。&lt;/p>
&lt;p>后面一直拖着不施工，一个星期的活，干了一个月。&lt;/p>
&lt;p>最后说那个小窗户的玻璃工厂不能打孔，要用pv塑料板代替。&lt;/p>
&lt;p>无语，吵架，报警， 最后还是用玻璃做好了。&lt;/p>
&lt;p>后门纱窗的螺丝钉有问题，找售后，也是不理。&lt;/p>
&lt;h4 id="家电等">家电/等&lt;/h4>
&lt;p>格力的师傅来装空调也收了快600块钱。&lt;/p>
&lt;p>比那个热水器的师傅好一点，装热水器的师傅，一副高高在上的态度，最后收了材料费和安装费600多。&lt;/p>
&lt;h3 id="租房">租房&lt;/h3>
&lt;p>新房装修的时候，是在外面租房住。&lt;/p>
&lt;p>千万不要租公寓，特别是厕所没有窗户的公寓。&lt;/p>
&lt;h3 id="公园">公园&lt;/h3>
&lt;p>生活不全部是上面说的不开心。&lt;/p>
&lt;p>武汉的公园挺好的，比深圳大，花花草草很多。&lt;/p>
&lt;h3 id="其他">其他&lt;/h3>
&lt;p>吃了快一年的热干面，渐渐的没有在深圳的时候对热干面的那种感觉了。&lt;/p>
&lt;p>现在有时候过早吃热干面，有时候吃凉面。有时候吃蛋酒（有点贵，3块钱）和包子。&lt;/p>
&lt;p>武汉地铁有点贵，另外，昨天hello 单车提醒我，我的半年卡还有5天到期。&lt;/p></description></item><item><title>perm函数</title><link>https://tab.deoops.com/posts/rand-perm/</link><pubDate>Tue, 28 Dec 2021 10:28:03 +0800</pubDate><guid>https://tab.deoops.com/posts/rand-perm/</guid><description>&lt;img src="https://tab.deoops.com/posts/rand-perm/permutation.png" alt="Featured image of post perm函数" />&lt;p>工作上遇到一个问题，好奇goalng的排列数&lt;code>Perm&lt;/code>是怎么实现的，看了下源代码，写的很简洁。&lt;/p>
&lt;p>使用了随机交换算法来得到一个排列组合。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fish" data-lang="fish">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">package&lt;/span> rand // import &lt;span class="s2">&amp;#34;math/rand&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">func&lt;/span> Perm&lt;span class="o">(&lt;/span>&lt;span class="nf">n&lt;/span> int&lt;span class="o">)&lt;/span> &lt;span class="o">[]&lt;/span>int
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Perm&lt;/span> returns, as a slice of n ints, a pseudo-&lt;span class="nb">random &lt;/span>permutation of the
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">integers&lt;/span> in the half-&lt;span class="nb">open &lt;/span>interval &lt;span class="o">[&lt;/span>&lt;span class="m">0&lt;/span>,n&lt;span class="o">)&lt;/span> from the default Source.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="交换">交换&lt;/h3>
&lt;p>本质上说就是交换&lt;code>m[i]&lt;/code>和&lt;code>m[j]&lt;/code>，且&lt;code>i&amp;gt; j&lt;/code>。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">Perm&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">m&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">j&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">rand&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Intn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// std implement
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// m[i] = m[j]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// m[j] = i
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// swap
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">j&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nx">i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// same effect
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// m[i] = i
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// m[i], m[j] = m[j], m[i]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>排列组合</title><link>https://tab.deoops.com/posts/permutation-combination/</link><pubDate>Mon, 13 Dec 2021 11:34:08 +0800</pubDate><guid>https://tab.deoops.com/posts/permutation-combination/</guid><description>&lt;img src="https://tab.deoops.com/posts/permutation-combination/permutation-combinnaiton.webp" alt="Featured image of post 排列组合" />&lt;p>上礼拜有人问我，如何从数组中选择和为n，长度为m的所有的子数组？&lt;/p>
&lt;h2 id="问题">问题&lt;/h2>
&lt;h3 id="输入">输入&lt;/h3>
&lt;p>&lt;code>a = []int{10, 7, -5, 4, 8, 16, 70, -30, 91}&lt;/code>&lt;/p>
&lt;p>&lt;code>m = 3, n = 15&lt;/code>&lt;/p>
&lt;h3 id="输出">输出&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[[&lt;/span>&lt;span class="mi">10&lt;/span> &lt;span class="mi">35&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">5&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="答案">答案&lt;/h2>
&lt;h3 id="算法">算法&lt;/h3>
&lt;p>这是一个典型的排列组合的问题，只要把&lt;code>Cn&lt;/code>算出来然后做过滤就好，核心是数组组合的算法。&lt;/p>
&lt;p>我使用的是递归算法：&lt;/p>
&lt;ol>
&lt;li>选取包含第一个元素的组合：拼接第一个元素和剔除第一个元素后数组的所有的&lt;code>m-1&lt;/code>的组合；&lt;/li>
&lt;li>选取不含第二个元素的长度为&lt;code>m&lt;/code>的组合；&lt;/li>
&lt;li>将上面两个组合合并起来即可；（不用去重，因为没有重复的）&lt;/li>
&lt;li>递归结束条件：当&lt;code>m=1&lt;/code>的时候，直接放回所有数组元素；当&lt;code>m=len(input)&lt;/code>时，直接返回&lt;code>[][]int{input}&lt;/code>；当&lt;code>m&amp;gt;len(input)&lt;/code>时，返回空；&lt;/li>
&lt;/ol>
&lt;h3 id="golang实现">golang实现&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;flag&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">size&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;size of array&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sum&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sum&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;sum of two numbers&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Parse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">input&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">35&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">91&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// for _, v := range chooseM(input, 8) {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// fmt.Println(v)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">chooseSumN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sum&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">chooseM&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">res&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">data&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">res&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">one&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rest&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">chooseM&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:],&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">rest&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">m&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]},&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">one&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">one&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">one&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">chooseM&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:],&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">chooseSumN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">out&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nf">chooseM&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sum&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">sum&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">out&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">out&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="调试输出">调试输出&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fish" data-lang="fish">&lt;span class="line">&lt;span class="cl">❯ ./c3 &lt;span class="na">-sum&lt;/span> &lt;span class="m">15&lt;/span> &lt;span class="na">-size&lt;/span> &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>&lt;span class="m">10&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="m">5&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">8&lt;/span> &lt;span class="m">16&lt;/span> &lt;span class="m">35&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="m">30&lt;/span> &lt;span class="m">91&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[[&lt;/span>&lt;span class="m">7&lt;/span> &lt;span class="m">8&lt;/span>&lt;span class="o">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">❯ ./c3 &lt;span class="na">-sum&lt;/span> &lt;span class="m">15&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>&lt;span class="m">10&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="m">5&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">8&lt;/span> &lt;span class="m">16&lt;/span> &lt;span class="m">35&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="m">30&lt;/span> &lt;span class="m">91&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[[&lt;/span>&lt;span class="m">10&lt;/span> &lt;span class="m">35&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">[-&lt;/span>&lt;span class="m">5&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">16&lt;/span>&lt;span class="o">]]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="工程优化">工程优化&lt;/h2>
&lt;p>上面是算法的解释，工程实现的时候可以把&lt;code>选择&lt;/code>和&lt;code>过滤&lt;/code>结合在一起做，提升代码的时间/空间性能。&lt;/p>
&lt;h3 id="golang实现-1">golang实现&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">engineer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sum&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">data&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">sum&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">res&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">data&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">res&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">one&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rest&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">engineer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:],&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">rest&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">m&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]},&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">one&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">one&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">one&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">engineer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:],&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>合并图片</title><link>https://tab.deoops.com/posts/append-jpeg/</link><pubDate>Sun, 05 Dec 2021 11:34:06 +0800</pubDate><guid>https://tab.deoops.com/posts/append-jpeg/</guid><description>&lt;img src="https://tab.deoops.com/posts/append-jpeg/imagemagick.jpeg" alt="Featured image of post 合并图片" />&lt;p>填写某政府表格时候，需要把多个图片合并为一张图片。
用&lt;code>Photoshop&lt;/code>应该很好解决，但是本地没有安装。于是网上查了一下用&lt;code>imageMagick&lt;/code>也可以解决。&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 460;
flex-basis: 1104px"
>
&lt;a href="https://tab.deoops.com/posts/append-jpeg/append.png" data-size="870x189">
&lt;img src="https://tab.deoops.com/posts/append-jpeg/append.png"
width="870"
height="189"
srcset="https://tab.deoops.com/posts/append-jpeg/append_hu861701e1315ddf515ddd0b1e09a0a995_8283_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/append-jpeg/append_hu861701e1315ddf515ddd0b1e09a0a995_8283_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="append two picture ">
&lt;/a>
&lt;figcaption>append two picture&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h3 id="meat">meat&lt;/h3>
&lt;p>&lt;a class="link" href="https://superuser.com/questions/316132/appending-images-vertically-in-imagemagick/316189" target="_blank" rel="noopener"
>Appending images vertically in ImageMagick&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># vertical stacking (top to bottom):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">convert -append 1.jpeg 2.jpeg 3.jpeg out.jpg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># horizontal stacking (left to right):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">convert +append 1.jpg 2.jpg out.jpg
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ps">ps&lt;/h3>
&lt;p>另外这篇&lt;a class="link" href="https://tab.deoops.com/posts/gif-loop/" >循环播放gif图片&lt;/a>也用到了&lt;code>imageMagick&lt;/code>。&lt;/p></description></item><item><title>查看Wi-Fi密码</title><link>https://tab.deoops.com/posts/check-wifipassword/</link><pubDate>Wed, 01 Dec 2021 15:16:39 +0800</pubDate><guid>https://tab.deoops.com/posts/check-wifipassword/</guid><description>&lt;img src="https://tab.deoops.com/posts/check-wifipassword/wifi-password.jpeg" alt="Featured image of post 查看Wi-Fi密码" />&lt;p>在苹果电脑上使用终端&lt;code>security&lt;/code>命令查看Wi-Fi密码：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">security find-generic-password -wa &lt;span class="s1">&amp;#39;your wifi-ssid&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 230;
flex-basis: 554px"
>
&lt;a href="https://tab.deoops.com/posts/check-wifipassword/wifi.png" data-size="868x376">
&lt;img src="https://tab.deoops.com/posts/check-wifipassword/wifi.png"
width="868"
height="376"
srcset="https://tab.deoops.com/posts/check-wifipassword/wifi_hu66e9221b77a6acb1198c7195748bfb4f_66710_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/check-wifipassword/wifi_hu66e9221b77a6acb1198c7195748bfb4f_66710_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="macos dialogue">
&lt;/a>
&lt;figcaption>macos dialogue&lt;/figcaption>
&lt;/figure>
在弹出的系统对话框中输入正确的用户名和密码，终端即可以看到Wi-Fi密码。&lt;/p>
&lt;p>ps. 除了当前连接的Wi-Fi，系统所有保存过的Wi-Fi密码都可以通过&lt;code>security&lt;/code>命令查到。
&lt;figure
class="gallery-image"
style="
flex-grow: 128;
flex-basis: 308px"
>
&lt;a href="https://tab.deoops.com/posts/check-wifipassword/all-wifi.png" data-size="1302x1012">
&lt;img src="https://tab.deoops.com/posts/check-wifipassword/all-wifi.png"
width="1302"
height="1012"
srcset="https://tab.deoops.com/posts/check-wifipassword/all-wifi_hu1b8799fe9b8c9e0d590c4630ece7700f_262038_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/check-wifipassword/all-wifi_hu1b8799fe9b8c9e0d590c4630ece7700f_262038_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="macos all remember wifi list">
&lt;/a>
&lt;figcaption>macos all remember wifi list&lt;/figcaption>
&lt;/figure>&lt;/p></description></item><item><title> 重新安装macport</title><link>https://tab.deoops.com/posts/reinstall-macport/</link><pubDate>Mon, 29 Nov 2021 11:50:01 +0800</pubDate><guid>https://tab.deoops.com/posts/reinstall-macport/</guid><description>&lt;img src="https://tab.deoops.com/posts/reinstall-macport/sip.png" alt="Featured image of post  重新安装macport" />&lt;p>updated: 好像是因为我安装了&lt;code>ripgrep&lt;/code>所以会一直更新&lt;code>cargo-c&lt;/code>依赖。&lt;/p>
&lt;p>不知道为啥每次&lt;code>sudo port -v upgrade outdated &lt;/code>都会重新安装&lt;code>cargo-c&lt;/code>，
进而会安装编译&lt;code>rust&lt;/code>。 编译&lt;code>rust&lt;/code>很费时间和CPU风扇。&lt;/p>
&lt;p>所以我就卸载了&lt;code>rust&lt;/code>和一众依赖，后面特意又卸载了&lt;code>cargo-c&lt;/code>。但是每次&lt;code>upgrade outdated&lt;/code>
&lt;code>cargo-c&lt;/code>又回来了，很是烦人。 google一圈后，决定重新安装&lt;code>macport&lt;/code>&lt;/p>
&lt;h2 id="清理安装包">清理安装包&lt;/h2>
&lt;p>尝试&lt;a class="link" href="https://superuser.com/questions/165652/how-can-i-clean-up-my-macports-installation" target="_blank" rel="noopener"
>&lt;code>clean&lt;/code> 所有的&lt;/a>安装包：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo port uninstall cargo-c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo port -v selfupdate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo port -f clean --all all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf /opt/local/var/macports/packages/*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf /opt/local/var/macports/distfiles/*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf /opt/local/var/macports/build/*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">port &lt;span class="nb">echo&lt;/span> leaves
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo port uninstall leaves
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo port -f uninstall inactive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## SURPRISE! after upgrade, `cargo-c` come back.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo port upgrade outdated
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="卸载macport">卸载macport&lt;/h2>
&lt;p>参考&lt;a class="link" href="https://guide.macports.org/chunked/installing.macports.uninstalling.html" target="_blank" rel="noopener"
>官网协助&lt;/a>步骤：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo port -fp uninstall installed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo dscl . -delete /Users/macports
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo dscl . -delete /Groups/macports
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> /opt/local &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> /Applications/DarwinPorts &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> /Applications/MacPorts &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> /Library/LaunchDaemons/org.macports.* &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> /Library/Receipts/DarwinPorts*.pkg &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> /Library/Receipts/MacPorts*.pkg &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> /Library/StartupItems/DarwinPortsStartup &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> /Library/Tcl/darwinports1.0 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> /Library/Tcl/macports1.0 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> ~/.macports
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>最后一步报错了：这三个&lt;code>/opt/local&lt;/code>, &lt;code>/opt/local/var/db&lt;/code>, &lt;code>/opt/local/var/db/postgres&lt;/code>
目录无法删除。&lt;/p>
&lt;p>&lt;code>sudo su &lt;/code>切换为root还是报权限不足。&lt;/p>
&lt;h2 id="sip">SIP&lt;/h2>
&lt;p>查了一下是&lt;a class="link" href="https://superuser.com/questions/1049689/which-folders-are-affected-by-system-integrity-protection" target="_blank" rel="noopener"
>system integrity proction(SIP)&lt;/a>的原因&lt;/p>
&lt;h3 id="查看sip">查看SIP&lt;/h3>
&lt;h4 id="状态">状态&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ csrutil status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">System Integrity Protection status: enabled.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="查看用户httpsapplestackexchangecomquestions317576how-to-delete-macports-user-after-using-the-migration-assistant320714320714">查看&lt;a class="link" href="https://apple.stackexchange.com/questions/317576/how-to-delete-macports-user-after-using-the-migration-assistant/320714#320714" target="_blank" rel="noopener"
>用户&lt;/a>&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">dscl . list /Users &lt;span class="p">|&lt;/span> grep -v &lt;span class="s1">&amp;#39;^_&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">daemon
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Guest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mixelpix
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nobody
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="删除postgres">删除postgres&lt;/h3>
&lt;p>可以看到上面有postgres用户，所以删除&lt;code>postgres&lt;/code>之后，就可以删除&lt;code>/opt/local&lt;/code>目录了：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo dscl . -delete /Groups/postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo dscl . -delete /Users/postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf /opt/local
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>fish shell</title><link>https://tab.deoops.com/posts/try-fish/</link><pubDate>Fri, 26 Nov 2021 11:33:15 +0800</pubDate><guid>https://tab.deoops.com/posts/try-fish/</guid><description>&lt;img src="https://tab.deoops.com/posts/try-fish/fish.png" alt="Featured image of post fish shell" />&lt;p>今天在hacker news上闲逛，又看到有人推销&lt;code>fish&lt;/code>。心想马上就2022年了，不如换个shell耍耍。&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 134;
flex-basis: 323px"
>
&lt;a href="https://tab.deoops.com/posts/try-fish/hn-fish.png" data-size="1436x1066">
&lt;img src="https://tab.deoops.com/posts/try-fish/hn-fish.png"
width="1436"
height="1066"
srcset="https://tab.deoops.com/posts/try-fish/hn-fish_hufedcf2709999a125b54ea6d9eb6768c1_417931_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/try-fish/hn-fish_hufedcf2709999a125b54ea6d9eb6768c1_417931_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="fish shell topic on hackernews">
&lt;/a>
&lt;figcaption>fish shell topic on hackernews&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>其实早在2013年就接触过&lt;a class="link" href="https://fishshell.com/" target="_blank" rel="noopener"
>fish&lt;/a>，那个时候自己比较菜，工作的时候很多bash脚本在fish上都不能使用，所以就放弃fish。&lt;/p>
&lt;h2 id="安装">安装&lt;/h2>
&lt;p>安装fish&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo port install fish
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo chpass -s /opt/local/bin/fish &lt;span class="si">${&lt;/span>&lt;span class="nv">USER&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat /etc/shells
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>退出&lt;code>zsh&lt;/code>，重启&lt;code>terminal&lt;/code>&lt;/p>
&lt;h2 id="安装插件">安装插件&lt;/h2>
&lt;h3 id="oh-my-fish--fisher">oh-my-fish / fisher&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fish" data-lang="fish">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">curl&lt;/span> https://raw.githubusercontent.com/oh-my-&lt;span class="nb">fish&lt;/span>/oh-my-&lt;span class="nb">fish&lt;/span>/master/bin/install &lt;span class="o">&amp;gt;&lt;/span> install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">fish &lt;/span>install &lt;span class="na">--path&lt;/span>&lt;span class="o">=&lt;/span>~/.local/share/omf &lt;span class="na">--config&lt;/span>&lt;span class="o">=&lt;/span>~/.config/omf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 可能出现 https://git.io无法访问的问题
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">curl&lt;/span> &lt;span class="na">-sL&lt;/span> https://git.io/fisher &lt;span class="o">|&lt;/span> &lt;span class="nb">source&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nf">fisher&lt;/span> install jorgebucaran/fisher
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="autojump-j">autojump/ j&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fish" data-lang="fish">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">sudo&lt;/span> &lt;span class="nf">port&lt;/span> uninstall autojump
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">git&lt;/span> clone https://github.com/wting/autojump.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">cd&lt;/span> autojump/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./install.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">cd&lt;/span> repo/github/autojump/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">vi&lt;/span> .config/&lt;span class="nb">fish&lt;/span>/config.&lt;span class="nb">fish
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">&lt;/span>&lt;span class="nf">j&lt;/span> home
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="nvm">nvm&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fish" data-lang="fish">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">sudo&lt;/span> &lt;span class="nf">port&lt;/span> uninstall nvm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fisher&lt;/span> install jorgebucaran/nvm.&lt;span class="nb">fish
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">&lt;/span>&lt;span class="nf">nvm&lt;/span> install latest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">nvm&lt;/span> list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">nvm&lt;/span> &lt;span class="na">--version&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#nvm use v17.1.0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Now using Node v17.1.0 (npm 8.1.2) ~/.local/share/nvm/v17.1.0/bin/node
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">node&lt;/span> &lt;span class="na">--version&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="fisher-plugins">fisher plugins&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fish" data-lang="fish">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fisher&lt;/span> install IlanCosman/tide@v5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">fisher&lt;/span> install PatrickF1/fzf.&lt;span class="nb">fish
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">&lt;/span>&lt;span class="nf">fisher&lt;/span> install franciscolourenco/done
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="配置">配置&lt;/h2>
&lt;h3 id="path">PATH&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fish" data-lang="fish">&lt;span class="line">&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">$PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">fish_add_path&lt;/span> /Users/r/go/bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">fish_add_path&lt;/span> /opt/local/bin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="alias">alias&lt;/h3>
&lt;p>默认&lt;code>ls&lt;/code>命令对文件和目录没有做颜色的区分，可以使用&lt;code>alias ls='ls -G'&lt;/code>加上颜色选项:)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fish" data-lang="fish">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ~/.config/fish/config.fish
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#starship init fish | source
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="k">test&lt;/span> &lt;span class="na">-f&lt;/span> /Users/r/.autojump/share/autojump/autojump.&lt;span class="nb">fish&lt;/span>&lt;span class="p">;&lt;/span> . /Users/r/.autojump/share/autojump/autojump.&lt;span class="nb">fish&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">set&lt;/span> &lt;span class="na">--local&lt;/span> &lt;span class="nv">AUTOJUMP_PATH&lt;/span> &lt;span class="nv">$HOME&lt;/span>/.autojump/share/autojump/autojump.&lt;span class="nb">fish
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb"> &lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="k">test&lt;/span> &lt;span class="na">-e&lt;/span> &lt;span class="nv">$AUTOJUMP_PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">source&lt;/span> &lt;span class="nv">$AUTOJUMP_PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">alias &lt;/span>&lt;span class="nv">ls&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;ls -G&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">alias &lt;/span>&lt;span class="nv">yaegi&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;rlwrap yaegi&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">#alias swagger=&amp;#34;docker run --rm -it -e GOPATH=$HOME/go:/go -v $HOME:$HOME -w $(pwd) quay.io/goswagger/swagger&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span> &lt;span class="nb">alias &lt;/span>&lt;span class="nv">kks&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;kubectl -n kube-system &amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">alias &lt;/span>&lt;span class="nv">kku&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;kubectl -n wu &amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">alias &lt;/span>&lt;span class="nv">kkl&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;kubectl -n location &amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">alias &lt;/span>&lt;span class="nv">pt&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;git push &amp;amp;&amp;amp; git push --tags&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">alias &lt;/span>&lt;span class="nv">vi&lt;/span>&lt;span class="o">=&lt;/span>nvim
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">alias &lt;/span>&lt;span class="nv">vim&lt;/span>&lt;span class="o">=&lt;/span>nvim
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c"># alias code=nvim
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span> &lt;span class="nb">alias &lt;/span>&lt;span class="nv">t&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;tmux -u&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c"># alias docker_prune=&amp;#34;docker rmi `docker images -f &amp;#39;dangling=true&amp;#39; -q`&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span> &lt;span class="c"># alias docker_prune=&amp;#34;docker system prune&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span> &lt;span class="nb">alias &lt;/span>&lt;span class="nv">chrome&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">set&lt;/span> &lt;span class="na">--universal&lt;/span> &lt;span class="nv">nvm_default_version&lt;/span> v17.&lt;span class="m">3&lt;/span>.&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>clickhouse初始化</title><link>https://tab.deoops.com/posts/clickhouse-start/</link><pubDate>Mon, 22 Nov 2021 18:39:03 +0800</pubDate><guid>https://tab.deoops.com/posts/clickhouse-start/</guid><description>&lt;img src="https://tab.deoops.com/posts/clickhouse-start/clickhouse.jpeg" alt="Featured image of post clickhouse初始化" />&lt;p>总体来看&lt;code>clickhouse&lt;/code>的&lt;code>ddl&lt;/code>操作方式和&lt;code>mysql&lt;/code>很像。比如&lt;code>use database_name&lt;/code>， &lt;code>create user ... identified by ''&lt;/code>等。&lt;/p>
&lt;h2 id="server">server&lt;/h2>
&lt;h3 id="docker-run">docker run&lt;/h3>
&lt;p>启动clickhouse服务：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">docker run -d --name clickhouse-server -p 8123:8123 -p 9000:9000 --ulimit &lt;span class="nv">nofile&lt;/span>&lt;span class="o">=&lt;/span>262144:262144 yandex/clickhouse-server:21.8.10.19
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="default-user权限">default user权限&lt;/h3>
&lt;p>默认defualt 用户不能添加新的用户，需要修改default权限，否则会报错&lt;code>Code: 497. DB::Exception: Received from localhost:9000. DB::Exception: default: Not enough privileges. To execute this query it's necessary to have the grant CREATE USER ON *.*. &lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">exec&lt;/span> -it clickhouse-server bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apt update -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apt install vim
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /etc/clickhouse-server/users.xml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update &amp;lt;access_management&amp;gt;1&amp;lt;/access_management&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker restart clickhouse-server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 227;
flex-basis: 545px"
>
&lt;a href="https://tab.deoops.com/posts/clickhouse-start/default.png" data-size="1550x682">
&lt;img src="https://tab.deoops.com/posts/clickhouse-start/default.png"
width="1550"
height="682"
srcset="https://tab.deoops.com/posts/clickhouse-start/default_hu801c8cfdfea5b55e3cf77a27138605f8_217042_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/clickhouse-start/default_hu801c8cfdfea5b55e3cf77a27138605f8_217042_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="access management for default user">
&lt;/a>
&lt;figcaption>access management for default user&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="client">client&lt;/h2>
&lt;h3 id="docker-run-client">docker run client&lt;/h3>
&lt;p>启动clickhouse client，添加用户和数据库：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">docker run -it --rm --link clickhouse-server:clickhouse-server yandex/clickhouse-client --host clickhouse-server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## create database&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fd87688bfa29 :&lt;span class="o">)&lt;/span> create database blc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CREATE DATABASE blc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Query id: 19562cda-a1e7-46f9-a3c2-03dec173e15b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Ok.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> rows in set. Elapsed: 0.009 sec.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fd87688bfa29 :&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## create user&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fd87688bfa29 :&lt;span class="o">)&lt;/span> create user abc IDENTIFIED by &lt;span class="s1">&amp;#39;ssss&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CREATE USER abc IDENTIFIED WITH sha256_hash BY &lt;span class="s1">&amp;#39;28E51044F4A9CBAE2BBD3D8A9D8C902AD1455D42208277AC4A913B003038A3DC&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Query id: ee533fe8-7d66-428a-bbde-89d0a4d15924
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Ok.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> rows in set. Elapsed: 0.002 sec.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## grant &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fd87688bfa29 :&lt;span class="o">)&lt;/span> GRANT ALL PRIVILEGES ON blc. * TO abc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">GRANT SHOW, SELECT, INSERT, ALTER, CREATE DATABASE, CREATE TABLE, CREATE VIEW, CREATE DICTIONARY, CREATE FUNCTION, DROP, TRUNCATE, OPTIMIZE, SYSTEM MERGES, SYSTEM TTL MERGES, SYSTEM FETCHES, SYSTEM MOVES, SYSTEM SENDS, SYSTEM REPLICATION QUEUES, SYSTEM DROP REPLICA, SYSTEM SYNC REPLICA, SYSTEM RESTART REPLICA, SYSTEM RESTORE REPLICA, SYSTEM FLUSH DISTRIBUTED, dictGet ON blc.* TO abc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Query id: cd09b798-f7e0-45f7-8511-9914de75238c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Ok.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> rows in set. Elapsed: 0.002 sec.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fd87688bfa29 :&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="sdk">sdk&lt;/h2>
&lt;h3 id="connect-from-golang-client">connect from golang client&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">db&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;database/sql&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span> &lt;span class="s">&amp;#34;github.com/ClickHouse/clickhouse-go&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">globalDB&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Init open connection to clickhouse and check a ping cmd.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// url: &amp;#39;tcp://localhost:9000?debug=true&amp;amp;username=abc&amp;amp;password=ssss&amp;amp;database=blc&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">url&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">connect&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">sql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;clickhouse&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">url&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">connect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ping&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">globalDB&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">connect&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">connect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Start create tables if not exists.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">Start&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nf">createTables&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>用户线程调度模型</title><link>https://tab.deoops.com/posts/go-scheduler/</link><pubDate>Fri, 19 Nov 2021 14:44:20 +0800</pubDate><guid>https://tab.deoops.com/posts/go-scheduler/</guid><description>&lt;img src="https://tab.deoops.com/posts/go-scheduler/go-scheduler.png" alt="Featured image of post 用户线程调度模型" />&lt;p>一般来说多线程3种并发模型：&lt;/p>
&lt;ol>
&lt;li>N:1， 把n个用户线程（Green threed）映射到一个操作系统的线程（OS Threed）上。&lt;/li>
&lt;/ol>
&lt;p>这种模型的优点是 用户线程之间的上下文切换（context switch）会非常快，
缺点是不能充分的运用多核CPU资源（一个OS Thread只能在一个CPU上）；
2. 1:1， 每个用户线程映射到一个操作系统线程上。&lt;/p>
&lt;p>这种和第一种的优缺点正好相反。1:1 可以充分利用多核处理器资源，但是上下文切换很慢。&lt;/p>
&lt;ol start="3">
&lt;li>M:N，把M个用户线程映射到N个操作系统线程上。&lt;/li>
&lt;/ol>
&lt;p>这种结合了前面两种模型的优点，同时规避了他们的缺点。&lt;/p>
&lt;h2 id="mgp">M/G/P&lt;/h2>
&lt;p>golang runtime主要通过抽象出Machine/Processor/Groutine三种对象，和一些算法(steal)实现了M:N模型。&lt;/p>
&lt;h3 id="machine">Machine&lt;/h3>
&lt;p>M对应操作系统线程，代表被操作系统管理的线程资源。&lt;/p>
&lt;h3 id="goroutine">Goroutine&lt;/h3>
&lt;p>G对应用户线程（Goroutine），包含了stack，&lt;code>指令指针&lt;/code>，还有一些会影响这个Goroutine调度的关键信息，比如有关的channel。&lt;/p>
&lt;h3 id="processor">Processor&lt;/h3>
&lt;p>P对应本地逻辑调度器上下文（context），是调度算法具体的执行对象，主要用来处理&lt;code>steal&lt;/code>和&lt;code>hand-off&lt;/code>等算法。&lt;/p>
&lt;h2 id="demo">demo&lt;/h2>
&lt;h3 id="normal">normal&lt;/h3>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 102;
flex-basis: 245px"
>
&lt;a href="https://tab.deoops.com/posts/go-scheduler/in-motion.jpeg" data-size="400x391">
&lt;img src="https://tab.deoops.com/posts/go-scheduler/in-motion.jpeg"
width="400"
height="391"
srcset="https://tab.deoops.com/posts/go-scheduler/in-motion_hu66b0699a4d4006020605c239340bcbd0_15905_480x0_resize_q75_box.jpeg 480w, https://tab.deoops.com/posts/go-scheduler/in-motion_hu66b0699a4d4006020605c239340bcbd0_15905_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
alt="Machine Processor Groutine demo">
&lt;/a>
&lt;figcaption>Machine Processor Groutine demo&lt;/figcaption>
&lt;/figure>
上图中，我们有2个M(OS Thread)，每个M都有一个本地的context（P），都在运行一个goroutine（G）。&lt;/p>
&lt;p>有几点需要说明一下：&lt;/p>
&lt;ol>
&lt;li>M&lt;strong>必须&lt;/strong>得到一个P&lt;strong>才能&lt;/strong>运行goroutine里面的指令；&lt;/li>
&lt;li>P的数量等于环境变量&lt;code>GOMAXPROCS&lt;/code>的值， 一般等于宿主机的处理器核心数；&lt;/li>
&lt;li>灰色的goroutine没有在&lt;code>running&lt;/code>，但是已经准备好被调度了。他们所处的队列叫&lt;code>runqueues&lt;/code>，每当执行的&lt;code>go statement&lt;/code>指令时，新的goroutine就会加到runqueue的尾部；&lt;/li>
&lt;li>每个P都有自己本地runqueue。&lt;/li>
&lt;/ol>
&lt;h3 id="syscall--hand-off">(sys)call / hand-off&lt;/h3>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 137;
flex-basis: 330px"
>
&lt;a href="https://tab.deoops.com/posts/go-scheduler/syscall.jpeg" data-size="550x400">
&lt;img src="https://tab.deoops.com/posts/go-scheduler/syscall.jpeg"
width="550"
height="400"
srcset="https://tab.deoops.com/posts/go-scheduler/syscall_hu71699ffe4298f5dd3b241a2b684b0eae_17678_480x0_resize_q75_box.jpeg 480w, https://tab.deoops.com/posts/go-scheduler/syscall_hu71699ffe4298f5dd3b241a2b684b0eae_17678_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
alt="syscall demo">
&lt;/a>
&lt;figcaption>syscall demo&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;code>M0&lt;/code>把自己的context给了&lt;code>M1&lt;/code>，流程是这样的：&lt;/p>
&lt;ol>
&lt;li>M0执行G0上的某条&lt;code>syscall&lt;/code>指令；&lt;/li>
&lt;li>M0放弃P进入block状态，M1得到并继续执行P调度算法，可能去执行另外某一个goroutine；&lt;/li>
&lt;li>&lt;code>syscall&lt;/code>返回，M0因为没有P所以不能继续执行G0。现在M0需要去偷一个P执行G0，否则就把G0放到&lt;code>global runqueue&lt;/code>里面然后把自己放回thread cahe去sleep。&lt;/li>
&lt;/ol>
&lt;p>也有几点需要单独说明：&lt;/p>
&lt;ol>
&lt;li>M1可能是scheduler为了处理syscall特意创建的，也可能是来自&lt;code>thread cache&lt;/code>；&lt;/li>
&lt;li>当P本地的runqueue为空时，P会从&lt;code>global runqueue&lt;/code>拉取G；即使本地runqueue没有空，P也会定期的检查&lt;code>global runqueue&lt;/code>里的goroutine。&lt;/li>
&lt;li>正是因为要处理&lt;code>syscal/hand-off&lt;/code>，所以即使GOMAXPROCS等于1，Go还是会启动多个OS线程。&lt;/li>
&lt;/ol>
&lt;h3 id="stealing-work">stealing work&lt;/h3>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 137;
flex-basis: 330px"
>
&lt;a href="https://tab.deoops.com/posts/go-scheduler/steal.jpeg" data-size="550x400">
&lt;img src="https://tab.deoops.com/posts/go-scheduler/steal.jpeg"
width="550"
height="400"
srcset="https://tab.deoops.com/posts/go-scheduler/steal_hu803057213e7fa552581c1059eddb0e8c_17446_480x0_resize_q75_box.jpeg 480w, https://tab.deoops.com/posts/go-scheduler/steal_hu803057213e7fa552581c1059eddb0e8c_17446_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
alt="steal work/goroutine demo">
&lt;/a>
&lt;figcaption>steal work/goroutine demo&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>当P自己本地的runqueue空了，而且global runqueue也是空的时候，
P就会去其他P偷掉对方一半的G，从而使得自己和其它P都能高效工作，提高整体性能。&lt;/p>
&lt;p>&lt;a class="link" href="https://morsmachine.dk/go-scheduler" target="_blank" rel="noopener"
>参考文档&lt;/a>&lt;/p></description></item><item><title>纸巾和盆栽</title><link>https://tab.deoops.com/posts/tissue-flower/</link><pubDate>Fri, 19 Nov 2021 09:53:25 +0800</pubDate><guid>https://tab.deoops.com/posts/tissue-flower/</guid><description>&lt;img src="https://tab.deoops.com/posts/tissue-flower/flower.jpeg" alt="Featured image of post 纸巾和盆栽" />&lt;p>月初的时候同事抱怨公司没有纸巾了，有点儿不方便。
八卦一阵后，原来是说上个月团建超预算了，下个月才有经费采购纸巾。估计还要等20多天。&lt;/p>
&lt;p>慢慢的大家的纸巾都用完了，私下的抱怨也越来越多。&lt;/p>
&lt;p>到了月中也就不怎么抱怨了，毕竟才几块钱的东西，大家基本上都自己买了。&lt;/p>
&lt;p>本来事情很简单过去了。不想前几天公司的老大在办公室逛的时候说了一句，&lt;code>这些盆栽有的已经枯了，要找人修一修了&lt;/code>。&lt;/p>
&lt;p>然后今天办公室的盆栽就都换新了:
&lt;figure
class="gallery-image"
style="
flex-grow: 133;
flex-basis: 319px"
>
&lt;a href="https://tab.deoops.com/posts/tissue-flower/plants.jpeg" data-size="2216x1664">
&lt;img src="https://tab.deoops.com/posts/tissue-flower/plants.jpeg"
width="2216"
height="1664"
srcset="https://tab.deoops.com/posts/tissue-flower/plants_hu35fc5cd3eb5d91108373340cc98977a4_493896_480x0_resize_q75_box.jpeg 480w, https://tab.deoops.com/posts/tissue-flower/plants_hu35fc5cd3eb5d91108373340cc98977a4_493896_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
alt="beautiful potted plants">
&lt;/a>
&lt;figcaption>beautiful potted plants&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>有一说一，这些盆栽挺漂亮的。&lt;/p>
&lt;p>不过公司要是能把没有纸巾的问题解决了，赏花的时候心里会更舒服些，不要&lt;strong>辜负&lt;/strong>了绿油油漂亮的盆栽。&lt;/p>
&lt;p>ps. 我也不敢提纸巾的时候，忍一忍就过去了哈。
pps. 下午接到通知，大老板要从上海过来。公司还请了保洁阿姨搞卫生。可能是特批了一笔经费吧。&lt;/p></description></item><item><title>循环播放gif图片</title><link>https://tab.deoops.com/posts/gif-loop/</link><pubDate>Thu, 18 Nov 2021 17:23:48 +0800</pubDate><guid>https://tab.deoops.com/posts/gif-loop/</guid><description>&lt;img src="https://tab.deoops.com/posts/gif-loop/deja-vu-brain-injury.jpeg" alt="Featured image of post 循环播放gif图片" />&lt;h2 id="install">install&lt;/h2>
&lt;p>首先使用&lt;code>macport&lt;/code>安装 &lt;code>imagemagick&lt;/code>软件包，因为macport是编译安装软件包，所以安装过程会比较久（~9min）。
更加习惯homebrew的可以参考 &lt;a class="link" href="https://imagemagick.org/script/download.php#macosx" target="_blank" rel="noopener"
>官网imagemagick download&lt;/a> 安装。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ sudo port install imagemagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Password:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Computing dependencies &lt;span class="k">for&lt;/span> ImageMagickWarning: cltversion: The Command Line Tools are installed, but MacPorts cannot determine the version.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Warning: cltversion: For a possible fix, please see: https://trac.macports.org/wiki/ProblemHotlist#reinstall-clt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The following dependencies will be installed:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> aom
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> brotli
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Activating webp @1.2.1_0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Cleaning webp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Fetching archive &lt;span class="k">for&lt;/span> ImageMagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Attempting to fetch ImageMagick-6.9.11-60_1+x11.darwin_21.x86_64.tbz2 from https://packages.macports.org/ImageMagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Attempting to fetch ImageMagick-6.9.11-60_1+x11.darwin_21.x86_64.tbz2 from https://pek.cn.packages.macports.org/macports/packages/ImageMagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Attempting to fetch ImageMagick-6.9.11-60_1+x11.darwin_21.x86_64.tbz2 from https://kmq.jp.packages.macports.org/ImageMagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Fetching distfiles &lt;span class="k">for&lt;/span> ImageMagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Attempting to fetch ImageMagick-6.9.11-60.tar.xz from https://distfiles.macports.org/ImageMagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Verifying checksums &lt;span class="k">for&lt;/span> ImageMagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Extracting ImageMagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Configuring ImageMagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Building ImageMagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Staging ImageMagick into destroot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Installing ImageMagick @6.9.11-60_1+x11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Activating ImageMagick @6.9.11-60_1+x11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Cleaning ImageMagick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Updating database of binaries
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Scanning binaries &lt;span class="k">for&lt;/span> linking errors
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; No broken files found.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; No broken ports found.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">~ took 8m49s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="convert">convert&lt;/h2>
&lt;p>修改gif循环次数，当&lt;code>loop为0&lt;/code>时则关闭了gif的循环播放。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># convert -h | grep loop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># -loop iterations add Netscape loop extension to your GIF animation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">convert -loop &lt;span class="m">1000&lt;/span> dog.gif bad_dog.gif
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>换行符</title><link>https://tab.deoops.com/posts/carrier-return/</link><pubDate>Wed, 17 Nov 2021 14:58:30 +0800</pubDate><guid>https://tab.deoops.com/posts/carrier-return/</guid><description>&lt;img src="https://tab.deoops.com/posts/carrier-return/line-feed.jpeg" alt="Featured image of post 换行符" />&lt;p>换行符&lt;code>\r\n&lt;/code>和&lt;code>\n&lt;/code>的关系和区别可以追溯到60年前，打字机广泛被使用的时代。&lt;/p>
&lt;p>在打字机还刚刚被发明的时候，人们输入完一行字之后，需要两个动作才能开始输入下一行的内容。&lt;/p>
&lt;p>滚动滚轮，让纸张往上移动一行， 即是 &lt;code>\n&lt;/code> 操作；
移动 打字的指针到 行首， 即是&lt;code>\r&lt;/code> 。
上面两个操作没有顺序的要求， 1-&amp;gt;2 ; 2-&amp;gt;1 都可以。&lt;/p>
&lt;h3 id="windows">windows&lt;/h3>
&lt;p>Windows 操作系统 的文本对 new line的 编码 使用的是 2-&amp;gt;1 的 组合操作;&lt;/p>
&lt;h3 id="unix">unix&lt;/h3>
&lt;p>Linux/Unix 操作系统 则只使用操作 1 。&lt;/p>
&lt;blockquote>
&lt;p>A line feed means moving one line forward. The code is &lt;code>\n&lt;/code>.
A carriage return means moving the cursor to the beginning of the line. The code is &lt;code>\r&lt;/code>.
Windows editors often still use the combination of both as &lt;code>\r\n&lt;/code> in text files. Unix uses mostly only the &lt;code>\n&lt;/code>.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>The separation comes from typewriter times, when you turned the wheel to move the paper to change the line and moved the carriage to restart typing on the beginning of a line. This was two steps&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a class="link" href="https://stackoverflow.com/questions/12747722/what-is-the-difference-between-a-line-feed-and-a-carriage-return" target="_blank" rel="noopener"
>参考：What is the difference between a “line feed” and a “carriage return”&lt;/a>
&lt;figure
class="gallery-image"
style="
flex-grow: 125;
flex-basis: 300px"
>
&lt;a href="https://tab.deoops.com/posts/carrier-return/left-side.png" data-size="1000x800">
&lt;img src="https://tab.deoops.com/posts/carrier-return/left-side.png"
width="1000"
height="800"
srcset="https://tab.deoops.com/posts/carrier-return/left-side_hud4506dd4606452c9e6d5d0a0120cf9da_1237959_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/carrier-return/left-side_hud4506dd4606452c9e6d5d0a0120cf9da_1237959_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="left side of typewriter">
&lt;/a>
&lt;figcaption>left side of typewriter&lt;/figcaption>
&lt;/figure>&lt;/p></description></item><item><title>bash简介</title><link>https://tab.deoops.com/posts/bash-command/</link><pubDate>Wed, 17 Nov 2021 10:06:54 +0800</pubDate><guid>https://tab.deoops.com/posts/bash-command/</guid><description>&lt;img src="https://tab.deoops.com/posts/bash-command/terminal.jpeg" alt="Featured image of post bash简介" />&lt;p>本文会不定期更新 :)&lt;/p>
&lt;h2 id="set">set&lt;/h2>
&lt;p>可以使用set命令改变shell脚本默认的执行流程。
比如 &lt;code>set -e&lt;/code> 可以使得shell脚本遇到某一条命令出错（ &lt;code>echo $?&lt;/code> 不为0）时立即退出执行。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#/bin/bash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> -e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> you cannot see me, unless you comment out the &lt;span class="s1">&amp;#39;set -e&amp;#39;&lt;/span> flag, haha
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a class="link" href="https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html" target="_blank" rel="noopener"
>set详细文档&lt;/a>&lt;/p>
&lt;h2 id="du">du&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ du -sh Downloads
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4.1G Downloads
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a class="link" href="http://zh.wikipedia.org/wiki/Du_%28Unix%29" target="_blank" rel="noopener"
>wiki&lt;/a>&lt;/p>
&lt;h2 id="rm">rm&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rm &lt;span class="nv">$0&lt;/span> &lt;span class="c1"># 删除当前文件 for cleanup&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="job">job&lt;/h2>
&lt;h3 id="nohup">nohup&lt;/h3>
&lt;p>在后台执行当前命令：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nohup /usr/sbin/script.sh &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>默认情况下，进程是前台进程，这时就把Shell给占据了，我们无法进行其他操作，对于那些没有交互的进程，
我们希望将其在后台启动，可以在启动参数的时候加一个&amp;rsquo;&amp;amp;&amp;lsquo;实现这个目的。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ sleep &lt;span class="m">5&lt;/span> &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span> &lt;span class="m">34769&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">✦ ❯
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span> + &lt;span class="m">34769&lt;/span> &lt;span class="k">done&lt;/span> sleep &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">✦ ❯
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>进程切换到后台的时候，我们把它称为job。切换到后台时会输出相关job信息，上面&amp;amp;的输出 [1] 34769 ：
[1]表示job ID 是1,11319表示进程ID是34769。切换到后台的进程，仍然可以用ps命令查看。&lt;/p>
&lt;h3 id="fgbg-suspended">fg/bg suspended&lt;/h3>
&lt;p>可以通过bg &lt;!-- raw HTML omitted -->（background）和fg&lt;!-- raw HTML omitted -->（foreground）命令将其在前后台间状态切换。
可以使用&lt;!-- raw HTML omitted -->+z 组合键把当前fg的进程挂起:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">Source changed &lt;span class="s2">&amp;#34;/Users/r/datewu.github.io/content/posts/bash-command/index.md&amp;#34;&lt;/span>: WRITE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Total in &lt;span class="m">15&lt;/span> ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">^Z
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span> + &lt;span class="m">3595&lt;/span> suspended hugo server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意，挂起的进程会暂停运行。需要再执行bg/fg命令才能继续运行：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">datewu.github.io on  main &lt;span class="o">[&lt;/span>!?&lt;span class="o">]&lt;/span> took 7m41s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">✦ ❯ &lt;span class="nb">bg&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span> + &lt;span class="m">3595&lt;/span> continued hugo server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>同样的，bg之后执行fg命令就可以把job重新分配到当前的shell了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">datewu.github.io on  main &lt;span class="o">[&lt;/span>!?&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">✦ ❯ ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Makefile Readme.md archetypes config.yaml content data layouts resources static themes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">datewu.github.io on  main &lt;span class="o">[&lt;/span>!?&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">✦ ❯ &lt;span class="nb">fg&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span> + &lt;span class="m">3595&lt;/span> running hugo server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="守护进程">守护进程&lt;/h2>
&lt;p>如果一个进程永远都是以后台方式启动，并且不能受到Shell退出影响而退出，一个正统的做法是将其创建为守护进程。
守护进程值得是系统长期运行的后台进程，类似Windows服务。守护进程信息通过ps –a无法查看到，需要用到–x参数。
当查看守护进程时，往往还附上-j参数以查看作业控制信息，其中TPGID一栏为-1就是守护进程。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root ~ ps xj
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PPID PID PGID SID TTY TPGID STAT UID TIME COMMAND
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">953&lt;/span> &lt;span class="m">1190&lt;/span> &lt;span class="m">1190&lt;/span> &lt;span class="m">1190&lt;/span> ? -1 Ss &lt;span class="m">1000&lt;/span> 0:00 /bin/sh /usr/bin/startkde
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">1490&lt;/span> &lt;span class="m">1482&lt;/span> &lt;span class="m">1482&lt;/span> ? -1 Sl &lt;span class="m">1000&lt;/span> 0:00 /usr/bin/VBoxClient –seamless
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">1491&lt;/span> &lt;span class="m">1477&lt;/span> &lt;span class="m">1477&lt;/span> ? -1 Sl &lt;span class="m">1000&lt;/span> 0:00 /usr/bin/VBoxClient –display
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>创建守护进程最关键的一步是调用setsid函数创建一个新的Session，并成为Session Leader。
成功创建守护进程的流程为：&lt;/p>
&lt;ol>
&lt;li>创建一个新的Session，当前进程成为Seesion Leader， 当前进程的id就是Session id；&lt;/li>
&lt;li>创建一个新的进程组，当前进程成为进程组的Leader， 当前进程的id就是进程组的id；&lt;/li>
&lt;li>如果当前进程原本有一个控制终端，则它会失去这个shell，成为一个没有shell的进程（即守护进程）。&lt;/li>
&lt;/ol>
&lt;p>可以使用的命令有 &lt;code>disown setsid nohup&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ tldr &lt;span class="nb">disown&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Command &lt;span class="nb">disown&lt;/span> does not exist &lt;span class="k">for&lt;/span> the host platform. Displaying the page from linux platform
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">disown&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Allow sub-processes to live beyond the shell that they are attached to.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> See also the &lt;span class="nb">jobs&lt;/span> command.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> More information: https://www.gnu.org/software/bash/manual/bash.html#index-disown.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Disown the current job:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">disown&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Disown a specific job:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">disown&lt;/span> %job_number
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Disown all jobs:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">disown&lt;/span> -a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Keep job &lt;span class="o">(&lt;/span>&lt;span class="k">do&lt;/span> not &lt;span class="nb">disown&lt;/span> it&lt;span class="o">)&lt;/span>, but mark it so that no future SIGHUP is received on shell exit:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">disown&lt;/span> -h %job_number
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">See also: &lt;span class="nb">jobs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">~
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">❯ man setsid &lt;span class="p">|&lt;/span> head
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SETSID&lt;span class="o">(&lt;/span>2&lt;span class="o">)&lt;/span> System Calls Manual SETSID&lt;span class="o">(&lt;/span>2&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> setsid – create session and &lt;span class="nb">set&lt;/span> process group ID
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SYNOPSIS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#include &amp;lt;unistd.h&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pid_t
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> setsid&lt;span class="o">(&lt;/span>void&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="exit">exit&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#/bin/bash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">exit&lt;span class="o">(&lt;/span>0&lt;span class="o">)&lt;/span> &lt;span class="c1">#脚本/命令正常退出&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">exit&lt;span class="o">(&lt;/span>1&lt;span class="o">)&lt;/span> &lt;span class="c1"># 脚本/命令异常退出&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="--">$? &amp;amp;&amp;amp; ||&lt;/h2>
&lt;p>shell 在执行某个命令的时候，会返回一个返回值，该返回值保存在 shell 变量 $? 中。
当 $? == 0 时，表示执行成功；当 $? == 1 时（非0返回值，一般在0-255间），表示执行失败。
shell 提供了 &amp;amp;&amp;amp; 和 || 来实现命令执行flow控制的功能，shell 将根据 &amp;amp;&amp;amp; 或 || 前面命令的返回值来选择执行后续命令。&lt;/p>
&lt;h3 id="heading">&amp;amp;&amp;amp;&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">command1 &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> command2 &lt;span class="o">[&amp;amp;&amp;amp;&lt;/span> command3 ...&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>命令之间使用&lt;code>&amp;amp;&amp;amp;&lt;/code>连接，实现逻辑与的功能；&lt;/li>
&lt;li>只有在 &lt;code>&amp;amp;&amp;amp;&lt;/code> 左边的命令返回真（命令返回值 &lt;code>$? == 0&lt;/code>），&amp;amp;&amp;amp; 右边的命令才会被执行；&lt;/li>
&lt;li>只要有一个命令返回假（命令返回值 &lt;code>$? == 1&lt;/code>），后面的命令就不会被执行。 即是短路的功能。&lt;/li>
&lt;/ol>
&lt;h3 id="heading-1">||&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">command1 &lt;span class="o">||&lt;/span> command2 &lt;span class="o">[||&lt;/span> command3 ...&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>命令之间使用 &lt;code>||&lt;/code> 连接，实现 逻辑或的功能；&lt;/li>
&lt;li>只有在&lt;code>||&lt;/code>左边的命令返回假（命令返回值 &lt;code>$? == 1&lt;/code>），&lt;code>||&lt;/code> 右边的命令才会被执行。这和 c 语言中的逻辑或语法功能相同，即实现defult赋值操作；&lt;/li>
&lt;li>只要有一个命令返回真（命令返回值 &lt;code>$? == 0&lt;/code>），后面的命令就不会被执行。&lt;/li>
&lt;/ol>
&lt;h2 id="heading-2">$&lt;/h2>
&lt;p>shell语句变量无需声明，需要引用变量指时， 在变量名前添加$符号即可（有时需要配合括号消除歧义）:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">var&lt;/span>&lt;span class="o">=&lt;/span>hellhttp://sdf.com?uid&lt;span class="o">=&lt;/span>233&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="nv">pwd&lt;/span>&lt;span class="o">=&lt;/span>ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> var &lt;span class="c1"># var&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$var&lt;/span> &lt;span class="c1"># hellhttp://sdf.com?uid=233&amp;amp;pwd=ls&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">va&lt;/span>&lt;span class="o">=&lt;/span>he
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$valloworld&lt;/span> &lt;span class="c1"># 无输出，因为没有valloworld变量&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">va&lt;/span>&lt;span class="si">}&lt;/span>lloworld &lt;span class="c1"># hellworld&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="heading-3">$()&lt;/h3>
&lt;p>先执行括号里面的shell命令，然后把括号里面shell命令的输出做为新的命令去执行。
也可以使用泛引号``。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ &lt;span class="nb">echo&lt;/span> ls &amp;gt; abc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">~/codebase
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">❯ &lt;span class="k">$(&lt;/span>less abc&lt;span class="k">)&lt;/span> &lt;span class="c1"># same as `less abc`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">abc gobookIread jsbook lol playaround
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">~/codebase
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">❯ &lt;span class="k">$(&lt;/span>cat abc&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">abc gobookIread jsbook lol playaround
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">~/codebase
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">❯ &lt;span class="k">$(&lt;/span>ls&lt;span class="k">)&lt;/span> &lt;span class="c1"># same as `ls`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zsh: &lt;span class="nb">command&lt;/span> not found: abc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">❯ &lt;span class="nb">echo&lt;/span> &lt;span class="sb">`&lt;/span>date&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2021年11月17日 星期三 11时58分02秒 CST
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">~
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">❯ &lt;span class="nb">echo&lt;/span> &lt;span class="k">$(&lt;/span>date&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2021年11月17日 星期三 11时58分10秒 CST
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="wget">wget&lt;/h2>
&lt;p>http basic auth&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">wget --no-check-certificate --user user --password pass https://server_address/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="curl">curl&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">curl -I google.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -i google.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Post json file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -vX POST http://localhost:9095/post -d @t.json -H &lt;span class="s2">&amp;#34;Content-Type: application/json&amp;#34;&lt;/span> -H &lt;span class="s1">&amp;#39;Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIiwiaWF0IjoxNTUxNDEyODY2LCJleHAiOjE1NTIwMTc2NjZ9.V6ZT8L_r_arIlxtRHul-FxKt4exErTkvNdYy7O_cR5A&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="argument">argument&lt;/h2>
&lt;h3 id="default-argument">default argument&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/local/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;begin&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">date
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">duration&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">1&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="s2">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="c1"># default 3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sleep &lt;span class="nv">$duration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;finish&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">date
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#begin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#2021年11月17日 星期三 12时05分52秒 CST&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#finish&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#2021年11月17日 星期三 12时05分55秒 CST&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#~ took 3s &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="loop">loop&lt;/h2>
&lt;p>bash 提供 for和while两种循环控制&lt;/p>
&lt;h3 id="for">for&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># for in &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> i in abc.s&lt;span class="o">{&lt;/span>1..1000&lt;span class="o">}&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># for arguments&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./for.sh x y z sdf&lt;span class="o">{&lt;/span>1..4&lt;span class="o">}&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">9&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#for a; do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># echo $a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="while-read">while (read)&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="nb">read&lt;/span> -r h&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -n &lt;span class="nv">$h&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#❯ bash read-pwds.sh &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#abcde&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#abcdexyz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#xyz% &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="macos">macos&lt;/h2>
&lt;h3 id="osascript">osascript&lt;/h3>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 312;
flex-basis: 749px"
>
&lt;a href="https://tab.deoops.com/posts/bash-command/mac.png" data-size="868x278">
&lt;img src="https://tab.deoops.com/posts/bash-command/mac.png"
width="868"
height="278"
srcset="https://tab.deoops.com/posts/bash-command/mac_hu5339105ebcd044e0ab56fca4fb90c867_103215_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/bash-command/mac_hu5339105ebcd044e0ab56fca4fb90c867_103215_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="macos osascript notification">
&lt;/a>
&lt;figcaption>macos osascript notification&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># must use sh for `at` command&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#!/usr/bin/osascript&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#display notification &amp;#34;Lorem ipsum dolor sit amet&amp;#34; with title &amp;#34;Title&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https://apple.stackexchange.com/questions/57412/how-can-i-trigger-a-notification-center-notification-from-an-applescript-or-shel/115373#115373&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">osascript -e &lt;span class="s1">&amp;#39;display notification &amp;#34;吃武汉热干面啦&amp;#34; with title &amp;#34;米西米西&amp;#34; &amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>清理git submodule</title><link>https://tab.deoops.com/posts/git-submodule/</link><pubDate>Tue, 16 Nov 2021 16:13:57 +0800</pubDate><guid>https://tab.deoops.com/posts/git-submodule/</guid><description>&lt;img src="https://tab.deoops.com/posts/git-submodule/git-submodule.png" alt="Featured image of post 清理git submodule" />&lt;p>当我们本地对git的submodule目录下的文件做了改动时，会发现不论是用&lt;code>git checkout .&lt;/code>
还是 &lt;code>git clean -df&lt;/code>都无法丢弃修改。使用&lt;code>git status&lt;/code>命令查看工作树的状态时会有如下
报错信息&lt;code>git submodule modified content&lt;/code>&lt;/p>
&lt;h2 id="错误">错误&lt;/h2>
&lt;p>以hugo为例，当使用&lt;code>hugo server&lt;/code>本地预览博客文章时， hugo会修改主题目录的内容。从而出现 git submodule modified content的问题。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ git status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">位于分支 main
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">您的分支领先 &lt;span class="s1">&amp;#39;origin/main&amp;#39;&lt;/span> 共 &lt;span class="m">1&lt;/span> 个提交。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> （使用 &lt;span class="s2">&amp;#34;git push&amp;#34;&lt;/span> 来发布您的本地提交）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">尚未暂存以备提交的变更：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> （使用 &lt;span class="s2">&amp;#34;git add &amp;lt;文件&amp;gt;...&amp;#34;&lt;/span> 更新要提交的内容）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> （使用 &lt;span class="s2">&amp;#34;git restore &amp;lt;文件&amp;gt;...&amp;#34;&lt;/span> 丢弃工作区的改动）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> （提交或丢弃子模组中未跟踪或修改的内容）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 修改： themes/stack &lt;span class="o">(&lt;/span>修改的内容&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">修改尚未加入提交（使用 &lt;span class="s2">&amp;#34;git add&amp;#34;&lt;/span> 和/或 &lt;span class="s2">&amp;#34;git commit -a&amp;#34;&lt;/span>）
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个问题挺常见的，Google后使用下面两条命令即可清理submodule：&lt;/p>
&lt;h2 id="meat">meat&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">git submodule foreach --recursive git reset --hard
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git submodule update --recursive --init
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a class="link" href="https://stackoverflow.com/a/44669463" target="_blank" rel="noopener"
>How do I revert my changes to a git submodule?&lt;/a>&lt;/p>
&lt;h3 id="make">make&lt;/h3>
&lt;p>建议在根目录下编写内容如下的&lt;code>Makefile&lt;/code>， 以节省输入命令的时间和加强记忆。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">clean&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">clean&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -@git submodule deinit -f .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -@git submodule update --init --recursive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#git submodule deinit -f .
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#git submodule update --init
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>执行&lt;code>make&lt;/code>命令即可清除本地对git submodule的改动。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ make
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">已清除目录 &lt;span class="s1">&amp;#39;themes/stack&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">子模组 &lt;span class="s1">&amp;#39;themes/stack&amp;#39;&lt;/span>（https://github.com/datewu/hugo-theme-stack.git）未对路径 &lt;span class="s1">&amp;#39;themes/stack&amp;#39;&lt;/span> 注册
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">子模组 &lt;span class="s1">&amp;#39;themes/stack&amp;#39;&lt;/span>（https://github.com/datewu/hugo-theme-stack.git）已对路径 &lt;span class="s1">&amp;#39;themes/stack&amp;#39;&lt;/span> 注册
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">子模组路径 &lt;span class="s1">&amp;#39;themes/stack&amp;#39;&lt;/span>：检出 &lt;span class="s1">&amp;#39;aeb077874a7de9ce71304c990ad5cfdc72664f38&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>加油</title><link>https://tab.deoops.com/posts/jia-you/</link><pubDate>Thu, 01 Jul 2021 10:54:49 +0800</pubDate><guid>https://tab.deoops.com/posts/jia-you/</guid><description>&lt;img src="https://tab.deoops.com/posts/jia-you/jiayou.jpeg" alt="Featured image of post 加油" />&lt;p>上个周末江江回家看小宝发了好多脾气。&lt;/p>
&lt;p>表面上是和妈妈吵架，实际上还是怪我没工作。&lt;/p>
&lt;p>“你爸妈其实很想你去上班，应该把你赶出去，却想让我来当坏人。让我来和你吵架。”&lt;/p>
&lt;p>工作找了3个月了，确实很对不住家人们的期待。&lt;/p>
&lt;p>这周四去武汉吧，打工或者做生意，不在家里呆着了。&lt;/p></description></item><item><title>'小'偷</title><link>https://tab.deoops.com/posts/little-child/</link><pubDate>Tue, 01 Jun 2021 11:09:29 +0800</pubDate><guid>https://tab.deoops.com/posts/little-child/</guid><description>&lt;img src="https://tab.deoops.com/posts/little-child/child.jpeg" alt="Featured image of post '小'偷" />&lt;p>凌晨5点不到，二楼的房门被打开。&lt;/p>
&lt;p>老妈下来翻箱倒柜找东西，我睡眼朦胧，不情不愿的问了下在找什么。&lt;/p>
&lt;p>老妈说有没有看到装钱的包包。&lt;/p>
&lt;p>几句话交流下来，原来是今天准备去买菜，发现4000多块人民币连钱带包都不见了，最后一次拿钱是在3楼。&lt;/p>
&lt;p>结合以往的经验，我说应该是&lt;code>又&lt;/code>被小孩子偷，老妈想了想去3楼了。&lt;/p>
&lt;p>十多分钟后，我去3楼去看看情况，果然是被家里全托的4个小孩偷了。&lt;/p>
&lt;p>每天偷100块，主要是买烧烤，平均每次吃80多块钱的烧烤。&lt;/p>
&lt;p>4个小孩，全部知情，无一人上报/揭发。&lt;/p>
&lt;p>其中一个小女孩，读2年级，经常被另外3给小男孩欺负，她虽然没有分赃但也是啥也不说。&lt;/p>
&lt;p>3个男孩子，两个读2年级，一个读4年级。&lt;/p>
&lt;p>3个男孩子吃不完的烧烤就带给学校别的小伙伴吃（但是不给另外全托的那个女孩子）。&lt;/p>
&lt;p>我把他们一个个单独拉出来问话。&lt;/p>
&lt;p>结果有问题的是二年级的a男生和四年级的A男生。&lt;/p>
&lt;p>A有前科，在我家偷过好几次，只是数额比较小，最多20。&lt;/p>
&lt;p>另外，b男生的2000多块钱的儿童手表不见过好几次，有一次是A帮着从a的书包里搜出来了，手表用袋子包了好几层。&lt;/p>
&lt;p>回到这次偷钱事件上。&lt;/p>
&lt;p>a虽然承认每次事自己拿的钱，但是一口咬定说：“是A叫他拿的，不拿的话A就打死他。&amp;quot;&lt;/p>
&lt;p>A很狡猾，啥也不承认。&lt;/p>
&lt;p>综合所有人的口供，总的说来，就是罗生门，所有人都说自己没问题，或者是被胁迫的。&lt;/p>
&lt;p>我心中暗想，去吃烧烤的时候咋没说是被胁迫的（小女孩除外，他们不带她去吃）。&lt;/p>
&lt;p>只是没想到9，10岁年纪的小孩子已经可以演绎罗生门了。&lt;/p>
&lt;p>人之初性本善，人到底是啥时候忘记的本心呢？3岁？ 5岁？&lt;/p>
&lt;p>救救孩子吧&lt;/p></description></item><item><title>19公里80块</title><link>https://tab.deoops.com/posts/19-80/</link><pubDate>Thu, 20 May 2021 10:37:55 +0800</pubDate><guid>https://tab.deoops.com/posts/19-80/</guid><description>&lt;img src="https://tab.deoops.com/posts/19-80/taxi.jpeg" alt="Featured image of post 19公里80块" />&lt;p>昨天在武汉打了个的士，19公里，80块，路况基本一路通畅，3到4个红绿灯。&lt;/p>
&lt;p>在2021年网约车这么多的情况，的士师傅还是这么狂的也是少见。&lt;/p>
&lt;h2 id="经过">经过&lt;/h2>
&lt;p>本来是打开滴滴，弹出来&lt;code>青菜拼车&lt;/code>，只要40来块钱两个人，但是一直拼不到。&lt;/p>
&lt;p>看了下滴滴快车是69块。&lt;/p>
&lt;p>但是等了15来分钟的拼车，还要赶着去客运站，感觉被滴滴耍了，怒退单。&lt;/p>
&lt;p>同行的伙伴说打的士吧，应该不贵。&lt;/p>
&lt;p>这个武汉的的士师傅，还是个女师傅，真的是太心黑了。&lt;/p>
&lt;p>打表，跑了16来公里就上80多块钱了。我们提出抗议后，大方的说“行，反正快到了了，那就不打表了，给80就行”。&lt;/p>
&lt;p>惹不起她，达到目的地 给了80块。&lt;/p>
&lt;h2 id="后记">后记&lt;/h2>
&lt;p>最后我们几十赶到客运站了，但是直达老家的车去保养了，我们转了两次车回家了。&lt;/p>
&lt;p>另外在的士上接到了个约我面试的电话:&amp;gt;&lt;/p></description></item><item><title>vscode按键调整</title><link>https://tab.deoops.com/posts/vscode-hold/</link><pubDate>Sun, 09 May 2021 19:25:25 +0800</pubDate><guid>https://tab.deoops.com/posts/vscode-hold/</guid><description>&lt;img src="https://tab.deoops.com/posts/vscode-hold/vim-jkhl.png" alt="Featured image of post vscode按键调整" />&lt;p>今天发现&lt;code>vscodevim&lt;/code>插件不能连续输入方向键&lt;code>j&lt;/code>， 以为是插件的问题，关闭了插件。&lt;/p>
&lt;p>发现在&lt;code>vscode&lt;/code>里按住&lt;code>j&lt;/code>不放，编辑器并不会连续输入&lt;code>j&lt;/code>。&lt;/p>
&lt;p>需要调整系统的&lt;code>dafaults&lt;/code>关闭&lt;code>PressAndHold&lt;/code>选项：&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/VSCodeVim/Vim/blob/master/README.md#mac" target="_blank" rel="noopener"
>enable key-repeating&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>To enable key-repeating, execute the following in your Terminal, log out and back in, and then restart VS Code:&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">defaults write com.microsoft.VSCode ApplePressAndHoldEnabled -bool &lt;span class="nb">false&lt;/span> &lt;span class="c1"># Enable key-repeating for vs code&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>快慢指针</title><link>https://tab.deoops.com/posts/two-points/</link><pubDate>Mon, 19 Apr 2021 19:56:53 +0800</pubDate><guid>https://tab.deoops.com/posts/two-points/</guid><description>&lt;img src="https://tab.deoops.com/posts/two-points/Image-3.gif" alt="Featured image of post 快慢指针" />&lt;p>4月份腾讯面试的时候被问到如何在空间复杂度为O（1）前提下检查连表是否为闭环：&lt;/p>
&lt;p>当时没想出来，面试官提醒用快慢指针也没写出来。&lt;/p>
&lt;p>回到家里想了下，其实当时已经想出来了，没敢写出来:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">circular&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">head&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ListNode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">slow&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fast&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">head&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">head&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">fast&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">fast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Next&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">slow&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">slow&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Next&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fast&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">fast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Next&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Next&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">slow&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">fast&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 133;
flex-basis: 320px"
>
&lt;a href="https://tab.deoops.com/posts/two-points/fast-slow-points.jpeg" data-size="960x720">
&lt;img src="https://tab.deoops.com/posts/two-points/fast-slow-points.jpeg"
width="960"
height="720"
srcset="https://tab.deoops.com/posts/two-points/fast-slow-points_hub5c5dabfad933cb82a6562cb6d3de6a5_42941_480x0_resize_q75_box.jpeg 480w, https://tab.deoops.com/posts/two-points/fast-slow-points_hub5c5dabfad933cb82a6562cb6d3de6a5_42941_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
alt="Floyd’s slow and fast pointers approach">
&lt;/a>
&lt;figcaption>Floyd’s slow and fast pointers approach&lt;/figcaption>
&lt;/figure>&lt;/p></description></item><item><title>自研</title><link>https://tab.deoops.com/posts/zi-yan/</link><pubDate>Wed, 31 Mar 2021 17:24:52 +0800</pubDate><guid>https://tab.deoops.com/posts/zi-yan/</guid><description>&lt;img src="https://tab.deoops.com/posts/zi-yan/open-source.png" alt="Featured image of post 自研" />&lt;p>同事问我，把企业的&lt;code>harbor&lt;/code>镜像仓库服务暴露到公网之后，有人暴力登陆怎么办？&lt;/p>
&lt;p>harbor默认是没有captcha的，google了很久也没看到。&lt;/p>
&lt;p>咋办呢？&lt;/p>
&lt;p>所以还是自研的产品好哦，随随便便就可以加个手机验证码。&lt;/p>
&lt;p>ps：今天是在招商金科的最后一天了。&lt;/p></description></item><item><title>React 17.0.2</title><link>https://tab.deoops.com/posts/react-17.0.2/</link><pubDate>Mon, 29 Mar 2021 17:02:01 +0800</pubDate><guid>https://tab.deoops.com/posts/react-17.0.2/</guid><description>&lt;img src="https://tab.deoops.com/posts/react-17.0.2/react-17.jpeg" alt="Featured image of post React 17.0.2" />&lt;p>今天看到react 17.0.2 发布一个礼拜了(快有1年没大的更新了），想升级试一试，在项目下执行 &lt;code>npm update&lt;/code>指令，结果报错如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">✗ npm update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! code ERESOLVE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! ERESOLVE unable to resolve dependency tree
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! Found: @babel/core@7.12.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! node_modules/@babel/core
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! @babel/core@&lt;span class="s2">&amp;#34;7.12.3&amp;#34;&lt;/span> from the root project
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! @babel/core@&lt;span class="s2">&amp;#34;^7.9.0&amp;#34;&lt;/span> from @svgr/webpack@5.4.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! node_modules/@svgr/webpack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! @svgr/webpack@&lt;span class="s2">&amp;#34;5.4.0&amp;#34;&lt;/span> from the root project
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! &lt;span class="m">9&lt;/span> more &lt;span class="o">(&lt;/span>babel-jest, babel-loader, ...&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! Could not resolve dependency:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! peer @babel/core@&lt;span class="s2">&amp;#34;^7.13.0&amp;#34;&lt;/span> from @babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining@7.13.12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! node_modules/@babel/preset-env/node_modules/@babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! @babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining@&lt;span class="s2">&amp;#34;^7.13.12&amp;#34;&lt;/span> from @babel/preset-env@7.13.12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! node_modules/@babel/preset-env
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! @babel/preset-env@&lt;span class="s2">&amp;#34;^7.9.5&amp;#34;&lt;/span> from @svgr/webpack@5.4.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! node_modules/@svgr/webpack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! @svgr/webpack@&lt;span class="s2">&amp;#34;5.4.0&amp;#34;&lt;/span> from the root project
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! Fix the upstream dependency conflict, or retry
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! this &lt;span class="nb">command&lt;/span> with --force, or --legacy-peer-deps
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! to accept an incorrect &lt;span class="o">(&lt;/span>and potentially broken&lt;span class="o">)&lt;/span> dependency resolution.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! See /Users/r/.npm/eresolve-report.txt &lt;span class="k">for&lt;/span> a full report.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! A &lt;span class="nb">complete&lt;/span> log of this run can be found in:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm ERR! /Users/r/.npm/_logs/2021-03-30T08_44_22_160Z-debug.log
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个项目运行过 &lt;code>npm run eject&lt;/code>，所以担心是eject造成的。&lt;/p>
&lt;p>于是在另外一个目录执行&lt;code>npx create-react-app abc&lt;/code>命令做来一个对照组。&lt;/p>
&lt;p>把&lt;code>abc&lt;/code>项目eject后发现npm install依然会失败。&lt;/p>
&lt;p>google发现有类似的&lt;a class="link" href="https://www.gitmemory.com/issue/facebook/create-react-app/10738/807720421" target="_blank" rel="noopener"
>遭遇&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>Humm, if I see things correctly, the resolving dependency error occurs because create-react-app has the &amp;ldquo;@babel/core&amp;rdquo;: dependency fixed to &amp;ldquo;7.12.3&amp;rdquo; in its &amp;ldquo;packages.json&amp;rdquo; file. 3 days ago, @babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining was merged to Babe master branch that requires &amp;ldquo;@babel/core&amp;rdquo; dependency to be &amp;ldquo;7.13.0&amp;rdquo; or greater. I don&amp;rsquo;t know create-react-app too well, but would perhaps relaxing the &amp;ldquo;@babel/core&amp;rdquo; dependency to &amp;ldquo;^7.12.3&amp;rdquo; be a proper way to fix this issue?&lt;/p>
&lt;/blockquote>
&lt;p>修改package.json文件，添加&amp;quot;@babel/core&amp;quot;: &amp;ldquo;7.13.14&amp;rdquo;, 依赖，重新npm install 恢复正常。&lt;/p>
&lt;p>一下是完整的package.json文件，供参考:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;abc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;version&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;0.1.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;private&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;proxy&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;http://localhost:8080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;dependencies&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@babel/core&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;7.13.14&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@material-ui/core&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^4.11.3&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@material-ui/icons&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^4.11.2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@pmmmwh/react-refresh-webpack-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;0.4.3&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@svgr/webpack&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;5.5.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@testing-library/jest-dom&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^5.11.10&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@testing-library/react&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^11.2.5&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@testing-library/user-event&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^12.8.3&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@tinymce/tinymce-react&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^3.12.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@typescript-eslint/eslint-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^4.5.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;@typescript-eslint/parser&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^4.5.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;babel-eslint&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^10.1.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;babel-jest&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^26.6.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;babel-loader&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;8.1.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;babel-plugin-named-asset-import&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^0.3.7&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;babel-preset-react-app&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^10.0.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;bfj&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^7.0.2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;camelcase&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^6.1.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;case-sensitive-paths-webpack-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2.3.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;css-loader&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;4.3.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;dotenv&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;8.2.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;dotenv-expand&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;5.1.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;eslint&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^7.11.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;eslint-config-react-app&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^6.0.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;eslint-plugin-flowtype&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^5.2.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;eslint-plugin-import&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^2.22.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;eslint-plugin-jest&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^24.1.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;eslint-plugin-jsx-a11y&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^6.3.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;eslint-plugin-react&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^7.21.5&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;eslint-plugin-react-hooks&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^4.2.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;eslint-plugin-testing-library&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^3.9.2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;eslint-webpack-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^2.5.2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;file-loader&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;6.1.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;fs-extra&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^9.0.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;html-react-parser&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^1.2.4&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;html-webpack-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;4.5.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;identity-obj-proxy&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;3.0.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;jest&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;26.6.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;jest-circus&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;26.6.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;jest-resolve&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;26.6.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;jest-watch-typeahead&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;0.6.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;js-base64&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^3.6.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mini-css-extract-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;0.11.3&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;optimize-css-assets-webpack-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;5.0.4&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;pnp-webpack-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1.6.4&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;postcss-flexbugs-fixes&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;4.2.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;postcss-loader&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;3.0.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;postcss-normalize&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;8.0.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;postcss-preset-env&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;6.7.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;postcss-safe-parser&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;5.0.2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;prismjs&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^1.23.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;prompts&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2.4.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;react&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^17.0.2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;react-app-polyfill&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^2.0.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;react-dev-utils&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^11.0.3&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;react-dom&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^17.0.2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;react-hook-form&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^6.15.5&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;react-refresh&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^0.8.3&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;react-router-dom&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^5.2.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;resolve&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1.18.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;resolve-url-loader&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^3.1.2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;sass-loader&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^10.0.5&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;semver&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;7.3.2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;style-loader&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1.3.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;terser-webpack-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;4.2.3&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;tinymce&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^5.7.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;ts-pnp&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1.2.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;url-loader&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;4.1.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;web-vitals&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^1.1.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;webpack&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;4.44.2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;webpack-dev-server&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;3.11.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;webpack-manifest-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2.2.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;workbox-webpack-plugin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;5.1.4&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;scripts&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;node scripts/start.js&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;build&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;node scripts/build.js&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;node scripts/test.js&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;eslintConfig&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;extends&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;react-app&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;react-app/jest&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;browserslist&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;production&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;gt;0.2%&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;not dead&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;not op_mini all&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;development&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;last 1 chrome version&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;last 1 firefox version&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;last 1 safari version&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;jest&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;roots&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;lt;rootDir&amp;gt;/src&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;collectCoverageFrom&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;src/**/*.{js,jsx,ts,tsx}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;!src/**/*.d.ts&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;setupFiles&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;react-app-polyfill/jsdom&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;setupFilesAfterEnv&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;lt;rootDir&amp;gt;/src/setupTests.js&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;testMatch&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;lt;rootDir&amp;gt;/src/**/__tests__/**/*.{js,jsx,ts,tsx}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;lt;rootDir&amp;gt;/src/**/*.{spec,test}.{js,jsx,ts,tsx}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;testEnvironment&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;jsdom&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;testRunner&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/Users/r/repo/github/blog-fn/node_modules/jest-circus/runner.js&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;transform&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;^.+\\.(js|jsx|mjs|cjs|ts|tsx)$&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;rootDir&amp;gt;/config/jest/babelTransform.js&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;^.+\\.css$&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;rootDir&amp;gt;/config/jest/cssTransform.js&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;^(?!.*\\.(js|jsx|mjs|cjs|ts|tsx|css|json)$)&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;rootDir&amp;gt;/config/jest/fileTransform.js&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;transformIgnorePatterns&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;[/\\\\]node_modules[/\\\\].+\\.(js|jsx|mjs|cjs|ts|tsx)$&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;^.+\\.module\\.(css|sass|scss)$&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;modulePaths&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;moduleNameMapper&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;^react-native$&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;react-native-web&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;^.+\\.module\\.(css|sass|scss)$&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;identity-obj-proxy&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;moduleFileExtensions&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;web.js&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;js&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;web.ts&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;web.tsx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;tsx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;json&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;web.jsx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;jsx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;node&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;watchPlugins&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;jest-watch-typeahead/filename&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;jest-watch-typeahead/testname&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;resetMocks&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;babel&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;presets&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;react-app&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;devDependencies&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;babel-plugin-prismjs&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;^2.0.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>顺丰包裹</title><link>https://tab.deoops.com/posts/sf-sz/</link><pubDate>Sat, 20 Mar 2021 17:11:26 +0800</pubDate><guid>https://tab.deoops.com/posts/sf-sz/</guid><description>&lt;img src="https://tab.deoops.com/posts/sf-sz/sf.jpeg" alt="Featured image of post 顺丰包裹" />&lt;p>快从深圳回老家了，东西丢的差不多了，剩下的东西直接顺丰寄回家。&lt;/p>
&lt;p>一共寄了3次顺丰包裹。&lt;/p>
&lt;p>前两次的那个工作人员，6块钱一个纸箱，而且按照体积算。&lt;/p>
&lt;p>第一次算了69kg：4个包裹，288+21元，&lt;/p>
&lt;p>第二次算了51kg： 3个包裹加一个小包裹 216 + 21元。&lt;/p>
&lt;p>第三次换了个工作人员算了38kg：两个纸箱和我自己煤气灶的纸箱不算 173 + 21元。&lt;/p>
&lt;p>第一次算了4个纸箱 4 * 6 = 24 块，第二次算了3个纸箱 3 * 6 = 18 元， 第三次没有收纸箱的钱。&lt;/p>
&lt;p>算下来，寄的越重越省钱。&lt;/p>
&lt;h3 id="update">update&lt;/h3>
&lt;p>今天（3月31号）寄了最后一次快递，33kg。两个纸箱，一大一小，再加一个帐篷的包。一共 148 +12 = 169元。&lt;/p>
&lt;p>纸箱没有收费。&lt;/p></description></item><item><title>调试golang测试</title><link>https://tab.deoops.com/posts/go-test/</link><pubDate>Wed, 14 Oct 2020 18:38:01 +0800</pubDate><guid>https://tab.deoops.com/posts/go-test/</guid><description>&lt;img src="https://tab.deoops.com/posts/go-test/ta_moderationworkflow.png" alt="Featured image of post 调试golang测试" />&lt;p>调试某个go test程序的时候，需要实现&lt;code>confirm/approve&lt;/code>功能:&lt;/p>
&lt;blockquote>
&lt;p>测试完&lt;code>testCase1&lt;/code>之后（或者说是某个断点），用户输入&lt;code>yes&lt;/code>，执行下一个&lt;code>case&lt;/code>，输入&lt;code>no&lt;/code>， 则退出整个测试。&lt;/p>
&lt;/blockquote>
&lt;h2 id="分析">分析&lt;/h2>
&lt;p>下意识的觉得这个很好实现，调用&lt;code>fmt.Scan&lt;/code>应该就OK了。&lt;/p>
&lt;p>但是写的时候才发现，&lt;code>go test&lt;/code> 会强制重定向&lt;code>os.Stdin = /dev/null&lt;/code>忽略所有的 stdin输入，&lt;/p>
&lt;p>所以没法使用 &lt;code>fmt.Scan&lt;/code>来等待键盘(用户)的输入：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// fmt.Scan reads from os.Stdin, which is set to /dev/null when testing.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Tests should be automated and self-contained anyway, so you don&amp;#39;t want
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// to read from stdin.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Either use an external file, a bytes.Buffer, or a strings.Reader and
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// call scan.Fscan if you want to test **the literal** `scan` Function.
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>可以&lt;a class="link" href="https://tab.deoops.com/posts/shell-fifo/" >参考事件驱动&lt;/a>，使用&lt;code>named pipes&lt;/code>来实现&lt;code>confirm/approve&lt;/code>功能：&lt;/p>
&lt;h3 id="消费者">消费者&lt;/h3>
&lt;p>先写一个消费者的函数&lt;code>readPipe&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;bufio&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">readPipe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">readPipe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;pipe&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">reader&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">bufio&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewScanner&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Scan&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Text&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后在测试的case里调用&lt;code>readPipe&lt;/code>函数：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;testing&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">TestCase1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;testing test case 1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;test case 1 tested&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">readPipe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">TestCase2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;testing test case 2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;test case 2 tested&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">readPipe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">TestCase3&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;testing test case 3&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;test case 3 tested&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">readPipe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="生成者">生成者&lt;/h3>
&lt;p>创建&lt;code>pipe&lt;/code>，然后往pipe里写数据，就可以触发(&lt;code>unblock&lt;/code>)消费者进程。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">➜ ~ mkfifo pipe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ ~ ls -alh pipe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prw-r--r-- &lt;span class="m">1&lt;/span> r staff 0B &lt;span class="m">4&lt;/span> &lt;span class="m">24&lt;/span> 16:32 pipe
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>写入数据：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">➜ ~ date &amp;gt; pipe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ ~ date &amp;gt; pipe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ ~ date &amp;gt; pipe
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="测试">测试&lt;/h2>
&lt;p>调试的结果如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">➜ ~ go &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">testing &lt;span class="nb">test&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">test&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="m">1&lt;/span> tested
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span> 2020年 4月24日 星期五 16时31分50秒 CST
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">testing &lt;span class="nb">test&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">test&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="m">2&lt;/span> tested
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2&lt;/span> 2020年 4月24日 星期五 16时31分59秒 CST
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">testing &lt;span class="nb">test&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">test&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="m">3&lt;/span> tested
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">3&lt;/span> 2020年 4月24日 星期五 16时32分08秒 CST
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PASS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ok abc 36.016s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>更换brew源</title><link>https://tab.deoops.com/posts/brew-repo/</link><pubDate>Fri, 14 Aug 2020 11:33:00 +0800</pubDate><guid>https://tab.deoops.com/posts/brew-repo/</guid><description>&lt;img src="https://tab.deoops.com/posts/brew-repo/homebrew-social-card.png" alt="Featured image of post 更换brew源" />&lt;p>国内网络环境日益恶劣，执行&lt;code>brew update/upgrade&lt;/code>花费的时间够我泡好一壶普洱茶。&lt;/p>
&lt;p>不过好景不长，谁能想到那么大的普洱茶饼，日积月累一点点的被我喝完了。&lt;/p>
&lt;p>哎，怀恋普洱茶呀。 没了普洱茶，我决定换了brew的官方源，给自己节约节约生命。&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>挑挑拣拣一圈之后，我决定使用清华大学开源软件镜像站]的brew源。&lt;/p>
&lt;p>按照&lt;a class="link" href="https://mirrors.tuna.tsinghua.edu.cn/help/homebrew/" target="_blank" rel="noopener"
>官网的&lt;/a>指引很快就换好了repo，效果很好。&lt;/p>
&lt;p>和&lt;a class="link" href="https://tab.deoops.com/posts/macos-dns/" >设置macos DNS servers&lt;/a>一样我也整理了个shell脚本：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/local/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>set_qh&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git -C &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>brew --repo&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git -C &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>brew --repo homebrew/core&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git -C &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>brew --repo homebrew/cask&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-cask.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> brew update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># revocer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">recover&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git -C &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>brew --repo&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> remote set-url origin https://github.com/Homebrew/brew.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git -C &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>brew --repo homebrew/core&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> remote set-url origin https://github.com/Homebrew/homebrew-core.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git -C &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>brew --repo homebrew/cask&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> remote set-url origin https://github.com/Homebrew/homebrew-cask.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> brew update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">a&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">1&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="s2">&amp;#34;check&amp;#34;&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="c1"># default to check&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;r&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> recover
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;set&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set_qh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;check&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;goping to EXPORT HOMEBREW_BOTTLE_DOMAIN&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">export&lt;/span> &lt;span class="nv">HOMEBREW_BOTTLE_DOMAIN&lt;/span>&lt;span class="o">=&lt;/span>https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$HOMEBREW_BOTTLE_DOMAIN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> brew config &lt;span class="p">|&lt;/span> grep ORIGIN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> brew update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> brew upgrade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> brew cleanup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$a&lt;/span> successed!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上面的bash脚本支持3个参数 &lt;code>check&lt;/code>,&lt;code>set&lt;/code>和 &lt;code>recover&lt;/code>，默认使用 &lt;code>check&lt;/code>参数。&lt;/p>
&lt;p>保存为&lt;code>set-brew-repo.sh&lt;/code>文件，再加上可执行权限即可：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">➜ ~ chmod +x set-brew-repo.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ ~ ./set-brew-repo.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>设置dns</title><link>https://tab.deoops.com/posts/macos-dns/</link><pubDate>Wed, 10 Jun 2020 22:20:03 +0800</pubDate><guid>https://tab.deoops.com/posts/macos-dns/</guid><description>&lt;img src="https://tab.deoops.com/posts/macos-dns/dns-resolver.png" alt="Featured image of post 设置dns" />&lt;p>众所周知，修改&lt;a class="link" href="https://en.wikipedia.org/wiki/Resolv.conf" target="_blank" rel="noopener"
>&lt;code>/etc/resolv.conf&lt;/code>&lt;/a>配置文件可以配置Linux的dns 解析服务器。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@VM-8-3-centos ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat /etc/resolv.conf &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Generated by NetworkManager&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nameserver 183.60.83.19
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nameserver 183.60.82.98
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>那么苹果系统的dns 解析服务器应该在哪里配置呢，也是配置/etc/resolv.conf文件吗？&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">➜ ~ cat /etc/resolv.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># macOS Notice&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This file is not consulted for DNS hostname resolution, address&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># resolution, or the DNS query routing mechanism used by most&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># processes on this system.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># To view the DNS configuration used by this system, use:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># scutil --dns&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># SEE ALSO&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># dns-sd(1), scutil(8)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This file is automatically generated.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nameserver 127.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nameserver 192.168.1.1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="故事">故事&lt;/h2>
&lt;p>因为新冠的爆发，公司下放了VPN权限，可以在家接公司办公网络办公。&lt;/p>
&lt;p>这段时间我在家享受丝滑顺畅的办公内网网络，基本没遇到啥问题，每天都美滋滋的。&lt;/p>
&lt;p>昨天手机运营商&lt;strong>联通&lt;/strong>突然打电话给我说，我的手机是5G手机，设置一下网络模式可以在原有4G的套餐上使用5G网络啦，诚邀我体验。&lt;/p>
&lt;p>那么&lt;strong>联通&lt;/strong>是&lt;strong>怎么知道&lt;/strong>我使用的是5G手机的呢？？？这个先按下不表。&lt;/p>
&lt;p>我稍稍体验了一会，5G网络的速度和时延果然和宣传中的一样牛逼。&lt;/p>
&lt;p>我不由的感叹：华为果然🐂🍺。&lt;/p>
&lt;p>这么好的网络质量，不应该让笔记本也享受享受吗？&lt;/p>
&lt;p>话不多说我立马把苹果电脑连接上了手机热点，用了不多久就发现遇到了DNS的问题。&lt;/p>
&lt;h3 id="问题">问题&lt;/h3>
&lt;p>苹果笔记本连接手机热点的Wi-Fi后，手机热点 不会使用 VPN指定的DNS server去解析 办公网络的内网地址，导致无妨访问内网域名。&lt;/p>
&lt;h3 id="解决方案">解决方案&lt;/h3>
&lt;p>解决的办法也很简单：打开 设置-&amp;gt; 网络 -&amp;gt; WI-Fi -&amp;gt; 高级 -&amp;gt; DNS -&amp;gt; 修改DNS 服务器 即可。&lt;/p>
&lt;p>鼓捣一会发现，每次操作dns server都需要用鼠标点击UI，再点击6次子菜单，复制两次DNS server 的IP 地址，才能完成设置，这种操作很不程序员。&lt;/p>
&lt;p>于是搜索了macos设置dns servers的命令，把上面的UI操作脚本化了。整理了一份&lt;code>bash&lt;/code>脚本如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/local/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="nv">a&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">1&lt;/span>&lt;span class="k">:-&lt;/span>&lt;span class="nv">check&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">a&lt;/span>&lt;span class="si">}&lt;/span>ing ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#dns=&amp;#34;100.67.174.10 100.67.174.11&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">dns&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;100.67.174.10 100.67.174.11&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;check&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networksetup -getinfo wi-fi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networksetup -getdnsservers wi-fi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;set&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networksetup -setdnsservers wi-fi &lt;span class="nv">$dns&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networksetup -getdnsservers wi-fi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;clear&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networksetup -setdnsservers wi-fi Empty
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networksetup -getdnsservers wi-fi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$a&lt;/span> successed!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>脚本支持3个参数 &lt;code>check&lt;/code>,&lt;code>set&lt;/code>和 &lt;code>clear&lt;/code>，默认使用 &lt;code>check&lt;/code>参数。&lt;/p>
&lt;p>保存为&lt;code>set-dns.sh&lt;/code>文件，再加上可执行权限即可：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">➜ ~ chmod +x set-dns.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ ~ ./set-dns.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>tcl入门</title><link>https://tab.deoops.com/posts/tcl-101/</link><pubDate>Tue, 19 May 2020 16:41:43 +0800</pubDate><guid>https://tab.deoops.com/posts/tcl-101/</guid><description>&lt;img src="https://tab.deoops.com/posts/tcl-101/tcl-tk.jpeg" alt="Featured image of post tcl入门" />&lt;p>使用了一段时间&lt;a class="link" href="https://tab.deoops.com/posts/expect-interactive/" >Expect自动化工具简介&lt;/a>里面的&lt;code>expect&lt;/code>脚本，发现少了一些功能：&lt;/p>
&lt;ol>
&lt;li>怎么给&lt;code>expect&lt;/code>脚本传参数呢？&lt;/li>
&lt;li>&lt;code>expect&lt;/code>怎么调用 &lt;code>bash/sh&lt;/code>外部命令呢？&lt;/li>
&lt;li>&lt;code>expect&lt;/code>怎么操作字符串呢？&lt;/li>
&lt;/ol>
&lt;h2 id="tcl">tcl&lt;/h2>
&lt;p>前面的文章&lt;a class="link" href="https://tab.deoops.com/posts/expect-interactive/" >Expect命令&lt;/a>里面提到过，expect 使用的是&lt;code>Tcl/tk&lt;/code>的语法。&lt;/p>
&lt;p>所以 大家Google 一下 &lt;code>tcl tutorial&lt;/code>就可以解决上面三个问题了。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;a class="link" href="https://wiki.tcl-lang.org/page/argv" target="_blank" rel="noopener"
>tcl argc argc&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://zetcode.com/lang/tcl/" target="_blank" rel="noopener"
>Tcl tutorial&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://www.tcl.tk/man/tcl8.4/TclCmd/regexp.htm" target="_blank" rel="noopener"
>Tcl regexp&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="new-expect-script">new expect script&lt;/h3>
&lt;p>结合上面的3篇教程我把上篇文章自动化ssh 登陆的脚本优化如下:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/bin/expect -f
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># for anyone not familar with expect&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># should read this awesome article&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https://www.pantz.org/software/expect/expect_examples_and_tips.html&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="nv">$argc&lt;/span> !&lt;span class="o">=&lt;/span> 1&lt;span class="o">}&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> puts &lt;span class="s2">&amp;#34;must set one argument for server_A host ip&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> puts &lt;span class="s2">&amp;#34;./login.tcl 1.1.2.2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> timeout &lt;span class="m">15&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#set info [gets stdin]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> info &lt;span class="o">[&lt;/span>&lt;span class="nb">exec&lt;/span> privateRESTfullAPI2GetPwd -host &lt;span class="nv">$argv&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> result &lt;span class="o">[&lt;/span>regexp &lt;span class="o">{&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="o">([&lt;/span>^&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>*&lt;span class="o">)&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="o">[&lt;/span>^&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>*&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="o">([&lt;/span>^&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>*&lt;span class="o">)&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="o">[&lt;/span>^&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>*&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="o">([&lt;/span>^&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>*&lt;span class="o">)&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="nv">$info&lt;/span> match host pw1 pw2&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">send_user &lt;span class="s2">&amp;#34;going to connected to server_A\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spawn ssh -q -o &lt;span class="nv">StrictHostKeyChecking&lt;/span>&lt;span class="o">=&lt;/span>no nobody@host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">expect &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout &lt;span class="o">{&lt;/span> send_user &lt;span class="s2">&amp;#34;\ntimeout Failed to get password prompt, is VPN on?\n&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> eof &lt;span class="o">{&lt;/span> send_user &lt;span class="s2">&amp;#34;\nSSH failure for server_A\n&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;*assword:&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">send &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$pwd1&lt;/span>&lt;span class="s2">\r&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">expect &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout &lt;span class="o">{&lt;/span>send_user &lt;span class="s2">&amp;#34;\nSSH failure for server_B\n&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Last login:*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">send &lt;span class="s2">&amp;#34;su -\r&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">expect &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> eof &lt;span class="o">{&lt;/span> send_user &lt;span class="s2">&amp;#34;\nSSH failure check your password \n&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;密码&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">send &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$pw2&lt;/span>&lt;span class="s2">\r&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interact
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>简单解释上面的脚本：&lt;/p>
&lt;ol>
&lt;li>$argc 命令行参数的个数； $argv 命令行参数（不含命令本身）;&lt;/li>
&lt;li>&lt;code>puts&lt;/code> 相当于 bash 的 &lt;code>echo&lt;/code>命令 ;&lt;/li>
&lt;li>&lt;code>exec&lt;/code> 相当于 bash的 &lt;code>$()&lt;/code>;&lt;/li>
&lt;li>privateRESTfullAPI2GetPwd -host $argv 是我本地的一个用来查询主机密码的工具，返回值的格式为：&lt;code>Passworod of &amp;quot;1.1.1.1&amp;quot; are &amp;quot;pwd for noby&amp;quot; and &amp;quot;pwd for root&amp;quot;&lt;/code>&lt;/li>
&lt;li>正则表达式 &lt;code> {\&amp;quot;([^\&amp;quot;]*)\&amp;quot;[^\&amp;quot;]*\&amp;quot;([^\&amp;quot;]*)\&amp;quot;[^\&amp;quot;]*\&amp;quot;([^\&amp;quot;]*)\&amp;quot;}&lt;/code>用来提取上面&lt;code>privateAPI2GetPwd&lt;/code>返回值中3个 双引号中的内容， 即： host, pwd1, pwd2&lt;/li>
&lt;li>命令&lt;code>set result [regexp {...第五条..} $info match host pw1 pw2]&lt;/code>把上面正则表达式的的3个 &lt;code>group&lt;/code> 分别赋值给 &lt;code>host, pw1, pw2&lt;/code>三个变量。 丢弃了&lt;code>result&lt;/code> 和 &lt;code>match&lt;/code> 两个变量。&lt;/li>
&lt;/ol></description></item><item><title>socat工具</title><link>https://tab.deoops.com/posts/socat-usage/</link><pubDate>Tue, 14 Apr 2020 09:50:07 +0800</pubDate><guid>https://tab.deoops.com/posts/socat-usage/</guid><description>&lt;img src="https://tab.deoops.com/posts/socat-usage/socat.jpeg" alt="Featured image of post socat工具" />&lt;p>众所周知kubenetest的端口转发功能&lt;a class="link" href="https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/#forward-a-local-port-to-a-port-on-the-pod" target="_blank" rel="noopener"
>kubectl port-forward&lt;/a>非常实用，可以提高开发人员的debug效率。&lt;/p>
&lt;p>其实&lt;code>kubectl port-forward&lt;/code>的底层脏活累活都是&lt;code>socat&lt;/code>命令在做，&lt;code>kubectl&lt;/code>只能算是一个代理商。&lt;/p>
&lt;h2 id="socat">socat&lt;/h2>
&lt;h3 id="端口转发">端口转发&lt;/h3>
&lt;p>&lt;code>socat tcp-listen:58812,reuseaddr,fork tcp:localhost:8000&lt;/code>把58812端口的流量转发到 8000上。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">bash-5.1# python3 -m http.server &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-5.1# socat tcp-listen:58812,reuseaddr,fork tcp:localhost:8000 &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-5.1# curl -I localhost:58812
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HTTP/1.0 &lt;span class="m">200&lt;/span> OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Server: SimpleHTTP/0.6 Python/3.10.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Date: Thu, &lt;span class="m">14&lt;/span> Apr &lt;span class="m">2022&lt;/span> 03:19:15 GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Content-type: text/html&lt;span class="p">;&lt;/span> &lt;span class="nv">charset&lt;/span>&lt;span class="o">=&lt;/span>utf-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Content-Length: &lt;span class="m">336&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>从而使得原来无法访问的 &lt;code>localhost:8000&lt;/code>端口的服务，现在可以通过&lt;code>*:58812&lt;/code>访问到了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">bash-5.1# netstat -nlp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Active Internet connections &lt;span class="o">(&lt;/span>only servers&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tcp &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 0.0.0.0:58812 0.0.0.0:* LISTEN 10/socat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tcp &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 0.0.0.0:8000 0.0.0.0:* LISTEN 31/python3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Active UNIX domain sockets &lt;span class="o">(&lt;/span>only servers&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Proto RefCnt Flags Type State I-Node PID/Program name Path
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="其他">其他&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">➜ ~ tldr socat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">socat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Multipurpose relay &lt;span class="o">(&lt;/span>SOcket CAT&lt;span class="o">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Listen to a port, &lt;span class="nb">wait&lt;/span> &lt;span class="k">for&lt;/span> an incoming connection and transfer data to STDIO:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> socat - TCP-LISTEN:8080,fork
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Create a connection to a host and port, transfer data in STDIO to connected host:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> socat - TCP4:www.example.com:80
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Forward incoming data of a &lt;span class="nb">local&lt;/span> port to another host and port:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> socat TCP-LISTEN:80,fork TCP4:www.example.com:80
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="语法">语法&lt;/h2>
&lt;p>&lt;a class="link" href="https://linux.die.net/man/1/socat" target="_blank" rel="noopener"
>man 手册&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>Socat is a command line based utility that establishes two bidirectional byte streams and transfers data between them. Because the streams can be constructed from a large set of different types of data sinks and sources (see address types), and because lots of address options may be applied to the streams, socat can be used for many different purposes.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>Filan is a utility that prints information about its active file descriptors to stdout. It has been written for debugging socat, but might be useful for other purposes too. Use the -h option to find more infos.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>Procan is a utility that prints information about process parameters to stdout. It has been written to better understand some UNIX process properties and for debugging socat, but might be useful for other purposes too.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>The life cycle of a socat instance typically consists of four phases.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>In the init phase, the command line options are parsed and logging is initialized.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>During the open phase, socat opens the first address and afterwards the second address. These steps are usually blocking; thus, especially for complex address types like socks, connection requests or authentication dialogs must be completed before the next step is started.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>In the transfer phase, socat watches both streamscq read and write file descriptors via CWselect() , and, when data is available on one side and can be written to the other side, socat reads it, performs newline character conversions if required, and writes the data to the write file descriptor of the other stream, then continues waiting for more data in both directions.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>When one of the streams effectively reaches EOF, the closing phase begins. Socat transfers the EOF condition to the other stream, i.e. tries to shutdown only its write stream, giving it a chance to terminate gracefully. For a defined time socat continues to transfer data in the other direction, but then closes all remaining channels and terminates.&lt;/p>
&lt;/blockquote></description></item><item><title>TCP/IP教程</title><link>https://tab.deoops.com/posts/tcp-ip-tutorial/</link><pubDate>Mon, 13 Apr 2020 22:25:56 +0800</pubDate><guid>https://tab.deoops.com/posts/tcp-ip-tutorial/</guid><description>&lt;img src="https://tab.deoops.com/posts/tcp-ip-tutorial/The-logical-mapping-between-OSI-basic-reference-model-and-the-TCP-IP-stack.png" alt="Featured image of post TCP/IP教程" />&lt;p>本文不定期更新 :)&lt;/p>
&lt;p>上个礼拜逛&lt;a class="link" href="https://news.ycombinator.com/" target="_blank" rel="noopener"
>Hacker News&lt;/a>看到推荐了一份写于1991年介绍TCP/IP协议的文章&lt;a class="link" href="https://tools.ietf.org/html/rfc1180" target="_blank" rel="noopener"
>A TCP/IP Tutorial&lt;/a>。&lt;/p>
&lt;p>初略的扫了几眼，发现不错，加入了收藏夹。&lt;/p>
&lt;p>昨天晚上抽出时间来细读了一遍觉得很有翻译的价值，于是试着翻译一下：&lt;/p>
&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>This tutorial contains only one view of the salient points of TCP/IP,
and therefore it is the &amp;ldquo;bare bones&amp;rdquo; of TCP/IP technology. It omits
the history of development and funding, the business case for its
use, and its future as compared to ISO OSI. Indeed, a great deal of
technical information is also omitted. What remains is a minimum of
information that must be understood by the professional working in a
TCP/IP environment. These professionals include the systems
administrator, the systems programmer, and the network manager.&lt;/p>
&lt;p>This tutorial uses examples from the UNIX TCP/IP environment, however
the main points apply across all implementations of TCP/IP.&lt;/p>
&lt;p>Note that the purpose of this memo is explanation, not definition.
If any question arises about the correct specification of a protocol,
please refer to the actual standards defining RFC.&lt;/p>
&lt;p>The next section is an overview of TCP/IP, followed by detailed
descriptions of individual components.&lt;/p>
&lt;ol>
&lt;li>序言&lt;/li>
&lt;/ol>
&lt;p>这篇教程只是对 TCP/IP 协议中一些最重要的要点做描述性的介绍，因此可以把这篇教程看作是TCP/IP 技术的骨架。
这篇教程&lt;strong>不涉及&lt;/strong> TCP/IP 的发展历史，资金/资助来源，商业用途以及和ISO OSI的对比来看TCP/IP的未来会怎样。而且很多详细的技术细节也不会在本文中得到介绍。
这篇教程所&lt;strong>涉及&lt;/strong>的内容，恰恰是一个日常工作在TCP/IP 环境的专业人士&lt;strong>必须&lt;/strong>理解的&lt;strong>最少&lt;/strong>TCP/IP技术信息量，不能再少了。这些专业人士包括了系统管理员，系统程序员，和网络管理员。
这篇教程使用的例子都是在 UNIX TCP/IP 环境，但是这些例子所表达的主要意思对所有实现了TCP/IP协议的环境来说都是同样试用的。&lt;/p>
&lt;p>&lt;strong>注意&lt;/strong>⚠️ 这篇教程的目的是解释/介绍 TCP/IP技术，并不是给TCP/IP 技术下定义。&lt;/p>
&lt;p>如果读者对这篇教程描述的某个协议的规格/规范产生了疑问，请参考这个协议的RFC具体的规范定义。
下个小节是对 TCP/IP技术的概览，然后是单独的对每个TCP/IP组件详细的描述。&lt;/p>
&lt;h2 id="tcpip-overview">TCP/IP Overview&lt;/h2>
&lt;p>The generic term &amp;ldquo;TCP/IP&amp;rdquo; usually means anything and everything
related to the specific protocols of TCP and IP. It can include
other protocols, applications, and even the network medium. A sample
of these protocols are: UDP, ARP, and ICMP. A sample of these
applications are: TELNET, FTP, and rcp. A more accurate term is
&amp;ldquo;internet technology&amp;rdquo;. A network that uses internet technology is
called an &amp;ldquo;internet&amp;rdquo;.&lt;/p>
&lt;ol start="2">
&lt;li>TCP/IP 概览&lt;/li>
&lt;/ol>
&lt;p>术语“TCP/IP”一般意义上来说，通常是指 任何以及所有和 ‘TCP 协议’，与 ‘IP 协议’有关的技术。 “TCP/IP”术语可以指 其它的网络协议，网络应用，甚至是物理网络媒介。这些网络协议可以是：UDP, ARP, 和 ICMP； 网络应用可以是：TELNET，FTP，和 RCP。&lt;/p>
&lt;p>“TCP/IP”更准确的术语应该是“互联网技术”。当一个网络使用了互联网技术，我们就可以把这个网络叫“互联网”。&lt;/p>
&lt;h3 id="basic-structure">Basic Structure&lt;/h3>
&lt;p>To understand this technology you must first understand the following
logical structure:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>----------------------------&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| network applications |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">|... \ | / .. \ | / ...|&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ----- ----- |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| |TCP| |UDP| |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ----- ----- |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| \ / |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| -------- |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| | IP | |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ----- -*------ |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| |ARP| | |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ----- | |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| \ | |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ------ |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| |ENET| |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ---@-- |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>----------&lt;span class="l">|-----------------&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> ----------------------o---------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> Ethernet Cable
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> Figure 1. Basic TCP/IP Network Node&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This is the logical structure of the layered protocols inside a
computer on an internet. Each computer that can communicate using
internet technology has such a logical structure. It is this logical
structure that determines the behavior of the computer on the
internet. The boxes represent processing of the data as it passes
through the computer, and the lines connecting boxes show the path
of data. The horizontal line at the bottom represents the Ethernet
cable; the &amp;ldquo;o&amp;rdquo; is the transceiver. The &amp;ldquo;*&amp;rdquo; is the IP address and the
&amp;ldquo;@&amp;rdquo; is the Ethernet address. Understanding this logical structure is
essential to understanding internet technology; it is referred to
throughout this tutorial.&lt;/p>
&lt;p>2.1 基础结构&lt;/p>
&lt;p>要想理解TCP/IP技术，首先你&lt;strong>必须&lt;/strong>要理解下面图表展示的网络节点逻辑结构：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>----------------------------&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| 网络应用 |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">|... \ | / .. \ | / ...|&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ----- ----- |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| |TCP| |UDP| |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ----- ----- |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| \ / |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| -------- |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| | IP | |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ----- -*------ |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| |ARP| | |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ----- | |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| \ | |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ------ |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| |ENET| |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">| ---@-- |&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>----------&lt;span class="l">|-----------------&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">|&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>-------------------&lt;span class="l">o---------&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">以太网网线&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">图1. 基础TCP/IP网络节点逻辑结构&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上图（图1）描绘的是互联网上某台计算机节点内部网络协议的逻辑分层架构。每一台能使用互联网技术和其它计算机通信的计算机都有图1描述的逻辑结构。图1描述的逻辑结构也决定了互联网上计算机的行为。&lt;/p>
&lt;p>图1中的 虚线框 表示当数据在计算机内部传输时 对数据的某种处理， 连接虚线框的虚线表示数据在计算机内部传输的路径。最下面的那条虚线表示以太网线；“o”表示接收发送器， “*”表示IP 地址，“@”表示 以太（MAC）地址。&lt;/p>
&lt;p>理解图1所描述的逻辑结构的对理解整个互联网技术起着关键性作用；而且对图1的引用贯穿了整篇教程。&lt;/p>
&lt;h3 id="terminology">Terminology&lt;/h3>
&lt;p>The name of a unit of data that flows through an internet is
dependent upon where it exists in the protocol stack. In summary: if
it is on an Ethernet it is called an Ethernet frame; if it is between
the Ethernet driver and the IP module it is called a IP packet; if it
is between the IP module and the UDP module it is called a UDP
datagram; if it is between the IP module and the TCP module it is
called a TCP segment (more generally, a transport message); and if it
is in a network application it is called a application message.&lt;/p>
&lt;p>These definitions are imperfect. Actual definitions vary from one
publication to the next. More specific definitions can be found in
RFC 1122, section 1.3.3.&lt;/p>
&lt;p>A driver is software that communicates directly with the network
interface hardware. A module is software that communicates with a
driver, with network applications, or with another module.&lt;/p>
&lt;p>The terms driver, module, Ethernet frame, IP packet, UDP datagram,
TCP message, and application message are used where appropriate
throughout this tutorial&lt;/p>
&lt;p>2.2 术语&lt;/p>
&lt;p>根据数据在图1中被哪一层逻辑层处理，我们给每层的数据块起了不同的名字加以区分。&lt;/p>
&lt;p>总的来说，如果数据块在以太网上，那么这个数据块就被称为 &amp;lsquo;Ethernet frame&amp;rsquo;；
如果数据块&lt;/p></description></item><item><title>SSH代理（Agent）</title><link>https://tab.deoops.com/posts/ssh-agent/</link><pubDate>Sun, 12 Apr 2020 11:34:44 +0800</pubDate><guid>https://tab.deoops.com/posts/ssh-agent/</guid><description>&lt;img src="https://tab.deoops.com/posts/ssh-agent/ssh-agent-typical.png" alt="Featured image of post SSH代理（Agent）" />&lt;h2 id="问题">问题&lt;/h2>
&lt;p>已知本地local可以ssh到server A和B，&lt;/p>
&lt;p>问如何从server A ssh到server B，以及如何在server A 和B之间使用scp互传文件 ？&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>配置&lt;code>ssh_config&lt;/code>然后使用 &lt;code>ssh-add&lt;/code>命令指定使用ssh agent可以很安全和高效的解决上面的两个问题。&lt;/p>
&lt;h3 id="配置ssh_config">配置ssh_config&lt;/h3>
&lt;p>注意看注释，下面脚本所有的操作和配置都是在 本地local上执行的:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl"> vi .ssh/config &lt;span class="c1">## 修改配置 添加forward agent&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HOST server-A
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HostName 1.2.3.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> User root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> IdentityFile ~/.ssh/serverA
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ForwardAgent yes &lt;span class="c1"># 现在 serverA可以和local本机的agent通信啦&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HOST server-B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HostName 6.7.8.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> User root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> IdentityFile ~/.ssh/serverB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ForwardAgent yes &lt;span class="c1"># 现在 serverB可以和local本机的ssh agent 通信啦&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rg Forward /etc/ssh/ssh_config &lt;span class="c1">## 检查全局的forwordagent配置有没有被覆盖&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$SSH_AUTH_SOCK&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="c1">## 查看本地ssh agent是否在运行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssh-add -L &lt;span class="c1">## 查看/操作/删除 ssh agent hold的keys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssh-add -K li
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssh-add -K ~/.ssh/serverA &lt;span class="c1">## 给agent serverA 密钥，使得serverB 可以“使用” 这个密钥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssh-add -K ~/.ssh/serverB &lt;span class="c1">## 给agent serverB密钥，使得serverA可以“使用”这个密钥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssh-add -K ~/.ssh/github &lt;span class="c1">## 给阿根廷 github密钥，使得serverA， serverB都可以ssh github，方便测试&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssh-add -L
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="验证github">验证github&lt;/h3>
&lt;p>也是在本机local操作，以&lt;a class="link" href="https://developer.github.com/v3/guides/using-ssh-agent-forwarding/#troubleshooting-ssh-agent-forwarding" target="_blank" rel="noopener"
>github&lt;/a>作为测试目标：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ssh -T git@github.com &lt;span class="c1">## 本地基准测试&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssh serverA &lt;span class="c1">## 测试serverA &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssh -T git@github.com &lt;span class="c1">## 测试/验证&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="小结">小结&lt;/h2>
&lt;p>注意看注释，注意&lt;code>ForwardAgent&lt;/code>配置应用到哪个server上了。&lt;/p>
&lt;p>当 server 可以和local本机的agent通信的时候，就表示 server 好像拥有了local本地的private keys了。&lt;/p>
&lt;p>具体说： 当server A 的 ForwardAgent 开启时， server A就可以直接ssh到server B了，&lt;/p>
&lt;p>如果这个时候 server B 的ForwordAgent没有开启，server B是不可以ssh 到server A的&lt;/p></description></item><item><title>Expect自动化工具简介</title><link>https://tab.deoops.com/posts/expect-interactive/</link><pubDate>Thu, 19 Mar 2020 16:07:45 +0800</pubDate><guid>https://tab.deoops.com/posts/expect-interactive/</guid><description>&lt;img src="https://tab.deoops.com/posts/expect-interactive/automate.jpeg" alt="Featured image of post Expect自动化工具简介" />&lt;p>公司服务器使用了两层跳板机，外面的一台我们管它叫 &lt;code>server A&lt;/code>， 另外一台 叫它 &lt;code>server B&lt;/code>。&lt;/p>
&lt;p>虽然我不知道这种双保险给公司带来了多少安全感，但是我知道我的运维效率降低了差不多90%吧 :&amp;gt;。&lt;/p>
&lt;p>&lt;code>server A&lt;/code>被直接暴露在公网上， 我们不能使用 &lt;code>ssh key&lt;/code> 只能使用 &lt;code>password&lt;/code>认证&lt;code>ssh&lt;/code>。&lt;/p>
&lt;p>这还不算完，&lt;code>server A&lt;/code>每3小时改一次自己的&lt;code>root&lt;/code>密码。&lt;/p>
&lt;p>后面的&lt;code>server B&lt;/code>跳板机器的自我安全感就强多了，&lt;code>server B&lt;/code>可以直接免密使用&lt;code>ssh key&lt;/code>登陆所有的内网服务器，而且允许&lt;code>server A&lt;/code>免密登陆到自己。&lt;/p>
&lt;p>我决得这样两次登录很浪费时间，于是写了个脚本从外网一次性登陆到&lt;code>server B&lt;/code>服务器上。&lt;/p>
&lt;h2 id="expect-脚本">expect 脚本&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/bin/expect -f
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># for anyone not familar with expect&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># should read this awesome post&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https://www.pantz.org/software/expect/expect_examples_and_tips.html&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> timeout &lt;span class="m">15&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### CHANGE pwd every 3h&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> &lt;span class="nb">pwd&lt;/span> &lt;span class="s2">&amp;#34;mySuperSecretpwd123&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> nested_ssh &lt;span class="s2">&amp;#34;ssh server_B&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## for debug&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># log_user 0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># exp_internal 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">send_user &lt;span class="s2">&amp;#34;going to connected to server A\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spawn ssh -q -o &lt;span class="nv">StrictHostKeyChecking&lt;/span>&lt;span class="o">=&lt;/span>no server_A
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">expect &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout &lt;span class="o">{&lt;/span> send_user &lt;span class="s2">&amp;#34;\ntimeout Failed to get password prompt, is VPN on?\n&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> eof &lt;span class="o">{&lt;/span> send_user &lt;span class="s2">&amp;#34;\nSSH failure for server A\n&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;*assword:&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">send &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$pwd&lt;/span>&lt;span class="s2">\r&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">expect &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout &lt;span class="o">{&lt;/span>send_user &lt;span class="s2">&amp;#34;\nSSH failure for server B\n&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Last login:*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">send &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$nested_ssh&lt;/span>&lt;span class="s2">\r&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interact
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="基本语法">基本语法&lt;/h3>
&lt;p>简单说下基本流程如下：&lt;/p>
&lt;ol>
&lt;li>set: 设置变量；&lt;/li>
&lt;li>spawn: 给对象一个进程空间，让对象可以运行起来&lt;/li>
&lt;li>expect: 模拟用户等待，&lt;strong>期待&lt;/strong>对象输出字符串；&lt;/li>
&lt;li>send: 模拟用户输入，给对象发送字符串；&lt;/li>
&lt;li>send_user: 提示用户;&lt;/li>
&lt;li>interact: 用户直接和对象通信，expect不再在中间传话了。&lt;/li>
&lt;/ol>
&lt;p>因为&lt;code>expect&lt;/code>语法继承自&lt;code>Tcl&lt;/code>，所以变量赋值/初始化的方式和 &lt;code>Bash&lt;/code>不同，需要使用&lt;code>set&lt;/code>关键字。&lt;/p>
&lt;p>注意第5点&lt;code>send_user&lt;/code>命令是为了更好的用户交互，主要是给用户一下提示信息/反馈信息。&lt;/p>
&lt;p>最后注意：&lt;code>send &amp;quot;$pwd\r&amp;quot;&lt;/code>语句的&lt;a class="link" href="https://tab.deoops.com/posts/carrier-return/" >转以符&lt;/a>是 &lt;code>\r&lt;/code> 而不是&lt;code>\r\n&lt;/code>。&lt;/p>
&lt;h2 id="详细语法">详细语法&lt;/h2>
&lt;p>&lt;code>expect&lt;/code>详细的语法和参数解释参考&lt;a class="link" href="https://www.pantz.org/software/expect/expect_examples_and_tips.html" target="_blank" rel="noopener"
>Expect examples and tips&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>Expect is an automation and testing tool used to automate a process that receives interactive commands. If you can connect to any machine using ssh, telnet, ftp, etc then you can automate the process with an expect script. This works even with local programs where you would have to interact with a script or program on the command line.&lt;/p>
&lt;/blockquote></description></item><item><title>容器PID</title><link>https://tab.deoops.com/posts/container-pid/</link><pubDate>Fri, 13 Mar 2020 22:43:32 +0800</pubDate><guid>https://tab.deoops.com/posts/container-pid/</guid><description>&lt;img src="https://tab.deoops.com/posts/container-pid/the-matrix.jpeg" alt="Featured image of post 容器PID" />&lt;p>架构部的同事问了我两个问题:&lt;/p>
&lt;ol>
&lt;li>宿主机上有个进程很耗 cpu，怎么判断它是不是某个容器的进程;&lt;/li>
&lt;li>如果它是跑在容器里，怎么查到是哪个容器(container id);&lt;/li>
&lt;/ol>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>有两种方法来解决上面两个问题：&lt;/p>
&lt;h3 id="cgroup">cgroup&lt;/h3>
&lt;p>通过查看pid的cgroup是否含有 &lt;code>slice&lt;/code>信息来判断是否是容器进程:&lt;/p>
&lt;h4 id="主机进程-cgroup">主机进程 cgroup&lt;/h4>
&lt;p>直接运行在宿主机主的进程的cgroup是没有&lt;code>slice&lt;/code>信息的：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat /proc/1/cgroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">11:perf_event:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10:memory:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">9:devices:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8:cpuacct,cpu:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7:cpuset:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6:hugetlb:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:blkio:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4:net_prio,net_cls:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3:freezer:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2:pids:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1:name&lt;span class="o">=&lt;/span>systemd:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat /proc/19/cgroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">11:perf_event:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10:memory:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">9:devices:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8:cpuacct,cpu:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7:cpuset:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6:hugetlb:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:blkio:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4:net_prio,net_cls:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3:freezer:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2:pids:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1:name&lt;span class="o">=&lt;/span>systemd:/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="k8s-pod进程-cgroup">k8s pod进程 cgroup&lt;/h4>
&lt;p>在宿主机上看跑在容器进程的cgroup是可以看到&lt;code>slice&lt;/code>信息的：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat /proc/20397/cgroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">11:perf_event:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod6d62265d_cd4d_4807_8d2f_386714d5bbdc.slice/docker-c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10:memory:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod6d62265d_cd4d_4807_8d2f_386714d5bbdc.slice/docker-c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">9:devices:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod6d62265d_cd4d_4807_8d2f_386714d5bbdc.slice/docker-c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8:cpuacct,cpu:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod6d62265d_cd4d_4807_8d2f_386714d5bbdc.slice/docker-c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7:cpuset:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod6d62265d_cd4d_4807_8d2f_386714d5bbdc.slice/docker-c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6:hugetlb:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod6d62265d_cd4d_4807_8d2f_386714d5bbdc.slice/docker-c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:blkio:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod6d62265d_cd4d_4807_8d2f_386714d5bbdc.slice/docker-c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4:net_prio,net_cls:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod6d62265d_cd4d_4807_8d2f_386714d5bbdc.slice/docker-c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3:freezer:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod6d62265d_cd4d_4807_8d2f_386714d5bbdc.slice/docker-c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2:pids:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod6d62265d_cd4d_4807_8d2f_386714d5bbdc.slice/docker-c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1:name&lt;span class="o">=&lt;/span>systemd:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod6d62265d_cd4d_4807_8d2f_386714d5bbdc.slice/docker-c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc.scope
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>从上面的输出可以看到 pid &lt;code>20397&lt;/code>是 kubernets pod拉起来的进程， 而且&lt;code>pod ID&lt;/code> 是：
&lt;code>6d62265d_cd4d_4807_8d2f_386714d5bbdc&lt;/code>, 对应的 &lt;code>contariner ID&lt;/code> 是
&lt;code>c44a782ba5482052e66dc3f5ed3811e2a699db09b6715e26102d582a51ac52cc&lt;/code>&lt;/p>
&lt;h4 id="docker-container进程-cgroup">docker container进程 cgroup&lt;/h4>
&lt;p>docker containre 和 k8s 一样，也会设置cgroup slice：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># docker run --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=super123456secret -d mysql:5.7.28&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Unable to find image &lt;span class="s1">&amp;#39;mysql:5.7.28&amp;#39;&lt;/span> locally
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5.7.28: Pulling from library/mysql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">804555ee0376: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">c53bab458734: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ca9d72777f90: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2d7aad6cb96e: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8d6ca35c7908: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6ddae009e760: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">327ae67bbe7b: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">31f1f8385b27: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a5a3ad97e819: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">48bede7828ac: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">380afa2e6973: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Digest: sha256:b38555e593300df225daea22aeb104eed79fc80d2f064fde1e16e1804d00d0fc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Status: Downloaded newer image &lt;span class="k">for&lt;/span> mysql:5.7.28
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># ps aux | grep mysql&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">polkitd &lt;span class="m">23855&lt;/span> 3.0 1.1 &lt;span class="m">1007636&lt;/span> &lt;span class="m">190588&lt;/span> ? Ssl 09:39 0:00 mysqld
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">24176&lt;/span> 0.0 0.0 &lt;span class="m">112724&lt;/span> &lt;span class="m">984&lt;/span> pts/0 S+ 09:39 0:00 grep --color&lt;span class="o">=&lt;/span>auto mysql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat /proc/23855/cgroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">11:perf_event:/system.slice/docker-771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10:memory:/system.slice/docker-771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">9:devices:/system.slice/docker-771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8:cpuacct,cpu:/system.slice/docker-771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7:cpuset:/system.slice/docker-771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6:hugetlb:/system.slice/docker-771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:blkio:/system.slice/docker-771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4:net_prio,net_cls:/system.slice/docker-771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3:freezer:/system.slice/docker-771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2:pids:/system.slice/docker-771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1:name&lt;span class="o">=&lt;/span>systemd:/system.slice/docker-771aa2fdc8cae66a0cb05a4585beff44a69f0f1c5b2a21fd159cbeea0a86d633.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># docker ps | grep 771aa2fdc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">771aa2fdc8ca mysql:5.7.28 &lt;span class="s2">&amp;#34;docker-entrypoint.s…&amp;#34;&lt;/span> &lt;span class="m">58&lt;/span> seconds ago Up &lt;span class="m">57&lt;/span> seconds 0.0.0.0:3306-&amp;gt;3306/tcp, 33060/tcp mysql
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>从上面bash脚本的输出可以清楚的看到，cgroup配置的&lt;code>container ID&lt;/code> 和 docker ps 命令输出的 &lt;code>container ID&lt;/code>是一样的，都是 &lt;code>771aa2fdc8ca&lt;/code>&lt;/p>
&lt;h3 id="ppid">ppid&lt;/h3>
&lt;p>下面两种方法和docker强相关，不推荐。&lt;/p>
&lt;h4 id="pstree">pstree&lt;/h4>
&lt;p>老老实实的一步步排查主机上所有的container ppid：
用 &lt;code>pstree&lt;/code>命令查看宿主机上的进程树，看&lt;code>&amp;lt;pid&amp;gt;&lt;/code> 是不是&lt;code>docker-current&lt;/code>创建的子进程;&lt;/p>
&lt;h4 id="docker-inspect">docker inspect&lt;/h4>
&lt;p>使用&lt;code>docker inspect&lt;/code>命令查询所有容器的pid，然后做过滤，找到该进程对应的容器名，id，容器的详细信息中，包含了它在宿主机上的进程号。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">docker inspect -f &lt;span class="s2">&amp;#34;{{.Id}} {{.State.Pid}} {{.Config.Hostname}}&amp;#34;&lt;/span> &lt;span class="k">$(&lt;/span>docker ps -q&lt;span class="k">)&lt;/span> &lt;span class="p">|&lt;/span> grep &amp;lt;pid&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="发散思维">发散思维&lt;/h2>
&lt;h3 id="matrix">MATRIX&lt;/h3>
&lt;p>那么进程自己如何判断自己是否在container中呢？&lt;/p>
&lt;p>答案很简单，如果 &lt;code>pid 1&lt;/code> 的cgroup有slice信息，说明进程现在在容器中，否则则说明不在容器里。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># kubectl exec -it binary-controller-7dfd4bbd6f-6hsvd sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/ &lt;span class="c1"># ps&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PID USER TIME COMMAND
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> root 0:30 /binary-controller -kubeconfig&lt;span class="o">=&lt;/span>inCluster -mode&lt;span class="o">=&lt;/span>prodution
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">196&lt;/span> root 0:00 sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">202&lt;/span> root 0:00 ps
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/ &lt;span class="c1"># cat /proc/1/cgroup &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">11:hugetlb:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod482f0a01_7b3e_48cd_adb6_61c9097b43a4.slice/docker-b3079dba7a1cf909631c2f9e8ad38cc7f193e6ba8fe649d4d6f590a7d11b0509.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10:pids:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod482f0a01_7b3e_48cd_adb6_61c9097b43a4.slice/docker-b3079dba7a1cf909631c2f9e8ad38cc7f193e6ba8fe649d4d6f590a7d11b0509.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">9:perf_event:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod482f0a01_7b3e_48cd_adb6_61c9097b43a4.slice/docker-b3079dba7a1cf909631c2f9e8ad38cc7f193e6ba8fe649d4d6f590a7d11b0509.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8:freezer:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod482f0a01_7b3e_48cd_adb6_61c9097b43a4.slice/docker-b3079dba7a1cf909631c2f9e8ad38cc7f193e6ba8fe649d4d6f590a7d11b0509.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7:memory:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod482f0a01_7b3e_48cd_adb6_61c9097b43a4.slice/docker-b3079dba7a1cf909631c2f9e8ad38cc7f193e6ba8fe649d4d6f590a7d11b0509.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6:net_prio,net_cls:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod482f0a01_7b3e_48cd_adb6_61c9097b43a4.slice/docker-b3079dba7a1cf909631c2f9e8ad38cc7f193e6ba8fe649d4d6f590a7d11b0509.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:blkio:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod482f0a01_7b3e_48cd_adb6_61c9097b43a4.slice/docker-b3079dba7a1cf909631c2f9e8ad38cc7f193e6ba8fe649d4d6f590a7d11b0509.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4:cpuacct,cpu:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod482f0a01_7b3e_48cd_adb6_61c9097b43a4.slice/docker-b3079dba7a1cf909631c2f9e8ad38cc7f193e6ba8fe649d4d6f590a7d11b0509.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3:devices:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod482f0a01_7b3e_48cd_adb6_61c9097b43a4.slice/docker-b3079dba7a1cf909631c2f9e8ad38cc7f193e6ba8fe649d4d6f590a7d11b0509.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2:cpuset:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod482f0a01_7b3e_48cd_adb6_61c9097b43a4.slice/docker-b3079dba7a1cf909631c2f9e8ad38cc7f193e6ba8fe649d4d6f590a7d11b0509.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1:name&lt;span class="o">=&lt;/span>systemd:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod482f0a01_7b3e_48cd_adb6_61c9097b43a4.slice/docker-b3079dba7a1cf909631c2f9e8ad38cc7f193e6ba8fe649d4d6f590a7d11b0509.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## OH NO, I&amp;#39;M IN THE MATRIX&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>准确的分页</title><link>https://tab.deoops.com/posts/pagination-wf/</link><pubDate>Mon, 02 Mar 2020 11:00:52 +0800</pubDate><guid>https://tab.deoops.com/posts/pagination-wf/</guid><description>&lt;img src="https://tab.deoops.com/posts/pagination-wf/available-paginations.png" alt="Featured image of post 准确的分页" />&lt;p>昨天同事调试前端页面分页功能时， 发现了一个分页的问题。&lt;/p>
&lt;p>问题简要描述如下：&lt;/p>
&lt;p>前端选择一些过滤条件（a&amp;amp;&amp;amp;b&amp;amp;&amp;amp;c||d &amp;hellip;）向后端请求数据，过一会发现用同样的过滤条件去查询，数据变少了，前端看上去第一页和最后一页是一样的。&lt;/p>
&lt;p>初步怀疑是分页出了问题。&lt;/p>
&lt;p>这个分页的问题比较麻烦，不能稳定复现，一会出现一会又不出现。&lt;/p>
&lt;p>分析了很长一段时间后，发现是后台的定时任务更新了db数据使得很多数据不再符合前面的过滤条件，后端框架返回的总页码数，和data的数量不符。&lt;/p>
&lt;p>也就是说后端返回的总页码数是脏/旧数据。&lt;/p>
&lt;h2 id="脏数据">脏数据&lt;/h2>
&lt;p>查看后端框架代码时候，发现后端查询db的执行了&lt;code>count&lt;/code> 和 &lt;code>select&lt;/code> 两条query：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">form&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table_name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">condition_a&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- meamwhile other workers update table_a
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- A LOT in short time
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- or they(the workers) MIGHT lock
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- the WHOLE table for READ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">form&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table_name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">condition_a&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这就是是造成脏数据的原因。&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;h3 id="window-function">window function&lt;/h3>
&lt;p>可以用 window function 做到上述两条query的同时查询（其实就是一条查询）：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OVER&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">full_count&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tbl&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">-- /* whatever */
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">ORDER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">col1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">LIMIT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">OFFSET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="common-table-expressions-cte">Common Table Expressions (cte)&lt;/h3>
&lt;blockquote>
&lt;p>However, as Dani pointed out, when OFFSET is at least as great as the number of rows returned from the base query, no rows are returned. So we also don&amp;rsquo;t get full_count.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>If that&amp;rsquo;s not acceptable, a possible workaround to always return the full count would be with a CTE and an OUTER JOIN:&lt;/p>
&lt;/blockquote>
&lt;p>参考&lt;a class="link" href="https://stackoverflow.com/questions/28888375/run-a-query-with-a-limit-offset-and-also-get-the-total-number-of-rows" target="_blank" rel="noopener"
>Run a query with a LIMIT/OFFSET and also get the total number of rows&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">WITH&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cte&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tbl&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">-- /* whatever */
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cte&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ORDER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">col1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">LIMIT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">OFFSET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sub&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">RIGHT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cte&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">c&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">full_count&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>安装wireguard</title><link>https://tab.deoops.com/posts/try-wireguard/</link><pubDate>Mon, 06 Jan 2020 16:50:26 +0800</pubDate><guid>https://tab.deoops.com/posts/try-wireguard/</guid><description>&lt;img src="https://tab.deoops.com/posts/try-wireguard/site-to-site-complex.svg" alt="Featured image of post 安装wireguard" />&lt;p>今天在hacker news上看到 wireguard macos client 发布了，决定试用一下。&lt;/p>
&lt;p>和所有的vpn安装一样，wireguard的安装也是分两步，一是安装vpn server，二是安装 vpn的client。
安装不分先后，配置先配置server，然后在配置client。&lt;/p>
&lt;h2 id="服务端">服务端&lt;/h2>
&lt;h3 id="安装">安装&lt;/h3>
&lt;p>服务器为 RHEL 7.6 (Maipo)， 服务端的安装流程:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>sudo -i
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat /etc/redhat-release&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Red Hat Enterprise Linux Server release 7.6 &lt;span class="o">(&lt;/span>Maipo&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># echo &amp;#34;net.ipv4.ip_forward = 1&amp;#34; &amp;gt;&amp;gt; /etc/sysctl.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># sysctl -p&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### install packages&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># curl -Lo /etc/yum.repos.d/wireguard.repo https://copr.fedorainfracloud.org/coprs/jdoss/wireguard/repo/epel-7/jdoss-wireguard-epel-7.repo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># yum install -y epel-release wireguard-dkms wireguard-tools&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># yum install -y epel-release&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># rpm -ivh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># yum update -y&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># yum install -y epel-release wireguard-dkms wireguard-tools&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># init 6&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="配置">配置&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### wireguard server conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat wg.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Interface&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ListenPort&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">58855&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PrivateKey&lt;/span> &lt;span class="o">=&lt;/span> private_key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Peer&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PublicKey&lt;/span> &lt;span class="o">=&lt;/span> public_key_one
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#AllowedIPs = 0.0.0.0/0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">AllowedIPs&lt;/span> &lt;span class="o">=&lt;/span> 10.0.0.7/32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Peer&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PublicKey&lt;/span> &lt;span class="o">=&lt;/span> public_key_two
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#AllowedIPs = 0.0.0.0/0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">AllowedIPs&lt;/span> &lt;span class="o">=&lt;/span> 10.0.0.9/32
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="启动wg0设备">启动wg0 设备&lt;/h3>
&lt;p>记得加上&lt;code>iptables&lt;/code>设置：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### start wg0 device&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat start-wireguard.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip l a dev wg0 &lt;span class="nb">type&lt;/span> wireguard
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip a a dev wg0 10.0.0.1/24
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> wg setconf wg0 wg.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip l &lt;span class="nb">set&lt;/span> up dev wg0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> iptables -A FORWARD -i wg0 -j ACCEPT&lt;span class="p">;&lt;/span> iptables -A FORWARD -o wg0 -j ACCEPT&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="客户端">客户端&lt;/h2>
&lt;h3 id="下载">下载&lt;/h3>
&lt;p>在app store可以直接下载wireguard 客户端。&lt;/p>
&lt;p>如果是中国大陆的app store， 则需要修改Apple ID的国家和地区才能下载wireguard客户端。&lt;/p>
&lt;h3 id="配置-1">配置&lt;/h3>
&lt;p>注意 &lt;code>[Peer]&lt;/code>的 Endpoint 和服务器端的&lt;code>[Interface]&lt;/code>对上（都是58855端口)：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Interface]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">PrivateKey&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">private_key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ListenPort&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">54123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Address&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">10.0.0.9/32&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">DNS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">8.8.8.8, 1.1.1.1, 1.0.0.1, 8.8.4.4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Peer]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">PublicKey&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">server_public_key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">AllowedIPs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">0.0.0.0/0, ::/0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Endpoint&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">server_address:58855&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">PersistentKeepalive&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">30&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="折腾调试">折腾调试&lt;/h2>
&lt;p>安装完成后，可能会遇到vpn不通的问题，可以安装下面介绍的 
&lt;code>udp&lt;/code> port troubleshoot方法调试调试：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># nc on client to scan, and tcpdump on server side&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### client side&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ ~ nc -vz -u server &lt;span class="m">58885&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## the -z option to perform a scan instead of attempting to initiate a connection.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### server side&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># yum install tcpdump&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># tcpdump -i eth0 udp port 58855 -vv -X&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="后记">后记&lt;/h2>
&lt;p>体验一天，大体说来，wireguard比shadowsocks 速度快上6到8倍。&lt;/p>
&lt;h3 id="kernel-update">kernel update&lt;/h3>
&lt;p>当我们对主机执行升级Linux kernel操作之后，需要重新load wireguard mod，否则 &lt;code>ip link add ...&lt;/code>wg0的时候会报错。&lt;/p>
&lt;p>这个时候 删除旧的 dkms mod， 然后add新的wireguard mod即可：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">dkms status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls /var/lib/dkms/wireguard/0.0.20191206/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /var/lib/dkms/wireguard/0.0.20191206/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /var/lib/dkms/wireguard/0.0.20200105/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /var/lib/dkms/wireguard/0.0.20191206
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /var/lib/dkms/wireguard/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf /var/lib/dkms/wireguard/kernel-4.18.0-80.11.2.el8_0.x86_64-x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dkms status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dkms add -m wireguard/0.0.20200105
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dkms status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /etc/wireguard/wg0.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wg-quick up /etc/wireguard/wg0.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>挂载硬盘</title><link>https://tab.deoops.com/posts/load-disk/</link><pubDate>Fri, 18 Oct 2019 10:03:07 +0800</pubDate><guid>https://tab.deoops.com/posts/load-disk/</guid><description>&lt;img src="https://tab.deoops.com/posts/load-disk/disk.jpeg" alt="Featured image of post 挂载硬盘" />&lt;h2 id="update-more-user-friendly">update: more user friendly&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#bin/bash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mustBeRoot&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>id -u&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;0&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;只有root用户才能运行&amp;#34;&lt;/span> 1&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;当前登录用户`whoami`&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 数据盘挂载&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checkAndMountDataDisk&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;选择数据盘/分区 ：&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fdisk -l &lt;span class="p">|&lt;/span> grep /dev &lt;span class="p">|&lt;/span> grep G &lt;span class="p">|&lt;/span> cut -f &lt;span class="m">1&lt;/span> -d ,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34; &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">read&lt;/span> -p &lt;span class="s2">&amp;#34;请输入硬盘/分区 名：/dev/&amp;#34;&lt;/span> -r disk_name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">disk_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>blkid &lt;span class="p">|&lt;/span> grep &lt;span class="nv">$disk_name&lt;/span>&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -ne &lt;span class="m">0&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;获取硬盘/分区 &lt;/span>&lt;span class="nv">$disk_name&lt;/span>&lt;span class="s2"> uuid失败，请检查名称是否准确&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">disk_path&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$disk_id&lt;/span> &lt;span class="p">|&lt;/span> cut -f &lt;span class="m">1&lt;/span> -d &lt;span class="s1">&amp;#39;:&amp;#39;&lt;/span> &lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;已选择 &lt;/span>&lt;span class="nv">$disk_path&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">disk_uuid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>blkid &lt;span class="nv">$disk_path&lt;/span> &lt;span class="p">|&lt;/span> cut -f &lt;span class="m">2&lt;/span> -d &lt;span class="s1">&amp;#39;&amp;#34;&amp;#39;&lt;/span> &lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">disk_info&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>lsblk -f &lt;span class="nv">$disk_path&lt;/span> &lt;span class="p">|&lt;/span> grep &lt;span class="nv">$disk_uuid&lt;/span> &lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -ne &lt;span class="m">0&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;获取硬盘/分区 &lt;/span>&lt;span class="nv">$disk_path&lt;/span>&lt;span class="s2"> 详细信息失败，请检查名称是否正确&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">fs_type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$disk_info&lt;/span> &lt;span class="p">|&lt;/span> cut -f &lt;span class="m">2&lt;/span> -d &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$fs_type&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;ext4&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;硬盘文件系统格式不是ext4。&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">read&lt;/span> -p &lt;span class="s2">&amp;#34;是否格式化为 ext4？ 输入 y 同意格式化&amp;#34;&lt;/span> -r format_ext4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$format_ext4&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;y&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;未格式化 &lt;/span>&lt;span class="nv">$disk_path&lt;/span>&lt;span class="s2"> 文件系统格式，退出安装脚本。&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;即将格式化 &lt;/span>&lt;span class="nv">$disk_path&lt;/span>&lt;span class="s2"> 文件系统格式....&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkfs.ext4 &lt;span class="nv">$disk_path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -d &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;数据盘挂载点/data目录已存在&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;创建数据盘挂载点/data目录&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkdir &lt;span class="nv">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mount &lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$disk_uuid&lt;/span> &lt;span class="nv">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;UUID=&lt;/span>&lt;span class="nv">$disk_uuid&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2"> ext4 defaults 0 0&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/fstab
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;硬盘挂载成功&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checkDataMountpoint&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;挂载数据盘&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> grep &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> /etc/fstab &lt;span class="p">|&lt;/span> grep ext4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -ne &lt;span class="m">0&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> checkAndMountDataDisk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;数据盘已挂载&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mount -a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpAndUntar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mustBeRoot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checkDataMountpoint &lt;span class="si">${&lt;/span>&lt;span class="nv">1&lt;/span>&lt;span class="p">-/data&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="lsblk">lsblk&lt;/h2>
&lt;p>首先使用&lt;code>lsblk&lt;/code>查看当前系统硬盘挂载的情况&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@dev-7 ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># lsblk&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sr0 11:0 &lt;span class="m">1&lt;/span> 1024M &lt;span class="m">0&lt;/span> rom
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vda 253:0 &lt;span class="m">0&lt;/span> 40G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─vda1 253:1 &lt;span class="m">0&lt;/span> 40G &lt;span class="m">0&lt;/span> part /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vdb 253:16 &lt;span class="m">0&lt;/span> 200G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─vdb1 253:17 &lt;span class="m">0&lt;/span> 200G &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="format-and-mount">format and mount&lt;/h2>
&lt;p>格式化硬盘然后挂载到&lt;code> /media/newdrive&lt;/code> 目录&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### disk_add_new.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">function&lt;/span> set_vars&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">fs_ty&lt;/span>&lt;span class="o">=&lt;/span>ext4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">mount_point&lt;/span>&lt;span class="o">=&lt;/span>/media/newdrive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#check=`fdisk -l | grep GB | cut -d &amp;#39;:&amp;#39; -f1 | cut -c 6-`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#new_disk=`echo $check | cut -d &amp;#39; &amp;#39; -f 2`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">new_disk&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># new_disk=${check##*\ }&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">function&lt;/span> make_file_system&lt;span class="o">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkfs -t &lt;span class="nv">$fs_ty&lt;/span> &lt;span class="nv">$new_disk&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">function&lt;/span> get_uuid&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">uuid_info&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>blkid &lt;span class="nv">$new_disk&lt;/span>&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">uuid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">uuid_info&lt;/span>&lt;span class="p">#*UUID&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$uuid&lt;/span> &lt;span class="p">|&lt;/span> cut -d &lt;span class="s1">&amp;#39;&amp;#34;&amp;#39;&lt;/span> -f 2&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">function&lt;/span> mount_and_auto_mount&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkdir -p &lt;span class="nv">$mount_point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mount -t &lt;span class="nv">$fs_ty&lt;/span> &lt;span class="nv">$new_disk&lt;/span> &lt;span class="nv">$mount_point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> grep &lt;span class="nv">$id&lt;/span> /etc/fstab &lt;span class="o">||&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$id&lt;/span> &lt;span class="nv">$mount_point&lt;/span> &lt;span class="nv">$fs_ty&lt;/span> defaults &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &amp;gt;&amp;gt; /etc/fstab
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">function&lt;/span> run&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set_vars &lt;span class="nv">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> make_file_system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> get_uuid
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> &lt;span class="si">${#&lt;/span>&lt;span class="nv">id&lt;/span>&lt;span class="si">}&lt;/span> -gt &lt;span class="m">30&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mount_and_auto_mount
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">run &lt;span class="nv">$1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="扩容">扩容&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">mount_point&lt;/span>&lt;span class="o">=&lt;/span>/media/newdrive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># check=`fdisk -l | grep GB | cut -d &amp;#39;:&amp;#39; -f1 | cut -c 6-`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># disk=`echo $check | cut -d &amp;#39; &amp;#39; -f 2`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">disk&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$1&lt;/span> &lt;span class="c1"># /dev/sdb sdc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">fs_ty&lt;/span>&lt;span class="o">=&lt;/span>ext4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">e2fsck -f &lt;span class="nv">$disk&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">resize2fs &lt;span class="nv">$disk&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -t &lt;span class="nv">$fs_ty&lt;/span> &lt;span class="nv">$disk&lt;/span> &lt;span class="nv">$mount_point&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="逻辑卷">逻辑卷&lt;/h2>
&lt;h3 id="创建逻辑卷">创建逻辑卷&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">pvcreate /dev/vdb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vgcreate vg02 /dev/vdb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lvcreate -l 90%free -n kubelet vg02
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkfs.xfs -n &lt;span class="nv">ftype&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span> /dev/vg02/kubelet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/vg02/kubelet /var/lib/kubelet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;/dev/mapper/vg02-kubelet /var/lib/kubelet xfs defaults 0 0 &amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/fstab
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="扩容逻辑卷">扩容逻辑卷&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 1. 删除未挂载的逻辑卷&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> lvremove vg02/kubelet &lt;span class="c1"># lvremove vg02&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 2. 删除kubelet的磁盘&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vgreduce vg02 /dev/vdb &lt;span class="c1"># vgremove vg02&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 3. 将原来的磁盘加到别的vg&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vgextend vg01 /dev/vdb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 4. 扩容逻辑卷&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> lvextend -L +200G /dev/vg01/var
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 5. 生效&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> xfs_groups /dev/vg01/var
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 6. 删除/etc/fstab 中kubelet的挂载点&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## vim /etc/fstab +5dd&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="troubleshoot">troubleshoot&lt;/h3>
&lt;p>有时候删除逻辑卷会遇到报错&lt;code>Logical volume vg01/LVgdb contains a filesystem in use&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@cnsz92vl14311 ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># umount /dev/vg01/LVgdb &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@cnsz92vl14311 ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># lvremove /dev/vg01&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Do you really want to remove active logical volume LVgdb? &lt;span class="o">[&lt;/span>y/n&lt;span class="o">]&lt;/span>: y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Logical volume &lt;span class="s2">&amp;#34;LVgdb&amp;#34;&lt;/span> successfully removed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@cnsz92vl14311 ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># lsblk&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vda 252:0 &lt;span class="m">0&lt;/span> 60G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─vda1 252:1 &lt;span class="m">0&lt;/span> 476M &lt;span class="m">0&lt;/span> part /boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─vda2 252:2 &lt;span class="m">0&lt;/span> 59.5G &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ├─vg00-root 253:0 &lt;span class="m">0&lt;/span> 10G &lt;span class="m">0&lt;/span> lvm /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ├─vg00-home 253:1 &lt;span class="m">0&lt;/span> 500M &lt;span class="m">0&lt;/span> lvm /home
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ├─vg00-var 253:2 &lt;span class="m">0&lt;/span> 10G &lt;span class="m">0&lt;/span> lvm /var
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ├─vg00-tmp 253:3 &lt;span class="m">0&lt;/span> 10G &lt;span class="m">0&lt;/span> lvm /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─vg00-app 253:4 &lt;span class="m">0&lt;/span> 29G &lt;span class="m">0&lt;/span> lvm /app
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vdb 252:16 &lt;span class="m">0&lt;/span> 300G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@cnsz92vl14311 ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>证书问题</title><link>https://tab.deoops.com/posts/container-ca/</link><pubDate>Thu, 12 Sep 2019 10:11:32 +0800</pubDate><guid>https://tab.deoops.com/posts/container-ca/</guid><description>&lt;img src="https://tab.deoops.com/posts/container-ca/common-ca.png" alt="Featured image of post 证书问题" />&lt;p>&lt;code>docker run&lt;/code>调试某个container报如下所示&lt;code>x509&lt;/code>证书错误，一开始怀疑是容器网络（&lt;code>--network host&lt;/code>) 的问题 :&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>deoops@dev-3 ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># docker run --network host datewu/controller:v0.0.2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;panic&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;error&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;Get https://google.com: x509: certificate signed by unknown authority&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;time&amp;#34;&lt;/span>:1555498448,&lt;span class="s2">&amp;#34;message&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;get max item failed&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">panic: get max item failed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">goroutine &lt;span class="m">26&lt;/span> &lt;span class="o">[&lt;/span>running&lt;span class="o">]&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">github.com/rs/zerolog.&lt;span class="o">(&lt;/span>*Logger&lt;span class="o">)&lt;/span>.Panic.func1&lt;span class="o">(&lt;/span>0x7773e9, 0x13&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /Users/deoops/go/pkg/mod/github.com/rs/zerolog@v1.13.0/log.go:307 +0x4f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">github.com/rs/zerolog.&lt;span class="o">(&lt;/span>*Event&lt;span class="o">)&lt;/span>.msg&lt;span class="o">(&lt;/span>0xc00012e8a0, 0x7773e9, 0x13&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /Users/deoops/go/pkg/mod/github.com/rs/zerolog@v1.13.0/event.go:141 +0x1c1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">github.com/rs/zerolog.&lt;span class="o">(&lt;/span>*Event&lt;span class="o">)&lt;/span>.Msg&lt;span class="o">(&lt;/span>...&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /Users/deoops/go/pkg/mod/github.com/rs/zerolog@v1.13.0/event.go:105
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">main.catchUp&lt;span class="o">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /Users/deoops/github/controller/work.go:69 +0x326
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">main.populate&lt;span class="o">(&lt;/span>0xc000114000&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /Users/deoops/github/controller/worker.go:10 +0x26
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">created by main.initWork
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /Users/deoops/github/controller/work.go:84 +0x7f
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>错误信息大概是说 client 不能识别google的https 证书， 可能是base image &lt;code>alpine&lt;/code>的问题。&lt;/p>
&lt;p>将&lt;code>base image&lt;/code>改为 &lt;code>scratch&lt;/code> ，结果还是会报&lt;code>x509&lt;/code>错。&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>给 &lt;code>alpine&lt;/code>镜像 &lt;a class="link" href="https://support.circleci.com/hc/en-us/articles/360016505753-Resolve-Certificate-Signed-By-Unknown-Authority-error-in-Alpine-images" target="_blank" rel="noopener"
>加上ca-certificates&lt;/a>解决了问题:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span class="line">&lt;span class="cl">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> alpine&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># add Common CA certificates PEM files&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> apk --no-cache add ca-certificates&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># ....&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># docker build -t datewu/alpine-ca .&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>以后用到&lt;code>alpine&lt;/code>的Dockerfile 直接 &lt;code>FROM datewu/alpine-ca&lt;/code> 问题解决啦😄&lt;/p>
&lt;blockquote>
&lt;p>总结一下：当容器里的进程访问外部tls server时，如果容器内没有配置Common CA certificates，客户端就会出现无法识别server证书的问题。&lt;/p>
&lt;/blockquote>
&lt;p>ps:
今天在写字楼二楼快餐店吃晚饭的时候，遇到两个建筑工人，50-60岁的样子，像是夫妻。&lt;/p>
&lt;p>两个人一起打才吃了10块钱：一人一个素菜，豆芽菜和黑油白。&lt;/p>
&lt;p>pps：快餐店下午的汤是免费的，所以他们一人又拿了一碗汤，&lt;/p>
&lt;p>回想起今天我过早才就吃了10块钱，嗟乎唏嘘。&lt;/p></description></item><item><title>细说kubeconfig</title><link>https://tab.deoops.com/posts/explain-kubeconfig/</link><pubDate>Sun, 11 Aug 2019 22:09:21 +0800</pubDate><guid>https://tab.deoops.com/posts/explain-kubeconfig/</guid><description>&lt;img src="https://tab.deoops.com/posts/explain-kubeconfig/kubeconfig.png" alt="Featured image of post 细说kubeconfig" />&lt;p>今天准备管理某一个kubernetes 集群时发现master主机22端口因为管理的需要被禁用了，无法登陆服务器。&lt;/p>
&lt;p>问了一下运维人员，原来是基于安全原因，公司决定禁用所有服务器的&lt;code>root ssh&lt;/code>登陆权限，&lt;/p>
&lt;p>平时我都是ssh 登陆到master node，在服务器上直接使用kubectl命令 查看/部署/debug deployment/service等资源，&lt;/p>
&lt;p>现在只好修改下本地 kubeconfig 文件，用自己本地的 &lt;code>kubectl&lt;/code> 管理/操作kubernetes集群。&lt;/p>
&lt;p>操作了一段时间后，发现用本地kubectl操作kubernetes体验蛮好的，特别是服务器缺少本地editor(vim) &lt;code>kubectl edit ...&lt;/code> 的语法高亮支持。&lt;/p>
&lt;p>配置kubeconfig过程分享如下，大体上说过就两步：&lt;/p>
&lt;ol>
&lt;li>添加 context；&lt;/li>
&lt;li>use context。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">vim .kube/config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl config use-context dev-8-admin@kubernetes
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>除了使用vim 编辑 &lt;code>.kube/config&lt;/code> 文件，对于一些简单的配置也可以使用&lt;code>kubectl config&lt;/code> command 快速配置kubeconfig：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## create new cluster&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kubectl config set-cluster NAME &lt;span class="o">[&lt;/span>--server&lt;span class="o">=&lt;/span>server&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>--certificate-authority&lt;span class="o">=&lt;/span>path/to/certificate/authority&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>--insecure-skip-tls-verify&lt;span class="o">=&lt;/span>true&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## create new user&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl config set-credentials NAME &lt;span class="o">[&lt;/span>--client-certificate&lt;span class="o">=&lt;/span>path/to/certfile&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>--client-key&lt;span class="o">=&lt;/span>path/to/keyfile&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>--token&lt;span class="o">=&lt;/span>bearer_token&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>--username&lt;span class="o">=&lt;/span>basic_user&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>--password&lt;span class="o">=&lt;/span>basic_password&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>--auth-provider&lt;span class="o">=&lt;/span>provider_name&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>--auth-provider-arg&lt;span class="o">=&lt;/span>&lt;span class="nv">key&lt;/span>&lt;span class="o">=&lt;/span>value&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## create new context&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl config set-context &lt;span class="o">[&lt;/span>NAME &lt;span class="p">|&lt;/span> --current&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>--cluster&lt;span class="o">=&lt;/span>cluster_nickname&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>--user&lt;span class="o">=&lt;/span>user_nickname&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>--namespace&lt;span class="o">=&lt;/span>namespace&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## use context&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl config use-context CONTEXT_NAME &lt;span class="o">[&lt;/span>options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>另外，&lt;code>kubectl config set&lt;/code> 不支持对 &lt;code>certificate-authority-data&lt;/code>字段的设置，只支持指定data文件的路径， 所以推荐用vim 编辑kubeconfig文件。&lt;/p>
&lt;h2 id="kuebconfig-demo">kuebconfig demo&lt;/h2>
&lt;p>下面是一份配置好的 kubeconfig demo文件，供参考:
（略去了client 的证书, private key等敏感信息）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">clusters&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">cluster&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">certificate-authority-data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">YOUR kubernete CA BASE64 DATA &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://test-8:9443&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dev-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">cluster&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">certificate-authority&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/Users/r/.minikube/ca.crt&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://192.168.99.117:8443&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">minikube&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">contexts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">context&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cluster&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dev-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">user&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dev-8-admin&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dev-8-admin@kubernetes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">context&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cluster&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">minikube&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">user&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">minikube&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">minikube&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">current-context&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test-8-admin@kubernetes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Config&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">preferences&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">users&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dev-8-admin&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">user&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">client-certificate-data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">YOUR client CERT BASE64 DATA&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">client-key-data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">YOUR client PRIVATE KEY DATA&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">minikube&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">user&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">client-certificate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/Users/r/.minikube/client.crt&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">client-key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/Users/r/.minikube/client.key&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="kubecofig-字段解释">kubecofig 字段解释&lt;/h3>
&lt;p>kubeconfig是什么，以及上面的编辑过程到底做了什么：&lt;/p>
&lt;p>kubeconfig 是一个配置文件，这个配置文件使用了 yaml 文件的语法，主要记录了kubernetes 集群的认证信息。&lt;/p>
&lt;p>kubectl 或者是其它的kubernetes client通过&lt;strong>解析kubeconfig文件&lt;/strong>得到kubernetes cluster的认证信息，从而使用/管理 kubernetes 集群。&lt;/p>
&lt;p>安装kubectl的时候，&lt;code>~/.kube/config&lt;/code>文件就是一个kubeconfig，而且可以配置管理多个kubernetes集群。&lt;/p>
&lt;p>kubeconfig的可读性很高，建议仔细通读下。&lt;/p>
&lt;p>一个kubeconfig文件包含了3个对象， 一种关系:&lt;/p>
&lt;p>一个 kubeconfg 可以包含 多个 context，多个 cluster， 多个 user。 每个 context 由一个cluster 和 user 组成。&lt;/p>
&lt;p>cluster由 apiserver地址， server ca 信息，和cluster name 组成。&lt;/p>
&lt;p>user (user 的定义其实就是 kubernetes client 的 auth 定义) 的定义相对灵活些：&lt;/p>
&lt;ol>
&lt;li>可以是我上面贴出来的 certificate 认证信息；&lt;/li>
&lt;li>也可以是 username/password 的认证信息(k3s 的kubeconfig 就是用的这种)；&lt;/li>
&lt;li>或者是用serviceAccount 的 token认证也可以，&lt;/li>
&lt;/ol>
&lt;p>总的说来一份auth 信息 和 一个name 对应了一个user 的定义。&lt;/p>
&lt;p>大家应该注意到了 cluster 和 user 的组合&lt;strong>可以很灵活&lt;/strong>，从而产生多种 context。&lt;/p>
&lt;h2 id="client-go操作kubecofig">client-go操作kubecofig&lt;/h2>
&lt;h3 id="marshal">marshal&lt;/h3>
&lt;p>把 &lt;code>restclient.Config&lt;/code> 编码保存到文件：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;clientcmdapi &amp;#34;&lt;/span>&lt;span class="nx">k8s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">io&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="k">go&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">tools&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">clientcmd&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">api&lt;/span>&lt;span class="s">&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> &amp;#34;&lt;/span>&lt;span class="nx">k8s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">io&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="k">go&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">tools&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">clientcmd&lt;/span>&lt;span class="err">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 节选，有删减
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">snipedDumpKubeconfig&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">globalKubeCfg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">clientcmdapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewConfig&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">globalKubeCfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Clusters&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">clusterName&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">clientcmdapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewCluster&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">globalKubeCfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Clusters&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">clusterName&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">Server&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Host&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">globalKubeCfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Clusters&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">clusterName&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">CertificateAuthorityData&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CAData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">globalKubeCfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AuthInfos&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">authName&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">clientcmdapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewAuthInfo&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">globalKubeCfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AuthInfos&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">authName&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">ClientCertificateData&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CertData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">globalKubeCfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AuthInfos&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">authName&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">ClientKeyData&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">KeyData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">globalKubeCfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Contexts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">contextName&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">clientcmdapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewContext&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">globalKubeCfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Contexts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">contextName&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">Cluster&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">clusterName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">globalKubeCfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Contexts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">contextName&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">AuthInfo&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">authName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">clientcmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WriteToFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">globalKubeCfg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">globalKubeconfFile&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="unmarshal">unmarshal&lt;/h3>
&lt;p>由 kubeconfig文件生成 &lt;code>restclient.Config&lt;/code>：
在官方的 &lt;code>k8s.io/client-go/tools/clientcmd&lt;/code> 包中可以找到example：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// RESTConfigFromKubeConfig is a convenience method to give back a restconfig from your kubeconfig bytes.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// For programmatic access, this is what you want 80% of the time
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">RESTConfigFromKubeConfig&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">configBytes&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">restclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">clientConfig&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">NewClientConfigFromBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">configBytes&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">clientConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ClientConfig&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// BuildConfigFromFlags is a helper function that builds configs from a master
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// url or a kubeconfig filepath. These are passed in as command line flags for cluster
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// components. Warnings should reflect this usage. If neither masterUrl or kubeconfigPath
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// are passed in we fallback to inClusterConfig. If inClusterConfig fails, we fallback
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// to the default config.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">BuildConfigFromFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">masterUrl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">kubeconfigPath&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">restclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">kubeconfigPath&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">masterUrl&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Warningf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Neither --kubeconfig nor --master was specified. Using the inClusterConfig. This might not work.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">kubeconfig&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">restclient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">InClusterConfig&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">kubeconfig&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Warning&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error creating inClusterConfig, falling back to default config: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nf">NewNonInteractiveDeferredLoadingClientConfig&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">ClientConfigLoadingRules&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ExplicitPath&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">kubeconfigPath&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">ConfigOverrides&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ClusterInfo&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">clientcmdapi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Cluster&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Server&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">masterUrl&lt;/span>&lt;span class="p">}}).&lt;/span>&lt;span class="nf">ClientConfig&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Systemd配置问题</title><link>https://tab.deoops.com/posts/systemd-conf/</link><pubDate>Sat, 11 May 2019 16:02:39 +0800</pubDate><guid>https://tab.deoops.com/posts/systemd-conf/</guid><description>&lt;img src="https://tab.deoops.com/posts/systemd-conf/Systemd_components.svg" alt="Featured image of post Systemd配置问题" />&lt;h2 id="问题">问题&lt;/h2>
&lt;p>用 kubeadm 部署 kubernetes 集群，启动kubelet服务后，kubelet daemon 会认为 &lt;code>/etc/sysconfig/kubelet&lt;/code>内容的优先级更高，&lt;/p>
&lt;p>覆盖&lt;code>KUBELET_EXTRA_ARGS&lt;/code>环境变量&lt;code>--pod-infra-container-image&lt;/code>的配置内容。&lt;/p>
&lt;h3 id="分析">分析&lt;/h3>
&lt;h4 id="kubeletservice文件">kubelet.service文件&lt;/h4>
&lt;p>首先查看&lt;code>/etc/systemd/system/kubelet.service&lt;/code>文件:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># cat /etc/systemd/system/kubelet.service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Unit]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Description&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">kubelet: The Kubernetes Node Agent&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Documentation&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">https://kubernetes.io/docs/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Service]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/usr/bin/kubelet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Restart&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">always&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">StartLimitInterval&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">RestartSec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Install]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">WantedBy&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">multi-user.target&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意第5行的ExecStart指令为&lt;code>/usr/bin/kubelet&lt;/code>&lt;/p>
&lt;h4 id="kubeletserviced-目录">kubelet.service.d 目录&lt;/h4>
&lt;p>然后查看kubelet服务的配置目录&lt;code>/etc/systemd/system/kubelet.service.d/&lt;/code>，注意
&lt;code>kubeadm&lt;/code>会在这里创建一个10-kubeadm.conf文件来配置&lt;code>kubelet&lt;/code>启动方式（参数）。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Note: This dropin only works with kubeadm and kubelet v1.11+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Service]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Environment&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Environment&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This is a file that &amp;#34;kubeadm init&amp;#34; and &amp;#34;kubeadm join&amp;#34; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">EnvironmentFile&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">-/var/lib/kubelet/kubeadm-flags.env&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">EnvironmentFile&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">-/etc/sysconfig/kubelet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置文件的load的顺序是以字母顺序排列的， 如果我们也在这里创建了kubelet的配置文件，比如20-my-kubelet.conf，&lt;code>10-*&lt;/code>会先被读取，&lt;code>20-*&lt;/code>其次。&lt;/p>
&lt;p>注意&lt;code>10-kubeadm.conf&lt;/code>文件的倒数第二行&lt;code>ExecStart=空行&lt;/code>，这一行等效于&lt;code>kubeadm&lt;/code>覆盖了上面&lt;a class="link" href="#kubeletservice%e6%96%87%e4%bb%b6" >kubelet.service&lt;/a> 的ExecStart指令！&lt;/p>
&lt;h3 id="结论">结论&lt;/h3>
&lt;p>&lt;code>[Service]&lt;/code>覆盖和充值特性。&lt;/p>
&lt;p>ExecStart参数特性：如果已经设置&lt;code>ExecStart&lt;/code>指令参数， 后续ExecStart指令会叠加所有的参数，顺序apply所有指令。&lt;/p>
&lt;p>如果想要清空前面的&lt;code>ExecStart&lt;/code>指令，则需要写一行空的&lt;code>ExecStart=&lt;/code>,然后写新的ExecStart=&amp;hellip;&amp;hellip;指令。&lt;/p>
&lt;p>同理&lt;code>KUBELET_EXTRA_ARGS&lt;/code>也会有覆盖和清空的语法。&lt;/p>
&lt;p>目前我们&lt;code>/etc/systemd/system/kubelet.service.d/20-my-kubelet.conf&lt;/code>文件是这样的：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Service]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Environment&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;KUBELET_EXTRA_ARGS=--pod-infra-container-image=172.20.8.4/library/pause:3.1 --feature-gates=LocalStorageCapacityIsolation=true \&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">--kube-reserved-cgroup&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/kubepods.slice --kube-reserved=cpu=500m,memory=500Mi,ephemeral-storage=1Gi \&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">--system-reserved-cgroup&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/system.slice --system-reserved=cpu=500m,memory=500Mi,ephemeral-storage=1Gi \&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">--eviction-hard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">memory.available&amp;lt;500Mi,nodefs.available&amp;lt;10%&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>表面上看 &lt;code>20-my-kubelet.conf&lt;/code>追加了&lt;code>KUBELET_EXTRA_ARGS&lt;/code>环境变量，应该是成功的配置了&lt;code>--pod-infra-container-image&lt;/code>参数，&lt;/p>
&lt;p>但是在&lt;code>10-kubeadm.conf&lt;/code>文件里已经定义&lt;code>EnvironmentFile=-/etc/sysconfig/kubelet&lt;/code>，然后
在&lt;code>/etc/sysconfig/kubelet&lt;/code>里有一句&lt;code>KUBELET_EXTRA_ARGS=&lt;/code>，等于号后面无值，清空了&lt;code>KUBELET_EXTRA_ARGS&lt;/code>环境变量。&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>删除20-my-kubelet.conf文件，直接在/etc/systemconf/kubelet中定义KUBELET_EXTRA_ARGS参数定义：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># cat /etc/systemconf/kubelet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#KUBELET_EXTRA_ARGS=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">KUBELET_EXTRA_ARGS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">--pod-infra-container-image=192.168.9.20/library/pause:3.1 --feature-gates=LocalStorageCapacityIsolation=true \&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">--kube-reserved-cgroup&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/kubepods.slice --kube-reserved=cpu=500m,memory=500Mi,ephemeral-storage=1Gi \&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">--system-reserved-cgroup&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/system.slice --system-reserved=cpu=500m,memory=500Mi,ephemeral-storage=1Gi \&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">--eviction-hard&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">memory.available&amp;lt;500Mi,nodefs.available&amp;lt;10%&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>修改完配置文件后，执行&lt;code>kubeadm init&lt;/code>可以看到 &lt;code>pod-infra-contrainer-image&lt;/code>配置生效了。&lt;/p>
&lt;p>参考&lt;a class="link" href="https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files" target="_blank" rel="noopener"
>systemd config&lt;/a>&lt;/p></description></item><item><title>Neutron小记</title><link>https://tab.deoops.com/posts/neutron-port/</link><pubDate>Sun, 21 Apr 2019 18:39:27 +0800</pubDate><guid>https://tab.deoops.com/posts/neutron-port/</guid><description>&lt;img src="https://tab.deoops.com/posts/neutron-port/Neutron-Networking-CompNet-v1.png" alt="Featured image of post Neutron小记" />&lt;p>前段时间的花了很多功夫对接k8s和openstack的kuryr-kubernetes网路组件。
学到了很多openstack的知识，今天抽出时间来整理下。&lt;/p>
&lt;h2 id="client">client&lt;/h2>
&lt;p>首先是 install openstack-cli neutron client：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat /etc/redhat-release&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Red Hat Enterprise Linux Server release 7.5 &lt;span class="o">(&lt;/span>Maipo&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#### add openstack yum repo source&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># vi /etc/yum.repos.d/openstack.repo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># yum install -y python2-openstackclient openstack-neutron&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops shells&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat source&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">OS_PROJECT_DOMAIN_NAME&lt;/span>&lt;span class="o">=&lt;/span>default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">OS_USER_DOMAIN_NAME&lt;/span>&lt;span class="o">=&lt;/span>default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">OS_PROJECT_NAME&lt;/span>&lt;span class="o">=&lt;/span>your_project_name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">OS_USERNAME&lt;/span>&lt;span class="o">=&lt;/span>your_use_name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">OS_PASSWORD&lt;/span>&lt;span class="o">=&lt;/span>your_pwd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">OS_AUTH_URL&lt;/span>&lt;span class="o">=&lt;/span>http://10.8.1.3:35357/v3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">OS_IDENTITY_API_VERSION&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">OS_IMAGE_API_VERSION&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="vip">vip&lt;/h3>
&lt;p>我们来创建一个&lt;code>virtual IP&lt;/code>验证上一步配置的openstack source对不对 ：&lt;/p>
&lt;ol>
&lt;li>创建 vip 对应的port;&lt;/li>
&lt;li>把 上一步创建好的port加入到 vm ip对应port 的 &lt;code>allow-address-pairs&lt;/code> 属性中;&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops shells&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat vip.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">. ./source
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">network&lt;/span>&lt;span class="o">=&lt;/span>your_network_id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### i&amp;#39;ve comment out the create Port operation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#subnet=you_subnet_id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#for i in {62..64}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># echo $i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># neutron port-create --fixed-ip subnet_id=$subnet,ip_address=10.0.1.$i --device-owner &amp;#39;Virtual IP&amp;#39; --no-security-groups --name &amp;#39;Virtual IP&amp;#39; $network&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># openstack port list | grep -E &amp;#39;10.0.1.6(2|3|4)&amp;#39; | cut -d &amp;#39;|&amp;#39; -f 4,5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#p1=mac_address=fa:16:3e:aa:6b:68,ip_address=&amp;#39;10.0.1.64&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#p2=mac_address=fa:16:3e:1d:11:2d,ip_address=&amp;#39;10.0.1.62&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#p3=mac_address=fa:16:3e:b8:47:f9,ip_address=&amp;#39;10.0.1.63&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">p1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">ip_address&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;10.0.1.64&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">p2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">ip_address&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;10.0.1.62&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">p3&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">ip_address&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;10.0.1.63&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">p4&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">ip_address&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;10.0.1.80&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#for p in `neutron port-list --device-owner compute:nova -f value | grep -E &amp;#39;10.0.1.5(1|2|3)&amp;#39; | cut -d &amp;#39; &amp;#39; -f 1 `;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> p in &lt;span class="sb">`&lt;/span>neutron port-list --device-owner compute:nova -f value &lt;span class="p">|&lt;/span> grep -E &lt;span class="s1">&amp;#39;10.0.1&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> cut -d &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span> -f &lt;span class="m">1&lt;/span> &lt;span class="sb">`&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$p&lt;/span> &lt;span class="nv">$p1&lt;/span> &lt;span class="nv">$p2&lt;/span> &lt;span class="nv">$p3&lt;/span> &lt;span class="nv">$p4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">### must NOT set virtual ip Port macaddress&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">### leave it empty to use host port macaddress&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neutron port-update &lt;span class="nv">$p&lt;/span> --allowed-address-pair &lt;span class="nv">$p1&lt;/span> --allowed-address-pair &lt;span class="nv">$p2&lt;/span> --allowed-address-pair &lt;span class="nv">$p3&lt;/span> --allowed-address-pair &lt;span class="nv">$p4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="create-port">create port&lt;/h3>
&lt;p>申请创建&lt;code>port&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops shells&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat create-port.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#!/bin/bash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">. ./source
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">network&lt;/span>&lt;span class="o">=&lt;/span>your_network_id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">subnet&lt;/span>&lt;span class="o">=&lt;/span>your_subnetwork_id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">function&lt;/span> setup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#i=$1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#ip_addr=10.0.1.$((i+1))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;going to create ip ...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#neutron port-create --fixed-ip subnet_id=$subnet,ip_address=$ip_addr --device-owner &amp;#39;compute:kuryr&amp;#39; --no-security-groups --name &amp;#39;concurrent load test IP&amp;#39; $network&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neutron port-create &lt;span class="nv">subnet_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$subnet&lt;/span> --device-owner &lt;span class="s1">&amp;#39;compute:kuryr&amp;#39;&lt;/span> --no-security-groups --name &lt;span class="s1">&amp;#39;concurrent load test IP lll&amp;#39;&lt;/span> &lt;span class="nv">$network&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> i in &lt;span class="sb">`&lt;/span>seq &lt;span class="nv">$1&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">time&lt;/span> setup &lt;span class="nv">$i&lt;/span> &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="update-allow-address-pairs">update allow-address-pairs&lt;/h3>
&lt;p>批量update allow-address-pairs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops shells&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat allow-address-pairs-load-test.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">. ./source
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">vm_port&lt;/span>&lt;span class="o">=&lt;/span>vm_port_id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">function&lt;/span> setup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">mac&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> $&lt;span class="o">[&lt;/span>RANDOM%10&lt;span class="o">]&lt;/span>$&lt;span class="o">[&lt;/span>RANDOM%10&lt;span class="o">]&lt;/span>:$&lt;span class="o">[&lt;/span>RANDOM%10&lt;span class="o">]&lt;/span>$&lt;span class="o">[&lt;/span>RANDOM%10&lt;span class="o">]&lt;/span>:$&lt;span class="o">[&lt;/span>RANDOM%10&lt;span class="o">]&lt;/span>$&lt;span class="o">[&lt;/span>RANDOM%10&lt;span class="o">]&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ip_addr&lt;/span>&lt;span class="o">=&lt;/span>10.0.1.&lt;span class="k">$((&lt;/span>i+1&lt;span class="k">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">param&lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="s2">&amp;#34; --allowed-address-pair ip_address=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">ip_addr&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">,mac_address=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">mac&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#echo $vm_port $param&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">neutron port-update &lt;span class="nv">$vm_port&lt;/span> &lt;span class="nv">$param&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> starting
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> i in &lt;span class="sb">`&lt;/span>seq &lt;span class="nv">$1&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="c1">## for i in `jot $1`; do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$i&lt;/span>&lt;span class="s2">...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">time&lt;/span> setup &lt;span class="nv">$i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="delete-port--allowed-address-pairs">delete port &amp;amp; allowed-address-pairs&lt;/h3>
&lt;p>清理 Port 和 Port allowed-address-pairs&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>. ./source
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#neutron port-list --device-owner compute:kuryr&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">neutron port-delete &lt;span class="sb">`&lt;/span>neutron port-list --device-owner compute:kuryr -c id -f value&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">neutron port-list --device-owner compute:nova &lt;span class="p">|&lt;/span> grep 10.0.1 &lt;span class="p">|&lt;/span> grep -vE &lt;span class="s1">&amp;#39;10.0.1.5(1|2|3)&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> p in &lt;span class="sb">`&lt;/span>neutron port-list --device-owner compute:nova -f value &lt;span class="p">|&lt;/span> grep 10.0.1 &lt;span class="p">|&lt;/span> cut -d &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span> -f &lt;span class="m">1&lt;/span> &lt;span class="sb">`&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> neutron port-update &lt;span class="nv">$p&lt;/span> --allowed-address-pairs &lt;span class="nv">action&lt;/span>&lt;span class="o">=&lt;/span>clear &lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="trunk-port">trunk port&lt;/h3>
&lt;p>创建trunk 子port&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> i in &lt;span class="sb">`&lt;/span>openstack port list &lt;span class="p">|&lt;/span> grep ACTIVE &lt;span class="p">|&lt;/span>grep -vE &lt;span class="s1">&amp;#39;(22.1.104|1.106|132|117|129)&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">do&lt;/span> openstack network trunk &lt;span class="nb">unset&lt;/span> --subport &lt;span class="nv">$i&lt;/span> trunktest&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> i in &lt;span class="sb">`&lt;/span>openstack port list &lt;span class="p">|&lt;/span> grep DOWN &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">do&lt;/span> openstack port delete &lt;span class="nv">$i&lt;/span> &lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">############################################&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openstack network create —share —external —provider-physical-network provider —provider-network-type vlan —provider-segment &lt;span class="m">162&lt;/span> podlan162 —transparent-vlan
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openstack subnet create —no-dhcp —subnet-range 172.23.0.0/16 —gateway 172.23.0.254 —network podlan162 —allocation-pool &lt;span class="nv">start&lt;/span>&lt;span class="o">=&lt;/span>172.23.1.101,end&lt;span class="o">=&lt;/span>172.23.1.201 —dns-nameserver 114.114.114.114 jyvlan162sub2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openstack port create —network podlan162 —fixed-ip &lt;span class="nv">subnet&lt;/span>&lt;span class="o">=&lt;/span>jyvlan162sub2,ip-address&lt;span class="o">=&lt;/span>172.23.1.129 —project admin v162port
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># openstack trunk 端口加入&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openstack network trunk create —parent-port v162port trunktest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openstack network create —share —external —provider-physical-network provider —provider-network-type vlan —provider-segment &lt;span class="m">163&lt;/span> podlan163 —transparent-vlan
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openstack subnet create —no-dhcp —subnet-range 172.24.0.0/16 —gateway 172.24.0.254 —network podlan163 —allocation-pool &lt;span class="nv">start&lt;/span>&lt;span class="o">=&lt;/span>172.24.1.101,end&lt;span class="o">=&lt;/span>172.24.1.201 —dns-nameserver 114.114.114.114 jyvlan164sub2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openstack port create —network podlan163 —fixed-ip &lt;span class="nv">subnet&lt;/span>&lt;span class="o">=&lt;/span>jyvlan164sub2,ip-address&lt;span class="o">=&lt;/span>172.24.1.129 —project admin v163port
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openstack network trunk &lt;span class="nb">set&lt;/span> trunktest —subport &lt;span class="nv">port&lt;/span>&lt;span class="o">=&lt;/span>v163port,segmentation-type&lt;span class="o">=&lt;/span>vlan,segmentation-id&lt;span class="o">=&lt;/span>&lt;span class="m">163&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 测试子网，测试163 tag&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo ip link add link eth0 name eth0.163 &lt;span class="nb">type&lt;/span> vlan id &lt;span class="m">163&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo ip link &lt;span class="nb">set&lt;/span> dev eth0.163 address fa:16:3e:26:a8:08
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo ip link &lt;span class="nb">set&lt;/span> dev eth0.163 up
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>nopCloser函数</title><link>https://tab.deoops.com/posts/read-again/</link><pubDate>Wed, 17 Apr 2019 21:39:31 +0800</pubDate><guid>https://tab.deoops.com/posts/read-again/</guid><description>&lt;img src="https://tab.deoops.com/posts/read-again/nopcloser.png" alt="Featured image of post nopCloser函数" />&lt;p>update: &lt;code>ioutil&lt;/code>逐渐被&lt;code>io&lt;/code> 取代。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">ioutil&lt;/span> &lt;span class="c1">// import &amp;#34;io/ioutil&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">NopCloser&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Reader&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ReadCloser&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">NopCloser&lt;/span> &lt;span class="nx">returns&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="nx">ReadCloser&lt;/span> &lt;span class="nx">with&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="nx">no&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">op&lt;/span> &lt;span class="nx">Close&lt;/span> &lt;span class="nx">method&lt;/span> &lt;span class="nx">wrapping&lt;/span> &lt;span class="nx">the&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">provided&lt;/span> &lt;span class="nx">Reader&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">As&lt;/span> &lt;span class="nx">of&lt;/span> &lt;span class="nx">Go&lt;/span> &lt;span class="mf">1.16&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">this&lt;/span> &lt;span class="nx">function&lt;/span> &lt;span class="nx">simply&lt;/span> &lt;span class="nx">calls&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NopCloser&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">io&lt;/span> &lt;span class="c1">// import &amp;#34;io&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">NopCloser&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="nx">Reader&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">ReadCloser&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">NopCloser&lt;/span> &lt;span class="nx">returns&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="nx">ReadCloser&lt;/span> &lt;span class="nx">with&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="nx">no&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">op&lt;/span> &lt;span class="nx">Close&lt;/span> &lt;span class="nx">method&lt;/span> &lt;span class="nx">wrapping&lt;/span> &lt;span class="nx">the&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">provided&lt;/span> &lt;span class="nx">Reader&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>最近使用&lt;a class="link" href="https://github.com/h2non/baloo" target="_blank" rel="noopener"
>baloo&lt;/a>写集成测试，遇到了个需求，
在&lt;code>unmarshal&lt;/code>respones之后（或者之前）还要再输出一次response的纯文本格式供debug参考。&lt;/p>
&lt;p>即需要多次读http.Resp.Body。&lt;/p>
&lt;h2 id="问题">问题&lt;/h2>
&lt;p>response.Body 只能读一次，读完之后再进行read操作就会遇到&lt;code>EOF&lt;/code> error。&lt;/p>
&lt;h2 id="分析问题">分析问题&lt;/h2>
&lt;p>模糊记得&lt;code>baloo&lt;/code>在一次请求中能多次(&lt;code>JSON()&lt;/code> 和 &lt;code>String()&lt;/code>)读取response.Body内容。&lt;/p>
&lt;p>仔细去看了下&lt;code>baloo&lt;/code>的源代码，发现&lt;code>baloo&lt;/code>自己在内部 封装了一个对象 &lt;code>http.RawResonse&lt;/code> ，使用了 &lt;code>iouti.NopCloser&lt;/code>函数重新填充了&lt;code>res.Body&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">readBodyJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Response&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">body&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReadAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Re-fill body reader stream after reading it
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NopCloser&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewBuffer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">body&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">body&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>有了&lt;code> ioutil.NopCloser&lt;/code>函数，可以很快速的写出&lt;code>debugPlugin&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">debugPlugin&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">f&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">h&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReadAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;response:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;response Type:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Header&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Content-Type&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// should CLOSE, due to next Close method will be no-op
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NopCloser&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewBuffer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Next&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">p&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewResponsePlugin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意：应该先 &lt;code>resp.Body.Close()&lt;/code> 掉，然后重新填充reader。&lt;/p>
&lt;p>因为新的&lt;code>Response.Body.Close()&lt;/code>是 &lt;code>no-op&lt;/code>操作，不会去close 之前的Body，可能会造成资源泄漏。&lt;/p></description></item><item><title>Mysql Autocommit问题</title><link>https://tab.deoops.com/posts/mysql-autocommit/</link><pubDate>Fri, 12 Apr 2019 10:37:04 +0800</pubDate><guid>https://tab.deoops.com/posts/mysql-autocommit/</guid><description>&lt;img src="https://tab.deoops.com/posts/mysql-autocommit/Start-ad-hoc-Transaction.jpeg" alt="Featured image of post Mysql Autocommit问题" />&lt;p>客户反馈我们的产品有个很奇怪的问题。&lt;/p>
&lt;p>添加完商品后，可以看到商品，但是一刷新页面，刚才添加的商品就消失啦。&lt;/p>
&lt;p>以前没碰到过，一直都用的好好的为什么今天就不行了呢？&lt;/p>
&lt;h2 id="分析问题">分析问题&lt;/h2>
&lt;p>既然一刷新即消失了，就证明没有写入到数据库。&lt;/p>
&lt;p>没写入到数据库是什么原因呢？ API 也没有报错呀？&lt;/p>
&lt;p>更加奇怪的是，有的页面有这个问题，有的没有这个问题。&lt;/p>
&lt;p>后端的API 有的是golang写的，有的是Java写的。&lt;/p>
&lt;p>&lt;code>golang&lt;/code> orm对mysql 数据库的写操作存在上面说的刷新就丢失的问题，&lt;code>Java&lt;/code>的orm对mysql的写操作没有问题。&lt;/p>
&lt;p>这是为什么呢？&lt;/p>
&lt;h2 id="dba"> DBA&lt;/h2>
&lt;p>排查了很久发现原来是客户那边的DBA把 mysql的 &lt;code>session autocommit&lt;/code>的配置关闭啦。&lt;/p>
&lt;p>&lt;a class="link" href="https://dev.mysql.com/doc/refman/5.6/en/innodb-autocommit-commit-rollback.html" target="_blank" rel="noopener"
>autocommit&lt;/a>&lt;/p>
&lt;p>翻了下文档，确定　&lt;code>Java&lt;/code>的orm框架会忽略mysql server的配置默认自己commit，&lt;code>golang&lt;/code>的orm则没有这个优化（也许是有但我们没有启用？）。&lt;/p>
&lt;p>所以会出现 java的后端是正常的，golang的后端写不了mysql。
　&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>客户DBA开启&lt;code>autocommit&lt;/code>配置项后，产品业务恢复正常。&lt;/p></description></item><item><title>Macvlan路由规则</title><link>https://tab.deoops.com/posts/macvlan-route/</link><pubDate>Mon, 11 Mar 2019 11:33:48 +0800</pubDate><guid>https://tab.deoops.com/posts/macvlan-route/</guid><description>&lt;img src="https://tab.deoops.com/posts/macvlan-route/Macvlan-network-with-traffic-flows.png" alt="Featured image of post Macvlan路由规则" />&lt;p>对macvlan 不熟悉的同学，可以先看下这篇&lt;a class="link" href="https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking/#macvlan" target="_blank" rel="noopener"
>macvlan virtual network简介&lt;/a>&lt;/p>
&lt;p>默认情况下Linux kernel会阻止(drop)宿主机（host eth0）虚拟出来的 macvlan network（&lt;code>bridge mode&lt;/code>） 和宿主机host eth0）之间网络数据包。&lt;/p>
&lt;p>调试了一段时间后，我们发现了可以通过路由表来绕过这个限制。
具体实施的方法如下：&lt;/p>
&lt;blockquote>
&lt;p>在host network namesapces下新增 一个macvlan device，然后添加路由规则即可。&lt;/p>
&lt;/blockquote>
&lt;p>通信的两个方向简单解释如下：&lt;/p>
&lt;h2 id="eth0host---podmacvlan">eth0(host) -&amp;gt; pod(macvlan)&lt;/h2>
&lt;p>宿主机host eth0 通过break0 设备 和route table的路由规则 可以访问到pod（在macvlan中）&lt;/p>
&lt;p>shell调试脚本如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ip link add break0 link eth0 &lt;span class="nb">type&lt;/span> macvlan mode bridge
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># NOTE: if use /24 CIDR will auto add a route rule &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># (100.75.30.0/24 dev break0 proto kernel scope link src 100.75.30.1) &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># which we don&amp;#39;t need&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ifconfig break0 100.75.30.7/32 up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip r a 100.75.30.71 dev break0 &lt;span class="c1"># 100.75.30.71 is a pod ip for test&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>因为kuryr是用python配置网络的，所以也提供对应的python脚本如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pyroute2&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">IPDB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">_create_break0&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="n">IPDB&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">ipdb&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ipdb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">interfaces&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IF_NAME&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">up&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">commit&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">index&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="n">ipdb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">create&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ifname&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">IF_NAME&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">kind&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">MACVLAN_KIND&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">link&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">ipdb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">interfaces&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">macvlan_mode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">MACVLAN_MODE_BRIDGE&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_ip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">addr&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34;/32&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">up&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">index&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="n">ipdb_exceptions&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CreateException&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">LOG&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Exception when create break0 device &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">_route_spec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ip&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;dst&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34;/32&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;oif&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">idx&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">add_route&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ip&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">spec&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_route_spec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="n">IPDB&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">ipdb&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipdb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">routes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">spec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">commit&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ipdb_exceptions&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CommitException&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">link_exceptions&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">NetlinkError&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">LOG&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Exception &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2"> when add route table &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="pod---eth0host">pod -&amp;gt; eth0(host)&lt;/h2>
&lt;p>因为是2层打通的，所以只要有mac_addr就可以访问，和pod以及宿主机eth0&lt;strong>具体的IP&lt;/strong> 地址没关系。&lt;/p>
&lt;p>在pod 里面使用 &lt;code>arp -n&lt;/code> 可以看到，host IP（100.75.30.51） 和 break0 （100.75.30.7） 的IP
对应的是同一个mac addr， 都是 break0的mac addr。&lt;/p>
&lt;p>在主机上添加 路由 &lt;code>ip r add 100.75.30.71 dev break0&lt;/code> （100.75.30.71 是pod 的IP地址），&lt;/p>
&lt;p>然后在 pod 上ping 下 host IP， 宿主机eth0的hostIP 和 break0 的两个条目就会在pod的arp 表里显示出来。&lt;/p>
&lt;p>如果只是从 host ping pod， 则 pod的arp 表只显示 break0 这个条目。&lt;/p></description></item><item><title>Markdown语法指南</title><link>https://tab.deoops.com/posts/markdown-syntax/</link><pubDate>Mon, 11 Mar 2019 00:00:00 +0000</pubDate><guid>https://tab.deoops.com/posts/markdown-syntax/</guid><description>&lt;img src="https://tab.deoops.com/posts/markdown-syntax/pawel-czerwinski-8uZPynIu-rQ-unsplash.jpg" alt="Featured image of post Markdown语法指南" />&lt;p>This article offers a sample of basic Markdown syntax that can be used in Hugo content files, also it shows whether basic HTML elements are decorated with CSS in a Hugo theme.&lt;/p>
&lt;h2 id="headings">Headings&lt;/h2>
&lt;p>The following HTML &lt;code>&amp;lt;h1&amp;gt;&lt;/code>—&lt;code>&amp;lt;h6&amp;gt;&lt;/code> elements represent six levels of section headings. &lt;code>&amp;lt;h1&amp;gt;&lt;/code> is the highest section level while &lt;code>&amp;lt;h6&amp;gt;&lt;/code> is the lowest.&lt;/p>
&lt;h1 id="h1">H1&lt;/h1>
&lt;h2 id="h2">H2&lt;/h2>
&lt;h3 id="h3">H3&lt;/h3>
&lt;h4 id="h4">H4&lt;/h4>
&lt;h5 id="h5">H5&lt;/h5>
&lt;h6 id="h6">H6&lt;/h6>
&lt;h2 id="paragraph">Paragraph&lt;/h2>
&lt;p>Xerum, quo qui aut unt expliquam qui dolut labo. Aque venitatiusda cum, voluptionse latur sitiae dolessi aut parist aut dollo enim qui voluptate ma dolestendit peritin re plis aut quas inctum laceat est volestemque commosa as cus endigna tectur, offic to cor sequas etum rerum idem sintibus eiur? Quianimin porecus evelectur, cum que nis nust voloribus ratem aut omnimi, sitatur? Quiatem. Nam, omnis sum am facea corem alique molestrunt et eos evelece arcillit ut aut eos eos nus, sin conecerem erum fuga. Ri oditatquam, ad quibus unda veliamenimin cusam et facea ipsamus es exerum sitate dolores editium rerore eost, temped molorro ratiae volorro te reribus dolorer sperchicium faceata tiustia prat.&lt;/p>
&lt;p>Itatur? Quiatae cullecum rem ent aut odis in re eossequodi nonsequ idebis ne sapicia is sinveli squiatum, core et que aut hariosam ex eat.&lt;/p>
&lt;h2 id="blockquotes">Blockquotes&lt;/h2>
&lt;p>The blockquote element represents content that is quoted from another source, optionally with a citation which must be within a &lt;code>footer&lt;/code> or &lt;code>cite&lt;/code> element, and optionally with in-line changes such as annotations and abbreviations.&lt;/p>
&lt;h4 id="blockquote-without-attribution">Blockquote without attribution&lt;/h4>
&lt;blockquote>
&lt;p>Tiam, ad mint andaepu dandae nostion secatur sequo quae.
&lt;strong>Note&lt;/strong> that you can use &lt;em>Markdown syntax&lt;/em> within a blockquote.&lt;/p>
&lt;/blockquote>
&lt;h4 id="blockquote-with-attribution">Blockquote with attribution&lt;/h4>
&lt;blockquote>
&lt;p>Don&amp;rsquo;t communicate by sharing memory, share memory by communicating.&lt;!-- raw HTML omitted -->
— &lt;!-- raw HTML omitted -->Rob Pike&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>&lt;!-- raw HTML omitted -->&lt;/p>
&lt;/blockquote>
&lt;h2 id="tables">Tables&lt;/h2>
&lt;p>Tables aren&amp;rsquo;t part of the core Markdown spec, but Hugo supports supports them out-of-the-box.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name&lt;/th>
&lt;th>Age&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Bob&lt;/td>
&lt;td>27&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Alice&lt;/td>
&lt;td>23&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="inline-markdown-within-tables">Inline Markdown within tables&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Italics&lt;/th>
&lt;th>Bold&lt;/th>
&lt;th>Code&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;em>italics&lt;/em>&lt;/td>
&lt;td>&lt;strong>bold&lt;/strong>&lt;/td>
&lt;td>&lt;code>code&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="code-blocks">Code Blocks&lt;/h2>
&lt;h4 id="code-block-with-backticks">Code block with backticks&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;!doctype html&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">html&lt;/span> &lt;span class="na">lang&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;en&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">head&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">meta&lt;/span> &lt;span class="na">charset&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;utf-8&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>Example HTML5 Document&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">head&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">p&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>Test&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">p&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">html&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="code-block-indented-with-four-spaces">Code block indented with four spaces&lt;/h4>
&lt;pre>&lt;code>&amp;lt;!doctype html&amp;gt;
&amp;lt;html lang=&amp;quot;en&amp;quot;&amp;gt;
&amp;lt;head&amp;gt;
&amp;lt;meta charset=&amp;quot;utf-8&amp;quot;&amp;gt;
&amp;lt;title&amp;gt;Example HTML5 Document&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
&amp;lt;p&amp;gt;Test&amp;lt;/p&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code>&lt;/pre>
&lt;h4 id="code-block-with-hugos-internal-highlight-shortcode">Code block with Hugo&amp;rsquo;s internal highlight shortcode&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;!doctype html&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">html&lt;/span> &lt;span class="na">lang&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;en&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">head&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">meta&lt;/span> &lt;span class="na">charset&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;utf-8&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>Example HTML5 Document&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">head&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">p&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>Test&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">p&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">html&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>
&lt;h2 id="list-types">List Types&lt;/h2>
&lt;h4 id="ordered-list">Ordered List&lt;/h4>
&lt;ol>
&lt;li>First item&lt;/li>
&lt;li>Second item&lt;/li>
&lt;li>Third item&lt;/li>
&lt;/ol>
&lt;h4 id="unordered-list">Unordered List&lt;/h4>
&lt;ul>
&lt;li>List item&lt;/li>
&lt;li>Another item&lt;/li>
&lt;li>And another item&lt;/li>
&lt;/ul>
&lt;h4 id="nested-list">Nested list&lt;/h4>
&lt;ul>
&lt;li>Fruit
&lt;ul>
&lt;li>Apple&lt;/li>
&lt;li>Orange&lt;/li>
&lt;li>Banana&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Dairy
&lt;ul>
&lt;li>Milk&lt;/li>
&lt;li>Cheese&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="other-elements--abbr-sub-sup-kbd-mark">Other Elements — abbr, sub, sup, kbd, mark&lt;/h2>
&lt;p>&lt;!-- raw HTML omitted -->GIF&lt;!-- raw HTML omitted --> is a bitmap image format.&lt;/p>
&lt;p>H&lt;!-- raw HTML omitted -->2&lt;!-- raw HTML omitted -->O&lt;/p>
&lt;p>X&lt;!-- raw HTML omitted -->n&lt;!-- raw HTML omitted --> + Y&lt;!-- raw HTML omitted -->n&lt;!-- raw HTML omitted --> = Z&lt;!-- raw HTML omitted -->n&lt;!-- raw HTML omitted -->&lt;/p>
&lt;p>Press &lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->CTRL&lt;!-- raw HTML omitted -->+&lt;!-- raw HTML omitted -->ALT&lt;!-- raw HTML omitted -->+&lt;!-- raw HTML omitted -->Delete&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --> to end the session.&lt;/p>
&lt;p>Most &lt;!-- raw HTML omitted -->salamanders&lt;!-- raw HTML omitted --> are nocturnal, and hunt for insects, worms, and other small creatures.&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>The above quote is excerpted from Rob Pike&amp;rsquo;s &lt;a class="link" href="https://www.youtube.com/watch?v=PAAkCSZUG1c" target="_blank" rel="noopener"
>talk&lt;/a> during Gopherfest, November 18, 2015.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>数学符号KaTeX</title><link>https://tab.deoops.com/posts/math-typesetting/</link><pubDate>Fri, 08 Mar 2019 00:00:00 +0000</pubDate><guid>https://tab.deoops.com/posts/math-typesetting/</guid><description>&lt;img src="https://tab.deoops.com/posts/math-typesetting/katex.png" alt="Featured image of post 数学符号KaTeX" />&lt;p>Mathematical notation in a Hugo project can be enabled by using third party JavaScript libraries.&lt;/p>
&lt;p>In this example we will be using &lt;a class="link" href="https://katex.org/" target="_blank" rel="noopener"
>KaTeX&lt;/a>&lt;/p>
&lt;ul>
&lt;li>Create a partial under &lt;code>/layouts/partials/math.html&lt;/code>&lt;/li>
&lt;li>Within this partial reference the &lt;a class="link" href="https://katex.org/docs/autorender.html" target="_blank" rel="noopener"
>Auto-render Extension&lt;/a> or host these scripts locally.&lt;/li>
&lt;li>Include the partial in your templates like so:&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">{{&lt;/span> &lt;span class="k">if&lt;/span> or .Params.math .Site.Params.math &lt;span class="o">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{{&lt;/span> partial &lt;span class="s2">&amp;#34;math.html&amp;#34;&lt;/span> . &lt;span class="o">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{{&lt;/span> end &lt;span class="o">}}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>To enable KaTex globally set the parameter &lt;code>math&lt;/code> to &lt;code>true&lt;/code> in a project&amp;rsquo;s configuration&lt;/li>
&lt;li>To enable KaTex on a per page basis include the parameter &lt;code>math: true&lt;/code> in content files&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Note:&lt;/strong> Use the online reference of &lt;a class="link" href="https://katex.org/docs/supported.html" target="_blank" rel="noopener"
>Supported TeX Functions&lt;/a>&lt;/p>
&lt;h3 id="examples">Examples&lt;/h3>
&lt;p>Block math:
$$
\varphi = 1+\frac{1} {1+\frac{1} {1+\frac{1} {1+\cdots} } }
$$&lt;/p></description></item><item><title>无法创建macvlan设备</title><link>https://tab.deoops.com/posts/macvlan-busy/</link><pubDate>Thu, 07 Mar 2019 11:17:49 +0800</pubDate><guid>https://tab.deoops.com/posts/macvlan-busy/</guid><description>&lt;img src="https://tab.deoops.com/posts/macvlan-busy/maxresdefault.jpeg" alt="Featured image of post 无法创建macvlan设备" />&lt;p>最近给客户调试 macvlan network时，遇到了&lt;code>Linux kernel&lt;/code> 报错
&lt;code>SIOCSIFFKAGS: Device or resource busy.&lt;/code> 无法创建网络device。&lt;/p>
&lt;p>结果长时间的debug分析，
发现问题是高并发压测 创建和释放&lt;code>macvlan device&lt;/code>的时候，设备的&lt;code>mac address&lt;/code>出现了重复。&lt;/p>
&lt;p>ps：这个问题只出现在 &lt;code>macvlan&lt;/code>network 的设备中。&lt;/p>
&lt;p>可以用下面的shell脚本来复现macvlan &lt;code>Device or resource busy&lt;/code>的错误：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="k">function&lt;/span> setup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip l a m&lt;span class="nv">$i&lt;/span> address 00:40:2F:4D:5E:6F link eth0 &lt;span class="nb">type&lt;/span> macvlan mode bridge
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip netns add ns&lt;span class="nv">$i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip l &lt;span class="nb">set&lt;/span> m&lt;span class="nv">$i&lt;/span> netns ns&lt;span class="nv">$i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip netns &lt;span class="nb">exec&lt;/span> ns&lt;span class="nv">$i&lt;/span> ifconfig m&lt;span class="nv">$i&lt;/span> 10.0.0.&lt;span class="k">$((&lt;/span>i+1&lt;span class="k">))&lt;/span>/24 up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> cleaning up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip -all netns d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> creating netsnses
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> i in &lt;span class="sb">`&lt;/span>seq &lt;span class="nv">$1&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$i&lt;/span>....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#setup $i &amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> setup &lt;span class="nv">$i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果把 macvlan 类型改为 dummy (上面脚本第5行 type macvlan 改为 type &lt;code>dummy&lt;/code>) ，即使 MAC address 重复也不会引发kernel 报错。&lt;/p></description></item><item><title>pod生命周期事件生成器</title><link>https://tab.deoops.com/posts/pleg-unhealth/</link><pubDate>Mon, 11 Feb 2019 10:33:42 +0800</pubDate><guid>https://tab.deoops.com/posts/pleg-unhealth/</guid><description>&lt;img src="https://tab.deoops.com/posts/pleg-unhealth/reboot.jpeg" alt="Featured image of post pod生命周期事件生成器" />&lt;h2 id="pleg">PLEG&lt;/h2>
&lt;p>不熟悉PLEG(Pod Lifecycle Event Generator)的同学，可以先看下这篇文章&lt;a class="link" href="https://developers.redhat.com/blog/2019/11/13/pod-lifecycle-event-generator-understanding-the-pleg-is-not-healthy-issue-in-kubernetes" target="_blank" rel="noopener"
>What is PLEG?&lt;/a>。&lt;/p>
&lt;p>这篇文章对pleg是什么和常见的&lt;code>unhealthy&lt;/code>问题有很详细的介绍。&lt;/p>
&lt;h3 id="cni">cni&lt;/h3>
&lt;p>当k8s的 cni 插件性能较差，node上的pod 数量较多（大于 80）的时候，我们常常会遇到PLEG出错的问题:&lt;/p>
&lt;blockquote>
&lt;p>PLEG is not healthy: pleg was last seen active 6m55.488150776s ago; threshold is 3m0s&lt;/p>
&lt;/blockquote>
&lt;p>调试&lt;a class="link" href="https://github.com/openstack/kuryr-kubernetes" target="_blank" rel="noopener"
>kuryr&lt;/a> cni的时候，发现当openstack &lt;code>neutron&lt;/code>服务压力比较大的时候。&lt;/p>
&lt;p>cni这边申请和释放 port的时延会相应的增加，导致虚拟机大量堆积无效的netns，&lt;/p>
&lt;p>然后就会遇到由&lt;code>kueblet PLEG not healthy&lt;/code>引起的docker hang 住问题。&lt;/p>
&lt;h2 id="docker">docker&lt;/h2>
&lt;p>重启 docker 和 kueblet 可以暂时解决PLEG unhealthy。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">systemctl restart docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart kubelet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># do NOT use `docker rm -vf`,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># which will kill running containers&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker rm -v &lt;span class="sb">`&lt;/span>docker ps -qa&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>建议同时修改 &lt;a class="link" href="https://www.ibm.com/support/knowledgecenter/en/SSBS6K_3.1.1/troubleshoot/docker_pods_overload.html" target="_blank" rel="noopener"
>kubelet 启动参数&lt;/a> &amp;ndash;housekeeping-interval=30s&lt;/p></description></item><item><title>bc语言</title><link>https://tab.deoops.com/posts/bc-language/</link><pubDate>Mon, 22 Oct 2018 18:16:25 +0800</pubDate><guid>https://tab.deoops.com/posts/bc-language/</guid><description>&lt;img src="https://tab.deoops.com/posts/bc-language/calculator.jpeg" alt="Featured image of post bc语言" />&lt;h2 id="base">base&lt;/h2>
&lt;p>通过修改&lt;code>ibase&lt;/code>和&lt;code>obase&lt;/code>可以实现各种进制的转化，比如十进制和二进制和十六进制之间的转换；&lt;/p>
&lt;blockquote>
&lt;p>If you aren’t familiar with conversion between decimal, binary, and hexadecimal formats, you can
use a calculator utility such as bc or dc to convert between different radix representations. For
example, in bc, you can run the command obase=2; 240 to print the number 240 in binary
(base 2) form.&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>❯ bc -q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ibase
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">obase
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1+ &lt;span class="m">3&lt;/span> *3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">obase&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">245&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">11110101&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">11111111&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">192&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">11000000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">168&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">10101000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">172&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">10101100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">obase&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">34&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">22&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">172&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">AC
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">^D%
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="syntax">syntax&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl"> bc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> An arbitrary precision calculator language.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> More information: https://manned.org/bc.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Start bc in interactive mode using the standard math library:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bc -l
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Calculate the result of an expression:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bc &lt;span class="o">&amp;lt;&amp;lt;&amp;lt;&lt;/span> &lt;span class="s2">&amp;#34;(1 + 2) * 2 ^ 2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Calculate the result of an expression and force the number of decimal places to 10:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bc &lt;span class="o">&amp;lt;&amp;lt;&amp;lt;&lt;/span> &lt;span class="s2">&amp;#34;scale=10; 5 / 3&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Calculate the result of an expression with sine and cosine using mathlib:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bc -l &lt;span class="o">&amp;lt;&amp;lt;&amp;lt;&lt;/span> &lt;span class="s2">&amp;#34;s(1) + c(1)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Pod生命周期和Liveness的区别</title><link>https://tab.deoops.com/posts/pod-life-live/</link><pubDate>Tue, 18 Sep 2018 23:33:25 +0800</pubDate><guid>https://tab.deoops.com/posts/pod-life-live/</guid><description>&lt;img src="https://tab.deoops.com/posts/pod-life-live/hook.gif" alt="Featured image of post Pod生命周期和Liveness的区别" />&lt;p>今天测试给我反馈了一个pod问题，测试给出的 use case 描述如下：&lt;/p>
&lt;p>配置一个nginx的web服务；&lt;/p>
&lt;ol>
&lt;li>在生命周期中选择http协议，端口配置80，路径配置/errorpath；&lt;/li>
&lt;li>服务中pod能正常启动；&lt;/li>
&lt;li>预期在pod的事件中应该有一个“FailedPostStartHook”错误信息。&lt;/li>
&lt;li>测试人员发现，第4点的预期没有达到，pod 正常启动了，却没有 &lt;code>FailedPostStarHook&lt;/code>事件出现。&lt;/li>
&lt;/ol>
&lt;p>简单分析了一下，我发现是测试人员把pod的&lt;code>lifecycle&lt;/code>和 pod的&lt;code>liveness/readiness&lt;/code> 诺混淆了，从而写出了错的test case。&lt;/p>
&lt;h2 id="lifecycle-handlers">Lifecycle handlers&lt;/h2>
&lt;p>首先回顾下pod lifecycle的作用：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">kubectl explain pod.spec.containers.lifecycle.postStart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RESOURCE: postStart &amp;lt;Object&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DESCRIPTION:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PostStart is called immediately after a container is created. If the
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> handler fails, the container is terminated and restarted according to its
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> restart policy. Other management of the container blocks &lt;span class="k">until&lt;/span> the hook
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> completes. More info: https://kubernetes.io/docs/concepts/containers/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> container-lifecycle-hooks/#container-hooks/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Handler defines a specific action that should be taken
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>简单翻译下就是说， &lt;code>kubernetes&lt;/code> 提供的pod start和exit的 lifecycle hooks 方便开发人员hooked到&lt;/p>
&lt;p>下面两个生命周期：&lt;/p>
&lt;ol>
&lt;li>通知外部世界pod已经启动完成 (postStart)&lt;/li>
&lt;li>pod优雅的退出 (preStop)&lt;/li>
&lt;/ol>
&lt;p>ps：&lt;code>init container&lt;/code>可以解决依赖问题，不要和postStart hooks混淆了哦。&lt;/p>
&lt;h3 id="举例子">举例子&lt;/h3>
&lt;p>当postStart hook的&lt;strong>handler&lt;/strong>发送http请求到指定的port和path时， 如果exit code 不为0时，&lt;/p>
&lt;p>会触发 &lt;code>FailedPostStartHook&lt;/code> 事件，然后执行用户给定的hook/handler。&lt;/p>
&lt;p>注意：lifecycle hooks不会理会http 自身的 response code健康与否，&lt;/p>
&lt;p>只要&lt;strong>handler&lt;/strong> exit code 为0 pod就会正常启动，不触发任何事件。&lt;/p>
&lt;p>可以配置一个错误的端口使产生&lt;code>FailedPostStartHook&lt;/code> event：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">lifecycle90&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ng&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Never&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">readinessProbe&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">lifecycle&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">postStart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">## change this to 8080 or 9090 to get the FailedPostStartHook event&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/teststart&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">preStop&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">httpGet&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/teststop&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="相关代码">相关代码&lt;/h3>
&lt;p>talk is cheap.&lt;/p>
&lt;p>&lt;code>handler&lt;/code>只关心&lt;a class="link" href="https://sourcegraph.com/github.com/kubernetes/kubernetes/-/blob/pkg/kubelet/lifecycle/handlers.go?L72" target="_blank" rel="noopener"
>getHTTPRespBody&lt;/a> 获取body的过程是否有err产生， 并不关心http respond code。&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 179;
flex-basis: 430px"
>
&lt;a href="https://tab.deoops.com/posts/pod-life-live/getBody.png" data-size="1488x830">
&lt;img src="https://tab.deoops.com/posts/pod-life-live/getBody.png"
width="1488"
height="830"
srcset="https://tab.deoops.com/posts/pod-life-live/getBody_hu1de47f0bc59d2d72f7f84f5247757181_215040_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/pod-life-live/getBody_hu1de47f0bc59d2d72f7f84f5247757181_215040_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="getHTTPRespBody">
&lt;/a>
&lt;figcaption>getHTTPRespBody&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="livenessreadiness-probe">Liveness/readiness probe&lt;/h2>
&lt;p>pod liveness/readiness &lt;strong>probe&lt;/strong> 则会检查 http code 是否为 &lt;code>2xx&lt;/code>来确定&lt;strong>probe&lt;/strong> 是否成功。&lt;/p>
&lt;h3 id="相关代码-1">相关代码&lt;/h3>
&lt;p>talk is cheap.&lt;/p>
&lt;p>&lt;a class="link" href="https://sourcegraph.com/github.com/kubernetes/kubernetes/-/blob/pkg/kubelet/prober/prober.go?L183" target="_blank" rel="noopener"
>runProbe&lt;/a> 调用&lt;a class="link" href="https://sourcegraph.com/github.com/kubernetes/kubernetes/-/blob/pkg/probe/http/http.go?L129" target="_blank" rel="noopener"
>http.Probe&lt;/a>，&lt;code>DoHTTPProbe&lt;/code>会检查http response code。&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 170;
flex-basis: 408px"
>
&lt;a href="https://tab.deoops.com/posts/pod-life-live/httpCode.png" data-size="1830x1076">
&lt;img src="https://tab.deoops.com/posts/pod-life-live/httpCode.png"
width="1830"
height="1076"
srcset="https://tab.deoops.com/posts/pod-life-live/httpCode_hu635bd497a36d20f21b0e9bb81ddae9bc_294012_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/pod-life-live/httpCode_hu635bd497a36d20f21b0e9bb81ddae9bc_294012_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="doHTTPProbe">
&lt;/a>
&lt;figcaption>doHTTPProbe&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>从源码可以清楚的看到， lifecyce 的&lt;strong>handler&lt;/strong> 只发送了http 请求，并没有检查 http response code,
liveness/readiness 的&lt;strong>prober&lt;/strong> 则做了http response code 的检查。&lt;/p></description></item><item><title>VPC模式</title><link>https://tab.deoops.com/posts/flannel-vpc/</link><pubDate>Tue, 11 Sep 2018 10:07:04 +0800</pubDate><guid>https://tab.deoops.com/posts/flannel-vpc/</guid><description>&lt;img src="https://tab.deoops.com/posts/flannel-vpc/flannel-vpc-mode.png" alt="Featured image of post VPC模式" />&lt;p>之前写了一篇post &lt;a class="link" href="https://tab.deoops.com/posts/tx-flannel/" >适配腾讯云backend&lt;/a> 的文章，从代码的角度简单记录了flannel
&lt;code>vpc backend&lt;/code>实现过程。&lt;/p>
&lt;p>这篇文章是对前面文章的补充，全局鸟瞰描绘了flannel &lt;code>vpc backend&lt;/code>网络数据包的流动过程。&lt;/p>
&lt;p>总体来看&lt;code>vpc&lt;/code> 和 &lt;code>host-gw&lt;/code> 模式是很类似的，理解&lt;code>host-gateway&lt;/code>模式 对理解&lt;code>vpc&lt;/code> 模式很有帮助。&lt;/p>
&lt;h2 id="host-gw">host gw&lt;/h2>
&lt;p>host gateway 模式：&lt;/p>
&lt;blockquote>
&lt;p>host-gw adds route table entries on hosts, so that host know how to traffic container network packets.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>This works on L2, because it only concerns hosts, switches and containers. switches does not care IP and route, hosts know containers exists, and how to route to them, containers just send and receive data.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>If hosts are at different networks, L3 is introduced, and routers are involved. routers have no idea that containers exists, and any containers packet will be dropped, making communication impossible.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>Of course, you can add route table entries on routers, but that is out of control flannel.&lt;/p>
&lt;/blockquote>
&lt;h3 id="l2">L2&lt;/h3>
&lt;p>为什么host-gw模式下，二层网络一定要打通:&lt;/p>
&lt;p>stackoverflow 上面已经有&lt;a class="link" href="https://stackoverflow.com/questions/45293321/why-host-gw-of-flannel-requires-direct-layer2-connectivity-between-hosts" target="_blank" rel="noopener"
>很好的回答&lt;/a>，我摘抄过来：&lt;/p>
&lt;p>host-gw adds route table entires on each host. And the entries are as following:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-s" data-lang="s">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Destination&lt;/span> &lt;span class="n">Gateway&lt;/span> &lt;span class="n">Genmask&lt;/span> &lt;span class="n">Flags&lt;/span> &lt;span class="n">Metric&lt;/span> &lt;span class="n">Ref&lt;/span> &lt;span class="n">Use&lt;/span> &lt;span class="n">Iface&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0.0.0.0&lt;/span> &lt;span class="m">10.110.110.1&lt;/span> &lt;span class="m">0.0.0.0&lt;/span> &lt;span class="n">UG&lt;/span> &lt;span class="m">100&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="n">eth0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">10.100.14.0&lt;/span> &lt;span class="m">10.110.110.21&lt;/span> &lt;span class="m">255.255.255.0&lt;/span> &lt;span class="n">UG&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="n">eth0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">10.100.38.0&lt;/span> &lt;span class="m">0.0.0.0&lt;/span> &lt;span class="m">255.255.255.0&lt;/span> &lt;span class="n">U&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="n">docker0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">10.110.110.0&lt;/span> &lt;span class="m">0.0.0.0&lt;/span> &lt;span class="m">255.255.255.0&lt;/span> &lt;span class="n">U&lt;/span> &lt;span class="m">100&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="n">eth0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">169.254.169.254&lt;/span> &lt;span class="m">10.110.110.1&lt;/span> &lt;span class="m">255.255.255.255&lt;/span> &lt;span class="n">UGH&lt;/span> &lt;span class="m">100&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="n">eth0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>The most import item is the value of Gateway(10.110.110.21).&lt;/p>
&lt;/blockquote>
&lt;p>The route table will change the destination mac address to the mac_address of node(10.110.110.21) which is connected L2 directly to 10.110.110.22(current node).&lt;/p>
&lt;p>If not L2 connected, the packet can not be delivered to nodes(next-hop)&lt;/p>
&lt;h2 id="vpc">vpc&lt;/h2>
&lt;h3 id="数据包">数据包&lt;/h3>
&lt;p>&lt;code>vpc backend&lt;/code>模式下网络数据包的流动过程如下：&lt;/p>
&lt;ol>
&lt;li>Flanneld 在每个node 节点创建一个 cni0 的网桥bridge设备，node里面的pod之间的通信走cni0网桥；&lt;/li>
&lt;li>Node 和 在本机上的pod 通信通过node的route table 转发到cni0；&lt;/li>
&lt;li>vpc backend适配器调用vpc sdk在vpc网络中维护了一个vpc route table；&lt;/li>
&lt;li>Node 和其它node里面的pod通信，是先通过 vpc route table 找到 pod 子网 所对应node，然后再通过这个node把网络流量转发到pod；&lt;/li>
&lt;li>跨node 的pod 通信通过这个route table找到pod网段所在的node，然后载通过 node 节点上的route table 转发到对应node 上cni0设备上然后找到对应的pod；&lt;/li>
&lt;li>VPC上的普通vm(即，该vm不是k8s node)和 k8s pod之间的通信与 上面第4，5点 通信是一样的。&lt;/li>
&lt;/ol>
&lt;h3 id="l2区别">L2区别&lt;/h3>
&lt;p>host-gw mode 因为是在node 节点上 添加的 route 规则，所以所有的节点要二层switch打通，否则 下一跳(next-hop)跳不过去，没人帮忙转发二层数据包(frame)。&lt;/p>
&lt;p>vpc backend mode 因为是在云厂商提供的外部router上添加的 route 规则，对vm做到了无感知，所以 vm之间无需打通 二层 switch。&lt;/p></description></item><item><title>子目录父目录</title><link>https://tab.deoops.com/posts/path-overlap/</link><pubDate>Mon, 10 Sep 2018 21:20:33 +0800</pubDate><guid>https://tab.deoops.com/posts/path-overlap/</guid><description>&lt;img src="https://tab.deoops.com/posts/path-overlap/Half-overlapping-paths-of-AB.png" alt="Featured image of post 子目录父目录" />&lt;p>最近开发的遇到一个需求是在判断 两个目录是否相互包含。&lt;/p>
&lt;p>想着用正则表达式或者递归去解决，捣鼓一段时间后发现总有些edge case 不能cover到，&lt;/p>
&lt;p>后来发现用 python 的pathlib 可以很好的解决。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pathlib&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">overlapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">a_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">b_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">a_path&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">b_path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parents&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="n">b_path&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">a_path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parents&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>收集容器syslog</title><link>https://tab.deoops.com/posts/pod-syslog/</link><pubDate>Mon, 03 Sep 2018 20:46:00 +0800</pubDate><guid>https://tab.deoops.com/posts/pod-syslog/</guid><description>&lt;img src="https://tab.deoops.com/posts/pod-syslog/local-domain-socket.png" alt="Featured image of post 收集容器syslog" />&lt;p>有一个app 跑在pod里面，这个app 默认会输出自己的运行日志到syslogd，&lt;/p>
&lt;p>请问如何让host主机上运行的syslogd日志收集器收集到上面app输出的运行日志呢？&lt;/p>
&lt;h2 id="devlog">/dev/log&lt;/h2>
&lt;p>答案：把 主机的 &lt;code>/dev/log&lt;/code>目录挂载到 pod 里面的 &lt;code>/dev/log&lt;/code>即可。&lt;/p>
&lt;blockquote>
&lt;p>Some of these messages need to be brought to a system administrator’s attention immediately. And it may not be just any system administrator – there may be a particular system administrator who deals with a particular kind of message. Other messages just need to be recorded for future reference if there is a problem. Still others may need to have information extracted from them by an automated process that generates monthly reports.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>To deal with these messages, most Unix systems have a facility called &amp;ldquo;Syslog.&amp;rdquo; It is generally based on a daemon called “Syslogd” Syslogd listens for messages on a Unix domain socket named /dev/log.&lt;/p>
&lt;/blockquote>
&lt;p>参考&lt;a class="link" href="https://www.gnu.org/software/libc/manual/html_node/Overview-of-Syslog.html" target="_blank" rel="noopener"
>syslog overview&lt;/a>&lt;/p>
&lt;h3 id="mountpath">mountPath&lt;/h3>
&lt;p>具体来说就在 pod 的yaml 定义中，添加 hostPath volume，然后挂载到pod里：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">syslog&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/dev/log&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">syslog&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/dev/log&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在&lt;code>client-go&lt;/code>等sdk中这样写即可：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Volume&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;syslog&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">VolumeSource&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumeSource&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">HostPath&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HostPathVolumeSource&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Path&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;/dev/log&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Containers&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Container&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumeMount&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;syslog&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">MountPath&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;/dev/log&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>调度到master节点</title><link>https://tab.deoops.com/posts/master-affinity/</link><pubDate>Sat, 18 Aug 2018 20:57:52 +0800</pubDate><guid>https://tab.deoops.com/posts/master-affinity/</guid><description>&lt;img src="https://tab.deoops.com/posts/master-affinity/toleration.webp" alt="Featured image of post 调度到master节点" />&lt;p>一般来说，kubernetes 的pod是不在master 节点上运行的。&lt;/p>
&lt;p>如果要求pod 必须被调度到master 节点上运行，可以修改pod 的 toleration 和 affinity。&lt;/p>
&lt;h2 id="toleration和affinity">toleration和affinity：&lt;/h2>
&lt;p>在pod加上toleration和affinity配置&lt;/p>
&lt;h3 id="yaml">yaml&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tolerations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;node-role.kubernetes.io/master&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Equal&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">effect&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;NoSchedule&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">affinity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nodeAffinity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">requiredDuringSchedulingIgnoredDuringExecution&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nodeSelectorTerms&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">node-role.kubernetes.io/master&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Exists&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="go">go&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">Operator&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TolerationOpExists&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">Effect&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TaintEffectNoSchedule&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">Affinity&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Affinity&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">NodeAffinity&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodeAffinity&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">RequiredDuringSchedulingIgnoredDuringExecution&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodeSelector&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">NodeSelectorTerms&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodeSelectorTerm&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodeSelectorTerm&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">MatchExpressions&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodeSelectorRequirement&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodeSelectorRequirement&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">Key&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;node-role.kubernetes.io/master&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="nx">Operator&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">apiv1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodeSelectorOpExists&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">+&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>替换k8s所有证书</title><link>https://tab.deoops.com/posts/k8s-certs/</link><pubDate>Fri, 10 Aug 2018 20:27:10 +0800</pubDate><guid>https://tab.deoops.com/posts/k8s-certs/</guid><description>&lt;img src="https://tab.deoops.com/posts/k8s-certs/k8s.webp" alt="Featured image of post 替换k8s所有证书" />&lt;p>客户需要把kubernetes &lt;code>apiserver/etcd/kubelet/kubectl&lt;/code> 等所有的证书有效期修改为100年。&lt;/p>
&lt;p>很明显这是一个不合理的需求，不过客户说什么就是什么。&lt;/p>
&lt;p>于是经几天的调试有了下面的这个 &lt;code>Makefile&lt;/code>批量生成所有(&lt;code>FILES&lt;/code>变量)的证书。&lt;/p>
&lt;p>如果对makefile的语法不熟悉，可以看看&lt;a class="link" href="https://tab.deoops.com/posts/makefile-tutorial/" >Makefile简介&lt;/a>&lt;/p>
&lt;h2 id="makefile">makefile&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">FILES&lt;/span> &lt;span class="o">=&lt;/span> ca.crt ca.key sa.key sa.pub front-proxy-ca.crt front-proxy-ca.key etcd_ca.crt etcd_ca.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CONFS&lt;/span> &lt;span class="o">=&lt;/span> admin.conf controller-manager.conf kubelet.conf scheduler.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SELFS&lt;/span> &lt;span class="o">=&lt;/span> kubelet.crt.self kubelet.crt.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#KEYs = ca.key front-proxy-ca.key etcd_ca.key sa.key
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#CAs = ca.crt front-proxy-ca.crt etcd_ca.crt
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#PUBs = sa.pub
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## kubernetes will sign certificate
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## automatically, so below
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## csr/cert is for test purpose
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#CSR = apiserver.csr apiserver-kubelet-client.csr
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">CERT_KEYS&lt;/span> &lt;span class="o">=&lt;/span> apiserver.key apiserver-kubelet-client.key front-proxy-client.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CERTS&lt;/span> &lt;span class="o">=&lt;/span> apiserver.cert apiserver-kubelet-client.cert front-proxy-client.cert
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># openssl genrsa -des3 -out rootCA.key 4096
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">CMD_CREATE_PRIVATE_KEY&lt;/span> &lt;span class="o">=&lt;/span> openssl genrsa -out &lt;span class="nv">$@&lt;/span> &lt;span class="m">2048&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CMD_CREATE_PUBLIC_KEY&lt;/span> &lt;span class="o">=&lt;/span> openssl rsa -in $&amp;lt; -pubout -out &lt;span class="nv">$@&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># openssl req -x509 -new -nodes -key rootCA.key -sha256 -days 1024 -out rootCA.crt
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">CMD_CREATE_CA&lt;/span> &lt;span class="o">=&lt;/span> openssl req -x509 -new -nodes -key $&amp;lt; -sha256 -days &lt;span class="m">36500&lt;/span> -out &lt;span class="nv">$@&lt;/span> -subj &lt;span class="s1">&amp;#39;/CN=kubernetes&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># openssl req -new -key mydomain.com.key -out mydomain.com.csr
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">CMD_CREATE_CSR&lt;/span> &lt;span class="o">=&lt;/span> openssl req -new -key $&amp;lt; -out &lt;span class="nv">$@&lt;/span> -config &lt;span class="k">$(&lt;/span>word 2,$^&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># openssl x509 -req -in mydomain.com.csr -CA rootCA.crt -CAkey rootCA.key -CAcreateserial -out mydomain.com.crt -days 500 -sha256
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">CMD_SIGN_CERT&lt;/span> &lt;span class="o">=&lt;/span> openssl x509 -req -in $&amp;lt; -CA &lt;span class="k">$(&lt;/span>word 2,$^&lt;span class="k">)&lt;/span> -CAkey &lt;span class="k">$(&lt;/span>word 3,$^&lt;span class="k">)&lt;/span> -CAcreateserial -out &lt;span class="nv">$@&lt;/span> -days &lt;span class="m">36500&lt;/span> -sha256 -extfile &lt;span class="k">$(&lt;/span>word 4,$^&lt;span class="k">)&lt;/span> -extensions my_extensions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># generata self sign certificate
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">CMD_CREATE_CERT&lt;/span> &lt;span class="o">=&lt;/span> openssl req -x509 -new -nodes -key $&amp;lt; -sha256 -days &lt;span class="m">36500&lt;/span> -out &lt;span class="nv">$@&lt;/span> -subj &lt;span class="s1">&amp;#39;/CN=nodeXXX@timestamp1531732165&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CMD_MSG&lt;/span> &lt;span class="o">=&lt;/span> @echo generating &lt;span class="nv">$@&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">MASTER_IP&lt;/span> &lt;span class="o">:=&lt;/span> 192.168.1.200 &lt;span class="c1">## REMEMBER CHANGE ME&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">all&lt;/span> &lt;span class="n">clean&lt;/span> &lt;span class="n">check&lt;/span> &lt;span class="n">self_sign&lt;/span> &lt;span class="n">rename&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">all&lt;/span>&lt;span class="o">:&lt;/span> ${&lt;span class="n">FILES&lt;/span>} ${&lt;span class="n">CONFS&lt;/span>} ${&lt;span class="n">CERT_KEYS&lt;/span>} ${&lt;span class="n">CERTS&lt;/span>}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">clean&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -rm &lt;span class="si">${&lt;/span>&lt;span class="nv">FILES&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">CONFS&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">CERT_KEYS&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">CERTS&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">self_sign&lt;/span>&lt;span class="o">:&lt;/span> ${&lt;span class="n">SELFS&lt;/span>}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">check&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> f in *.cert *.crt&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$$&lt;/span>f&lt;span class="p">;&lt;/span> openssl x509 -noout -dates -in &lt;span class="nv">$$&lt;/span>f&lt;span class="p">;&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;===&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">rename&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> f in *.cert&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$$&lt;/span>f&lt;span class="p">;&lt;/span> mv &lt;span class="nv">$$&lt;/span>f &lt;span class="nv">$$&lt;/span>&lt;span class="o">{&lt;/span>f%.*&lt;span class="o">}&lt;/span>.crt&lt;span class="p">;&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;=====&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">%.key&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_MSG&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_CREATE_PRIVATE_KEY&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">%.pub&lt;/span>&lt;span class="o">:&lt;/span> %.&lt;span class="n">key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_MSG&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_CREATE_PUBLIC_KEY&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">%.self&lt;/span>&lt;span class="o">:&lt;/span> %.&lt;span class="n">key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_MSG&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_CREATE_CERT&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">%.crt&lt;/span>&lt;span class="o">:&lt;/span> %.&lt;span class="n">key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_MSG&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_CREATE_CA&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">%.csr&lt;/span>&lt;span class="o">:&lt;/span> %.&lt;span class="n">key&lt;/span> %.&lt;span class="n">csr&lt;/span>.&lt;span class="n">cnf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_MSG&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_CREATE_CSR&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">%.cert&lt;/span>&lt;span class="o">:&lt;/span> %.&lt;span class="n">csr&lt;/span> &lt;span class="n">ca&lt;/span>.&lt;span class="n">crt&lt;/span> &lt;span class="n">ca&lt;/span>.&lt;span class="n">key&lt;/span> %.&lt;span class="n">csr&lt;/span>.&lt;span class="n">cnf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#%.cert: %.csr front-proxy-ca.crt front-proxy-ca.key %.csr.cnf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_MSG&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CMD_SIGN_CERT&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">%.conf&lt;/span>&lt;span class="o">:&lt;/span> %.&lt;span class="n">cert&lt;/span> %-&lt;span class="n">conf&lt;/span>.&lt;span class="n">sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sh &lt;span class="k">$(&lt;/span>word 2,$^&lt;span class="k">)&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">MASTER_IP&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上面的&lt;code>Makefile&lt;/code>还需要对应的&lt;code>csr&lt;/code>和 &lt;code>conffiles&lt;/code>。&lt;/p>
&lt;h3 id="admincsrcnf">admin.csr.cnf&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">cat &lt;span class="s">&amp;lt;&amp;lt;EOF &amp;gt; admin.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">apiVersion: v1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">clusters:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">- cluster:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> certificate-authority-data: $(cat ca.crt | base64 | tr -d &amp;#39;\n&amp;#39;)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> server: https://$1:6443
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> name: kubernetes
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">contexts:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">- context:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> cluster: kubernetes
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> user: kubernetes-admin
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> name: kubernetes-admin@kubernetes
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">current-context: kubernetes-admin@kubernetes
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">kind: Config
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">preferences: {}
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">users:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">- name: kubernetes-admin
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> user:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> client-certificate-data: $(cat admin.cert | base64 | tr -d &amp;#39;\n&amp;#39;)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> client-key-data: $(cat admin.key | base64 | tr -d &amp;#39;\n&amp;#39;)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="admin-confsh">admin-conf.sh&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[ req ]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">prompt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">no&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">utf8&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">yes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">distinguished_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">my_req_distinguished_name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">req_extensions&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">my_extensions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[ my_req_distinguished_name ]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">C&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">dn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ST&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">lol&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">L&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">dota&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">O&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">system:masters # change this&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">CN&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">kubernetes-admin # change this&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[ my_extensions ]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">basicConstraints&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">CA:FALSE&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">subjectKeyIdentifier&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">hash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># subjectAltName=@my_subject_alt_names&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># [ my_subject_alt_names ]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># DNS.1 = *.oats.org&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># DNS.2 = *.oats.net&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># DNS.3 = *.oats.in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># DNS.4 = oats.org&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># DNS.5 = oats.net&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># DNS.6 = oats.in&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="kubeadm">kubeadm&lt;/h2>
&lt;p>安装k8s集群的时候，使用&lt;code>kubeadm phase certs&lt;/code>命令更新证书即可：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">kubeadm alpha phase certs all --config kubeadm-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubeadm alpha phase kubelet config write-to-disk --config kubeadm-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubeadm alpha phase kubelet write-env-file --config kubeadm-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubeadm alpha phase kubeconfig kubelet --config kubeadm-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubeadm alpha phase kubeconfig all --config kubeadm-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## --experimental-cluster-signing-duration=187600h0m0s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubeadm alpha phase controlplane all --config kubeadm-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start kubelet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubeadm alpha phase mark-master --config kubeadm-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## kubeadm join 172.16.0.5:6443 --token xvrmo8.lk0ec7ifzn8mdflu2 --discovery-token-unsafe-skip-ca-verification&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>flannel vpc</title><link>https://tab.deoops.com/posts/tx-flannel/</link><pubDate>Wed, 08 Aug 2018 18:59:00 +0800</pubDate><guid>https://tab.deoops.com/posts/tx-flannel/</guid><description>&lt;img src="https://tab.deoops.com/posts/tx-flannel/flannel-vpc.png" alt="Featured image of post flannel vpc" />&lt;p>update: flannel从v0.14.0(2021/05/27)开始已经支持&lt;a class="link" href="https://github.com/flannel-io/flannel/tree/master/backend/tencentvpc" target="_blank" rel="noopener"
>腾讯云的vpc backend&lt;/a>了。&lt;/p>
&lt;p>客户需要在腾讯云上部署&lt;code>kubernetes&lt;/code>集群而且选用的网络插件是flannel，所以我们需要为&lt;code>flannel&lt;/code> 添加 腾讯云 vpc 的 backend 适配。&lt;/p>
&lt;p>我大致看了下github上 &lt;a class="link" href="https://github.com/coreos/flannel/tree/master/backend" target="_blank" rel="noopener"
>阿里云 和 aws&lt;/a> 适配器的代码，发现并不复杂，flannel已经把所有的dirty work flannel 都包装好API了。&lt;/p>
&lt;p>稍稍了解一些网络设备或者Linux网络相关的命令（比如&lt;code>route table&lt;/code>）就可以比较轻松的写出flannel适配器。&lt;/p>
&lt;p>整个适配过程可以分为下面4个步骤：&lt;/p>
&lt;ol>
&lt;li>定义 TxVpcBackend struct, 实现New func 在init func中注册;&lt;/li>
&lt;li>调用腾讯云SDK 实现 RegisterNetwork method;&lt;/li>
&lt;li>最后在main.go中 注册腾讯云backend 即可；&lt;/li>
&lt;li>部署deployment 的时候选择 tx-vpc 的backend 即可.&lt;/li>
&lt;/ol>
&lt;p>下面结合部分代码具体的说下实现过程：&lt;/p>
&lt;h2 id="开发">开发&lt;/h2>
&lt;h3 id="定义结构体">定义结构体&lt;/h3>
&lt;p>只是搭一个架子，方便注册到flannel backend上，不含具体适配器的逻辑：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">TxVpcBackend&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sm&lt;/span> &lt;span class="nx">subnet&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Manager&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">extIface&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">backend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ExternalInterface&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sm&lt;/span> &lt;span class="nx">subnet&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Manager&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">extIface&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">backend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ExternalInterface&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">backend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Backend&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">be&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">TxVpcBackend&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sm&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">sm&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">extIface&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">extIface&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">be&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">backend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tx-vpc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">New&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="实现registernetwork">实现RegisterNetwork&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">be&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">TxVpcBackend&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">RegisterNetwork&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">config&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">subnet&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">backend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Network&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 1. Parse our configuration
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">cfg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">AccessKeyID&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">AccessKeySecret&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Backend&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unmarshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Backend&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cfg&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error decoding VPC backend config: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Unmarshal Configure : %v\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 2. Acquire the lease form subnet manager
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">attrs&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">subnet&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LeaseAttrs&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">PublicIP&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">ip&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FromIP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">be&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">extIface&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ExtAddr&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">l&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">be&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AcquireLease&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">attrs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">switch&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Canceled&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DeadlineExceeded&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to acquire lease: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AccessKeyID&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AccessKeySecret&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AccessKeyID&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getenv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ACCESS_KEY_ID&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AccessKeySecret&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getenv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ACCESS_KEY_SECRET&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AccessKeyID&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AccessKeySecret&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ACCESS_KEY_ID and ACCESS_KEY_SECRET must be provided! &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">createRoute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Subnet&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AccessKeyID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AccessKeySecret&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Error DescribeVRouters: %s .\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">backend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SimpleNetwork&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">SubnetLease&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ExtIface&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">be&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">extIface&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>主要逻辑是 使用腾讯云的SDK 在vpc 网络下创建route , 即上面的&lt;/p>
&lt;p>&lt;code>err = createRoute(l.Subnet.String(), cfg.AccessKeyID, cfg.AccessKeySecret&lt;/code>&lt;/p>
&lt;p>因为&lt;code>createRoute Func&lt;/code>和 腾讯云sdk 的实现强相关，所以我就不展开了，个人可以去github上查看腾讯云的sdk文档。&lt;/p>
&lt;h3 id="targetrout">targetRout&lt;/h3>
&lt;p>最后targetRoute 应该是这个样子的：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">targetRoute&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">vpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Route&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">DestinationCidrBlock&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">common&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StringPtr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">dest&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">GatewayType&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">common&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StringPtr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;NORMAL_CVM&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">GatewayId&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">common&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StringPtr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nextHop&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">RouteDescription&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">common&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StringPtr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">desc&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; flannel podCIDR&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="registry">registry&lt;/h3>
&lt;p>在&lt;code>main.go&lt;/code>文件中加如&lt;code>import&lt;/code> pkg即可注册腾讯云适配器：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">_&lt;/span> &lt;span class="s">&amp;#34;github.com/coreos/flannel/backend/txvpc&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="部署">部署&lt;/h2>
&lt;h3 id="修改deploymnet">修改deploymnet&lt;/h3>
&lt;p>修改官方的deployment yaml 文件中 net-conf.json字段，
把&lt;code>&amp;quot;Type&amp;quot;: &lt;/code>改成&lt;code>tx-vpc&lt;/code>即可：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">net-conf.json&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> &amp;#34;Network&amp;#34;: &amp;#34;10.244.0.0/16&amp;#34;,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> &amp;#34;Backend&amp;#34;: {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> &amp;#34;Type&amp;#34;: &amp;#34;tx-vpc&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> }&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="新建ram账户">新建RAM账户&lt;/h3>
&lt;p>在腾讯云的dashboard新建 RAM 帐户，赋予vpc网络读写权限。&lt;/p>
&lt;p>记下 AccessKeyID 和 AccessKeySecret;&lt;/p>
&lt;p>修改deployment中填写&lt;code>deploy.yaml&lt;/code>为上一步中记录的 &lt;code>AccessKeyID&lt;/code> 和 &lt;code>AccessKeySecret&lt;/code>值。&lt;/p>
&lt;p>最后，用kubectl 部署flannle即可：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">kubectl create -f deploy.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Makefile简介</title><link>https://tab.deoops.com/posts/makefile-tutorial/</link><pubDate>Fri, 27 Jul 2018 12:38:51 +0800</pubDate><guid>https://tab.deoops.com/posts/makefile-tutorial/</guid><description>&lt;img src="https://tab.deoops.com/posts/makefile-tutorial/gnu-make.png" alt="Featured image of post Makefile简介" />&lt;p>网络上关于 &lt;code>makefile&lt;/code>的教程有很多，由于我日常不是写&lt;code>c/c++&lt;/code>的，
不常使用&lt;code>makefile&lt;/code>，需要用的时候总是要重新Google搜索makefile的语法。&lt;/p>
&lt;p>索性整理出来这篇 makefile 教程，备忘。&lt;/p>
&lt;h2 id="教程">教程&lt;/h2>
&lt;p>Makefile简易教程：&lt;/p>
&lt;h3 id="基本语法">基本语法&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">target&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">dependency&lt;/span>1 &lt;span class="n">dependency&lt;/span>2 ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">[TAB]&lt;/span> &lt;span class="err">action1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">[TAB]&lt;/span> &lt;span class="err">action2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>下面的makefile摘抄自&lt;a class="link" href="https://opensourceforu.com/2012/06/gnu-make-in-detail-for-beginners/" target="_blank" rel="noopener"
>GNU Make in Detail for Beginners&lt;/a>，这篇入门文章把makefile的语法写的非常透彻。&lt;/p>
&lt;p>推荐大家多读几遍&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="line">&lt;span class="cl">&lt;span class="c">##### makefile for compile C programs
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Compiler to use
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">CC&lt;/span> &lt;span class="o">=&lt;/span> gcc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># -g for debug, -O2 for optimise and -Wall additonal messages
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">OPTIONS&lt;/span> &lt;span class="o">=&lt;/span> -O2 -g -Wall
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Directory for header file
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">INCLUDES&lt;/span> &lt;span class="o">=&lt;/span> -I .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List of objects to be build
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">OBJS&lt;/span> &lt;span class="o">=&lt;/span> main.o module.o
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">all&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="n">clean&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">all&lt;/span>&lt;span class="o">:&lt;/span> ${&lt;span class="n">OBJS&lt;/span>}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s2">&amp;#34;Building...&amp;#34;&lt;/span> &lt;span class="c1"># print &amp;#34;Building...&amp;#34; message&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CC&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">OPTIONS&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">INCLUDES&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">OBJS&lt;/span>&lt;span class="si">}&lt;/span> -o main_bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">%.o&lt;/span>&lt;span class="o">:&lt;/span> %.&lt;span class="n">c&lt;/span> &lt;span class="c"># &amp;#39;%&amp;#39; pattern wildcard matching
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">CC&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">OPTIONS&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">INCLUDES&lt;/span>&lt;span class="si">}&lt;/span> -c %.c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">list&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="k">$(&lt;/span>shell ls&lt;span class="k">)&lt;/span> &lt;span class="c1"># print output of command `ls`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">clean&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo Cleaning up...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -rm -rf *.0 &lt;span class="c1"># &amp;#39;-&amp;#39; prefix for ignoring errors and continue execution&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -rm main_bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#### makefile for img manage
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">FILES&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">$(&lt;/span>shell find imgs -type f -iname &lt;span class="s2">&amp;#34;*.jpg&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> sed &lt;span class="s1">&amp;#39;s/imgs/thumb/g&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CONVERT_CMD&lt;/span> &lt;span class="o">=&lt;/span> convert -resize &lt;span class="s2">&amp;#34;100x100&amp;#34;&lt;/span> $&amp;lt; &lt;span class="nv">$@&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">MSG&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;\nUpdating thumbnail&amp;#34;&lt;/span> &lt;span class="nv">$@&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">all_thumb&lt;/span>&lt;span class="o">:&lt;/span> ${&lt;span class="n">FILES&lt;/span>}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">thumb/%.jpg&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">imgs&lt;/span>/%.&lt;span class="n">jpg&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">MSG&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CONVERT_CMD&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">thumb/%.JPG&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">imgs&lt;/span>/%.&lt;span class="n">JPG&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">MSG&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="si">${&lt;/span>&lt;span class="nv">CONVERT_CMD&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">clean_all&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo Cleaning up files...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -rm -rf thumb/*.&lt;span class="o">{&lt;/span>jpg,JPG&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="变量">变量&lt;/h3>
&lt;h4 id="赋值">赋值&lt;/h4>
&lt;h5 id="simple-assignment-">Simple assignment (:=)&lt;/h5>
&lt;p>We can assign values (RHS) to variables (LHS) with this operator, for example: CC := gcc. With simple assignment (:=), the value is expanded and stored to all occurrences in the Makefile when its first definition is found.&lt;/p>
&lt;p>For example, when a CC := ${GCC} ${FLAGS} simple definition is first encountered, CC is set to gcc -W and wherever ${CC} occurs in actions, it is replaced with gcc -W.&lt;/p>
&lt;h5 id="recursive-assignment-">Recursive assignment (=)&lt;/h5>
&lt;p>Recursive assignment (the operator used is =) involves variables and values that are not evaluated immediately on encountering their definition, but are re-evaluated every time they are encountered in an action that is being executed. As an example, say we have:&lt;/p>
&lt;p>GCC = gcc
FLAGS = -W
With the above lines, CC = ${GCC} {FLAGS} will be converted to gcc -W only when an action like ${CC} file.c is executed somewhere in the Makefile. With recursive assignation, if the GCC variable is changed later (for example, GCC = c++), then when it is next encountered in an action line that is being updated, it will be re-evaluated, and the new value will be used; ${CC} will now expand to c++ -W.&lt;/p>
&lt;p>We will also have an interesting and useful application further in the article, where this feature is used to deal with varying cases of filename extensions of image files.&lt;/p>
&lt;h5 id="conditional-assignment-">Conditional assignment (?=)&lt;/h5>
&lt;p>Conditional assignment statements assign the given value to the variable only if the variable does not yet have a value.&lt;/p>
&lt;h5 id="appending-">Appending (+=)&lt;/h5>
&lt;p>The appending operation appends texts to an existing variable. For example:&lt;/p>
&lt;p>CC = gcc
CC += -W
CC now holds the value gcc -W.&lt;/p>
&lt;h4 id="action内置变量">action内置变量&lt;/h4>
&lt;p>The &lt;code>%&lt;/code> character can be used for wildcard pattern-matching, to provide generic targets. For example:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">%.o&lt;/span>&lt;span class="o">:&lt;/span> %.&lt;span class="n">c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">[TAB]&lt;/span> &lt;span class="err">actions&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>When &lt;code>%&lt;/code> appears in the dependency list, it is replaced with the same string that was used to perform substitution in the target.
Inside actions, we can use special variables for matching filenames. Some of them are:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="line">&lt;span class="cl">&lt;span class="k">$@&lt;/span> &lt;span class="err">(full&lt;/span> &lt;span class="err">target&lt;/span> &lt;span class="err">name&lt;/span> &lt;span class="err">of&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">current&lt;/span> &lt;span class="err">target)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">$?&lt;/span> &lt;span class="err">(returns&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">dependencies&lt;/span> &lt;span class="err">that&lt;/span> &lt;span class="err">are&lt;/span> &lt;span class="err">newer&lt;/span> &lt;span class="err">than&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">current&lt;/span> &lt;span class="err">target)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">$*&lt;/span> &lt;span class="err">(returns&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">text&lt;/span> &lt;span class="err">that&lt;/span> &lt;span class="err">corresponds&lt;/span> &lt;span class="err">to&lt;/span> &lt;span class="err">%&lt;/span> &lt;span class="err">in&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">target)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">$&amp;lt;&lt;/span> &lt;span class="err">(name&lt;/span> &lt;span class="err">of&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">first&lt;/span> &lt;span class="err">dependency)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">dep.o&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">dep&lt;/span>.&lt;span class="n">src&lt;/span> &lt;span class="n">config&lt;/span>1.&lt;span class="n">cfg&lt;/span> &lt;span class="n">config&lt;/span>2.&lt;span class="n">cfg&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo the second preq is &lt;span class="k">$(&lt;/span>word 2,$^&lt;span class="k">)&lt;/span>, the third is &lt;span class="k">$(&lt;/span>word 3,$^&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">$^&lt;/span> &lt;span class="err">(name&lt;/span> &lt;span class="err">of&lt;/span> &lt;span class="err">all&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">dependencies&lt;/span> &lt;span class="err">with&lt;/span> &lt;span class="err">space&lt;/span> &lt;span class="err">as&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">delimiter)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">Instead&lt;/span> &lt;span class="err">of&lt;/span> &lt;span class="err">writing&lt;/span> &lt;span class="err">each&lt;/span> &lt;span class="err">of&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">file&lt;/span> &lt;span class="err">names&lt;/span> &lt;span class="err">in&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">actions&lt;/span> &lt;span class="err">and&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">target,&lt;/span> &lt;span class="err">we&lt;/span> &lt;span class="err">can&lt;/span> &lt;span class="err">use&lt;/span> &lt;span class="err">shorthand&lt;/span> &lt;span class="err">notations&lt;/span> &lt;span class="err">based&lt;/span> &lt;span class="err">on&lt;/span> &lt;span class="err">the&lt;/span> &lt;span class="err">above,&lt;/span> &lt;span class="err">to&lt;/span> &lt;span class="err">write&lt;/span> &lt;span class="err">more&lt;/span> &lt;span class="err">generic&lt;/span> &lt;span class="err">Makefiles.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="action-modifiers">action modifiers&lt;/h3>
&lt;p>We can change the behaviour of the actions we use by prefixing certain action modifiers to the actions. Two important action modifiers are:&lt;/p>
&lt;h4 id="--minus">- (minus)&lt;/h4>
&lt;p>Prefixing &lt;code>-&lt;/code> to any action causes any error that occurs while executing the action to be ignored.&lt;/p>
&lt;p>By default, execution of a Makefile stops when any command returns a non-zero (error) value.
If an error occurs, a message is printed, with the status code of the command, and noting that the error has been ignored.
Looking at the Makefile from our sample project: in the clean target, the rm target_bin command will produce an error if that file does not exist (this could happen if the project had never been compiled, or if make clean is run twice consecutively).
To handle this, we can prefix the rm command with a minus, to ignore errors: -rm target_bin.&lt;/p>
&lt;h4 id="-at">@ (at)&lt;/h4>
&lt;p>&lt;code>@&lt;/code> suppresses the standard print-action-to-standard-output behaviour of make, for the action/command that is prefixed with @.
For example, to echo a custom message to standard output, we want only the output of the echo command, and don’t want to print the echo command line itself. @echo Message will print “Message” without the echo command line being printed.&lt;/p>
&lt;h4 id="phony">.PHONY&lt;/h4>
&lt;p>Use PHONY to avoid file-target name conflicts.
Remember the all and clean special targets in our Makefile?
What happens when the project directory has files with the names all or clean?
The conflicts will cause errors.
Use the &lt;code>.PHONY&lt;/code> directive to specify which targets are not to be treated as files — for example: &lt;code>.PHONY: all clean&lt;/code>.&lt;/p>
&lt;h3 id="其它">其它&lt;/h3>
&lt;h4 id="dry-run">dry run&lt;/h4>
&lt;p>Simulating make without actual execution.
At times, maybe when developing the Makefile, we may want to trace the make execution (and view the logged messages) without actually running the actions, which is time consuming.
Simply use &lt;code>make -n&lt;/code> to do a “dry run”.&lt;/p>
&lt;h4 id="shell">shell&lt;/h4>
&lt;p>Using the shell command output in a variable
Sometimes we need to use the output from one command/action in other places in the Makefile — for example, checking versions/locations of installed libraries, or other files required for compilation.
We can obtain the shell output using the shell command.
For example, to return a list of files in the current directory into a variable, we would run: &lt;code>LS_OUT = $(shell ls)&lt;/code>.&lt;/p>
&lt;h4 id="nested-makefiles">Nested Makefiles&lt;/h4>
&lt;p>Nested Makefiles (which are Makefiles in one or more subdirectories that are also executed by running the make command in the parent directory) can be useful for building smaller projects as part of a larger project. To do this, we set up a target whose action changes directory to the subdirectory, and invokes make again:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">subtargets&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">cd&lt;/span> subdirectory &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="k">$(&lt;/span>MAKE&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Instead of running the make command, we used &lt;code>$(MAKE)&lt;/code>, an environment variable, to provide flexibility to include arguments.
For example, if you were doing a “dry run” invocation: if we used the make command directly for the subdirectory, the simulation option (-n) would not be passed, and the commands in the subdirectory’s Makefile would actually be executed.
To enable use of the -n argument, use the $(MAKE) variable.&lt;/p>
&lt;h2 id="实践">实践&lt;/h2>
&lt;p>在golang项目里的&lt;a class="link" href="https://github.com/datewu/project-abc/blob/master/Makefile" target="_blank" rel="noopener"
>实践&lt;/a>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Include variables from .envrc files
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="err">-include&lt;/span> &lt;span class="err">.envrc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ==================================================================================== #
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># HELPERS
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ==================================================================================== #
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## help: print this help message
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">help&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">help&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s2">&amp;#34;\t##IMPORTANT##: please run &amp;#39;echo .envrc &amp;gt;&amp;gt; .gitignore&amp;#39; at very first time&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s1">&amp;#39;Usage:&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @sed -n &lt;span class="s1">&amp;#39;s/^##//p&amp;#39;&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">MAKEFILE_LIST&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="p">|&lt;/span> column -t -s &lt;span class="s1">&amp;#39;:&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> sed -e &lt;span class="s1">&amp;#39;s/^/ /&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Create the new confirm target.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">confirm&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">confirm&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo -n &lt;span class="s1">&amp;#39;Are you sure? [y/N] &amp;#39;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">read&lt;/span> ans &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$$&lt;/span>&lt;span class="o">{&lt;/span>ans:-N&lt;span class="o">}&lt;/span> &lt;span class="o">=&lt;/span> y &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ==================================================================================== #
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DEVELOPMENT
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ==================================================================================== #
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## run/main: run the cmd/main binary file
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">run&lt;/span>/&lt;span class="n">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">run/main&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go run ./cmd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## run/debug: debug app use dlv
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">run&lt;/span>/&lt;span class="n">debug&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">run/debug&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dlv debug ./cmd --headless --listen :4040
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## run/test: runs go test with default values
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">run&lt;/span>/&lt;span class="n">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">run/test&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go &lt;span class="nb">test&lt;/span> -timeout 300s -v -count&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span> -race ./...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## run/update: runs go get -u &amp;amp;&amp;amp; go mod tidy
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">run&lt;/span>/&lt;span class="n">update&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">run/update&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go get -u ./...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go mod tidy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## db/psql: connection to the database using psql
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">db&lt;/span>/&lt;span class="n">psql&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">db/psql&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @psql &lt;span class="si">${&lt;/span>&lt;span class="nv">PG_DSN&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## db/generate use sqlc generated models and queries
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">db&lt;/span>/&lt;span class="n">generate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">db/generate&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s1">&amp;#39;sqlc generate in internal/sqlc fold&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @cd internal/sqlc &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> sqlc generate &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">cd&lt;/span> ../..
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## db/migrations/new name=$1: create a new database migration
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">db&lt;/span>/&lt;span class="n">migrations&lt;/span>/&lt;span class="n">new&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">db/migrations/new&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s1">&amp;#39;Creating migrate files for ${name}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @migrate create -seq -ext&lt;span class="o">=&lt;/span>.sql -dir&lt;span class="o">=&lt;/span>./migrations &lt;span class="si">${&lt;/span>&lt;span class="nv">name&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## db/migrations/up: apply all up database migrations
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">db&lt;/span>/&lt;span class="n">migrations&lt;/span>/&lt;span class="n">up&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">db/migrations/up&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">confirm&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s1">&amp;#39;Running up migrations...&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @migrate -path ./migrations -database &lt;span class="si">${&lt;/span>&lt;span class="nv">PG_DSN&lt;/span>&lt;span class="si">}&lt;/span> up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ==================================================================================== #
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># QUALITY CONTROL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ==================================================================================== #
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## audit: tidy dependencies and format, vet and test all code
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">audit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">audit&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s1">&amp;#39;Tidying and verifying module dependencies...&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go mod tidy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go mod verify
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s1">&amp;#39;Formatting code...&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go fmt ./...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s1">&amp;#39;Vetting code...&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go vet ./...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#staticcheck ./... # go install honnef.co/go/tools/cmd/staticcheck@latest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s1">&amp;#39;Running tests...&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go &lt;span class="nb">test&lt;/span> -race -vet&lt;span class="o">=&lt;/span>off ./...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## vendor: tidy and vendor dependencies
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">vendor&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">vendor&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s1">&amp;#39;Tidying and verifying module dependencies...&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go mod tidy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go mod verify
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s1">&amp;#39;Vendoring dependencies...&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go mod vendor
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ==================================================================================== #
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># BUILD
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ==================================================================================== #
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#current_time = $(shell date --iso-8601=seconds)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">current_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">$(&lt;/span>shell date -u +&lt;span class="s2">&amp;#34;%Y-%m-%dT%H:%M:%SZ&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">git_description&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">$(&lt;/span>shell git describe --always --dirty --tags --long&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">linker_flags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;-s -X main.buildTime=${current_time} -X main.version=${git_description}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## build/api: build the cmd/api application
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">build&lt;/span>/&lt;span class="n">api&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">build/main&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">audit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s1">&amp;#39;Building cmd/...&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> go build -ldflags&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">linker_flags&lt;/span>&lt;span class="si">}&lt;/span> -o&lt;span class="o">=&lt;/span>./bin/cmd ./cmd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#go tool dist list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">GOOS&lt;/span>&lt;span class="o">=&lt;/span>linux &lt;span class="nv">GOARCH&lt;/span>&lt;span class="o">=&lt;/span>amd64 go build -ldflags&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">linker_flags&lt;/span>&lt;span class="si">}&lt;/span> -o&lt;span class="o">=&lt;/span>./bin/linux_amd64/cmd ./cmd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## build/dlv-debug: build the application with dlv gcflags
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nf">.PHONY&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">build&lt;/span>/&lt;span class="n">dlv&lt;/span>-&lt;span class="n">debug&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">build/dlv-debug&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @echo &lt;span class="s2">&amp;#34;Building for delve debug...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> @go build &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -ldflags &lt;span class="si">${&lt;/span>&lt;span class="nv">linker_flags&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -ldflags&lt;span class="o">=&lt;/span>-compressdwarf&lt;span class="o">=&lt;/span>&lt;span class="nb">false&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -gcflags&lt;span class="o">=&lt;/span>&lt;span class="nv">all&lt;/span>&lt;span class="o">=&lt;/span>-d&lt;span class="o">=&lt;/span>checkptr &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -gcflags&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;all=-N -l&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -o ./bin/debug ./cmd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>事件驱动</title><link>https://tab.deoops.com/posts/shell-fifo/</link><pubDate>Wed, 27 Jun 2018 12:20:29 +0800</pubDate><guid>https://tab.deoops.com/posts/shell-fifo/</guid><description>&lt;img src="https://tab.deoops.com/posts/shell-fifo/pm.png" alt="Featured image of post 事件驱动" />&lt;p>在shell脚本里使用&lt;code>mkfifo&lt;/code>命令创建&lt;code>named pipes&lt;/code>可以实现简单的事件驱动，
避免poll（轮询）带来的时延（not real-time）和资源消耗的问题。&lt;/p>
&lt;h2 id="mkfifo">mkfifo&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ man mkfifo &lt;span class="p">|&lt;/span> head -n &lt;span class="m">12&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MKFIFO&lt;span class="o">(&lt;/span>1&lt;span class="o">)&lt;/span> General Commands Manual MKFIFO&lt;span class="o">(&lt;/span>1&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkfifo – make fifos
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SYNOPSIS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkfifo &lt;span class="o">[&lt;/span>-m mode&lt;span class="o">]&lt;/span> fifo_name ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DESCRIPTION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkfifo creates the fifos requested, in the order specified. By default,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> the resulting fifos have mode &lt;span class="m">0666&lt;/span> &lt;span class="o">(&lt;/span>rw-rw-rw-&lt;span class="o">)&lt;/span>, limited by the current
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> umask&lt;span class="o">(&lt;/span>2&lt;span class="o">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">~
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="consumer">consumer&lt;/h3>
&lt;p>消费者以blocked的状态监听&lt;code>事件的发生&lt;/code>，然后&lt;code>handle&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">pipe&lt;/span>&lt;span class="o">=&lt;/span>/tmp/testpipe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">trap&lt;/span> &lt;span class="s2">&amp;#34;rm -f &lt;/span>&lt;span class="nv">$pipe&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> EXIT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> ! -p &lt;span class="nv">$pipe&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkfifo &lt;span class="nv">$pipe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">read&lt;/span> line &amp;lt;&lt;span class="nv">$pipe&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$line&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;quit&amp;#39;&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$line&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;consumer exiting&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="producer">producer&lt;/h3>
&lt;p>生产者往&lt;code>pipe&lt;/code>里写入内容，&lt;code>触发事件&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">pipe&lt;/span>&lt;span class="o">=&lt;/span>/tmp/testpipe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> ! -p &lt;span class="nv">$pipe&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Reader not running&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">1&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="s2">&amp;#34;Hello from &lt;/span>&lt;span class="nv">$$&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$msg&lt;/span> &amp;gt;&lt;span class="nv">$pipe&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>审计目录</title><link>https://tab.deoops.com/posts/audit-file/</link><pubDate>Wed, 20 Jun 2018 17:02:58 +0800</pubDate><guid>https://tab.deoops.com/posts/audit-file/</guid><description>&lt;img src="https://tab.deoops.com/posts/audit-file/audit.jpeg" alt="Featured image of post 审计目录" />&lt;p>今天调试容器应用的时候发现，app运行一段时间后，容器外挂的一个volumn会偶发性的被删除。
于是需要监控下到底是谁/哪个进程把文件目录给删除了。&lt;/p>
&lt;p>google一阵子后，发现可以使用&lt;code>auditd&lt;/code> 服务来监控和搜索出都有那些进程操作够目标文件/目录。&lt;/p>
&lt;p>整个过程分为3步：&lt;/p>
&lt;ol>
&lt;li>开启 auditd 服务；&lt;/li>
&lt;li>使用auditctl 配置 auditd服务；&lt;/li>
&lt;li>一段时间之后 使用 ausearch 来查看/搜索审计的日志。&lt;/li>
&lt;/ol>
&lt;h2 id="启动监控">启动监控&lt;/h2>
&lt;p>开启&lt;code>auditd&lt;/code>服务：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">systemctl start auditd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## you may need `mkdir /var/log/audit`&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="添加监控规则">添加监控规则&lt;/h2>
&lt;p>编辑审计规则：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## list existing rules&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">auditctl -l
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## clean existing rules&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">auditctl -D
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## watch /var/run/yourfolder&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">auditctl -w /var/run/yourfolder -p war -k serachkey
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="auditctl语法">auditctl语法&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ddeoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># auditctl -h&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usage: auditctl &lt;span class="o">[&lt;/span>options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -a &amp;lt;l,a&amp;gt; Append rule to end of &amp;lt;l&amp;gt;ist with &amp;lt;a&amp;gt;ction
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -A &amp;lt;l,a&amp;gt; Add rule at beginning of &amp;lt;l&amp;gt;ist with &amp;lt;a&amp;gt;ction
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -b &amp;lt;backlog&amp;gt; Set max number of outstanding audit buffers
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> allowed &lt;span class="nv">Default&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -c Continue through errors in rules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -C &lt;span class="nv">f&lt;/span>&lt;span class="o">=&lt;/span>f Compare collected fields &lt;span class="k">if&lt;/span> available:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Field name, operator&lt;span class="o">(=&lt;/span>,!&lt;span class="o">=)&lt;/span>, field name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -d &amp;lt;l,a&amp;gt; Delete rule from &amp;lt;l&amp;gt;ist with &amp;lt;a&amp;gt;ction
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">l&lt;/span>&lt;span class="o">=&lt;/span>task,exit,user,exclude
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">a&lt;/span>&lt;span class="o">=&lt;/span>never,always
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -D Delete all rules and watches
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e &lt;span class="o">[&lt;/span>0..2&lt;span class="o">]&lt;/span> Set enabled flag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -f &lt;span class="o">[&lt;/span>0..2&lt;span class="o">]&lt;/span> Set failure flag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">0&lt;/span>&lt;span class="o">=&lt;/span>silent &lt;span class="nv">1&lt;/span>&lt;span class="o">=&lt;/span>printk &lt;span class="nv">2&lt;/span>&lt;span class="o">=&lt;/span>panic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -F &lt;span class="nv">f&lt;/span>&lt;span class="o">=&lt;/span>v Build rule: field name, operator&lt;span class="o">(=&lt;/span>,!&lt;span class="o">=&lt;/span>,&amp;lt;,&amp;gt;,&amp;lt;&lt;span class="o">=&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;gt;&lt;span class="o">=&lt;/span>,&lt;span class="p">&amp;amp;&lt;/span>,&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="o">=)&lt;/span> value
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -h Help
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -i Ignore errors when reading rules from file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -k &amp;lt;key&amp;gt; Set filter key on audit rule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -l List rules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -m text Send a user-space message
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -p &lt;span class="o">[&lt;/span>r&lt;span class="p">|&lt;/span>w&lt;span class="p">|&lt;/span>x&lt;span class="p">|&lt;/span>a&lt;span class="o">]&lt;/span> Set permissions filter on watch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">r&lt;/span>&lt;span class="o">=&lt;/span>read, &lt;span class="nv">w&lt;/span>&lt;span class="o">=&lt;/span>write, &lt;span class="nv">x&lt;/span>&lt;span class="o">=&lt;/span>execute, &lt;span class="nv">a&lt;/span>&lt;span class="o">=&lt;/span>attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -q &amp;lt;mount,subtree&amp;gt; make subtree part of mount point&lt;span class="err">&amp;#39;&lt;/span>s dir watches
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -r &amp;lt;rate&amp;gt; Set limit in messages/sec &lt;span class="o">(&lt;/span>&lt;span class="nv">0&lt;/span>&lt;span class="o">=&lt;/span>none&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -R &amp;lt;file&amp;gt; &lt;span class="nb">read&lt;/span> rules from file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -s Report status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -S syscall Build rule: syscall name or number
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -t Trim directory watches
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -v Version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -w &amp;lt;path&amp;gt; Insert watch at &amp;lt;path&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -W &amp;lt;path&amp;gt; Remove watch at &amp;lt;path&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --loginuid-immutable Make loginuids unchangeable once &lt;span class="nb">set&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --reset-lost Reset the lost record counter
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="分析日志">分析日志&lt;/h2>
&lt;p>查看/搜索 审计日志：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># ausearch -k wiserun -i &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>SYSCALL &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>2018年06月20日 14:22:33.669:8377&lt;span class="o">)&lt;/span> : &lt;span class="nv">arch&lt;/span>&lt;span class="o">=&lt;/span>x86_64 &lt;span class="nv">syscall&lt;/span>&lt;span class="o">=&lt;/span>unlinkat &lt;span class="nv">success&lt;/span>&lt;span class="o">=&lt;/span>no &lt;span class="nv">exit&lt;/span>&lt;span class="o">=&lt;/span>ENOTEMPTY&lt;span class="o">(&lt;/span>目录非空&lt;span class="o">)&lt;/span> &lt;span class="nv">a0&lt;/span>&lt;span class="o">=&lt;/span>0xffffffffffffff9c &lt;span class="nv">a1&lt;/span>&lt;span class="o">=&lt;/span>0xc42038ca80 &lt;span class="nv">a2&lt;/span>&lt;span class="o">=&lt;/span>0x200 &lt;span class="nv">a3&lt;/span>&lt;span class="o">=&lt;/span>0x0 &lt;span class="nv">items&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> &lt;span class="nv">ppid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">20523&lt;/span> &lt;span class="nv">pid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1890&lt;/span> &lt;span class="nv">auid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">uid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">gid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">euid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">suid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsuid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">egid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">sgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">tty&lt;/span>&lt;span class="o">=(&lt;/span>none&lt;span class="o">)&lt;/span> &lt;span class="nv">ses&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">comm&lt;/span>&lt;span class="o">=&lt;/span>yes_i_changed_you &lt;span class="nv">exe&lt;/span>&lt;span class="o">=&lt;/span>/root/yes_i_changed_you &lt;span class="nv">key&lt;/span>&lt;span class="o">=&lt;/span>wiserun
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>SYSCALL &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>2018年06月20日 14:22:33.669:8376&lt;span class="o">)&lt;/span> : &lt;span class="nv">arch&lt;/span>&lt;span class="o">=&lt;/span>x86_64 &lt;span class="nv">syscall&lt;/span>&lt;span class="o">=&lt;/span>unlinkat &lt;span class="nv">success&lt;/span>&lt;span class="o">=&lt;/span>no &lt;span class="nv">exit&lt;/span>&lt;span class="o">=&lt;/span>EISDIR&lt;span class="o">(&lt;/span>是一个目录&lt;span class="o">)&lt;/span> &lt;span class="nv">a0&lt;/span>&lt;span class="o">=&lt;/span>0xffffffffffffff9c &lt;span class="nv">a1&lt;/span>&lt;span class="o">=&lt;/span>0xc42038ca60 &lt;span class="nv">a2&lt;/span>&lt;span class="o">=&lt;/span>0x0 &lt;span class="nv">a3&lt;/span>&lt;span class="o">=&lt;/span>0x0 &lt;span class="nv">items&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> &lt;span class="nv">ppid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">20523&lt;/span> &lt;span class="nv">pid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1890&lt;/span> &lt;span class="nv">auid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">uid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">gid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">euid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">suid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsuid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">egid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">sgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">tty&lt;/span>&lt;span class="o">=(&lt;/span>none&lt;span class="o">)&lt;/span> &lt;span class="nv">ses&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">comm&lt;/span>&lt;span class="o">=&lt;/span>yes_i_changed_you &lt;span class="nv">exe&lt;/span>&lt;span class="o">=&lt;/span>/root/yes_i_changed_you &lt;span class="nv">key&lt;/span>&lt;span class="o">=&lt;/span>wiserun
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>SYSCALL &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>2018年06月20日 14:22:33.669:8378&lt;span class="o">)&lt;/span> : &lt;span class="nv">arch&lt;/span>&lt;span class="o">=&lt;/span>x86_64 &lt;span class="nv">syscall&lt;/span>&lt;span class="o">=&lt;/span>openat &lt;span class="nv">success&lt;/span>&lt;span class="o">=&lt;/span>yes &lt;span class="nv">exit&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">6&lt;/span> &lt;span class="nv">a0&lt;/span>&lt;span class="o">=&lt;/span>0xffffffffffffff9c &lt;span class="nv">a1&lt;/span>&lt;span class="o">=&lt;/span>0xc42038cae0 &lt;span class="nv">a2&lt;/span>&lt;span class="o">=&lt;/span>O_RDONLY&lt;span class="p">|&lt;/span>O_CLOEXEC &lt;span class="nv">a3&lt;/span>&lt;span class="o">=&lt;/span>0x0 &lt;span class="nv">items&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="nv">ppid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">20523&lt;/span> &lt;span class="nv">pid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1890&lt;/span> &lt;span class="nv">auid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">uid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">gid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">euid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">suid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsuid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">egid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">sgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">tty&lt;/span>&lt;span class="o">=(&lt;/span>none&lt;span class="o">)&lt;/span> &lt;span class="nv">ses&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">comm&lt;/span>&lt;span class="o">=&lt;/span>yes_i_changed_you &lt;span class="nv">exe&lt;/span>&lt;span class="o">=&lt;/span>/root/yes_i_changed_you &lt;span class="nv">key&lt;/span>&lt;span class="o">=&lt;/span>wiserun
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>SYSCALL &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>2018年06月20日 14:22:33.669:8379&lt;span class="o">)&lt;/span> : &lt;span class="nv">arch&lt;/span>&lt;span class="o">=&lt;/span>x86_64 &lt;span class="nv">syscall&lt;/span>&lt;span class="o">=&lt;/span>unlinkat &lt;span class="nv">success&lt;/span>&lt;span class="o">=&lt;/span>no &lt;span class="nv">exit&lt;/span>&lt;span class="o">=&lt;/span>EISDIR&lt;span class="o">(&lt;/span>是一个目录&lt;span class="o">)&lt;/span> &lt;span class="nv">a0&lt;/span>&lt;span class="o">=&lt;/span>0xffffffffffffff9c &lt;span class="nv">a1&lt;/span>&lt;span class="o">=&lt;/span>0xc42003e3c0 &lt;span class="nv">a2&lt;/span>&lt;span class="o">=&lt;/span>0x0 &lt;span class="nv">a3&lt;/span>&lt;span class="o">=&lt;/span>0x0 &lt;span class="nv">items&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> &lt;span class="nv">ppid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">20523&lt;/span> &lt;span class="nv">pid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1890&lt;/span> &lt;span class="nv">auid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">uid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">gid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">euid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">suid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsuid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">egid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">sgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">tty&lt;/span>&lt;span class="o">=(&lt;/span>none&lt;span class="o">)&lt;/span> &lt;span class="nv">ses&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">comm&lt;/span>&lt;span class="o">=&lt;/span>yes_i_changed_you &lt;span class="nv">exe&lt;/span>&lt;span class="o">=&lt;/span>/root/yes_i_changed_you &lt;span class="nv">key&lt;/span>&lt;span class="o">=&lt;/span>wiserun
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>SYSCALL &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>2018年06月20日 14:22:33.669:8380&lt;span class="o">)&lt;/span> : &lt;span class="nv">arch&lt;/span>&lt;span class="o">=&lt;/span>x86_64 &lt;span class="nv">syscall&lt;/span>&lt;span class="o">=&lt;/span>unlinkat &lt;span class="nv">success&lt;/span>&lt;span class="o">=&lt;/span>yes &lt;span class="nv">exit&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">a0&lt;/span>&lt;span class="o">=&lt;/span>0xffffffffffffff9c &lt;span class="nv">a1&lt;/span>&lt;span class="o">=&lt;/span>0xc42003e410 &lt;span class="nv">a2&lt;/span>&lt;span class="o">=&lt;/span>0x200 &lt;span class="nv">a3&lt;/span>&lt;span class="o">=&lt;/span>0x0 &lt;span class="nv">items&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> &lt;span class="nv">ppid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">20523&lt;/span> &lt;span class="nv">pid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1890&lt;/span> &lt;span class="nv">auid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">uid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">gid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">euid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">suid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsuid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">egid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">sgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">tty&lt;/span>&lt;span class="o">=(&lt;/span>none&lt;span class="o">)&lt;/span> &lt;span class="nv">ses&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">comm&lt;/span>&lt;span class="o">=&lt;/span>yes_i_changed_you &lt;span class="nv">exe&lt;/span>&lt;span class="o">=&lt;/span>/root/yes_i_changed_you &lt;span class="nv">key&lt;/span>&lt;span class="o">=&lt;/span>wiserun
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>SYSCALL &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>2018年06月20日 14:22:33.669:8381&lt;span class="o">)&lt;/span> : &lt;span class="nv">arch&lt;/span>&lt;span class="o">=&lt;/span>x86_64 &lt;span class="nv">syscall&lt;/span>&lt;span class="o">=&lt;/span>unlinkat &lt;span class="nv">success&lt;/span>&lt;span class="o">=&lt;/span>no &lt;span class="nv">exit&lt;/span>&lt;span class="o">=&lt;/span>EISDIR&lt;span class="o">(&lt;/span>是一个目录&lt;span class="o">)&lt;/span> &lt;span class="nv">a0&lt;/span>&lt;span class="o">=&lt;/span>0xffffffffffffff9c &lt;span class="nv">a1&lt;/span>&lt;span class="o">=&lt;/span>0xc42038cb80 &lt;span class="nv">a2&lt;/span>&lt;span class="o">=&lt;/span>0x0 &lt;span class="nv">a3&lt;/span>&lt;span class="o">=&lt;/span>0x0 &lt;span class="nv">items&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> &lt;span class="nv">ppid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">20523&lt;/span> &lt;span class="nv">pid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1890&lt;/span> &lt;span class="nv">auid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">uid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">gid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">euid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">suid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsuid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">egid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">sgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">tty&lt;/span>&lt;span class="o">=(&lt;/span>none&lt;span class="o">)&lt;/span> &lt;span class="nv">ses&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">comm&lt;/span>&lt;span class="o">=&lt;/span>yes_i_changed_you &lt;span class="nv">exe&lt;/span>&lt;span class="o">=&lt;/span>/root/yes_i_changed_you &lt;span class="nv">key&lt;/span>&lt;span class="o">=&lt;/span>wiserun
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>SYSCALL &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>2018年06月20日 14:22:33.669:8382&lt;span class="o">)&lt;/span> : &lt;span class="nv">arch&lt;/span>&lt;span class="o">=&lt;/span>x86_64 &lt;span class="nv">syscall&lt;/span>&lt;span class="o">=&lt;/span>unlinkat &lt;span class="nv">success&lt;/span>&lt;span class="o">=&lt;/span>yes &lt;span class="nv">exit&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">a0&lt;/span>&lt;span class="o">=&lt;/span>0xffffffffffffff9c &lt;span class="nv">a1&lt;/span>&lt;span class="o">=&lt;/span>0xc42038cbc0 &lt;span class="nv">a2&lt;/span>&lt;span class="o">=&lt;/span>0x200 &lt;span class="nv">a3&lt;/span>&lt;span class="o">=&lt;/span>0x0 &lt;span class="nv">items&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> &lt;span class="nv">ppid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">20523&lt;/span> &lt;span class="nv">pid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1890&lt;/span> &lt;span class="nv">auid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">uid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">gid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">euid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">suid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsuid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">egid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">sgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">fsgid&lt;/span>&lt;span class="o">=&lt;/span>root &lt;span class="nv">tty&lt;/span>&lt;span class="o">=(&lt;/span>none&lt;span class="o">)&lt;/span> &lt;span class="nv">ses&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">unset&lt;/span> &lt;span class="nv">comm&lt;/span>&lt;span class="o">=&lt;/span>yes_i_changed_you &lt;span class="nv">exe&lt;/span>&lt;span class="o">=&lt;/span>/root/yes_i_changed_you &lt;span class="nv">key&lt;/span>&lt;span class="o">=&lt;/span>wiserun
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ausearch语法">ausearch语法&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deoops ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># ausearch -h&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usage: ausearch &lt;span class="o">[&lt;/span>options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -a,--event &amp;lt;Audit event id&amp;gt; search based on audit event id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --arch &amp;lt;CPU&amp;gt; search based on the CPU architecture
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -c,--comm &amp;lt;Comm name&amp;gt; search based on &lt;span class="nb">command&lt;/span> line name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --checkpoint &amp;lt;checkpoint file&amp;gt; search from last &lt;span class="nb">complete&lt;/span> event
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --debug Write malformed events that are skipped to stderr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -e,--exit &amp;lt;Exit code or errno&amp;gt; search based on syscall &lt;span class="nb">exit&lt;/span> code
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -f,--file &amp;lt;File name&amp;gt; search based on file name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -ga,--gid-all &amp;lt;all Group id&amp;gt; search based on All group ids
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -ge,--gid-effective &amp;lt;effective Group id&amp;gt; search based on Effective
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> group id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -gi,--gid &amp;lt;Group Id&amp;gt; search based on group id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -h,--help &lt;span class="nb">help&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -hn,--host &amp;lt;Host Name&amp;gt; search based on remote host name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -i,--interpret Interpret results to be human readable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -if,--input &amp;lt;Input File name&amp;gt; use this file instead of current logs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --input-logs Use the logs even &lt;span class="k">if&lt;/span> stdin is a pipe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --just-one Emit just one event
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -k,--key &amp;lt;key string&amp;gt; search based on key field
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -l, --line-buffered Flush output on every line
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -m,--message &amp;lt;Message type&amp;gt; search based on message &lt;span class="nb">type&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -n,--node &amp;lt;Node name&amp;gt; search based on machine&lt;span class="s1">&amp;#39;s name
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -o,--object &amp;lt;SE Linux Object context&amp;gt; search based on context of object
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -p,--pid &amp;lt;Process id&amp;gt; search based on process id
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -pp,--ppid &amp;lt;Parent Process id&amp;gt; search based on parent process id
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -r,--raw output is completely unformatted
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -sc,--syscall &amp;lt;SysCall name&amp;gt; search based on syscall name or number
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -se,--context &amp;lt;SE Linux context&amp;gt; search based on either subject or
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> object
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> --session &amp;lt;login session id&amp;gt; search based on login session id
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -su,--subject &amp;lt;SE Linux context&amp;gt; search based on context of the Subject
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -sv,--success &amp;lt;Success Value&amp;gt; search based on syscall or event
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> success value
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -te,--end [end date] [end time] ending date &amp;amp; time for search
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -ts,--start [start date] [start time] starting data &amp;amp; time for search
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -tm,--terminal &amp;lt;TerMinal&amp;gt; search based on terminal
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> -ua,--uid-all &amp;lt;all User id&amp;gt; search based on All user id&amp;#39;&lt;/span>s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -ue,--uid-effective &amp;lt;effective User id&amp;gt; search based on Effective
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> user id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -ui,--uid &amp;lt;User Id&amp;gt; search based on user id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -ul,--loginuid &amp;lt;login id&amp;gt; search based on the User&lt;span class="err">&amp;#39;&lt;/span>s Login id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -uu,--uuid &amp;lt;guest UUID&amp;gt; search &lt;span class="k">for&lt;/span> events related to the virtual
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> machine with the given UUID.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -v,--version version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -vm,--vm-name &amp;lt;guest name&amp;gt; search &lt;span class="k">for&lt;/span> events related to the virtual
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> machine with the name.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -w,--word string matches are whole word
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -x,--executable &amp;lt;executable name&amp;gt; search based on executable name
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="tips">TIPS&lt;/h2>
&lt;p>如果需要记录被审计对象被删除事件，则需要审计该对象的上一级目录。&lt;/p>
&lt;p>&lt;a class="link" href="https://stackoverflow.com/questions/29519590/monitor-audit-file-delete-on-linux" target="_blank" rel="noopener"
>Monitor/audit file delete on Linux&lt;/a>&lt;/p></description></item><item><title>内核升级</title><link>https://tab.deoops.com/posts/kernel-upgrade/</link><pubDate>Wed, 16 May 2018 16:50:31 +0800</pubDate><guid>https://tab.deoops.com/posts/kernel-upgrade/</guid><description>&lt;img src="https://tab.deoops.com/posts/kernel-upgrade/kernel.png" alt="Featured image of post 内核升级" />&lt;p>众所周知centos的内核版本选择很保守，很多新内核的新特性，特别是网络和debug方面的特性都没有，所以我们来给centos升级下 kernel吧。&lt;/p>
&lt;p>整个升级安装的过程其实挺简单的一共分为4步：&lt;/p>
&lt;ol>
&lt;li>找到repo源；&lt;/li>
&lt;li>yum安装最新的kernel；&lt;/li>
&lt;li>修改grub2启动项；&lt;/li>
&lt;li>移除旧的kernel。&lt;/li>
&lt;/ol>
&lt;h2 id="安装">安装&lt;/h2>
&lt;h3 id="elrepo">elrepo&lt;/h3>
&lt;p>访问&lt;a class="link" href="http://elrepo.org/tiki/tiki-index.php" target="_blank" rel="noopener"
>elrepo website&lt;/a>查看对应 centos 版本最新的kernel repo源。
然后使用&lt;code>rpm&lt;/code>添加kernel源：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="install">install&lt;/h3>
&lt;p>安装内核：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">yum --disablerepo&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;\*&amp;#34;&lt;/span> --enablerepo&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;elrepo-kernel&amp;#34;&lt;/span> list available
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum --enablerepo&lt;span class="o">=&lt;/span>elrepo-kernel install kernel-ml kernel-ml-devel
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="boot">boot&lt;/h3>
&lt;p>修改&lt;code>grub2&lt;/code>启动项，开机使用新的内核：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">awk -F&lt;span class="se">\&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;$1==&amp;#34;menuentry &amp;#34; {print i++ &amp;#34; : &amp;#34; $2}&amp;#39;&lt;/span> /etc/grub2.cfg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grub2-set-default &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">init &lt;span class="m">6&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="cleanup">cleanup&lt;/h3>
&lt;p>删除旧内核&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">yum install yum-utils
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">package-cleanup --oldkernels --count&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uname -a
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="参考">参考&lt;/h2>
&lt;p>&lt;a class="link" href="https://www.howtoforge.com/tutorial/how-to-upgrade-kernel-in-centos-7-server/" target="_blank" rel="noopener"
>How to Upgrade Kernel on CentOS 7&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.tecmint.com/install-upgrade-kernel-version-in-centos-7/" target="_blank" rel="noopener"
>How to Install or Upgrade to Kernel 4.15 in CentOS 7&lt;/a>&lt;/p></description></item><item><title>vim配置</title><link>https://tab.deoops.com/posts/vim-conf/</link><pubDate>Mon, 14 May 2018 11:42:23 +0800</pubDate><guid>https://tab.deoops.com/posts/vim-conf/</guid><description>&lt;img src="https://tab.deoops.com/posts/vim-conf/vim.png" alt="Featured image of post vim配置" />&lt;p>使用vim有7，8年了，整理一下自己用到的vim配置，方便自查。&lt;/p>
&lt;h2 id="vim">vim&lt;/h2>
&lt;h3 id="basic">basic&lt;/h3>
&lt;p>基本设置，语法高亮，行号，等等：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-vimrc" data-lang="vimrc">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">execute&lt;/span> &lt;span class="nx">pathogen&lt;/span>#&lt;span class="nx">infect&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">syntax&lt;/span> &lt;span class="nx">on&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">filetype&lt;/span> &lt;span class="nx">plugin&lt;/span> &lt;span class="nx">indent&lt;/span> &lt;span class="nx">on&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">number&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="paste">paste&lt;/h3>
&lt;p>复制粘贴：
&lt;a class="link" href="https://stackoverflow.com/questions/2514445/turning-off-auto-indent-when-pasting-text-into-vim" target="_blank" rel="noopener"
>disable auto indent&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-vimrc" data-lang="vimrc">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">set&lt;/span> &lt;span class="nx">paste&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>Notice the “– INSERT (paste) –” at the bottom of the Vim window.&lt;/p>
&lt;/blockquote>
&lt;h3 id="fold">fold&lt;/h3>
&lt;p>代码折叠：
&lt;a class="link" href="http://vim.wikia.com/wiki/Folding" target="_blank" rel="noopener"
>Folding wiki&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-vimrc" data-lang="vimrc">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; close zc&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; open zo&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="font">font&lt;/h3>
&lt;p>安装字体：
&lt;a class="link" href="https://github.com/powerline/powerline" target="_blank" rel="noopener"
>install powerline font&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">wget https://github.com/powerline/powerline/raw/develop/font/PowerlineSymbols.otf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">open .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># double click the otf file you&amp;#39;ve just downloaded.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="kubectl-eidt-issue">kubectl eidt issue&lt;/h3>
&lt;p>使用&lt;code>kubectl edit&lt;/code>时，当yaml文件的annotation行过大会报错:&lt;/p>
&lt;p>&lt;code>annotation: kubectl.kubernetes.io/last-applied-configuration is too large&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-vimrc" data-lang="vimrc">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; annotation: kubectl.kubernetes.io/last-applied-configuration&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; is too large&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">maxmempattern&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="m">200000&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="neovim">neovim&lt;/h2>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 177;
flex-basis: 425px"
>
&lt;a href="https://tab.deoops.com/posts/vim-conf/neovim.png" data-size="996x562">
&lt;img src="https://tab.deoops.com/posts/vim-conf/neovim.png"
width="996"
height="562"
srcset="https://tab.deoops.com/posts/vim-conf/neovim_hu5b6b3b4ece43278365f5779b75ee7ecd_83052_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/vim-conf/neovim_hu5b6b3b4ece43278365f5779b75ee7ecd_83052_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="neovim v0.5.1">
&lt;/a>
&lt;figcaption>neovim v0.5.1&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>今年（2020），我从vim 8 迁移到了&lt;code>neovim&lt;/code>，下面是 &lt;code>~/.config/nvim/init.vim&lt;/code>的配置内容&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-vimrc" data-lang="vimrc">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; cp from ~/.vimrc&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; execute pathogen#infect()&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;syntax on&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;filetype plugin indent on&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">language&lt;/span> &lt;span class="nx">en_US&lt;/span>.&lt;span class="nx">UTF&lt;/span>&lt;span class="m">-8&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">rtp&lt;/span>&lt;span class="p">+=&lt;/span>&lt;span class="sr">/usr/&lt;/span>&lt;span class="nx">local&lt;/span>&lt;span class="sr">/opt/&lt;/span>&lt;span class="nx">fzf&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">number&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">encoding&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="nx">utf&lt;/span>&lt;span class="m">-8&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; You need to set ignorecase if you want to use what smartcase provides&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">ignorecase&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">smartcase&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; kubectl edit&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; annotation: kubectl.kubernetes.io/last-applied-configuration&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; is too large&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">maxmempattern&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="m">200000&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;set foldmethod=syntax&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;set clipboard=unnamed&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34;autocmd vimenter * NERDTree&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;autocmd StdinReadPre * let s:std_in=1&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;autocmd VimEnter * if argc() == 0 &amp;amp;&amp;amp; !exists(&amp;#34;s:std_in&amp;#34;) | NERDTree | endif&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">autocmd&lt;/span> &lt;span class="nx">StdinReadPre&lt;/span> * &lt;span class="k">let&lt;/span> &lt;span class="nx">s&lt;/span>:&lt;span class="nx">std_in&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">autocmd&lt;/span> &lt;span class="nx">VimEnter&lt;/span> * &lt;span class="k">if&lt;/span> &lt;span class="nx">argc&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">==&lt;/span> &lt;span class="m">1&lt;/span> &amp;amp;&amp;amp; &lt;span class="nx">isdirectory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">argv&lt;/span>&lt;span class="p">()&lt;/span>[&lt;span class="m">0&lt;/span>]&lt;span class="p">)&lt;/span> &amp;amp;&amp;amp; &lt;span class="p">!&lt;/span>&lt;span class="nx">exists&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;s:std_in&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nx">exe&lt;/span> &lt;span class="s1">&amp;#39;NERDTree&amp;#39;&lt;/span> &lt;span class="nx">argv&lt;/span>&lt;span class="p">()&lt;/span>[&lt;span class="m">0&lt;/span>] &lt;span class="p">|&lt;/span> &lt;span class="nx">wincmd&lt;/span> &lt;span class="nx">p&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nx">ene&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nx">exe&lt;/span> &lt;span class="s1">&amp;#39;cd &amp;#39;&lt;/span>.&lt;span class="nx">argv&lt;/span>&lt;span class="p">()&lt;/span>[&lt;span class="m">0&lt;/span>] &lt;span class="p">|&lt;/span> &lt;span class="k">endif&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">call&lt;/span> &lt;span class="nx">plug&lt;/span>#&lt;span class="nx">begin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stdpath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;data&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> .&lt;span class="s1">&amp;#39;/plugged&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; call plug#begin(&amp;#39;~/.vim/plugged&amp;#39;)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; Make sure you use single quotes&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;tpope/vim-commentary&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;vim-airline/vim-airline&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;vim-airline/vim-airline-themes&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; &amp;#34; Shorthand notation; fetches https://github.com/junegunn/vim-easy-align&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;junegunn/vim-easy-align&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; &amp;#34; Any valid git URL is allowed&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;https://github.com/junegunn/vim-github-dashboard.git&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; &amp;#34; Multiple Plug commands can be written in a single line using | separators&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;SirVer/ultisnips&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;honza/vim-snippets&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; &amp;#34; On-demand loading&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;scrooloose/nerdtree&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> { &lt;span class="s1">&amp;#39;on&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;NERDTreeToggle&amp;#39;&lt;/span> }&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;preservim/tagbar&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; Plug &amp;#39;tpope/vim-fireplace&amp;#39;, { &amp;#39;for&amp;#39;: &amp;#39;clojure&amp;#39; }&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; &amp;#34; Using a non-default branch&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;rdnetto/YCM-Generator&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> { &lt;span class="s1">&amp;#39;branch&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;stable&amp;#39;&lt;/span> }&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; &amp;#34; Using a tagged release; wildcard allowed (requires git 1.9.2 or above)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;fatih/vim-go&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> { &lt;span class="s1">&amp;#39;do&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;:GoUpdateBinaries&amp;#39;&lt;/span> }&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; &amp;#34; Plugin outside ~/.vim/plugged with post-update hook&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;junegunn/fzf&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> { &lt;span class="s1">&amp;#39;dir&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;~/.fzf&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;do&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;./install --all&amp;#39;&lt;/span> }&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;junegunn/fzf.vim&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; Track the engine.&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;SirVer/ultisnips&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; Snippets are separated from the engine. Add this if you want them:&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;honza/vim-snippets&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="nx">has&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;nvim&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;Shougo/deoplete.nvim&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> { &lt;span class="s1">&amp;#39;do&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;:UpdateRemotePlugins&amp;#39;&lt;/span> }&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;Shougo/deoplete.nvim&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;roxma/nvim-yarp&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;roxma/vim-hug-neovim-rpc&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">endif&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;tpope/vim-sensible&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;rust-lang/rust.vim&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; for reactjs jsx&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;pangloss/vim-javascript&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;leafgarland/typescript-vim&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;peitalin/vim-jsx-typescript&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">Plug&lt;/span> &lt;span class="s1">&amp;#39;styled-components/vim-styled-components&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> { &lt;span class="s1">&amp;#39;branch&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;main&amp;#39;&lt;/span> }&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; Plug &amp;#39;autozimu/LanguageClient-neovim&amp;#39;, {&amp;#39;branch&amp;#39;: &amp;#39;next&amp;#39;, &amp;#39;do&amp;#39;: &amp;#39;bash install.sh&amp;#39; }&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;Plug &amp;#39;jparise/vim-graphql&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34;Plug &amp;#39;neoclide/coc.nvim&amp;#39;, {&amp;#39;branch&amp;#39;: &amp;#39;release&amp;#39;}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">call&lt;/span> &lt;span class="nx">plug&lt;/span>#&lt;span class="nx">end&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; let g:coc_global_extensions = [&amp;#39;coc-json&amp;#39;, &amp;#39;coc-tsserver&amp;#39;]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; for js/ts synax&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; syntax highlighting can get out of sync i&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; https://thoughtbot.com/blog/modern-typescript-and-react-development-in-vim&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">autocmd&lt;/span> &lt;span class="nx">BufEnter&lt;/span> *.{&lt;span class="nx">js&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">jsx&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">ts&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">tsx&lt;/span>} :&lt;span class="nx">syntax&lt;/span> &lt;span class="nx">sync&lt;/span> &lt;span class="nx">fromstart&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">autocmd&lt;/span> &lt;span class="nx">BufLeave&lt;/span> *.{&lt;span class="nx">js&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">jsx&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">ts&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">tsx&lt;/span>} :&lt;span class="nx">syntax&lt;/span> &lt;span class="nx">sync&lt;/span> &lt;span class="nx">clear&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">let&lt;/span> &lt;span class="nx">g&lt;/span>:&lt;span class="nx">deoplete&lt;/span>#&lt;span class="nx">enable_at_startup&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="m">1&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">let&lt;/span> &lt;span class="nx">g&lt;/span>:&lt;span class="nx">go_def_mode&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="s1">&amp;#39;gopls&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">let&lt;/span> &lt;span class="nx">g&lt;/span>:&lt;span class="nx">go_info_mode&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="s1">&amp;#39;gopls&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">let&lt;/span> &lt;span class="nx">g&lt;/span>:&lt;span class="nx">UltiSnipsEditSplit&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="s2">&amp;#34;vertical&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">call&lt;/span> &lt;span class="nx">deoplete&lt;/span>#&lt;span class="nx">custom&lt;/span>#&lt;span class="nx">option&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;omni_patterns&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> { &lt;span class="s1">&amp;#39;go&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;[^. *\t]\.\w*&amp;#39;&lt;/span> }&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34;set list&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;set listchars=tab:&amp;gt;-&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">tabstop&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="m">4&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;set expandtab&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;set shiftwidth=2&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">autoindent&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">smartindent&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">let&lt;/span> &lt;span class="nx">mapleader&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span> &lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">nmap&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nx">C&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="nx">P&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> :&lt;span class="nx">FZF&lt;/span>&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nx">CR&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">let&lt;/span> &lt;span class="nx">NERDTreeShowHidden&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; If more than one window and previous buffer was NERDTree, go back to it.&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">autocmd&lt;/span> &lt;span class="nx">BufEnter&lt;/span> * &lt;span class="k">if&lt;/span> &lt;span class="nx">bufname&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;#&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=~&lt;/span># &lt;span class="s2">&amp;#34;^NERD_tree_&amp;#34;&lt;/span> &amp;amp;&amp;amp; &lt;span class="nx">winnr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;$&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nx">b&lt;/span># &lt;span class="p">|&lt;/span> &lt;span class="k">endif&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">let&lt;/span> &lt;span class="nx">g&lt;/span>:&lt;span class="nx">plug_window&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;noautocmd vertical topleft new&amp;#39;&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="nx">has&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;nvim&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"> &amp;#34;highlight! link TermCursor Cursor&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span> &lt;span class="nx">highlight&lt;/span>&lt;span class="p">!&lt;/span> &lt;span class="nx">TermCursorNC&lt;/span> &lt;span class="nx">guibg&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="nx">red&lt;/span> &lt;span class="nx">guifg&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="nx">white&lt;/span> &lt;span class="nx">ctermbg&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="nx">ctermfg&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="m">15&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">endif&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="nx">clipboard&lt;/span>&lt;span class="p">+=&lt;/span>&lt;span class="nx">unnamedplus&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">let&lt;/span> &lt;span class="nx">g&lt;/span>:&lt;span class="nx">go_imports_autosave&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="m">1&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;#34; nmap &amp;lt;silent&amp;gt; gd &amp;lt;Plug&amp;gt;(coc-definition)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; nmap &amp;lt;silent&amp;gt; gy &amp;lt;Plug&amp;gt;(coc-type-definition)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; nmap &amp;lt;silent&amp;gt; gr &amp;lt;Plug&amp;gt;(coc-references)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34; nmap &amp;lt;leader&amp;gt;rn &amp;lt;Plug&amp;gt;(coc-rename)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c">&amp;#34;let g:LanguageClient_serverCommands = {&amp;#39;javascript&amp;#39;: [&amp;#39;javascript-typescript-stdio&amp;#39;]}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>配置vscode eslint</title><link>https://tab.deoops.com/posts/vscode-eslint/</link><pubDate>Mon, 16 Apr 2018 16:34:09 +0800</pubDate><guid>https://tab.deoops.com/posts/vscode-eslint/</guid><description>&lt;img src="https://tab.deoops.com/posts/vscode-eslint/eslint-airbnb.jpeg" alt="Featured image of post 配置vscode eslint" />&lt;p>离职一段时间了，需要自己写点前端代码。
奈何&lt;code>vim&lt;/code>的js插件对&lt;code>jsx&lt;/code>的支持不太友好，所以转向&lt;code>vscode&lt;/code>写点&lt;code>jsx&lt;/code>。&lt;/p>
&lt;p>写了些&lt;code>react app&lt;/code>代码后，&lt;code>IDE&lt;/code>到处飘红色的波浪线〰️〰️〰️，很是恼人。&lt;/p>
&lt;p>全局配置&lt;code>react eslint&lt;/code>好多了， 记录下配置的过程备查。&lt;/p>
&lt;h2 id="配置">配置&lt;/h2>
&lt;p>基本上是用了&lt;code>airbnb&lt;/code>的配置：&lt;/p>
&lt;p>具体的步骤很简单，两步就好了：&lt;/p>
&lt;ol>
&lt;li>npm安装eslint和要用到plugin；&lt;/li>
&lt;li>根据需求配置全局的&lt;code>eslintrc&lt;/code>文件&lt;/li>
&lt;/ol>
&lt;h3 id="plugin">plugin&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">npm install -g jshint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm install -g eslint eslint-config-airbnb-base eslint-plugin-import
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi .eslintrc.js
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /usr/local/bin/npm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls /usr/local/lib/node_modules/eslint-config-airbnb-base
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm link eslint-config-airbnb-base
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls node_modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm link eslint-plugin-import
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm i -g eslint-plugin-react
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm i -g eslint-plugin-jsx-a11y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">npm link eslint-plugin-jsx-a11y eslint-plugin-react
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi .eslintrc.js
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="elinttcjs">.elinttc.js&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ~/.eslintrc.js
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">exports&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">parser&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;babel-eslint&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;plugins&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;react&amp;#34;&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;extends&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;airbnb-base&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;eslint:recommended&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;plugin:react/recommended&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;rules&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// &amp;#34;no-unused-vars&amp;#34;:0,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="s2">&amp;#34;no-console&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;off&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;max-len&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">120&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,{&lt;/span>&lt;span class="nx">ignoreComments&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">}]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// &amp;#34;prop-types&amp;#34;: [2]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;env&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;browser&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;node&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;jasmine&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="参考">参考&lt;/h2>
&lt;p>&lt;a class="link" href="https://www.robinwieruch.de/react-eslint-webpack-babel/" target="_blank" rel="noopener"
>react eslint webpack babel&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="http://www.zsoltnagy.eu/use-eslint-like-a-pro-with-es6-and-react/" target="_blank" rel="noopener"
>Use ESLint Like a Pro with ES6 and React&lt;/a>&lt;/p></description></item><item><title>配置http selinux</title><link>https://tab.deoops.com/posts/http-selinux/</link><pubDate>Mon, 16 Apr 2018 16:10:45 +0800</pubDate><guid>https://tab.deoops.com/posts/http-selinux/</guid><description>&lt;img src="https://tab.deoops.com/posts/http-selinux/selinux.webp" alt="Featured image of post 配置http selinux" />&lt;p>今天在&lt;code>digitocean&lt;/code>一台新申请的主机上部署web应用。部署完成，打开浏览器发现报错403。&lt;/p>
&lt;p>部署的web应用很简单，后端用nginx做了&lt;a class="link" href="https://tab.deoops.com/posts/nginx-proxy/" >反向代理&lt;/a>，应该没啥大问题。&lt;/p>
&lt;p>进一步打开chrome的console，发现对&lt;code>static file&lt;/code>的访问报错&lt;code>403&lt;/code>，还没到后端就已经报错了，
估计后面的 upstream socket也会报错。&lt;/p>
&lt;p>&lt;code>ssh&lt;/code>登陆到服务器上看了下nginx的日志，发现是权限的问题。&lt;/p>
&lt;p>进一步debug了之后发现虚拟机开启selinux，当时心头就一紧，估计要改selinux配置了，这是个麻烦事儿。&lt;/p>
&lt;p>想简单点直接关闭selinux，转念一想&lt;code>digitocean&lt;/code>的主机直接暴露在interner上，开着selinux 其实是个很好的保护。&lt;code>digitocean&lt;/code>打开自有它打开的道理，我猜可能有很多vm被攻破沦为僵尸网络了。&lt;/p>
&lt;p>google搜索了selinux的web server常用的配置，验证后，解决了&lt;code>nginx 403&lt;/code>的问题。记录分享如下：&lt;/p>
&lt;h2 id="check-selinux">check seLinux&lt;/h2>
&lt;h3 id="查看系统状态">查看系统状态&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.centos.org/docs/5/html/5.1/Deployment_Guide/sec-selinux-status-viewing.html" target="_blank" rel="noopener"
>查看selinux配置和状态&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deo ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># sestatus -v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SELinux status: enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SELinuxfs mount: /sys/fs/selinux
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SELinux root directory: /etc/selinux
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Loaded policy name: targeted
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Current mode: enforcing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Mode from config file: enforcing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Policy MLS status: enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Policy deny_unknown status: allowed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Max kernel policy version: &lt;span class="m">28&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Process contexts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Current context: unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Init context: system_u:system_r:init_t:s0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/sbin/sshd system_u:system_r:sshd_t:s0-s0:c0.c1023
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File contexts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Controlling terminal: unconfined_u:object_r:user_devpts_t:s0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/passwd system_u:object_r:passwd_file_t:s0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/shadow system_u:object_r:shadow_t:s0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/bin/bash system_u:object_r:shell_exec_t:s0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/bin/login system_u:object_r:login_exec_t:s0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/bin/sh system_u:object_r:bin_t:s0 -&amp;gt; system_u:object_r:shell_exec_t:s0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/sbin/agetty system_u:object_r:getty_exec_t:s0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/sbin/init system_u:object_r:bin_t:s0 -&amp;gt; system_u:object_r:init_exec_t:s0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/sbin/sshd system_u:object_r:sshd_exec_t:s0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="查看文件目录的selinux-label">查看文件目录的selinux label&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deo &lt;span class="o">]&lt;/span>&lt;span class="c1"># ls -Z /opt/todolist&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x. root root unconfined_u:object_r:admin_home_t:s0 static
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@deo &lt;span class="o">]&lt;/span>&lt;span class="c1"># ls -Z /usr/share/nginx/html&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r--. root root system_u:object_r:httpd_sys_content_t:s0 50x.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r--. root root system_u:object_r:httpd_sys_content_t:s0 index.html
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="meat">meat&lt;/h2>
&lt;p>下面两种方法选一种就可以了&lt;/p>
&lt;h3 id="label">label&lt;/h3>
&lt;p>修改目录label使得selinux 放行nginx:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">chcon -Rt httpd_sys_content_t /opt/todolist/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -Z /opt/todolist/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r--. root root unconfined_u:object_r:httpd_sys_content_t:s0 index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x. root root unconfined_u:object_r:httpd_sys_content_t:s0 static
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">setsebool -P httpd_can_network_connect &lt;span class="m">1&lt;/span> &lt;span class="p">;&lt;/span> setsebool -P httpd_enable_homedirs on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod &lt;span class="m">701&lt;/span> /home/dir
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="semanage">semanage&lt;/h3>
&lt;p>或者使用&lt;code>semanage&lt;/code>命令修改&lt;code>enforcement mode&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">~ &lt;span class="o">[&lt;/span>root@jp ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat fix_selinux_ng.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">semanage permissive -a httpd_tp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>segmanage&lt;/code>语法：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@jp ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># semanage -h&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usage: semanage &lt;span class="o">[&lt;/span>-h&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">{&lt;/span>import,export,login,user,port,ibpkey,ibendport,interface,module,node,fcontext,boolean,permissive,dontaudit&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">semanage is used to configure certain elements of SELinux policy with-out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">requiring modification to or recompilation from policy source.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">positional arguments:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">{&lt;/span>import,export,login,user,port,ibpkey,ibendport,interface,module,node,fcontext,boolean,permissive,dontaudit&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> import Import &lt;span class="nb">local&lt;/span> customizations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">export&lt;/span> Output &lt;span class="nb">local&lt;/span> customizations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> login Manage login mappings between linux users and SELinux
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> confined users
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> user Manage SELinux confined users &lt;span class="o">(&lt;/span>Roles and levels &lt;span class="k">for&lt;/span> an
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> SELinux user&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> port Manage network port &lt;span class="nb">type&lt;/span> definitions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ibpkey Manage infiniband ibpkey &lt;span class="nb">type&lt;/span> definitions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ibendport Manage infiniband end port &lt;span class="nb">type&lt;/span> definitions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> interface Manage network interface &lt;span class="nb">type&lt;/span> definitions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> module Manage SELinux policy modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> node Manage network node &lt;span class="nb">type&lt;/span> definitions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fcontext Manage file context mapping definitions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> boolean Manage booleans to selectively &lt;span class="nb">enable&lt;/span> functionality
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> permissive Manage process &lt;span class="nb">type&lt;/span> enforcement mode
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dontaudit Disable/Enable dontaudit rules in policy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">optional arguments:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -h, --help show this &lt;span class="nb">help&lt;/span> message and &lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="参考">参考&lt;/h2>
&lt;p>&lt;a class="link" href="https://thecruskit.com/fixing-403-errors-when-using-nginx-with-selinux/" target="_blank" rel="noopener"
>Fixing 403 errors when using nginx with SELinux&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://stackoverflow.com/questions/25995060/nginx-cannot-connect-to-jenkins-on-centos-7" target="_blank" rel="noopener"
>NGinX cannot connect to Jenkins on CentOS 7&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://serverfault.com/questions/686732/nginx-refuses-to-read-new-directory-in-home" target="_blank" rel="noopener"
> Nginx refuses to read new directory in /home&lt;/a>&lt;/p></description></item><item><title>分页打印日志</title><link>https://tab.deoops.com/posts/git-pager/</link><pubDate>Sat, 14 Apr 2018 10:38:59 +0800</pubDate><guid>https://tab.deoops.com/posts/git-pager/</guid><description>&lt;img src="https://tab.deoops.com/posts/git-pager/pager.jpeg" alt="Featured image of post 分页打印日志" />&lt;p>默认配置命令&lt;code>git log&lt;/code>会在新的窗口打印日志内容，需要敲一下键盘&lt;code>q&lt;/code> 才能返回当前目录，不方便连续查看:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">➜ lgthw_orign git:&lt;span class="o">(&lt;/span>otherbranch&lt;span class="o">)&lt;/span> git log --oneline --decorate --all --graph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## NOTE content below will be displayed on new window/buff&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* 40303b7 &lt;span class="o">(&lt;/span>HEAD -&amp;gt; otherbranch&lt;span class="o">)&lt;/span> thirdcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> * 3e6e2f7 &lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> secondcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span>/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* f40475e &lt;span class="o">(&lt;/span>tag: firstcommittag&lt;span class="o">)&lt;/span> firstcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>END&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## press `q` to exist&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ lgthw_orign git:&lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> git log --no-pager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fatal: unrecognized argument: --no-pager
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以把默认的分页改为&lt;code>inline&lt;/code>模式，可以更快的查看连续的日志：&lt;/p>
&lt;h2 id="meat">meat&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># use --no-pager options&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># or set pager to cat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git config --global core.pager cat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># or set pager to less&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># git config --global core.pager &amp;#34;less -erX&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="demo">demo&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">➜ lgthw_orign git:&lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> git log --oneline --decorate --all --graph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* f40475e &lt;span class="o">(&lt;/span>HEAD -&amp;gt; master&lt;span class="o">)&lt;/span> firstcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ lgthw_orign git:&lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> git branch otherbranch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ lgthw_orign git:&lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> git tag firstcommittag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ lgthw_orign git:&lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> git log --oneline --decorate --all --graph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* f40475e &lt;span class="o">(&lt;/span>HEAD -&amp;gt; master, tag: firstcommittag, otherbranch&lt;span class="o">)&lt;/span> firstcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ lgthw_orign git:&lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> date &amp;gt;&amp;gt; afile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ lgthw_orign git:&lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> ✗ git commit -am secondcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>master 3e6e2f7&lt;span class="o">]&lt;/span> secondcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> file changed, &lt;span class="m">1&lt;/span> insertion&lt;span class="o">(&lt;/span>+&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ➜ lgthw_orign git:&lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> git checkout .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ➜ lgthw_orign git:&lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> git log --oneline --decorate --all --graph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * 3e6e2f7 &lt;span class="o">(&lt;/span>HEAD -&amp;gt; master&lt;span class="o">)&lt;/span> secondcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * f40475e &lt;span class="o">(&lt;/span>tag: firstcommittag, otherbranch&lt;span class="o">)&lt;/span> firstcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ➜ lgthw_orign git:&lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> git checkout otherbranch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Switched to branch &lt;span class="s1">&amp;#39;otherbranch&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ➜ lgthw_orign git:&lt;span class="o">(&lt;/span>otherbranch&lt;span class="o">)&lt;/span> git log --oneline --decorate --all --graph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * 3e6e2f7 &lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> secondcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * f40475e &lt;span class="o">(&lt;/span>HEAD -&amp;gt; otherbranch, tag: firstcommittag&lt;span class="o">)&lt;/span> firstcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ➜ lgthw_orign git:&lt;span class="o">(&lt;/span>otherbranch&lt;span class="o">)&lt;/span> date &amp;gt;&amp;gt; afile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ➜ lgthw_orign git:&lt;span class="o">(&lt;/span>otherbranch&lt;span class="o">)&lt;/span> ✗ git commit -am thirdcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span>otherbranch 40303b7&lt;span class="o">]&lt;/span> thirdcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> file changed, &lt;span class="m">1&lt;/span> insertion&lt;span class="o">(&lt;/span>+&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ➜ lgthw_orign git:&lt;span class="o">(&lt;/span>otherbranch&lt;span class="o">)&lt;/span> git log --oneline --decorate --all --graph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * 40303b7 &lt;span class="o">(&lt;/span>HEAD -&amp;gt; otherbranch&lt;span class="o">)&lt;/span> thirdcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">|&lt;/span> * 3e6e2f7 &lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> secondcommit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">|&lt;/span>/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * f40475e &lt;span class="o">(&lt;/span>tag: firstcommittag&lt;span class="o">)&lt;/span> firstcommit
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="参考">参考&lt;/h3>
&lt;p>&lt;a class="link" href="http://blog.timlockridge.com/blog/2013/01/22/changing-the-display-of-git-log/" target="_blank" rel="noopener"
>Changing the Display of Git Log&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>FYI, &lt;code>cat&lt;/code> is not the ideal pager for me, since it displays the full git log from the beginning if I don&amp;rsquo;t append a -1 in the end of the command.
&lt;code>more&lt;/code> was not a good candidate either, since colors was not well displayed in the console with &lt;code>more&lt;/code>
I preferred to keep &lt;code>less&lt;/code> as the pager, but display content in the console.
So for me :
git config &amp;ndash;global core.pager &amp;ldquo;less -erX&amp;rdquo;
(important option here is the -X option)&lt;/p>
&lt;/blockquote></description></item><item><title>pip包冲突</title><link>https://tab.deoops.com/posts/python-import/</link><pubDate>Fri, 30 Mar 2018 10:21:25 +0800</pubDate><guid>https://tab.deoops.com/posts/python-import/</guid><description>&lt;img src="https://tab.deoops.com/posts/python-import/pip.png" alt="Featured image of post pip包冲突" />&lt;p>遇到一个奇怪的问题执行&lt;code>certbot&lt;/code>会报错，&lt;code>moudle conflict&lt;/code>和 &lt;code>No module&lt;/code>，但是&lt;code>yum install certbot&lt;/code>的时候没有报错。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">certbot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Traceback &lt;span class="o">(&lt;/span>most recent call last&lt;span class="o">)&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File &lt;span class="s2">&amp;#34;/bin/certbot&amp;#34;&lt;/span>, line 7, in &amp;lt;module&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">from certbot.main import main
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File &lt;span class="s2">&amp;#34;/usr/lib/python2.7/site-packages/certbot/main.py&amp;#34;&lt;/span>, line 17, in &amp;lt;module&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">from certbot import account
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File &lt;span class="s2">&amp;#34;/usr/lib/python2.7/site-packages/certbot/account.py&amp;#34;&lt;/span>, line 17, in &amp;lt;module&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">from acme import messages
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File &lt;span class="s2">&amp;#34;/usr/lib/python2.7/site-packages/acme/messages.py&amp;#34;&lt;/span>, line 7, in &amp;lt;module&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">from acme import challenges
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File &lt;span class="s2">&amp;#34;/usr/lib/python2.7/site-packages/acme/challenges.py&amp;#34;&lt;/span>, line 11, in &amp;lt;module&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">import requests
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File &lt;span class="s2">&amp;#34;/usr/lib/python2.7/site-packages/requests/__init__.py&amp;#34;&lt;/span>, line 58, in &amp;lt;module&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">from . import utils
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File &lt;span class="s2">&amp;#34;/usr/lib/python2.7/site-packages/requests/utils.py&amp;#34;&lt;/span>, line 32, in &amp;lt;module&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">from .exceptions import InvalidURL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File &lt;span class="s2">&amp;#34;/usr/lib/python2.7/site-packages/requests/exceptions.py&amp;#34;&lt;/span>, line 10, in &amp;lt;module&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">from .packages.urllib3.exceptions import HTTPError as BaseHTTPError
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File &lt;span class="s2">&amp;#34;/usr/lib/python2.7/site-packages/requests/packages/__init__.py&amp;#34;&lt;/span>, line 95, in load_module
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">raise ImportError&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;No module named &amp;#39;%s&amp;#39;&amp;#34;&lt;/span> % &lt;span class="o">(&lt;/span>name,&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ImportError: No module named &lt;span class="s1">&amp;#39;requests.packages.urllib3&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pip install requests urllib3 pyOpenSSL --force --upgrade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">certbot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">An unexpected error occurred:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VersionConflict: &lt;span class="o">(&lt;/span>setuptools 0.9.8 &lt;span class="o">(&lt;/span>/usr/lib/python2.7/site-packages&lt;span class="o">)&lt;/span>, Requirement.parse&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;setuptools&amp;gt;=1.0&amp;#39;&lt;/span>&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pip install --upgrade pip setuptools
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">certbot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="meat">meat&lt;/h2>
&lt;p>弄了很久决定抛弃&lt;code>yum&lt;/code>直接使用 &lt;code>pip&lt;/code>安装certbot，安装完成后，发现不再报错：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">yum install openssl-devel python-devel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pip install --upgrade pip setuptools
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pip install certbot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pip install requests urllib3 pyOpenSSL --force --upgrade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">certbot -d tab.deoops.com --manual --preferred-challenges dns certonly
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="小结">小结&lt;/h2>
&lt;p>本来是不想写这篇博文的，估摸着&lt;code>letsencrypt&lt;/code>官方 迟早会修复certbot rpm包的，结果一等就是两个月，
letsencrypt都没修复 rpm包。&lt;/p>
&lt;p>最近多台服务器的&lt;code>certbot&lt;/code>安装又遇到这个不兼容的问题，每次去其它的服务器上找&lt;code>command history&lt;/code>有点麻烦，所以记下来方便查找。&lt;/p></description></item><item><title>部署moodle</title><link>https://tab.deoops.com/posts/install-moodle/</link><pubDate>Tue, 20 Mar 2018 13:58:27 +0800</pubDate><guid>https://tab.deoops.com/posts/install-moodle/</guid><description>&lt;img src="https://tab.deoops.com/posts/install-moodle/moodle.png" alt="Featured image of post 部署moodle" />&lt;p>客户需要部署一套 &lt;a class="link" href="https://download.moodle.org/releases/latest/" target="_blank" rel="noopener"
>moodle&lt;/a> 教学系统。&lt;/p>
&lt;p>去&lt;a class="link" href="https://moodle.org/" target="_blank" rel="noopener"
>moodle官网&lt;/a>大致看了一圈，发现moodle 是一个典型的PHP web应用。&lt;/p>
&lt;p>其实这种&lt;code>LAMP (Linux, Apache, MySQL, PHP/Perl/Python)&lt;/code>的应用，&lt;/p>
&lt;p>我一般会用docker componse快速部署的，比如这个&lt;a class="link" href="https://github.com/bitnami/bitnami-docker-moodle/blob/master/docker-compose.yml" target="_blank" rel="noopener"
>docker componse&lt;/a>看上去就很不错。&lt;/p>
&lt;p>但是客户不想用docker，要求直接在vm上部署。&lt;/p>
&lt;p>初步确认部署环境为： &lt;code>nginx(let's encrypt)&lt;/code> + &lt;code>php 7.2&lt;/code> + &lt;code>pg 10&lt;/code> + &lt;code>Centos 7.4&lt;/code> 。&lt;/p>
&lt;h2 id="安装软件">安装软件&lt;/h2>
&lt;h3 id="初始化主机">初始化主机&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">hostnamectl set-hostname deoops.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># disable passwd login; use ssh-key only&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /etc/ssh/sshd_config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum update -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum upgrade -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">init &lt;span class="m">6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># add remi repo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安装nginx">安装nginx&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">yum install nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum -y install yum-utils
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum-config-manager --enable rhui-REGION-rhel-server-extras rhui-REGION-rhel-server-optional
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 安装let&amp;#39;s encrypt certbot&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install certbot-nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl &lt;span class="nb">enable&lt;/span> nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 签发证书&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">certbot --nginx certonly
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /etc/nginx/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安装php-dependency">安装php dependency&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">yum --enablerepo&lt;span class="o">=&lt;/span>remi,remi-php72 install php-fpm php-common php-opcache php-pecl-apcu php-cli php-pear php-pdo php-mysqlnd php-pgsql php-pecl-mongodb php-pecl-redis php-pecl-memcache php-pecl-memcached php-gd php-mbstring php-mcrypt php-xml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="配置nginx--php-fpm">配置nginx + php-fpm&lt;/h3>
&lt;p>详细的配置内容看&lt;a class="link" href="#%e9%85%8d%e7%bd%ae" >这里&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">vi /etc/nginx/nginx.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv mood.conf /etc/nginx/conf.d/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -ahl /etc/php-fpm.d/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv www.conf /etc/php-fpm.d/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv php.ini /etc/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start php-fpm.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl &lt;span class="nb">enable&lt;/span> php-fpm.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安装postgresql-10">安装postgresql 10&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">fdisk -l
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash newDisk.sh /dev/vdb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir /media/data/mood
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir /media/data/pgdata
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install https://download.postgresql.org/pub/repos/yum/10/redhat/rhel-7-x86_64/pgdg-centos10-10-2.noarch.rpm -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install postgresql10 -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install postgresql10-server postgresql10-contrib -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /var/lib/pgsql/10/data/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chown -R postgres:postgres /media/data/pgdata
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /usr/lib/systemd/system/postgresql-10.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/pgsql-10/bin/postgresql-10-setup initdb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl &lt;span class="nb">enable&lt;/span> postgresql-10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start postgresql-10
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="配置postgresql-hba">配置postgresql hba&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">netstat -nlp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /media/data/pgdata/pg_hba.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart postgresql-10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netstat -nlp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安装moodle-34">安装moodle 34&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv moodle-latest-34.tgz zh_cn.zip /media/data/mood/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /media/data/mood/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar xzf moodle-latest-34.tgz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /etc/nginx/conf.d/mood.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chown -R nginx:nginx /media/data/mood
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /var/lib/php/session/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /run/php-fpm/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netstat -nlp &lt;span class="p">|&lt;/span> grep php
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chown -R nginx:nginx /var/lib/php/session/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart php-fpm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">su - postgres
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安装moodle依赖包">安装moodle依赖包&lt;/h3>
&lt;p>安装 &lt;code>zip&lt;/code>,&lt;code>xmlrpc&lt;/code>,&lt;code>soap&lt;/code>等依赖包：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">yum --enablerepo&lt;span class="o">=&lt;/span>remi,remi-php72 install php72-php-zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart php-fpm.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart nginx.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">init &lt;span class="m">6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum --enablerepo&lt;span class="o">=&lt;/span>remi,remi-php72 install php72-php-pecl-zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum --enablerepo&lt;span class="o">=&lt;/span>remi,remi-php72 install php-zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart php-fpm.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum --enablerepo&lt;span class="o">=&lt;/span>remi,remi-php72 install php-intl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum --enablerepo&lt;span class="o">=&lt;/span>remi,remi-php72 install phpxmlrpc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum --enablerepo&lt;span class="o">=&lt;/span>remi,remi-php72 install php-xmlrpc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum --enablerepo&lt;span class="o">=&lt;/span>remi,remi-php72 install php-soap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart php-fpm.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="配置">配置&lt;/h2>
&lt;h3 id="配置nginx-php-fpm">配置nginx php-fpm&lt;/h3>
&lt;p>moodle使用的nginx 配置，基本适用于所有的php 应用：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># PHP Upstream Handler
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">upstream&lt;/span> &lt;span class="s">php-handler&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="s">unix:/run/php-fpm/php-fpm.sock&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">moodle-demo.deoops.com&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">ssl&lt;/span> &lt;span class="no">on&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="s">[::]:443&lt;/span> &lt;span class="s">ssl&lt;/span> &lt;span class="s">ipv6only=on&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1"># managed by Certbot
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">443&lt;/span> &lt;span class="s">ssl&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1"># managed by Certbot
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">ssl_certificate&lt;/span> &lt;span class="s">/etc/letsencrypt/live/moodle-demo.deoops.com/fullchain.pem&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1"># managed by Certbot
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">ssl_certificate_key&lt;/span> &lt;span class="s">/etc/letsencrypt/live/moodle-demo.deoops.com/privkey.pem&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1"># managed by Certbot
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">include&lt;/span> &lt;span class="s">/etc/letsencrypt/options-ssl-nginx.conf&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1"># managed by Certbot
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">ssl_dhparam&lt;/span> &lt;span class="s">/etc/letsencrypt/ssl-dhparams.pem&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1"># managed by Certbot
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">root&lt;/span> &lt;span class="s">/media/data/mood/moodle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">rewrite&lt;/span> &lt;span class="s">^/(.*\.php)(/)(.*)&lt;/span>$ &lt;span class="s">/&lt;/span>&lt;span class="nv">$1?file=/$3&lt;/span> &lt;span class="s">last&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">^~&lt;/span> &lt;span class="s">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">try_files&lt;/span> &lt;span class="nv">$uri&lt;/span> &lt;span class="nv">$uri/&lt;/span> &lt;span class="s">/index.php?q=&lt;/span>&lt;span class="nv">$request_uri&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">index&lt;/span> &lt;span class="s">index.php&lt;/span> &lt;span class="s">index.html&lt;/span> &lt;span class="s">index.htm&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="p">~&lt;/span> &lt;span class="sr">\.php$&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">include&lt;/span> &lt;span class="s">fastcgi.conf&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">fastcgi_pass&lt;/span> &lt;span class="s">php-handler&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># http -&amp;gt; https
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">if&lt;/span> &lt;span class="s">(&lt;/span>&lt;span class="nv">$host&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">moodle-demo.deoops.com)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">return&lt;/span> &lt;span class="mi">301&lt;/span> &lt;span class="s">https://&lt;/span>&lt;span class="nv">$host$request_uri&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="c1"># managed by Certbot
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">80&lt;/span> &lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="s">[::]:80&lt;/span> &lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">moodle-demo.deoops.com&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">return&lt;/span> &lt;span class="mi">404&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1"># managed by Certbot
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="配置https证书">配置https证书&lt;/h3>
&lt;p>配置let&amp;rsquo;s encrypt自更新&lt;code>crontab&lt;/code> job:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">certbot renew --dry-run
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crontab -e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crontab -l
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> 0,12 * * * python -c &lt;span class="s1">&amp;#39;import random; import time; time.sleep(random.random() * 3600)&amp;#39;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> certbot renew
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="参考">参考&lt;/h2>
&lt;p>&lt;a class="link" href="https://docs.moodle.org/33/en/PostgreSQL" target="_blank" rel="noopener"
>moodle: set up postgresql counts and database&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.howtoforge.com/tutorial/how-to-install-moodle-32-on-centos-7/" target="_blank" rel="noopener"
>PHP(php-fpm) nginx&lt;/a>&lt;/p></description></item><item><title>数据库备份</title><link>https://tab.deoops.com/posts/postgresql-backup/</link><pubDate>Sat, 24 Feb 2018 11:21:55 +0800</pubDate><guid>https://tab.deoops.com/posts/postgresql-backup/</guid><description>&lt;img src="https://tab.deoops.com/posts/postgresql-backup/postgresql-backup.jpeg" alt="Featured image of post 数据库备份" />&lt;p>工作需要定时备份postgresql slave数据库数据数据，服务器上运行了两个&lt;code>slave&lt;/code>实例，隶属于两个不同的&lt;code>master&lt;/code>。&lt;/p>
&lt;h2 id="备份">备份&lt;/h2>
&lt;p>两个&lt;code>slave server&lt;/code>实例分别监听在 &lt;code>5432&lt;/code>和 &lt;code>4432&lt;/code>端口&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Daily PostgreSQL maintenance: vacuuming and backuping.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> -e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> port in &lt;span class="m">5432&lt;/span> 4432&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">BACKDIR&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/data/pg_back/&lt;/span>&lt;span class="nv">$port&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> -d &lt;span class="nv">$BACKDIR&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">||&lt;/span> mkdir -p &lt;span class="nv">$BACKDIR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;[`date`] begin Maintaining pg on port &lt;/span>&lt;span class="nv">$port&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># no need to use -U option for DB in $(psql -l -t -p $port |awk &amp;#39;{ print $1}&amp;#39; |grep -vE &amp;#39;^-|:|^List|^Name|template[0|1]|postgres|\|&amp;#39;); do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">### swith form &amp;#39;awk and grep&amp;#39; hacks to psql options and &amp;#39;select sql&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">### which is more dbaer professioner :)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> DB in &lt;span class="k">$(&lt;/span>psql -AqXtc &lt;span class="s1">&amp;#39;SELECT datname FROM pg_database WHERE datistemplate = false;&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34; [`date`] Maintaining &lt;/span>&lt;span class="nv">$DB&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">PREFIX&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$BACKDIR&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="nv">$DB&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># NO need to do `vacuum` on slaves&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># do `vacunm` on master instead&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># echo &amp;#39;VACUUM&amp;#39; | psql -U postgres -hlocalhost -d $DB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">DUMP&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PREFIX&lt;/span>&lt;span class="s2">.`date &amp;#39;+%Y%m%d&amp;#39;`.sql.gz&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># no need for -U postgres option&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pg_dump -p &lt;span class="nv">$port&lt;/span> &lt;span class="nv">$DB&lt;/span> &lt;span class="p">|&lt;/span> gzip -c &amp;gt; &lt;span class="nv">$DUMP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">PREV&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PREFIX&lt;/span>&lt;span class="s2">.`date -d&amp;#39;1 day ago&amp;#39; &amp;#39;+%Y%m%d&amp;#39;`.sql.gz&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># md5sum -b $DUMP &amp;gt; $DUMP.md5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">md5&lt;/span>&lt;span class="o">=(&lt;/span>&lt;span class="k">$(&lt;/span>md5sum -b &lt;span class="nv">$DUMP&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$md5&lt;/span> &amp;gt; &lt;span class="nv">$DUMP&lt;/span>.md5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -f &lt;span class="nv">$PREV&lt;/span>.md5 &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> diff &lt;span class="nv">$PREV&lt;/span>.md5 &lt;span class="nv">$DUMP&lt;/span>.md5&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rm -f &lt;span class="nv">$PREV&lt;/span> &lt;span class="nv">$PREV&lt;/span>.md5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## delete too old backup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">TOOOLD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PREFIX&lt;/span>&lt;span class="s2">.`date -d&amp;#39;15 day ago&amp;#39; &amp;#39;+%Y%m%d&amp;#39;`.sql.gz&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> -f &lt;span class="nv">$TOOOLD&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">||&lt;/span> rm -f &lt;span class="nv">$TOOOLD&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;[`date`] Maintain pg on port &lt;/span>&lt;span class="nv">$port&lt;/span>&lt;span class="s2"> finished&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a class="link" href="https://luxagraf.net/src/automatic-offsite-postgresql-backups" target="_blank" rel="noopener"
>参考：Automatic Offsite PostgreSQL Backups Without a Password&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://stackoverflow.com/a/5773761" target="_blank" rel="noopener"
>参考：Only get hash value using md5sum (without filename) &lt;/a>&lt;/p>
&lt;h3 id="定时">定时&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">chmod +x pg_backup.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">su - postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crontab -e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 16 2 * * * /var/lib/pgsql/pg_backup.sh &amp;gt;&amp;gt; /var/log/psql_corn_bak.log&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># */3 * * * * /var/lib/pgsql/pg_backup.sh &amp;gt;&amp;gt; /var/log/psql_corn_bak.log 2&amp;gt;&amp;amp;1 ## every 3 minutes&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="psql">psql&lt;/h2>
&lt;p>一般情况下&lt;code>psql&lt;/code>的工作模式是和人的相互交互模式(interpreter)，在shell脚本里可以使用下面的options &lt;code> -AqXt -c&lt;/code>
会更实用写&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">-A: The output is not aligned&lt;span class="p">;&lt;/span> by default, the output is aligned.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-q &lt;span class="o">(&lt;/span>quiet&lt;span class="o">)&lt;/span>: This option forces psql not to write a welcome message or any other
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">informational output.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-t: This option tells psql to write the tuples only, without any header
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">information.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-X: This option informs psql to ignore the psql configuration that is stored in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">~/.psqlrc file.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-o: This option specifies psql to output the query result to a certain location.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-F: This option determines the field separator between columns. This option can
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">be used to generate CSV, which is useful to import data to Excel files.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PGOPTIONS: psql can use PGOPTIONS to add command-line options to send to the
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">server at runtime. This can be used to control statement behavior such as to
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">allow index scan only or to specify the statement timeout.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="demo">demo&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="nv">connection_number&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="nv">PGOPTIONS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;--statement_timeout=0&amp;#39;&lt;/span> psql -AqXt -c&lt;span class="s2">&amp;#34;SELECT count(*) FROM pg_stat_activity&amp;#34;&lt;/span>&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># The result of the command psql -AqXt –d postgres -c &amp;#34;SELECT count(*) FROM pg_stat_activity&amp;#34; is assigned to a bash variable. &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#The options -AqXt, as discussed previously, cause psql to return only the result without any decoration, as follows:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql -AqXt -c &lt;span class="s2">&amp;#34;SELECT count(*) FROM pg_stat_activity&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>两个奴隶</title><link>https://tab.deoops.com/posts/postgre-two-slaves/</link><pubDate>Mon, 05 Feb 2018 21:55:41 +0800</pubDate><guid>https://tab.deoops.com/posts/postgre-two-slaves/</guid><description>&lt;img src="https://tab.deoops.com/posts/postgre-two-slaves/postgres-replication.jpeg" alt="Featured image of post 两个奴隶" />&lt;p>一般postgres高可用集群是一个master配一个slave，但是开发这边需要做db的读写分离，所以运维这边
又添加了一台slave专门暴露出来做读操作。原来的slave还是只做备份。&lt;/p>
&lt;h2 id="ha">HA&lt;/h2>
&lt;p>一主一从高可用的配置可以参考下面这篇文章
&lt;a class="link" href="https://altecnotes.wordpress.com/2017/03/24/streaming-replication-with-postgresql/" target="_blank" rel="noopener"
>postgres streaming replication&lt;/a>，有时间的话我可能会搬运一下 :)&lt;/p>
&lt;h2 id="安装配置">安装配置&lt;/h2>
&lt;p>因为pg数据库集群已经配置好了一主一从，所以在master主机上&lt;strong>不需要&lt;/strong>配置&lt;code>pg_hba.conf&lt;/code>,
或者&lt;code>CREATE ROLE&lt;/code>等等。&lt;/p>
&lt;p>添加第二个&lt;code>slave&lt;/code>需要注意以下两点：&lt;/p>
&lt;ol>
&lt;li>等待pg_basebackup&lt;code>replicas stream&lt;/code>数据同步完成后，再启动 &lt;code>postgresql-9.6 service&lt;/code>;&lt;/li>
&lt;li>修改&lt;code>PG_DATA_DIR&lt;/code>目录的权限;&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rm /etc/yum.repos.d/pgdg-96-redhat.repo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install https://download.postgresql.org/pub/repos/yum/9.6/redhat/rhel-7-x86_64/pgdg-centos96-9.6-3.noarch.rpm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install -y postgresql96
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install -y postgresql96-server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install -y postgresql96-contrib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /usr/lib/systemd/system/postgresql-9.6.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir /data/pg9.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chown postgres:postgres /data/pg9.6/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /data/pg9.6/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup --help
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## you can add option --checkpoint=fast for an instance backup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## qhich is not recommend&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup -X stream -D /data/pg9.6/ -P -R -h 10.3.3.3 -U replicator
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls /data/pg9.6/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat /data/pg9.6/recovery.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /data/pg9.6/postgresql.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">pwd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start postgresql-9.6.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /data/pg9.6/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chown -R postgres:postgres /data/pg9.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod &lt;span class="m">700&lt;/span> /data/pg9.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start postgresql-9.6.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netstat -nlp &lt;span class="p">|&lt;/span> grep &lt;span class="m">5432&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">su - postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl &lt;span class="nb">enable&lt;/span> postgresql-9.6.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="check">check&lt;/h3>
&lt;p>在master主机上查看&lt;code>pg_stat_replication&lt;/code>表数据，验证第二个slave是否正常工作：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># on MASTER machine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>dba_lol@pg_master ~&lt;span class="o">]&lt;/span>$ sudo su - postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">上一次登录：五 2月 &lt;span class="m">23&lt;/span> 17:12:02 HKT 2018pts/1 上
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-bash-4.2$ psql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql &lt;span class="o">(&lt;/span>9.6.6&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type &lt;span class="s2">&amp;#34;help&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> help.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">postgres&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># select * from pg_stat_replication;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pid &lt;span class="p">|&lt;/span> usesysid &lt;span class="p">|&lt;/span> usename &lt;span class="p">|&lt;/span> application_name &lt;span class="p">|&lt;/span> client_addr &lt;span class="p">|&lt;/span> client_hostname &lt;span class="p">|&lt;/span> client_port &lt;span class="p">|&lt;/span> backend_start &lt;span class="p">|&lt;/span> backend_xmin &lt;span class="p">|&lt;/span> state &lt;span class="p">|&lt;/span> sent_location &lt;span class="p">|&lt;/span> write_location &lt;span class="p">|&lt;/span> flush_location &lt;span class="p">|&lt;/span> replay_location &lt;span class="p">|&lt;/span> sync_priorit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">y &lt;span class="p">|&lt;/span> sync_state
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------+----------+---------+------------------+-------------+-----------------+-------------+-------------------------------+--------------+-----------+---------------+----------------+----------------+-----------------+-------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--+------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">6720&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="m">19367&lt;/span> &lt;span class="p">|&lt;/span> replicator &lt;span class="p">|&lt;/span> walreceiver &lt;span class="p">|&lt;/span> 10.2.2.2 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="m">49308&lt;/span> &lt;span class="p">|&lt;/span> 2018-01-24 18:20:47.114058+08 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> streaming &lt;span class="p">|&lt;/span> 82/6B07DD60 &lt;span class="p">|&lt;/span> 82/6B07DD60 &lt;span class="p">|&lt;/span> 82/6B07DD60 &lt;span class="p">|&lt;/span> 82/6B07DD20 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="p">|&lt;/span> async
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">446&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="m">19367&lt;/span> &lt;span class="p">|&lt;/span> replicator &lt;span class="p">|&lt;/span> walreceiver &lt;span class="p">|&lt;/span> 10.2.2.4 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="m">54836&lt;/span> &lt;span class="p">|&lt;/span> 2018-02-21 13:21:39.420745+08 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> streaming &lt;span class="p">|&lt;/span> 82/6B07DD60 &lt;span class="p">|&lt;/span> 82/6B07DD60 &lt;span class="p">|&lt;/span> 82/6B07DD60 &lt;span class="p">|&lt;/span> 82/6B07DD20 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="p">|&lt;/span> async
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>&lt;span class="m">2&lt;/span> rows&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">postgres&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ps">PS&lt;/h2>
&lt;h3 id="add-slave-to-slave">add slave to slave&lt;/h3>
&lt;p>编辑&lt;code>recover.conf&lt;/code> 文件 的 &lt;code>primary_conninfo&lt;/code>地址信息可以实现&lt;code>slave&lt;/code> -&amp;gt; &lt;code>slave&lt;/code>的数据同步。&lt;/p></description></item><item><title>orange网关</title><link>https://tab.deoops.com/posts/try-orange/</link><pubDate>Mon, 05 Feb 2018 19:37:23 +0800</pubDate><guid>https://tab.deoops.com/posts/try-orange/</guid><description>&lt;img src="https://tab.deoops.com/posts/try-orange/orange.png" alt="Featured image of post orange网关" />&lt;p>几天之前试用过了&lt;a class="link" href="https://tab.deoops.com/posts/try-kong" >kong&lt;/a>效果不理想 ，今天来使用下小米出品（存疑？）的 &lt;a class="link" href="https://github.com/sumory/orange" target="_blank" rel="noopener"
>orange&lt;/a>网关。&lt;/p>
&lt;p>一个明显的区别是 kong的后端存储使用了postgresql，orange使用的是mysql。&lt;/p>
&lt;p>好了，废话不多说，贴出安装部署的过程如下：&lt;/p>
&lt;h2 id="安装">安装&lt;/h2>
&lt;h3 id="mysql">mysql&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rpm -ivh mysql-community-release-el7-5.noarch.rpm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install mysql-server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl start mysqld
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl &lt;span class="nb">enable&lt;/span> mysqld
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo mysql_secure_installation
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi save_your_root_pwd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git clone https://github.com/sumory/orange.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> orange/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> install/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">head orange-v0.6.4.sql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">head -n &lt;span class="m">100&lt;/span> orange-v0.6.4.sql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">head -n &lt;span class="m">50&lt;/span> orange-v0.6.4.sql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql -V
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql -u root -p
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> orange/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> install/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql -u o_usr -p o_database &amp;lt; orange-v0.6.4.sql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mysql -u o_usr -p o_database
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="orange">orange&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>yum remove kong-community-edition &lt;span class="c1">## get rid of annoying lua 5.1 version conflict&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /data/nginx/conf/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp api.conf api.conf.bak.18.03.09 &lt;span class="c1">## always backup conf files : )&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx -s stop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netstat -nlp &lt;span class="p">|&lt;/span> grep &lt;span class="m">443&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mv /usr/sbin/nginx /usr/sbin/nginx_old
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> yum install yum-utils
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> yum install openresty openresty-resty -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git clone https://github.com/sumory/orange.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git clone https://github.com/sumory/lor.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">pwd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv lor ~
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv orange ~
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> lor/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> ../orange/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ln -s /usr/local/bin/orange /bin/orange
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ln -s /usr/local/openresty/nginx/sbin/nginx /bin/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv /home/deoops/orange.conf /home/deoops/nginx.conf /usr/local/orange/conf/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /usr/local/orange/conf/orange.conf &lt;span class="c1">## make sure orange.conf has the right mysql server info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /data/nginx/conf/api.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chown root:root /usr/local/orange/conf/*.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">orange start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netstat -nlp &lt;span class="p">|&lt;/span> grep &lt;span class="m">443&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="小结">小结&lt;/h2>
&lt;p>用了几天，感觉UI比起kong来说简单些，开箱即用的功能比kong也多一些。
稳定性还有待进一步的观察。&lt;/p></description></item><item><title>kong网关</title><link>https://tab.deoops.com/posts/try-kong/</link><pubDate>Sat, 03 Feb 2018 18:05:04 +0800</pubDate><guid>https://tab.deoops.com/posts/try-kong/</guid><description>&lt;img src="https://tab.deoops.com/posts/try-kong/kong.png" alt="Featured image of post kong网关" />&lt;p>updated: kong不满足要求，后面调研了另外一个API产品 &lt;a class="link" href="https://tab.deoops.com/posts/try-orange" >orange&lt;/a>&lt;/p>
&lt;p>2015年接触openresty的时候接触过kong，了解到kong是基于openresty二次开发的商业产品，&lt;/p>
&lt;p>正好目前新公司要调研稳定好用的&lt;code>API Gateway&lt;/code>产品，所以本文简单记录下我对kong的安装配置感受。&lt;/p>
&lt;h2 id="安装">安装&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">yum install https://bintray.com/kong/kong-community-edition-rpm/download_file?file_path&lt;span class="o">=&lt;/span>centos/7/kong-community-edition-0.12.1.el7.noarch.rpm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kong
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl stop nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netstat -nlp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netstat -nlp&lt;span class="p">|&lt;/span>grep &lt;span class="m">80&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">date
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /etc/kong/kong.conf.default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vipw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">su - postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">create user kong&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">create database kong ownner kong&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">create database kong owner kong&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /etc/kong/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp kong.conf.default kong.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi kong.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kong migrations up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql -U kong
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tail /media/data/pgdata/log/postgresql-Wed.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /media/data/pgdata/pg_hba.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart postgresql-10.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kong migrations up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kong
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kong check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kong start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netstat -nlp &lt;span class="p">|&lt;/span> grep &lt;span class="m">80&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">which nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl localhost:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netstat -nlp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /usr/local/kong/nginx-kong.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">which -a nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kong
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kong restart --nginx-conf /etc/nginx/nginx.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.tmpl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /etc/nginx/nginx.conf.tmpl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kong restart --nginx-conf /etc/nginx/nginx.conf.tmpl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">which -a npm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安装控制台">安装控制台&lt;/h3>
&lt;p>使用&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">which -a docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum remove docker docker-common docker-selinux docker-engine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install -y yum-utils device-mapper-persistent-data lvm2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install docker-ce
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker run hello-world
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -sSL https://get.daocloud.io/daotools/set_mirror.sh &lt;span class="p">|&lt;/span> sh -s http://2b77623e.m.daocloud.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl &lt;span class="nb">enable&lt;/span> docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker run -d --rm -p 8080:8080 pgbi/kong-dashboard start --kong-url http://10.0.0.1:8001 --basic-auth &lt;span class="nv">usrtest&lt;/span>&lt;span class="o">=&lt;/span>pwdtest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker ps -a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">### registe the very first api through kong admin api&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -i -X POST --url http://10.0.0.11:8001/apis --data &lt;span class="s1">&amp;#39;name=admin-api&amp;#39;&lt;/span> --data &lt;span class="s1">&amp;#39;hosts=a.k.deoops.com&amp;#39;&lt;/span> --data &lt;span class="s1">&amp;#39;upstream_url=http://localhost:8080&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="小结">小结&lt;/h2>
&lt;p>开源Kong 的限制比较多，&lt;a class="link" href="https://tab.deoops.com/posts/nginx-proxy/" >反向代理&lt;/a>配置基本上靠插件，对现存的nginx的conf兼容性不友好。
简单的&lt;code>proxy_cache&lt;/code>配置一定要企业版才支持，下面的更加&lt;code>精细&lt;/code>配置也没有支持：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl"> &lt;span class="k">valid_referers&lt;/span> &lt;span class="s">*.deoops.cn&lt;/span> &lt;span class="s">deoops.cn&lt;/span> &lt;span class="s">*.deoops.com&lt;/span> &lt;span class="s">deoops.com&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">add_header&lt;/span> &lt;span class="s">&amp;#39;Access-Control-Allow-Headers&amp;#39;&lt;/span> &lt;span class="s">&amp;#39;os,&lt;/span> &lt;span class="s">ver,&lt;/span> &lt;span class="s">hwid,&lt;/span> &lt;span class="s">innerver,&lt;/span> &lt;span class="s">channel,&lt;/span> &lt;span class="s">net,&lt;/span> &lt;span class="s">token,&lt;/span> &lt;span class="s">et&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">proxy_cache&lt;/span> &lt;span class="s">my_cache&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">proxy_cache_valid&lt;/span> &lt;span class="mi">200&lt;/span> &lt;span class="mi">302&lt;/span> &lt;span class="mi">304&lt;/span> &lt;span class="s">10s&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">proxy_ignore_headers&lt;/span> &lt;span class="s">Expires&lt;/span> &lt;span class="s">Cache-Control&lt;/span> &lt;span class="s">Set-Cookie&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">proxy_cache_key&lt;/span> &lt;span class="nv">$host$request_uri$is_args$args$http_token&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="s">(&lt;/span>&lt;span class="nv">$request_uri&lt;/span> &lt;span class="p">~&lt;/span> &lt;span class="sr">img_vercode&lt;/span> &lt;span class="s">)&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">set&lt;/span> &lt;span class="nv">$no_proxy_cache&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="s">(&lt;/span>&lt;span class="nv">$remote_addr&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">114&lt;/span>&lt;span class="s">.13.118.24)&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">set&lt;/span> &lt;span class="nv">$no_proxy_cache&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>init优先级</title><link>https://tab.deoops.com/posts/golang-init/</link><pubDate>Tue, 23 Jan 2018 16:23:01 +0800</pubDate><guid>https://tab.deoops.com/posts/golang-init/</guid><description>&lt;img src="https://tab.deoops.com/posts/golang-init/init.png" alt="Featured image of post init优先级" />&lt;p>假设一个golang项目的三个源文件&lt;code>a.go&lt;/code>,&lt;code>b.go&lt;/code>, &lt;code>c.go&lt;/code>，都定义了&lt;code>function inint(){}&lt;/code>函数，&lt;/p>
&lt;p>其中&lt;code>c.go&lt;/code>文件初始化了一个全局变量&lt;code>globalVar&lt;/code>，同时&lt;code>a.go&lt;/code> 或者&lt;code>b.go&lt;/code>的&lt;code>init func&lt;/code> 引用了这个全局变量&lt;code>globalVar&lt;/code>。&lt;/p>
&lt;p>那么这个时候就会出现一个问题，在&lt;code>a.go&lt;/code>和 &lt;code>b.go&lt;/code>的init func中 &lt;code>globalVar&lt;/code>的引用是空值。&lt;/p>
&lt;h2 id="示例">示例&lt;/h2>
&lt;h3 id="文件结构">文件结构&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ tree
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── a.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── b.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── c.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── go.mod
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└── main.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> directories, &lt;span class="m">5&lt;/span> files
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="源代码">源代码&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// file `a.go`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// globalVar is empty
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;globalVar in a.go:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">globalVar&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// file `b.go`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// globalVar is empty
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;globalVar in b.go:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">globalVar&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// file `c.go`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">globalVar&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">initVar&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;globalVar in c.go:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">globalVar&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">initVar&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Millisecond&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;late is better than never&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// file `main.go`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">globalVar&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;vim-go&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="result">result&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ go build -o demo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">❯ ./demo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">globalVar in a.go:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">globalVar in b.go:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">globalVar in c.go: late is better than never
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vim-go
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="解决办法">解决办法&lt;/h2>
&lt;p>简单的解决办法可以是重命名&lt;code>c.go&lt;/code>为&lt;code>0a.go&lt;/code>保证&lt;code>0a.go&lt;/code>中的&lt;code>init&lt;/code>最早执行完成，&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mv c.go 01.go
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个解决方案的优点是可以不用修改代码，但是不够优雅。&lt;/p>
&lt;p>比较好的解决方式应该是，不要在&lt;code>init func&lt;/code>里初始化全局变量，应该直接在&lt;code>top block context&lt;/code>中对全局变量初始化：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// file `c.go`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">globalVar&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">initVar&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>试用Azure Centos虚拟机</title><link>https://tab.deoops.com/posts/azure-centos/</link><pubDate>Wed, 15 Nov 2017 10:48:20 +0800</pubDate><guid>https://tab.deoops.com/posts/azure-centos/</guid><description>&lt;img src="https://tab.deoops.com/posts/azure-centos/Azure.png" alt="Featured image of post 试用Azure Centos虚拟机" />&lt;p>换了份工作，新公司是做加密币交易所的，服务器都在国外。所以有机会接触到了微软的azure云服务，
服务器基本都在亚太区新加坡。&lt;/p>
&lt;p>ps：这是我第一次实操单台配置32c64g的虚拟机，纪念一下。以前工作中最多就8c16g，数量的话两三百台机器。&lt;/p>
&lt;h2 id="history">history&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">uname -a &lt;span class="c1"># kernel info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat /etc/redhat-release
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">df -alh &lt;span class="c1"># query disk info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ifconfig
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ping 10.0.0.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssh 10.0.0.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls .ssh/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv azagent .ssh/id_rsa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh .ssh/id_rsa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssh 10.0.0.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ping jd.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install yum-utils
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo yum install yum-utils
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum -y upgrade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum -y upgrade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum -y update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install openresty &lt;span class="c1"># install web server&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo vi /etc/ssh/sshd_config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl status sshd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart sshd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl restart sshd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install ansible
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install ansible
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl status openresty
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl &lt;span class="nb">enable&lt;/span> openresty
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl start openresty
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -I localhost
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uptime
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">date
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo install git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">locate openresty
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rpm -qc openresty &lt;span class="c1"># query configuration file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget https://copr.fedorainfracloud.org/coprs/dheche/prometheus/repo/epel-7/dheche-prometheus-epel-7.repo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">head dheche-prometheus-epel-7.repo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">suod mv dheche-prometheus-epel-7.repo /etc/yum.repos.d/prometheus.repo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo mv dheche-prometheus-epel-7.repo /etc/yum.repos.d/prometheus.repo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install prometheus
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install prometheus-node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo vi /etc/yum.repos.d/prometheus.repo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install prometheus
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install prometheus2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install node_exporter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install alertmanager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo vi /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssh ten
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo vi /etc/yum.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls /var/cache/yum/x86_64/7/prometheus/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls /var/cache/yum/x86_64/7/prometheus/packages/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /var/cache/yum/x86_64/7/prometheus/packages/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install yum-utils
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">history&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yumdownloader prometheus
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yumdownloader prometheus2 &lt;span class="c1"># download installed rmp packages&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yumdownloader node_exporter.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yumdownloader alertmanager.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scp node_exporter-0.15.2-1.el7.centos.x86_64.rpm ten:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssh ten
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssh ten &lt;span class="s1">&amp;#39;sudo systemctl enable node_exporter&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssh ten &lt;span class="s1">&amp;#39;sudo systemctl start node_exporter&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl start node_exporter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl &lt;span class="nb">enable&lt;/span> node_exporter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl &lt;span class="nb">enable&lt;/span> alertmanger
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl &lt;span class="nb">enable&lt;/span> alertmanager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl start alertmanager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netstat -nlp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo -i &lt;span class="c1"># su to root&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">pwd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm prometheus-1.8.2-1.el7.centos.x86_64.rpm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl &lt;span class="nb">enable&lt;/span> prometheus
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl start prometheus
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat/etc/passwd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rpm -qc prometheus2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /etc/default/prometheus
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">id prometheus
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat /etc/default/prometheus
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ls -alh /etc/prometheus/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo -i
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>总的说来敲了100来条指令，比较重要的是下面三条指令：&lt;/p>
&lt;ol>
&lt;li>&lt;code>sudo -i&lt;/code>切换为root用户；&lt;/li>
&lt;li>&lt;code>yumdownloader &lt;/code>保存通过yum安装的rpm包 (配合&lt;code>yum -C install &lt;/code>和&lt;code>SCP&lt;/code>可以加快LAN下所有主机的安装速度)；&lt;/li>
&lt;li>&lt;code>rpm -qc &lt;/code>查询安装包配置信息;&lt;/li>
&lt;/ol>
&lt;h2 id="timeout">timeout&lt;/h2>
&lt;p>默认情况下，Azure 的Linux主机的&lt;code>sshd&lt;/code> 服务会把闲着超过1分钟的客户端踢下线&lt;code>ssh session timeout&lt;/code>。
修改本地&lt;code>ssh&lt;/code> 客户端连接配置添加&lt;code>ServerAliveInterval&lt;/code>等配置项就可以规避上面说的timeout限制：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#### .ssh/config snippet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HOST singapore2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> HostName 40.50.60.70
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> IdentityFile ~/.ssh/az
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ServerAliveInterval &lt;span class="m">120&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ServerAliveCountMax &lt;span class="m">30&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ConnectTimeout &lt;span class="m">30&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>查找文件</title><link>https://tab.deoops.com/posts/find-locate/</link><pubDate>Sat, 16 Sep 2017 08:09:57 +0800</pubDate><guid>https://tab.deoops.com/posts/find-locate/</guid><description>&lt;img src="https://tab.deoops.com/posts/find-locate/fzf-command.png" alt="Featured image of post 查找文件" />&lt;h2 id="tldr">TLDR;&lt;/h2>
&lt;ol>
&lt;li>&lt;code>find&lt;/code>: 有很多过滤规则查找文件/目录/设备，而且可以递归查询某一个目录下的目录或文件，最后除了打印查询结果以外，还可以做其它操作（比如删除该文件）；&lt;/li>
&lt;li>&lt;code>locate&lt;/code>: 则简单很多，根据关键字 在缓存index中 检索出含有该关键字的文件或者目录；&lt;/li>
&lt;li>&lt;code>fzf&lt;/code>: 实时模糊查询，可以集成到常用的IDE中（比如&lt;code>fzf.vim&lt;/code>)。&lt;/li>
&lt;/ol>
&lt;h2 id="demo">demo&lt;/h2>
&lt;h3 id="find">find&lt;/h3>
&lt;p>The syntax of the Find command is:&lt;/p>
&lt;p>&lt;code>find [-H] [-L] [-P] [-D debugopts] [-Olevel] [starting-point...] [expression]&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>find . -name &lt;span class="s2">&amp;#34;*tar*gz&amp;#34;&lt;/span> -delete
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">find . -name &lt;span class="s2">&amp;#34;*tar*xz&amp;#34;&lt;/span> -delete
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">find . -name &lt;span class="s2">&amp;#34;*tar.xz&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">du -sh .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">find . -name &lt;span class="s2">&amp;#34;*zip*&amp;#34;&lt;/span> -delete
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">find . -type f &lt;span class="p">|&lt;/span> perl -lne &lt;span class="s1">&amp;#39;print if -B&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> xargs rm -f &lt;span class="c1"># delete all binary files under . recursivly&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="locate">locate&lt;/h3>
&lt;p>The syntax of the Locate command is:&lt;/p>
&lt;p>&lt;code>locate [OPTION]... PATTERN..&lt;/code>&lt;/p>
&lt;p>查询&lt;code>postgreql db&lt;/code>的配置文件：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>locate *hba_conf*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># equal to this&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">su - postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">show config_file&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">show hba_file&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="fzf">fzf&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">tldr fzf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fzf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Command-line fuzzy finder.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Similar to sk.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">More information: https://github.com/junegunn/fzf.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Start fzf on all files in the specified directory:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> find path/to/directory -type f &lt;span class="p">|&lt;/span> fzf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Start fzf &lt;span class="k">for&lt;/span> running processes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ps aux &lt;span class="p">|&lt;/span> fzf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Select multiple files with Shift + Tab and write to a file:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> find path/to/directory -type f &lt;span class="p">|&lt;/span> fzf --multi &amp;gt; filename
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Start fzf with a specified query:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fzf --query &lt;span class="s2">&amp;#34;query&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Start fzf on entries that start with core and end with either go, rb, or py:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fzf --query &lt;span class="s2">&amp;#34;^core go&lt;/span>$&lt;span class="s2"> | rb&lt;/span>$&lt;span class="s2"> | py&lt;/span>$&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- Start fzf on entries that not match pyc and match exactly travis:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fzf --query &lt;span class="s2">&amp;#34;!pyc &amp;#39;travis&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">See also: sk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 159;
flex-basis: 382px"
>
&lt;a href="https://tab.deoops.com/posts/find-locate/fzf.png" data-size="1418x890">
&lt;img src="https://tab.deoops.com/posts/find-locate/fzf.png"
width="1418"
height="890"
srcset="https://tab.deoops.com/posts/find-locate/fzf_hu582dc8c5511da3cda2a6630bb19f3b70_557722_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/find-locate/fzf_hu582dc8c5511da3cda2a6630bb19f3b70_557722_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="fzf search result">
&lt;/a>
&lt;figcaption>fzf search result&lt;/figcaption>
&lt;/figure>&lt;/p></description></item><item><title>代理和反向代理</title><link>https://tab.deoops.com/posts/nginx-proxy/</link><pubDate>Fri, 19 May 2017 10:30:05 +0800</pubDate><guid>https://tab.deoops.com/posts/nginx-proxy/</guid><description>&lt;img src="https://tab.deoops.com/posts/nginx-proxy/reverse-proxy-packet-flow.png" alt="Featured image of post 代理和反向代理" />&lt;h2 id="代理">代理&lt;/h2>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 166;
flex-basis: 399px"
>
&lt;a href="https://tab.deoops.com/posts/nginx-proxy/proxies.png" data-size="1323x794">
&lt;img src="https://tab.deoops.com/posts/nginx-proxy/proxies.png"
width="1323"
height="794"
srcset="https://tab.deoops.com/posts/nginx-proxy/proxies_hu3e3b7387a325d4f477d582dfaa11e0f9_514323_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/nginx-proxy/proxies_hu3e3b7387a325d4f477d582dfaa11e0f9_514323_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="proxies">
&lt;/a>
&lt;figcaption>proxies&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h3 id="正向代理">(正向)代理&lt;/h3>
&lt;p>代理一般是指正向代理，比如翻墙软件&lt;code>shadowsocks&lt;/code>就是一种正向代理。 shadowsocks通过&lt;code>socks 5&lt;/code>协议
在代理服务器上，&lt;/p>
&lt;p>代理我们（client）去访问被墙的资源（google/twitter/Facebook等服务器）。&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 214;
flex-basis: 514px"
>
&lt;a href="https://tab.deoops.com/posts/nginx-proxy/proxy-server.png" data-size="1462x682">
&lt;img src="https://tab.deoops.com/posts/nginx-proxy/proxy-server.png"
width="1462"
height="682"
srcset="https://tab.deoops.com/posts/nginx-proxy/proxy-server_hu862ce645965adb3b4cc7718adef8e305_78870_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/nginx-proxy/proxy-server_hu862ce645965adb3b4cc7718adef8e305_78870_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="forward proxy server">
&lt;/a>
&lt;figcaption>forward proxy server&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;blockquote>
&lt;p>A proxy server, sometimes referred to as a forward proxy, is a server that routes traffic between client(s) and another system, usually external to the network. By doing so, it can regulate traffic according to preset policies, convert and mask client IP addresses, enforce security protocols, and block unknown traffic.&lt;/p>
&lt;/blockquote>
&lt;h3 id="反向代理">反向代理&lt;/h3>
&lt;p>反向代理是说我们（client）被代理了， 我们自己还不知道。
我们以为和我们打交道的（处理我们的请求）的是nginx 服务器，其实nginx真正处理我们请求的是ngix后面的&lt;code>upstream&lt;/code>在
处理我们的请求逻辑。&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 242;
flex-basis: 581px"
>
&lt;a href="https://tab.deoops.com/posts/nginx-proxy/reverse-proxy.png" data-size="800x330">
&lt;img src="https://tab.deoops.com/posts/nginx-proxy/reverse-proxy.png"
width="800"
height="330"
srcset="https://tab.deoops.com/posts/nginx-proxy/reverse-proxy_hu8eb6024cc5014449d5925ea11f2cc90b_21131_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/nginx-proxy/reverse-proxy_hu8eb6024cc5014449d5925ea11f2cc90b_21131_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="reverse proxy server">
&lt;/a>
&lt;figcaption>reverse proxy server&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;blockquote>
&lt;p>A reverse proxy is a type of proxy server. Unlike a traditional proxy server, which is used to protect clients, a reverse proxy is used to protect servers. A reverse proxy is a server that accepts a request from a client, forwards the request to another one of many other servers, and returns the results from the server that actually processed the request to the client as if the proxy server had processed the request itself. The client only communicates directly with the reverse proxy server and it does not know that some other server actually processed its request.&lt;/p>
&lt;/blockquote>
&lt;h2 id="config">config&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### common set_header
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># /opt/nginx/conf.d/common.proxy;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">proxy_hide_header&lt;/span> &lt;span class="s">Vary&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_set_header&lt;/span> &lt;span class="s">Accept-Encoding&lt;/span> &lt;span class="s">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_ignore_headers&lt;/span> &lt;span class="s">Cache-Control&lt;/span> &lt;span class="s">Expires&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_set_header&lt;/span> &lt;span class="s">Cookie&lt;/span> &lt;span class="nv">$http_cookie&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_set_header&lt;/span> &lt;span class="s">Referer&lt;/span> &lt;span class="nv">$http_referer&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_set_header&lt;/span> &lt;span class="s">X-Forwarded-Host&lt;/span> &lt;span class="nv">$host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_set_header&lt;/span> &lt;span class="s">X-Forwarded-Server&lt;/span> &lt;span class="nv">$host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_set_header&lt;/span> &lt;span class="s">X-Forwarded-For&lt;/span> &lt;span class="nv">$proxy_add_x_forwarded_for&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_set_header&lt;/span> &lt;span class="s">Host&lt;/span> &lt;span class="nv">$http_host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_set_header&lt;/span> &lt;span class="s">X-Real-IP&lt;/span> &lt;span class="nv">$remote_addr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># csrf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">proxy_set_header&lt;/span> &lt;span class="s">X-CSRF-TOKEN&lt;/span> &lt;span class="nv">$http_x_xsrf_token&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_buffer_size&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_buffers&lt;/span> &lt;span class="mi">16&lt;/span> &lt;span class="mi">64k&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_busy_buffers_size&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">proxy_temp_file_write_size&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="demo">demo&lt;/h2>
&lt;p>下面的两个demo都使用了&lt;code>include /opt/nginx/conf.d/common.proxy&lt;/code>指令，来包含上面的proxy配置。&lt;/p>
&lt;h3 id="http">http&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### demo1-http
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">upstream&lt;/span> &lt;span class="s">upV1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">172.26.2.5&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9090&lt;/span> &lt;span class="s">fail_timeout=0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">172.26.2.6&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9090&lt;/span> &lt;span class="s">fail_timeout=0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">upstream&lt;/span> &lt;span class="s">upV2&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">172.26.2.5&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8080&lt;/span> &lt;span class="s">fail_timeout=0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">172.26.2.6&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8080&lt;/span> &lt;span class="s">fail_timeout=0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">80&lt;/span> &lt;span class="s">default&lt;/span> &lt;span class="s">backlog=16384&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">api.deoops.com&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">access_log&lt;/span> &lt;span class="s">/data/nginx/logs/grafana_access.log&lt;/span> &lt;span class="s">main&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">error_log&lt;/span> &lt;span class="s">/data/nginx/logs/grafanar_err.log&lt;/span> &lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">include&lt;/span> &lt;span class="s">/opt/nginx/conf.d/common.proxy&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/v1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_redirect&lt;/span> &lt;span class="no">off&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://upV1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/v2&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_redirect&lt;/span> &lt;span class="no">off&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://upV2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="https">https&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### demo2-https
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">443&lt;/span> &lt;span class="s">default&lt;/span> &lt;span class="s">ssl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">deoops.com&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">root&lt;/span> &lt;span class="s">/usr/local/nginx/html&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">index&lt;/span> &lt;span class="s">index.html&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_ssl_session_reuse&lt;/span> &lt;span class="no">off&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">ssl_session_cache&lt;/span> &lt;span class="s">shared:SSL:1m&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">ssl_session_timeout&lt;/span> &lt;span class="mi">10m&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">ssl_certificate&lt;/span> &lt;span class="s">/var/lib/teleport/deoops.com/cert.pem&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">ssl_certificate_key&lt;/span> &lt;span class="s">/var/lib/teleport/deoops.com/key.pem&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">ssl_verify_client&lt;/span> &lt;span class="no">off&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">ssl_protocols&lt;/span> &lt;span class="s">SSLv3&lt;/span> &lt;span class="s">TLSv1&lt;/span> &lt;span class="s">TLSv1.1&lt;/span> &lt;span class="s">TLSv1.2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">ssl_ciphers&lt;/span> &lt;span class="s">RC4:HIGH:!aNULL:!MD5&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">ssl_prefer_server_ciphers&lt;/span> &lt;span class="no">on&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_redirect&lt;/span> &lt;span class="no">off&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_set_header&lt;/span> &lt;span class="s">Host&lt;/span> &lt;span class="nv">$http_host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_set_header&lt;/span> &lt;span class="s">X-Real-IP&lt;/span> &lt;span class="nv">$remote_addr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_set_header&lt;/span> &lt;span class="s">X-Forwared-For&lt;/span> &lt;span class="nv">$proxy_add_x_forwarded_for&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">https://localhost:33000&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>缓存静态文件</title><link>https://tab.deoops.com/posts/nginx-cache/</link><pubDate>Sat, 29 Apr 2017 15:36:18 +0800</pubDate><guid>https://tab.deoops.com/posts/nginx-cache/</guid><description>&lt;img src="https://tab.deoops.com/posts/nginx-cache/tmpfs.png" alt="Featured image of post 缓存静态文件" />&lt;p>众所周知nginx有很强的分发静态文件的能力，很多时候nginx对静态资源分发能力的瓶颈和&lt;code>redis&lt;/code>一样在主机的网卡上。&lt;/p>
&lt;p>(一般虚拟机的网卡只有500mbps，如果你使用的是万兆的物理网卡就当我没说）&lt;/p>
&lt;p>和redis对比，nginx有另外一个瓶颈在服务器的硬盘IO上，SSD硬盘情况会好一些，
所以很多情况下，我们会把 nginx的cache 做在系统的ssd硬盘上，&lt;/p>
&lt;p>其实还可以直接把cache放到内存文件系统里，进一步提升磁盘io吞吐。&lt;/p>
&lt;h2 id="tmpfs">tmpfs&lt;/h2>
&lt;p>&lt;a class="link" href="https://www.jamescoyle.net/knowledge/951-the-difference-between-a-tmpfs-and-ramfs-ram-disk" target="_blank" rel="noopener"
>differences between ramfs and tmpfs&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>mkdir /mnt/ramdisk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -t tmpfs -o &lt;span class="nv">size&lt;/span>&lt;span class="o">=&lt;/span>512m tmpfs /mnt/ramdisk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;tmpfs /mnt/ramdisk tmpfs nodev,nosuid,noexec,nodiratime,size=1024M 0 0&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/fstab
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="nginx">nginx&lt;/h2>
&lt;h3 id="http-cache-config">http cache config&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">http&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">more_set_headers&lt;/span> &lt;span class="s">&amp;#39;Server:&lt;/span> &lt;span class="s">CachedLOL&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_cache_path&lt;/span> &lt;span class="s">/var/cache/nginx&lt;/span> &lt;span class="s">levels=1:2&lt;/span> &lt;span class="s">use_temp_path=on&lt;/span> &lt;span class="s">keys_zone=one:500m&lt;/span> &lt;span class="s">max_size=5g&lt;/span> &lt;span class="s">inactive=120m&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_temp_path&lt;/span> &lt;span class="s">/var/cache/nginx/tmp&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="location-conf">location conf&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">upstream&lt;/span> &lt;span class="s">upV1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">172.26.2.5&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9090&lt;/span> &lt;span class="s">fail_timeout=0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">172.26.2.6&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9090&lt;/span> &lt;span class="s">fail_timeout=0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">80&lt;/span> &lt;span class="s">default&lt;/span> &lt;span class="s">backlog=16384&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">tab.deoops.com&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="p">~&lt;/span>&lt;span class="sr">*&lt;/span> &lt;span class="s">(&lt;/span> &lt;span class="s">/static.*|/list.+|/&lt;/span> &lt;span class="s">)&lt;/span>$ &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_redirect&lt;/span> &lt;span class="no">off&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_cache&lt;/span> &lt;span class="no">on&lt;/span>&lt;span class="s">e&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_ignore_headers&lt;/span> &lt;span class="s">&amp;#34;Set-Cookie&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_hide_header&lt;/span> &lt;span class="s">&amp;#34;Set-Cookie&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">add_header&lt;/span> &lt;span class="s">X-Cache&lt;/span> &lt;span class="nv">$upstream_cache_status&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_cache_key&lt;/span> &lt;span class="nv">$uri$is_args$args$mobile&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_cache_min_uses&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_cache_valid&lt;/span> &lt;span class="mi">120m&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_cache_use_stale&lt;/span> &lt;span class="s">error&lt;/span> &lt;span class="s">timeout&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_buffering&lt;/span> &lt;span class="no">on&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://upV1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>安装配置openvpn</title><link>https://tab.deoops.com/posts/install-openvpn/</link><pubDate>Mon, 20 Feb 2017 13:24:19 +0800</pubDate><guid>https://tab.deoops.com/posts/install-openvpn/</guid><description>&lt;img src="https://tab.deoops.com/posts/install-openvpn/openvpnflows.jpeg" alt="Featured image of post 安装配置openvpn" />&lt;p>开发需要能调用&lt;code>facebook&lt;/code>的接口，我们运维这边需要配置一台测试服务器能访问&lt;code>facebook&lt;/code>，用shadowsocks
和squid 代理，性能不够好。所以决定上openvpn。&lt;/p>
&lt;p>简单记录下openVPN的安装配置过程，服务端和客户端使用的操作系统均是centos 7。&lt;/p>
&lt;h2 id="服务端">服务端&lt;/h2>
&lt;h3 id="安装">安装&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>yum install epel-release -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install openvpn openssl -y
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="自签名证书">自签名证书&lt;/h4>
&lt;p>使用&lt;code>openssl&lt;/code>工具生产自签名的ca，证书，client.key，并把这些证书传给客户端：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### CA&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl dhparam -out /etc/openvpn/dh.pem &lt;span class="m">2048&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl genrsa -out /etc/openvpn/ca.key &lt;span class="m">2048&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl req -new -key /etc/openvpn/ca.key -out /etc/openvpn/ca.csr -subj /CN&lt;span class="o">=&lt;/span>OpenVPN-CA/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl x509 -req -in /etc/openvpn/ca.csr -out /etc/openvpn/ca.crt -signkey /etc/openvpn/ca.key -days &lt;span class="m">3650&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="m">01&lt;/span> &amp;gt; /etc/openvpn/ca.srl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod &lt;span class="m">600&lt;/span> /etc/openvpn/ca.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### Server &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl genrsa -out /etc/openvpn/server.key &lt;span class="m">2048&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl req -new -key /etc/openvpn/server.key -out /etc/openvpn/server.csr -subj /CN&lt;span class="o">=&lt;/span>OpenVPN/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl x509 -req -in /etc/openvpn/server.csr -out /etc/openvpn/server.crt -CA /etc/openvpn/ca.crt -CAkey /etc/openvpn/ca.key -days &lt;span class="m">3650&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod &lt;span class="m">600&lt;/span> /etc/openvpn/server.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### Client&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl genrsa -out /etc/openvpn/client.key &lt;span class="m">2048&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl req -new -key /etc/openvpn/client.key -out /etc/openvpn/client.csr -subj /CN&lt;span class="o">=&lt;/span>OpenVPN-Client/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl x509 -req -in /etc/openvpn/client.csr -out /etc/openvpn/client.crt -CA /etc/openvpn/ca.crt -CAkey /etc/openvpn/ca.key -days &lt;span class="m">3650&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod &lt;span class="m">600&lt;/span> /etc/openvpn/client.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### 把clinet的证书私钥和ca正式传给客户端&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scp /etc/openvpn/ca.crt /etc/openvpn/client.crt /etc/openvpn/client.key client:
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="配置">配置&lt;/h3>
&lt;h4 id="服务端配置文件">服务端配置文件:&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># /etc/openvpn/server.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">server 10.8.0.0 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">verb &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">key /etc/openvpn/server.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ca /etc/openvpn/ca.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert /etc/openvpn/server.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dh /etc/openvpn/dh.pem
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">keepalive &lt;span class="m">10&lt;/span> &lt;span class="m">120&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">persist-key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">persist-tun
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">comp-lzo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">push &lt;span class="s2">&amp;#34;redirect-gateway def1 bypass-dhcp&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">push &lt;span class="s2">&amp;#34;dhcp-option DNS 8.8.8.8&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">push &lt;span class="s2">&amp;#34;dhcp-option DNS 8.8.4.4&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">user nobody
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">group nogroup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">proto udp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">port &lt;span class="m">1194&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dev tun1194
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">status openvpn-status.log
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="kernel-iptables">kernel iptables&lt;/h4>
&lt;p>打开服务器路由配置：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;net.ipv4.ip_forward=1&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/sysctl.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sysctl -p
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="启动">启动&lt;/h3>
&lt;p>服务器启动openVPN服务：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>systemctl &lt;span class="nb">enable&lt;/span> openvpn@server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl start openvpn@server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="客户端">客户端&lt;/h2>
&lt;h3 id="安装-1">安装&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>yum install epel-release -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum install openvpn -y
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="配置-1">配置&lt;/h3>
&lt;h4 id="证书">证书&lt;/h4>
&lt;p>把前面服务端签名的证书移动到配置目录下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>mv ~/ca.crt /etc/openvpn
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv ~/client* /etc/openvpn/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="配置文件">配置文件&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># /etc/openvpn/client.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nobind
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dev tun
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redirect-gateway def1 bypass-dhcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">remote CHANGE_TO_YOUR_SERVER_IP &lt;span class="m">1194&lt;/span> udp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">comp-lzo yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#duplicate-cn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">key /etc/openvpn/client.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert /etc/openvpn/client.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ca /etc/openvpn/ca.crt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="启动-1">启动&lt;/h3>
&lt;p>客户端启动openVPN服务：&lt;/p>
&lt;pre tabindex="0">&lt;code>#!/bin/bash
systemctl enable openvpn@client
systemctl start openvpn@client
&lt;/code>&lt;/pre>&lt;p>&lt;a class="link" href="https://www.rosehosting.com/blog/how-to-install-openvpn-on-centos-7/" target="_blank" rel="noopener"
>参考How to Install OpenVPN on CentOS 7&lt;/a>&lt;/p></description></item><item><title>Ansible</title><link>https://tab.deoops.com/posts/ansible-memo/</link><pubDate>Sat, 16 Apr 2016 11:33:05 +0800</pubDate><guid>https://tab.deoops.com/posts/ansible-memo/</guid><description>&lt;img src="https://tab.deoops.com/posts/ansible-memo/ansible.png" alt="Featured image of post Ansible" />&lt;p>本文不定期更新 :)&lt;/p>
&lt;p>&lt;a class="link" href="https://www.redhat.com/en/blog/system-administrators-guide-getting-started-ansible-fast?extIdCarryOver=true&amp;amp;sc_cid=701f2000001OH7YAAW" target="_blank" rel="noopener"
>A system administrator&amp;rsquo;s guide to getting started with Ansible&lt;/a>&lt;/p>
&lt;h2 id="ad-hoc">ad-hoc&lt;/h2>
&lt;p>管理集群的时候，常常来不及写playbooks，只需要执行一些ad-hoc查看某些主机的状态，
或者批量修改/上传配置文件到某些主机。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ansible all -m copy -a &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>&lt;span class="s1">&amp;#39;src=dvd.repo dest=/etc/yum.repos.d owner=root group=root mode=0644&amp;#39;&lt;/span> -b
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="playbook">playbook&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ansible-playbook -i prod_hosts demo.yml --skip-tag downloaded
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="host-file">host file&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[api]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">tt ansible_host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">tt3 ansible_host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">test3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">tt8 ansible_host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">test8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[db]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">pg1 ansible_host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">db88&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">pg2 ansible_host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">db98&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="task">task&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># demo.yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">db&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">vars&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tar_src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;tars/postgres_exporter_v0.4.1_linux-amd64.tar.gz&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tar_dest&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/usr/bin/&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">service_src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;services/postgres_exporter.service&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">service_dest&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/usr/lib/systemd/system/&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># works on centos; ubuntu is &amp;#39;/etc/systemd/system/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">debug&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">var=ansible_default_ipv4.address&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">untar to /usr/bin&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">unarchive&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ tar_src }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dest&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ tar_dest }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">download and untar prometheus tarball&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">downloaded&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">unarchive&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ prometheus_tarball_url }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dest&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ prometheus_install_path }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">copy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">no&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">copy service file&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">copy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ service_src }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dest&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ service_dest }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ensure node_export is ebalbe and running&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">systemd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">postgres_exporter&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">enabled&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">daemon_reload&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">started&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>tcp性能调优</title><link>https://tab.deoops.com/posts/tcp-tune/</link><pubDate>Tue, 05 Apr 2016 18:58:52 +0800</pubDate><guid>https://tab.deoops.com/posts/tcp-tune/</guid><description>&lt;img src="https://tab.deoops.com/posts/tcp-tune/sysctl.jpeg" alt="Featured image of post tcp性能调优" />&lt;p>我们一般会调整内核tcp参数以提高web服务器(比如ngin)的性能。&lt;/p>
&lt;h2 id="sysctl">sysctl&lt;/h2>
&lt;p>加载Linux 内核配置&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sysctl -p /etc/sysctl.d/xxx-xxx.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="meat">meat&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># /etc/sysctl.d/00-network.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Receive Queue Size per CPU Core, number of packets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Example server: 8 cores&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.core.netdev_max_backlog &lt;span class="o">=&lt;/span> &lt;span class="m">4096&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># SYN Backlog Queue, number of half-open connections&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_max_syn_backlog &lt;span class="o">=&lt;/span> &lt;span class="m">32768&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Accept Queue Limit, maximum number of established&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># connections waiting for accept() per listener.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.core.somaxconn &lt;span class="o">=&lt;/span> &lt;span class="m">65535&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Maximum number of SYN and SYN+ACK retries before&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># packet expires.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_syn_retries &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_synack_retries &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Timeout in seconds to close client connections in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># TIME_WAIT after receiving FIN packet.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_fin_timeout &lt;span class="o">=&lt;/span> &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Disable SYN cookie flood protection&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_syncookies &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Maximum number of threads system can have, total.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Commented, may not be needed. See user limits.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#kernel.threads-max = 3261780&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Maximum number of file descriptors system can have, total.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Commented, may not be needed. See user limits.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#fs.file-max = 3261780&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>再见scripttogr👋</title><link>https://tab.deoops.com/posts/blog-scripttogr/</link><pubDate>Mon, 13 Jul 2015 19:29:06 +0800</pubDate><guid>https://tab.deoops.com/posts/blog-scripttogr/</guid><description>&lt;img src="https://tab.deoops.com/posts/blog-scripttogr/scriptogr.png" alt="Featured image of post 再见scripttogr👋" />&lt;p>很久以前有幸遇到一款很干净简洁 blog saas产品，可以通过email和dropbox写/备份文章。&lt;/p>
&lt;p>今天发现&lt;a class="link" href="https://scriptogr.am/" target="_blank" rel="noopener"
>scripttogr&lt;/a> 已经关闭不运营了。&lt;/p>
&lt;p>可惜了。&lt;/p>
&lt;p>好的产品不一定能活下去，可惜了。&lt;/p></description></item><item><title>脚本注入</title><link>https://tab.deoops.com/posts/opkg-inject/</link><pubDate>Thu, 18 Jun 2015 13:32:58 +0800</pubDate><guid>https://tab.deoops.com/posts/opkg-inject/</guid><description>&lt;img src="https://tab.deoops.com/posts/opkg-inject/opkg.png" alt="Featured image of post 脚本注入" />&lt;p>使用opkg安装软件时，常常需要对候软件包进行初始化或者自定义化操作，这种开发需求一般写给shell脚本就可以对付了。
现在的问题是当这些脚本多了之后，原作者也不愿意修改安装包，我们怎么分发这些自定义的脚本，能不能把自定义的这些脚本编译到opkg包里？&lt;/p>
&lt;h2 id="位置">位置&lt;/h2>
&lt;p>把本地的shell脚本放在openwert 仓库的这个目录，编译openwrt的时候就会被打包到对应opkg二进制文件中：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/barrier_breaker/package/package-abc &lt;span class="c1"># package makefile文件所在&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">package-abc/files &lt;span class="c1"># shell脚本放置目录&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="步骤">步骤&lt;/h2>
&lt;ol>
&lt;li>修改Makefile&lt;/li>
&lt;/ol>
&lt;p>在&lt;code>package&lt;/code>目录下任意找一个package目录，比如&lt;code>chinadns&lt;/code>,
然后修改Makefile文件。
在install语句后添加 :&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="k">$(&lt;/span>INSTALL_BIN&lt;span class="k">)&lt;/span> ./files/your_script.sh &lt;span class="k">$(&lt;/span>1&lt;span class="k">)&lt;/span>/etc/config/your_script.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>
&lt;p>放置脚本
将脚本your_script.sh放置在files目录下；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>选择opkg
在make menuconfig 图像界面中选择修改过的包（chinadns）&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="附">附&lt;/h2>
&lt;p>package 和注入文件相关的部分&lt;code>makefile&lt;/code>代码:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="line">&lt;span class="cl">&lt;span class="c">##
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span> include &lt;span class="k">$(&lt;/span>TOPDIR&lt;span class="k">)&lt;/span>/rules.mk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PKG_NAME:&lt;span class="o">=&lt;/span>xxx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PKG_RELEASE:&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PKG_SOURCE:&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>PKG_NAME&lt;span class="k">)&lt;/span>-&lt;span class="k">$(&lt;/span>PKG_VERSION&lt;span class="k">)&lt;/span>.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PKG_SOURCE_URL:&lt;span class="o">=&lt;/span>https://github.com/xxx/releases/download/v&lt;span class="k">$(&lt;/span>PKG_VERSION&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PKG_MD5SUM:&lt;span class="o">=&lt;/span>f772a750580243cfxcsfd2xc39d7b9171b1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PKG_BUILD_DIR:&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>BUILD_DIR&lt;span class="k">)&lt;/span>/&lt;span class="k">$(&lt;/span>PKG_NAME&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> include &lt;span class="k">$(&lt;/span>INCLUDE_DIR&lt;span class="k">)&lt;/span>/package.mk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">##
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> define Package/xxx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> SECTION:&lt;span class="o">=&lt;/span>net
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CATEGORY:&lt;span class="o">=&lt;/span>Network
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> TITLE:&lt;span class="o">=&lt;/span>xxx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> endef
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">###
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> define Package/xxx/description
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> button haha upgrade.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> endef
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">###
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#define Package/xxx/conffiles&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#/etc/config/system&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#/etc/hotplug.d/button/00-button&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#endef&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">###
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> define Package/wps_button/install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#$(INSTALL_DIR) $(1)/etc/init.d&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">$(&lt;/span>INSTALL_BIN&lt;span class="k">)&lt;/span> ./files/xxx &lt;span class="k">$(&lt;/span>1&lt;span class="k">)&lt;/span>/etc/config/xxx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#$(INSTALL_DATA) ./files/system.conf $(1)/etc/config/system&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> endef
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">###
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">$(&lt;/span>&lt;span class="nb">eval&lt;/span> &lt;span class="k">$(&lt;/span>call BuildPackage,xxx&lt;span class="k">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">##
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>字符串</title><link>https://tab.deoops.com/posts/shell-string/</link><pubDate>Sun, 17 May 2015 15:11:27 +0800</pubDate><guid>https://tab.deoops.com/posts/shell-string/</guid><description>&lt;img src="https://tab.deoops.com/posts/shell-string/comma-seperator.png" alt="Featured image of post 字符串" />&lt;p>运维人员/系统管理员每天要在终端敲入大量命令，也要修改查看大量文本配置文件，日志信息。
甚至可以夸张一点说Linux/Unix system admin的全部工作就是和字符串打交道。&lt;/p>
&lt;h2 id="binary">binary&lt;/h2>
&lt;p>大家都知道文本文件是字符串组成的，其实二进制文件里面其实也包含了很多字符串：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">➜ infra-api git:&lt;span class="o">(&lt;/span>dev&lt;span class="o">)&lt;/span> file infra-api
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">infra-api: Mach-O 64-bit executable x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ infra-api git:&lt;span class="o">(&lt;/span>dev&lt;span class="o">)&lt;/span> strings infra-api &lt;span class="p">|&lt;/span> head
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">flag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">hash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mime
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">path
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sort
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sync
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">*int
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">AAAA
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Addr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ infra-api git:&lt;span class="o">(&lt;/span>dev&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="命令">命令&lt;/h2>
&lt;p>收集一些常用的shell 字符串操作命令&lt;/p>
&lt;h3 id="cut">cut&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">❯ tldr cut
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Cut out fields from stdin or files.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> More information: https://www.gnu.org/software/coreutils/cut.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Cut out the first sixteen characters of each line of stdin:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cut -c 1-16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Cut out the first sixteen characters of each line of the given files:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cut -c 1-16 file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Cut out everything from the 3rd character to the end of each line:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cut -c 3-
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Cut out the fifth field of each line, using a colon as a field delimiter &lt;span class="o">(&lt;/span>default delimiter is tab&lt;span class="o">)&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cut -d&lt;span class="s1">&amp;#39;:&amp;#39;&lt;/span> -f5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Cut out the 2nd and 10th fields of each line, using a semicolon as a delimiter:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cut -d&lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span> -f2,10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - Cut out the fields &lt;span class="m">3&lt;/span> through to the end of each line, using a space as a delimiter:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cut -d&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span> -f3-
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="catless">cat/less&lt;/h3>
&lt;p>cat，主要有三大使用场景：&lt;/p>
&lt;p>一次显示整个文件 &lt;code>cat filename&lt;/code>;
从标准输入流（键盘）新建一个文件。&lt;code>cat &amp;gt; filename&lt;/code>;
将几个文件合并为一个文件： &lt;code>cat file1 file2 &amp;gt; file&lt;/code>。
参数：
-n 或 &amp;ndash;number 由 1 开始对所有输出的行数编号
-b 或 &amp;ndash;number-nonblank 和 -n 相似，只不过对于空白行不编号
-s 或 &amp;ndash;squeeze-blank 当遇到有连续两行以上的空白行，就代换为一行的空白行
-v 或 &amp;ndash;show-nonprinting
例：&lt;/p>
&lt;ol>
&lt;li>把 textfile1 的档案内容加上行号后输入 textfile2 这个档案里&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">cat -n textfile1 &amp;gt; textfile2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>把 textfile1 和 textfile2 的档案内容加上行号（空白行不加）之后将内容附加到 textfile3 里。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">cat -b textfile1 textfile2 &amp;gt;&amp;gt; textfile3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>清空test.txt&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">cat /dev/null &amp;gt; /etc/test.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>另外，本文读取文件的操作可用less命令替代，less命令速度会更快些&lt;/strong>&lt;/p>
&lt;h3 id="awk">awk&lt;/h3>
&lt;p>awk可以算独立的一门编程语言，举两个例子：&lt;/p>
&lt;ol>
&lt;li>截取路由器MAC地址后四位&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="k">$(&lt;/span>cat /sys/class/ieee80211/&lt;span class="si">${&lt;/span>&lt;span class="nv">dev&lt;/span>&lt;span class="si">}&lt;/span>/macaddress&lt;span class="k">)&lt;/span> &lt;span class="p">|&lt;/span> awk -F &lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span> &lt;span class="s1">&amp;#39;{ print $5&amp;#34;&amp;#34;$6 }&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> tr a-z A-Z
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> sd:3s:xf:0h:w4:n8 &lt;span class="p">|&lt;/span> awk -F &lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span> &lt;span class="s1">&amp;#39;{ print $5&amp;#34;&amp;#34;$6 }&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> tr a-z A-Z
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">W4N8
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>对某一列求和&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">awk -F&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;{sum+=$2;} END{print sum;}&amp;#39;&lt;/span> file.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="运行方式">运行方式&lt;/h4>
&lt;ol>
&lt;li>命令行方式&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">awk &lt;span class="o">[&lt;/span>-F field-separator&lt;span class="o">]&lt;/span> &lt;span class="s1">&amp;#39;commands&amp;#39;&lt;/span> input-file&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中，commands 是awk命令，[-F域分隔符]是可选的。 input-file(s) 是待处理的文件。
在awk中，文件的每一行中，由域分隔符分开的每一项称为一个域。通常，在不指名-F域分隔符的情况下，默认的域分隔符是空格。&lt;/p>
&lt;ol start="2">
&lt;li>
&lt;p>脚本方式
将所有的awk指令写入一个文件，并使awk程序可执行，然后把awk解释器作为脚本的首行，即可运行awk脚本。
把脚本首行（magic bang）：&lt;code>#!/bin/sh&lt;/code> 换成： &lt;code>#!/bin/awk&lt;/code> 即可，以 &lt;code>which awk&lt;/code> 的输出为准。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>将所有的awk命令插入一个单独文件，然后调用：&lt;/p>
&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">awk -f awk-script-file input-file&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中，-f选项加载awk-script-file中的awk脚本，input-file(s)跟上面的是一样的。&lt;/p>
&lt;h3 id="tr">tr&lt;/h3>
&lt;p>tr 命令从标准输入删除或替换字符，并将结果写入标准输出。根据由 String1 和 String2 变量指定的字符串以及指定的标志，tr 命令可执行三种操作。&lt;/p>
&lt;p>本文使用了简单的&lt;strong>替换&lt;/strong>操作。&lt;em>小写字母转为大写字母。&lt;/em>&lt;/p></description></item><item><title>增加固件大小</title><link>https://tab.deoops.com/posts/firmware-size/</link><pubDate>Thu, 07 May 2015 11:45:48 +0800</pubDate><guid>https://tab.deoops.com/posts/firmware-size/</guid><description>&lt;img src="https://tab.deoops.com/posts/firmware-size/wr703n.jpeg" alt="Featured image of post 增加固件大小" />&lt;p>很多路由器的flash容量只有4m大，所以绝大多数openwrt固件也是4m大小。
当我们手动改造路由器加大flash容量后，可以调整openwrt默认设置使得编译出来的factory可以有8m的大小，
从而安装更多的内置软件。&lt;/p>
&lt;p>本文以wr703n路由器 为例子，简单介绍一下如何加大固件的容量，让我们预安装更多内置软件。&lt;/p>
&lt;h3 id="查看">查看&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ./tools/firmware-utils/src/mktplinkfw.c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fw_max_len为0xfc0000，16M flash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fw_max_len为0x7c0000，8M flash
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="修改">修改&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ./target/linux/ar71xx/image/Makefile
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 将703n的4Mlzma改为8Mlzma或16Mlzma
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span> &lt;span class="k">$(&lt;/span>&lt;span class="nb">eval&lt;/span> &lt;span class="k">$(&lt;/span>call SingleProfile,TPLINK-LZMA,&lt;span class="k">$(&lt;/span>fs_64kraw&lt;span class="k">)&lt;/span>,TLWR703,tl-wr703n-v1,TL-WR703N,ttyATH0,115200,0x07030101,1,8Mlzma&lt;span class="k">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>刷机HG255d</title><link>https://tab.deoops.com/posts/router-hg255d/</link><pubDate>Tue, 17 Mar 2015 09:09:58 +0800</pubDate><guid>https://tab.deoops.com/posts/router-hg255d/</guid><description>&lt;img src="https://tab.deoops.com/posts/router-hg255d/hg255d.jpg" alt="Featured image of post 刷机HG255d" />&lt;h2 id="交叉编译">交叉编译&lt;/h2>
&lt;ol>
&lt;li>在ubuntu下安装编译工具（gcc,xmllib,cmake, git 等)；&lt;/li>
&lt;li>git克隆openwrt仓库：&lt;code>git clone git://git.openwrt.org/14.07/openwrt.git&lt;/code>；&lt;/li>
&lt;li>自定义kernel target：&lt;/li>
&lt;/ol>
&lt;p>源代码做&lt;a class="link" href="http://my.oschina.net/osbin/blog/278782" target="_blank" rel="noopener"
>两处修改&lt;/a> :&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">target/linux/ramips/image/Makefile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/base-files/lib/ramips.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">target/linux/ramips/base-files/lib/preinit/06_set_iface_mac
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>在弹出的make menuconfig 图像界面中选择cpu型号；&lt;/li>
&lt;li>打开vpn开始编译固件。&lt;/li>
&lt;/ol>
&lt;h2 id="结果">结果&lt;/h2>
&lt;p>交叉编译完成后，根据上一步选择的安装包的多少，bin目录下会生成对应的opkg包，和固件：&lt;/p>
&lt;ol>
&lt;li>factory文件，可以称作底包；&lt;/li>
&lt;li>sysupgrade文件，可以称作升级包；&lt;/li>
&lt;/ol>
&lt;h3 id="webuboot烧录刷机">web/uboot烧录刷机&lt;/h3>
&lt;ol>
&lt;li>接通路由器电源，按住WPS按钮不放，然后按电源键开机， power LED快闪即松开WPS键，此时路由器已加入升级模式；&lt;/li>
&lt;li>访问路由器web地址（如：http://192.168.1.1), 按照web界面提示选取factory文件完成固件烧录刷机；&lt;/li>
&lt;/ol>
&lt;h3 id="sshftp-烧录">ssh/ftp 烧录&lt;/h3>
&lt;p>可以直接执行&lt;code>sysupgrade&lt;/code>命令烧录估计：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ssh-keygen -f &lt;span class="s2">&amp;#34;/home/openwrt-qqm/.ssh/known_hosts&amp;#34;&lt;/span> -R 192.168.1.1 &lt;span class="c1">#可以省略此条命令 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scp xxxxxx-squashfs-sysupgrade.bin root@192.168.1.1:/tmp/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssh root@192.168.1.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sysupgrade -n xxxxxxxxxxx-sysupgrade.bin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="opkg">opkg&lt;/h3>
&lt;p>烧录完系统固件后，可以使用&lt;code>opkg&lt;/code>安装软件包，比如&lt;code>china-dns&lt;/code>, &lt;code>shadowsocks&lt;/code>, &lt;code>openvpn&lt;/code>，等等。&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 100;
flex-basis: 240px"
>
&lt;a href="https://tab.deoops.com/posts/router-hg255d/hg255d.jpg" data-size="310x310">
&lt;img src="https://tab.deoops.com/posts/router-hg255d/hg255d.jpg"
width="310"
height="310"
srcset="https://tab.deoops.com/posts/router-hg255d/hg255d_hu95abe093e5988d14ccd200bc31cd3495_35267_480x0_resize_q75_box.jpg 480w, https://tab.deoops.com/posts/router-hg255d/hg255d_hu95abe093e5988d14ccd200bc31cd3495_35267_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
alt="hg255d router">
&lt;/a>
&lt;figcaption>hg255d router&lt;/figcaption>
&lt;/figure>&lt;/p></description></item><item><title>Google Domain</title><link>https://tab.deoops.com/posts/google-domain/</link><pubDate>Tue, 17 Jun 2014 14:22:06 +0800</pubDate><guid>https://tab.deoops.com/posts/google-domain/</guid><description>&lt;img src="https://tab.deoops.com/posts/google-domain/google-domain.png" alt="Featured image of post Google Domain" />&lt;p>刚刚在google+上看到google 推出了自己的域名注册服务，截两张图，纪念下。&lt;/p>
&lt;p>google推广自己的 &lt;strong>&lt;a class="link" href="https://com.google/" target="_blank" rel="noopener"
>com.google 域名注册托管服务&lt;/a>&lt;/strong>，把首页变成了镜像模式
&lt;figure
class="gallery-image"
style="
flex-grow: 195;
flex-basis: 469px"
>
&lt;a href="https://tab.deoops.com/posts/google-domain/google-domain.png" data-size="1100x562">
&lt;img src="https://tab.deoops.com/posts/google-domain/google-domain.png"
width="1100"
height="562"
srcset="https://tab.deoops.com/posts/google-domain/google-domain_hu8addcdeb3c155fbae74eb60aed2e0ca1_53610_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/google-domain/google-domain_hu8addcdeb3c155fbae74eb60aed2e0ca1_53610_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="google domain">
&lt;/a>
&lt;figcaption>google domain&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>搜索正常，不过搜索结果也使用了镜像效果：
&lt;figure
>
&lt;a href="https://tab.deoops.com/non.png" >
&lt;img src="https://tab.deoops.com/non.png"
loading="lazy"
alt="serach page">
&lt;/a>
&lt;figcaption>serach page&lt;/figcaption>
&lt;/figure>&lt;/p></description></item><item><title>歪楼</title><link>https://tab.deoops.com/posts/wai-lou/</link><pubDate>Mon, 12 May 2014 16:05:52 +0800</pubDate><guid>https://tab.deoops.com/posts/wai-lou/</guid><description>&lt;img src="https://tab.deoops.com/posts/wai-lou/wl.jpeg" alt="Featured image of post 歪楼" />&lt;p>从Firefox的查看元素&amp;gt;查看器入手，发现有搞头。然后又谷歌查阅了些资料，发现我想的方法对firefox浏览器的依赖性太强，最多也就能做成firefox的一个插件。&lt;/p>
&lt;p>简要记下我原来的思路：&lt;/p>
&lt;p>html源文档，用word打开的话，就可以自动去除所有的&lt;code>&amp;lt;tag&amp;gt;&lt;/code>，当然也可以用&lt;code>perl&lt;/code>写些正则表达式，所以搞到html源文档就有搞头。&lt;/p>
&lt;p>百度文库啊，豆丁啊，刀客88啊，什么的，表面上好像把源文档藏的好好的，但是只要用firefox查看下元素，他们就怂了，穿什么色的内裤都看的一清二楚。&lt;/p>
&lt;p>然后，成也萧何败也萧何，不想太依赖firefox。&lt;/p>
&lt;p>所以，作罢。&lt;/p>
&lt;p>不过也有些小收获，可以做些小的恶作剧。&lt;/p>
&lt;p>比如下图一，和下图二的恶作剧：&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 135;
flex-basis: 324px"
>
&lt;a href="https://tab.deoops.com/posts/wai-lou/quiz.jpeg" data-size="1188x880">
&lt;img src="https://tab.deoops.com/posts/wai-lou/quiz.jpeg"
width="1188"
height="880"
srcset="https://tab.deoops.com/posts/wai-lou/quiz_hu5bbe4659923f69bd65fdecb2cc7ea928_317155_480x0_resize_q75_box.jpeg 480w, https://tab.deoops.com/posts/wai-lou/quiz_hu5bbe4659923f69bd65fdecb2cc7ea928_317155_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
alt="quiz">
&lt;/a>
&lt;figcaption>quiz&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>（图一，恶搞的是百度文库的每个考试试卷文档，还不算太歪）&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 143;
flex-basis: 345px"
>
&lt;a href="https://tab.deoops.com/posts/wai-lou/weibo.png" data-size="1315x914">
&lt;img src="https://tab.deoops.com/posts/wai-lou/weibo.png"
width="1315"
height="914"
srcset="https://tab.deoops.com/posts/wai-lou/weibo_hu4e5c67c3889d5730d2eb73405719769d_344356_480x0_resize_box_3.png 480w, https://tab.deoops.com/posts/wai-lou/weibo_hu4e5c67c3889d5730d2eb73405719769d_344356_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="weibo">
&lt;/a>
&lt;figcaption>weibo&lt;/figcaption>
&lt;/figure>
（图二，恶搞的是文章。。。~~话说人家劈人家的腿与你何干？ ~~话说我没有节操又与他们劈不劈腿何干？）&lt;/p></description></item><item><title>雨好大</title><link>https://tab.deoops.com/posts/da-yu/</link><pubDate>Sat, 10 May 2014 16:21:02 +0800</pubDate><guid>https://tab.deoops.com/posts/da-yu/</guid><description>&lt;img src="https://tab.deoops.com/posts/da-yu/rain.jpeg" alt="Featured image of post 雨好大" />&lt;p>接连下了一周的雨，早上醒来的时候感觉被子有点潮潮的。&lt;/p>
&lt;p>听着外面的雨声，思索着要不要起床，忽然意识到明天要上班，于是又蒙头睡过。&lt;/p>
&lt;p>又过了会，醒了，起床洗漱，刷牙的时候我喜欢听歌，洗脸的时候也喜欢听歌，洗澡的时候也是，还有洗头的时候。&lt;/p>
&lt;p>感觉昨天晚餐还没有消化完全，所以就不急着吃早餐。四处晃了晃，下雨感觉干什么都没劲，打开电脑，然后是google.com.hk&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 258;
flex-basis: 620px"
>
&lt;a href="https://tab.deoops.com/posts/da-yu/google.jpeg" data-size="491x190">
&lt;img src="https://tab.deoops.com/posts/da-yu/google.jpeg"
width="491"
height="190"
srcset="https://tab.deoops.com/posts/da-yu/google_hu2c86cfb65dd94ae6e174cce48badd167_30476_480x0_resize_q75_box.jpeg 480w, https://tab.deoops.com/posts/da-yu/google_hu2c86cfb65dd94ae6e174cce48badd167_30476_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
alt="google doodles">
&lt;/a>
&lt;figcaption>google doodles&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>哦，今天是母亲节啊。
思绪一下子被打开了好大个缺口，好多情感向我袭来，&lt;/p>
&lt;p>眼看我就要被种种幸福的、委屈的、亲切的、美好的、懊悔的、恋恋不舍的，等等，回忆包围，&lt;/p>
&lt;p>毕业一年多，漂泊在外的我突然发现我好无助，然后不知道为啥，这些回忆就突然间模糊烟消云散了。&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 150;
flex-basis: 360px"
>
&lt;a href="https://tab.deoops.com/posts/da-yu/child.jpeg" data-size="510x340">
&lt;img src="https://tab.deoops.com/posts/da-yu/child.jpeg"
width="510"
height="340"
srcset="https://tab.deoops.com/posts/da-yu/child_hu63e49afffa9d0e6c669a2e1b584d896f_16050_480x0_resize_q75_box.jpeg 480w, https://tab.deoops.com/posts/da-yu/child_hu63e49afffa9d0e6c669a2e1b584d896f_16050_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
alt="child">
&lt;/a>
&lt;figcaption>child&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>慢慢来吧，生活总会是想要的那样的。&lt;/p>
&lt;p>下楼买早点去了，话说这把伞有点小了吧。&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 133;
flex-basis: 319px"
>
&lt;a href="https://tab.deoops.com/posts/da-yu/umbrella.jpeg" data-size="205x154">
&lt;img src="https://tab.deoops.com/posts/da-yu/umbrella.jpeg"
width="205"
height="154"
srcset="https://tab.deoops.com/posts/da-yu/umbrella_huf7225b652dd15c5d6820a7be494daf60_5347_480x0_resize_q75_box.jpeg 480w, https://tab.deoops.com/posts/da-yu/umbrella_huf7225b652dd15c5d6820a7be494daf60_5347_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
alt="umbrella">
&lt;/a>
&lt;figcaption>umbrella&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>撑着伞在雨里走着，想起刚来这工作的时候，和某个人一起打伞，还给了她50块钱，现在还没还给我。&lt;/p>
&lt;p>Anyway ，HAPPY MOTHER&amp;rsquo;S DAY!
&lt;figure
class="gallery-image"
style="
flex-grow: 150;
flex-basis: 360px"
>
&lt;a href="https://tab.deoops.com/posts/da-yu/mother.jpeg" data-size="1600x1066">
&lt;img src="https://tab.deoops.com/posts/da-yu/mother.jpeg"
width="1600"
height="1066"
srcset="https://tab.deoops.com/posts/da-yu/mother_hu28623d733cda5e9e327544394c637f2c_217058_480x0_resize_q75_box.jpeg 480w, https://tab.deoops.com/posts/da-yu/mother_hu28623d733cda5e9e327544394c637f2c_217058_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
alt="mother">
&lt;/a>
&lt;figcaption>mother&lt;/figcaption>
&lt;/figure>&lt;/p></description></item><item><title>谢谢vpngate</title><link>https://tab.deoops.com/posts/try-vpngate/</link><pubDate>Fri, 09 May 2014 16:39:24 +0800</pubDate><guid>https://tab.deoops.com/posts/try-vpngate/</guid><description>&lt;img src="https://tab.deoops.com/posts/try-vpngate/vpngate.jpeg" alt="Featured image of post 谢谢vpngate" />&lt;p>在天朝呆久了，有点迫害妄想症。用&lt;a class="link" href="https://www.vpngate.net" target="_blank" rel="noopener"
>vpngate&lt;/a>出来转转看看，发现确实是我想多了。&lt;/p>
&lt;p>anyway，谢谢vpngate，挺不错的vpn。&lt;/p></description></item><item><title>第七章FLOW3d铸造模具热循环分析</title><link>https://tab.deoops.com/posts/flow-3d/</link><pubDate>Thu, 08 May 2014 16:34:49 +0800</pubDate><guid>https://tab.deoops.com/posts/flow-3d/</guid><description>&lt;img src="https://tab.deoops.com/posts/flow-3d/software_flow_science.jpeg" alt="Featured image of post 第七章FLOW3d铸造模具热循环分析" />&lt;p>文章已丢失 :(&lt;/p></description></item><item><title>想写个cms</title><link>https://tab.deoops.com/posts/rails-cms/</link><pubDate>Mon, 23 Dec 2013 13:28:34 +0800</pubDate><guid>https://tab.deoops.com/posts/rails-cms/</guid><description>&lt;img src="https://tab.deoops.com/posts/rails-cms/ror.jpeg" alt="Featured image of post 想写个cms" />&lt;p>&lt;code>updated at 2014/2/16 坑太大，挑战太多，挑战失败，放弃啦 :)&lt;/code>&lt;/p>
&lt;p>看完Ruby On Rails tutorial，感觉热血沸腾。
来吧，少年，来写个CMS吧。&lt;/p>
&lt;h2 id="model">model&lt;/h2>
&lt;p>数据库设计&lt;/p>
&lt;h3 id="generate">generate&lt;/h3>
&lt;p>生成model schema数据模型：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rails g model App &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>title:string icon:binary descript:text &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>get_url:string hits:integer downloaded:integer score:decimal &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>version:string require_os_version:string author:references
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rails g model Author name:string descript:text website:string
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="populate">populate&lt;/h3>
&lt;p>填充假数据，便于测试。
&lt;a class="link" href="https://github.com/stympy/faker" target="_blank" rel="noopener"
>faker gem&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#db/seed.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">30&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">times&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ne&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Faker&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">App&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">author&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Faker&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Lorem&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">paragraph&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">we&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Faker&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Internet&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">url&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">Author&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">create!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">ne&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">descript&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">dt&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">website&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">we&lt;/span> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">users&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Author&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">order&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:created_at&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">take&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">17&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">50&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">times&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">users&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">each&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">u&lt;/span>&lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">te&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Faker&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">App&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Faker&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Hacker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">say_something_smart&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gu&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Faker&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Internet&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">url&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Faker&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Number&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">number&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Faker&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Number&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">number&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">se&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Faker&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Commerce&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">price&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">vn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">Faker&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">App&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">version&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;android 1.6+ | ios 6.0+&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">u&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">apps&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">create!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">icon&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kp">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">title&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">te&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">descript&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">dt&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">get_url&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">gu&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">hits&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">hs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">downloaded&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">dd&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">score&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">se&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">version&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">vn&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ss">require_os_version&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">rn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="数据录入">数据录入&lt;/h3>
&lt;ol>
&lt;li>手动/人工录入
form表单&lt;/li>
&lt;li>机器抓取
&lt;a class="link" href="https://github.com/sparklemotion/nokogiri" target="_blank" rel="noopener"
>nokogiri gem&lt;/a>&lt;/li>
&lt;/ol>
&lt;h2 id="uistatic_pages_controller">UI/static_pages_controller&lt;/h2>
&lt;h3 id="controller">controller&lt;/h3>
&lt;p>新建controller&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rails g controller StaticPages index
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rails g controller Apps update destroy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#destroy widget&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rails d controller widgets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rails d model Widget
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="scss">scss&lt;/h3>
&lt;p>调整scss&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-gemfile" data-lang="gemfile"># 修改gemfile
gem &amp;#39;bootstrap-will_paginate&amp;#39;
gem &amp;#39;will_paginate&amp;#39;
gem &amp;#39;bootstrap-sass&amp;#39;
&lt;/code>&lt;/pre>&lt;p>rename scss文件&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mv path/to/application.css path/to/application.scss
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-scss" data-lang="scss">&lt;span class="line">&lt;span class="cl">&lt;span class="k">@import&lt;/span> &lt;span class="s2">&amp;#34;bootstrap-sprockets&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">@import&lt;/span> &lt;span class="s2">&amp;#34;bootstrap&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/* mixins, variables, etc. */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$gray-medium-light&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mh">#eaeaea&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">@mixin&lt;/span>&lt;span class="nf"> box_sizing&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">-moz-box-sizing&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="ni">border-box&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">-webkit-box-sizing&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="ni">border-box&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">box-sizing&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="ni">border-box&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* universal */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">html&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">overflow-y&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="ni">scroll&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">body&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">padding-top&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">60&lt;/span>&lt;span class="kt">px&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* ....... */&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="erb">erb&lt;/h3>
&lt;p>添加title自定义支持&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># application.html.erb添加&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">title&lt;/span>&lt;span class="o">&amp;gt;&amp;lt;&lt;/span>&lt;span class="s">%= full_title(yield(:title)) %&amp;gt;&amp;lt;/title&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"># static_pages_helper.rb添加
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">def full_title(page_title =&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">base_title&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;LOL&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">page_title&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">empty?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">base_title&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">page_title&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> | &lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="n">base_title&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="action">action&lt;/h3>
&lt;p>编辑index action&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># static_pages_controller.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">index&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="no">App&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">per_page&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="vi">@apps&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">App&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">paginate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">page&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="ss">:page&lt;/span>&lt;span class="o">]&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># views/static_pages/insex.html.erb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="sx">% provide(:title, &lt;/span> &lt;span class="s2">&amp;#34;All apps&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="s">%&amp;gt; # 页面标题
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">&amp;lt;%= render @apps %&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="s">%= will_paginate @apps %&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"># views/apps/_app.html.erb
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">&amp;lt;span&amp;gt; &amp;lt;%=&lt;/span> &lt;span class="n">app&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">title&lt;/span> &lt;span class="s">%&amp;gt; * * &amp;lt;/span&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>连接数据库</title><link>https://tab.deoops.com/posts/rails-pg/</link><pubDate>Thu, 07 Nov 2013 10:06:54 +0800</pubDate><guid>https://tab.deoops.com/posts/rails-pg/</guid><description>&lt;img src="https://tab.deoops.com/posts/rails-pg/rails-pg.png" alt="Featured image of post 连接数据库" />&lt;p>跟着rails tutorial 学习rails框架时，遇到了db链接的问题&lt;/p>
&lt;h3 id="问题">问题&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rake db:create failed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PG::ConnectionBad: could not connect to server: No such file or directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Is the server running locally and accepting
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> connections on Unix domain socket &lt;span class="s2">&amp;#34;/var/pgsql_socket/.s.PGSQL.5432&amp;#34;&lt;/span>?
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Google之后发现是database.yml配置文件没有加上&lt;code>host：localhost&lt;/code>配置项。&lt;/p>
&lt;p>过一会，发现PATH没有包含psql命令。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">vi ~/.bash_profile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#添加下面一行内容&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/Applications/Postgres.app/Contents/Versions/9.4/bin:&lt;/span>&lt;span class="nv">$PATH&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## or&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/Applications/Postgres.app/Contents/Versions/9.4/bin:&lt;/span>&lt;span class="nv">$PATH&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &amp;gt;&amp;gt; ~/.zshrc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>终于&lt;code>rake db:migrate&lt;/code> 成功。&lt;/p>
&lt;h3 id="附录">附录&lt;/h3>
&lt;p>附上database.yml（production环境使用heroku环境变量)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cp">&amp;amp;default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">adapter&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">postgresql&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">encoding&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">unicode&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># For details on connection pooling, see rails configuration guide&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># http://guides.rubyonrails.org/configuring.html#database-pooling&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pool&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">5&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">development&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">&amp;lt;&amp;lt;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cp">*default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">database&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">xxx_development&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">test&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">&amp;lt;&amp;lt;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cp">*default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">database&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">xxx_test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">production&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">&amp;lt;&amp;lt;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cp">*default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">database&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">xxx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">username&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">xxx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">password&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">&amp;lt;%= ENV[&amp;#39;xxx_xxx_PASSWORD&amp;#39;] %&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>