<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="kubelet提供lifecyle handler hook给用户，用户提供Liveness/Readniess probe给kubelet"><title>Pod生命周期和Liveness的区别</title><link rel=canonical href=https://tab.deoops.com/posts/pod-life-live/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Pod生命周期和Liveness的区别"><meta property="og:description" content="kubelet提供lifecyle handler hook给用户，用户提供Liveness/Readniess probe给kubelet"><meta property="og:url" content="https://tab.deoops.com/posts/pod-life-live/"><meta property="og:site_name" content="鬼画桃符"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="pod"><meta property="article:tag" content="k8s"><meta property="article:published_time" content="2018-09-18T23:33:25+08:00"><meta property="article:modified_time" content="2018-09-18T23:33:25+08:00"><meta property="og:image" content="https://tab.deoops.com/posts/pod-life-live/hook.gif"><meta name=twitter:title content="Pod生命周期和Liveness的区别"><meta name=twitter:description content="kubelet提供lifecyle handler hook给用户，用户提供Liveness/Readniess probe给kubelet"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tab.deoops.com/posts/pod-life-live/hook.gif"></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>返回</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/pod-life-live/><img src=/posts/pod-life-live/hook_hu272076145e79d12d10d979ff0bdeaf35_73849_800x0_resize_box_1.gif srcset="/posts/pod-life-live/hook_hu272076145e79d12d10d979ff0bdeaf35_73849_800x0_resize_box_1.gif 800w, /posts/pod-life-live/hook_hu272076145e79d12d10d979ff0bdeaf35_73849_1600x0_resize_box_1.gif 1600w" width=800 height=552 loading=lazy alt="Featured image of post Pod生命周期和Liveness的区别"></a></div><div class=article-details><header class=article-category><a href=/categories/%E5%BC%80%E5%8F%91/ style=background-color:#2a9d8f;color:#fff>开发</a>
<a href=/categories/%E6%B5%8B%E8%AF%95/ style=background-color:#2a9d8f;color:#fff>测试</a></header><h2 class=article-title><a href=/posts/pod-life-live/>Pod生命周期和Liveness的区别</a></h2><h3 class=article-subtitle>kubelet提供lifecyle handler hook给用户，用户提供Liveness/Readniess probe给kubelet</h3><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Sep 18, 2018</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 2 分钟</time></div></footer></div></header><section class=article-content><p>今天测试给我反馈了一个pod问题，测试给出的 use case 描述如下：</p><p>配置一个nginx的web服务；</p><ol><li>在生命周期中选择http协议，端口配置80，路径配置/errorpath；</li><li>服务中pod能正常启动；</li><li>预期在pod的事件中应该有一个“FailedPostStartHook”错误信息。</li><li>测试人员发现，第4点的预期没有达到，pod 正常启动了，却没有 <code>FailedPostStarHook</code>事件出现。</li></ol><p>简单分析了一下，我发现是测试人员把pod的<code>lifecycle</code>和 pod的<code>liveness/readiness</code> 诺混淆了，从而写出了错的test case。</p><h2 id=lifecycle-handlers>Lifecycle handlers</h2><p>首先回顾下pod lifecycle的作用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl explain pod.spec.containers.lifecycle.postStart
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>RESOURCE: postStart &lt;Object&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>DESCRIPTION:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     PostStart is called immediately after a container is created. If the
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     handler fails, the container is terminated and restarted according to its
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     restart policy. Other management of the container blocks <span class=k>until</span> the hook
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     completes. More info: https://kubernetes.io/docs/concepts/containers/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     container-lifecycle-hooks/#container-hooks/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    Handler defines a specific action that should be taken
</span></span></code></pre></div><p>简单翻译下就是说， <code>kubernetes</code> 提供的pod start和exit的 lifecycle hooks 方便开发人员hooked到</p><p>下面两个生命周期：</p><ol><li>通知外部世界pod已经启动完成 (postStart)</li><li>pod优雅的退出 (preStop)</li></ol><p>ps：<code>init container</code>可以解决依赖问题，不要和postStart hooks混淆了哦。</p><h3 id=举例子>举例子</h3><p>当postStart hook的<strong>handler</strong>发送http请求到指定的port和path时， 如果exit code 不为0时，</p><p>会触发 <code>FailedPostStartHook</code> 事件，然后执行用户给定的hook/handler。</p><p>注意：lifecycle hooks不会理会http 自身的 response code健康与否，</p><p>只要<strong>handler</strong> exit code 为0 pod就会正常启动，不触发任何事件。</p><p>可以配置一个错误的端口使产生<code>FailedPostStartHook</code> event：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lifecycle90</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ng</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lifecycle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>postStart</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>  </span><span class=c>## change this to 8080 or 9090 to get the   FailedPostStartHook event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/teststart</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>preStop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/teststop</span><span class=w>
</span></span></span></code></pre></div><h3 id=相关代码>相关代码</h3><p>talk is cheap.</p><p><code>handler</code>只关心<a class=link href=https://sourcegraph.com/github.com/kubernetes/kubernetes/-/blob/pkg/kubelet/lifecycle/handlers.go?L72 target=_blank rel=noopener>getHTTPRespBody</a> 获取body的过程是否有err产生， 并不关心http respond code。</p><p><figure class=gallery-image style=flex-grow:179;flex-basis:430px><a href=/posts/pod-life-live/getBody.png data-size=1488x830><img src=/posts/pod-life-live/getBody.png width=1488 height=830 srcset="/posts/pod-life-live/getBody_hu1de47f0bc59d2d72f7f84f5247757181_215040_480x0_resize_box_3.png 480w, /posts/pod-life-live/getBody_hu1de47f0bc59d2d72f7f84f5247757181_215040_1024x0_resize_box_3.png 1024w" loading=lazy alt=getHTTPRespBody></a><figcaption>getHTTPRespBody</figcaption></figure></p><h2 id=livenessreadiness-probe>Liveness/readiness probe</h2><p>pod liveness/readiness <strong>probe</strong> 则会检查 http code 是否为 <code>2xx</code>来确定<strong>probe</strong> 是否成功。</p><h3 id=相关代码-1>相关代码</h3><p>talk is cheap.</p><p><a class=link href=https://sourcegraph.com/github.com/kubernetes/kubernetes/-/blob/pkg/kubelet/prober/prober.go?L183 target=_blank rel=noopener>runProbe</a> 调用<a class=link href=https://sourcegraph.com/github.com/kubernetes/kubernetes/-/blob/pkg/probe/http/http.go?L129 target=_blank rel=noopener>http.Probe</a>，<code>DoHTTPProbe</code>会检查http response code。</p><p><figure class=gallery-image style=flex-grow:170;flex-basis:408px><a href=/posts/pod-life-live/httpCode.png data-size=1830x1076><img src=/posts/pod-life-live/httpCode.png width=1830 height=1076 srcset="/posts/pod-life-live/httpCode_hu635bd497a36d20f21b0e9bb81ddae9bc_294012_480x0_resize_box_3.png 480w, /posts/pod-life-live/httpCode_hu635bd497a36d20f21b0e9bb81ddae9bc_294012_1024x0_resize_box_3.png 1024w" loading=lazy alt=doHTTPProbe></a><figcaption>doHTTPProbe</figcaption></figure></p><p>从源码可以清楚的看到， lifecyce 的<strong>handler</strong> 只发送了http 请求，并没有检查 http response code,
liveness/readiness 的<strong>prober</strong> 则做了http response code 的检查。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/pod/>pod</a>
<a href=/tags/k8s/>k8s</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>相关文章</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/posts/go-test/><div class=article-image><img src=/posts/go-test/ta_moderationworkflow.6a87608d9c7885970fe01d87442f4cb2_huf37469d72d7cd32aea4957f9e4060393_25339_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy data-key data-hash="md5-aodgjZx4hZcP4B2HRC9Msg=="></div><div class=article-details><h2 class=article-title>调试golang测试</h2></div></a></article><article class=has-image><a href=/posts/read-again/><div class=article-image><img src=/posts/read-again/nopcloser.51e91148fce87c446bfe48f140a9b798_hu50a7be3079bf16d477751bec8b519605_85339_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy data-key data-hash="md5-UekRSPzofERr/kjxQKm3mA=="></div><div class=article-details><h2 class=article-title>nopCloser函数</h2></div></a></article><article class=has-image><a href=/posts/explain-kubeconfig/><div class=article-image><img src=/posts/explain-kubeconfig/kubeconfig.8de483e194e9d703d6ade3fd9d8b3598_hu6b4ad2ec2bfdd2b8d356f680088de3f4_179870_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy data-key data-hash="md5-jeSD4ZTp1wPWreP9nYs1mA=="></div><div class=article-details><h2 class=article-title>细说kubeconfig</h2></div></a></article><article class=has-image><a href=/posts/k8s-certs/><div class=article-image><img src=/posts/k8s-certs/k8s.eecf4f46508db14e5515604412f82a89_hucdb5e2014b72ce09271c5c17f97648be_22078_250x150_fill_q75_h2_box_smart1_2.webp width=250 height=150 loading=lazy data-key data-hash="md5-7s9PRlCNsU5VFWBEEvgqiQ=="></div><div class=article-details><h2 class=article-title>替换k8s所有证书</h2></div></a></article><article class=has-image><a href=/posts/tx-flannel/><div class=article-image><img src=/posts/tx-flannel/flannel-vpc.70b121c6d4931e45681e621f37edafd2_hue54105a7a72eb92cf36c8a151067b0c3_60319_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy data-key data-hash="md5-cLEhxtSTHkVoHmIfN+2v0g=="></div><div class=article-details><h2 class=article-title>flannel vpc</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2006 -
2023 鬼画桃符</section><section class=powerby>豆腐炒糖</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#lifecycle-handlers>Lifecycle handlers</a><ol><li><a href=#举例子>举例子</a></li><li><a href=#相关代码>相关代码</a></li></ol></li><li><a href=#livenessreadiness-probe>Liveness/readiness probe</a><ol><li><a href=#相关代码-1>相关代码</a></li></ol></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>