<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="容器内进程HTTP GET报错"><title>证书问题</title><link rel=canonical href=https://tab.deoops.com/posts/container-ca/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="证书问题"><meta property="og:description" content="容器内进程HTTP GET报错"><meta property="og:url" content="https://tab.deoops.com/posts/container-ca/"><meta property="og:site_name" content="鬼画桃符"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="docker"><meta property="article:tag" content="certificate"><meta property="article:tag" content="https"><meta property="article:tag" content="x509"><meta property="article:published_time" content="2019-09-12T10:11:32+08:00"><meta property="article:modified_time" content="2019-09-12T10:11:32+08:00"><meta property="og:image" content="https://tab.deoops.com/posts/container-ca/common-ca.png"><meta name=twitter:title content="证书问题"><meta name=twitter:description content="容器内进程HTTP GET报错"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tab.deoops.com/posts/container-ca/common-ca.png"></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>返回</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/container-ca/><img src=/posts/container-ca/common-ca_hu249b34a0b606f672af7bc796fcfc189a_82371_800x0_resize_box_3.png srcset="/posts/container-ca/common-ca_hu249b34a0b606f672af7bc796fcfc189a_82371_800x0_resize_box_3.png 800w, /posts/container-ca/common-ca_hu249b34a0b606f672af7bc796fcfc189a_82371_1600x0_resize_box_3.png 1600w" width=800 height=285 loading=lazy alt="Featured image of post 证书问题"></a></div><div class=article-details><header class=article-category><a href=/categories/%E8%BF%90%E7%BB%B4/ style=background-color:#2a9d8f;color:#fff>运维</a>
<a href=/categories/%E7%94%9F%E6%B4%BB/ style=background-color:#2a9d8f;color:#fff>生活</a></header><h2 class=article-title><a href=/posts/container-ca/>证书问题</a></h2><h3 class=article-subtitle>容器内进程HTTP GET报错</h3><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Sep 12, 2019</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 1 分钟</time></div></footer></div></header><section class=article-content><p><code>docker run</code>调试某个container报如下所示<code>x509</code>证书错误，一开始怀疑是容器网络（<code>--network host</code>) 的问题 :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>deoops@dev-3 ~<span class=o>]</span><span class=c1># docker run  --network host  datewu/controller:v0.0.2</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;level&#34;</span>:<span class=s2>&#34;panic&#34;</span>,<span class=s2>&#34;error&#34;</span>:<span class=s2>&#34;Get https://google.com: x509: certificate signed by unknown authority&#34;</span>,<span class=s2>&#34;time&#34;</span>:1555498448,<span class=s2>&#34;message&#34;</span>:<span class=s2>&#34;get max item failed&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>panic: get max item failed
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>goroutine <span class=m>26</span> <span class=o>[</span>running<span class=o>]</span>:
</span></span><span class=line><span class=cl>github.com/rs/zerolog.<span class=o>(</span>*Logger<span class=o>)</span>.Panic.func1<span class=o>(</span>0x7773e9, 0x13<span class=o>)</span>
</span></span><span class=line><span class=cl>        /Users/deoops/go/pkg/mod/github.com/rs/zerolog@v1.13.0/log.go:307 +0x4f
</span></span><span class=line><span class=cl>github.com/rs/zerolog.<span class=o>(</span>*Event<span class=o>)</span>.msg<span class=o>(</span>0xc00012e8a0, 0x7773e9, 0x13<span class=o>)</span>
</span></span><span class=line><span class=cl>        /Users/deoops/go/pkg/mod/github.com/rs/zerolog@v1.13.0/event.go:141 +0x1c1
</span></span><span class=line><span class=cl>github.com/rs/zerolog.<span class=o>(</span>*Event<span class=o>)</span>.Msg<span class=o>(</span>...<span class=o>)</span>
</span></span><span class=line><span class=cl>        /Users/deoops/go/pkg/mod/github.com/rs/zerolog@v1.13.0/event.go:105
</span></span><span class=line><span class=cl>main.catchUp<span class=o>()</span>
</span></span><span class=line><span class=cl>        /Users/deoops/github/controller/work.go:69 +0x326
</span></span><span class=line><span class=cl>main.populate<span class=o>(</span>0xc000114000<span class=o>)</span>
</span></span><span class=line><span class=cl>        /Users/deoops/github/controller/worker.go:10 +0x26
</span></span><span class=line><span class=cl>created by main.initWork
</span></span><span class=line><span class=cl>        /Users/deoops/github/controller/work.go:84 +0x7f
</span></span></code></pre></div><p>错误信息大概是说 client 不能识别google的https 证书， 可能是base image <code>alpine</code>的问题。</p><p>将<code>base image</code>改为 <code>scratch</code> ，结果还是会报<code>x509</code>错。</p><h2 id=解决方案>解决方案</h2><p>给 <code>alpine</code>镜像 <a class=link href=https://support.circleci.com/hc/en-us/articles/360016505753-Resolve-Certificate-Signed-By-Unknown-Authority-error-in-Alpine-images target=_blank rel=noopener>加上ca-certificates</a>解决了问题:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> alpine</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># add Common CA certificates PEM files</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apk --no-cache add ca-certificates<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># ....</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># docker build -t datewu/alpine-ca .</span><span class=err>
</span></span></span></code></pre></div><p>以后用到<code>alpine</code>的Dockerfile 直接 <code>FROM datewu/alpine-ca</code> 问题解决啦😄</p><blockquote><p>总结一下：当容器里的进程访问外部tls server时，如果容器内没有配置Common CA certificates，客户端就会出现无法识别server证书的问题。</p></blockquote><p>ps:
今天在写字楼二楼快餐店吃晚饭的时候，遇到两个建筑工人，50-60岁的样子，像是夫妻。</p><p>两个人一起打才吃了10块钱：一人一个素菜，豆芽菜和黑油白。</p><p>pps：快餐店下午的汤是免费的，所以他们一人又拿了一碗汤，</p><p>回想起今天我过早才就吃了10块钱，嗟乎唏嘘。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/docker/>docker</a>
<a href=/tags/certificate/>certificate</a>
<a href=/tags/https/>https</a>
<a href=/tags/x509/>x509</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>相关文章</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/posts/vscode-eslint/><div class=article-image><img src=/posts/vscode-eslint/eslint-airbnb.2f6cfa69959d62c46e4a9dc5039f8e50_hue35271ac4524df007877384f8b1c06a2_74499_250x150_fill_q75_box_smart1.jpeg width=250 height=150 loading=lazy data-key data-hash="md5-L2z6aZWdYsRuSp3FA5+OUA=="></div><div class=article-details><h2 class=article-title>配置vscode eslint</h2></div></a></article><article class=has-image><a href=/posts/pleg-unhealth/><div class=article-image><img src=/posts/pleg-unhealth/reboot.0136e79b6a1a6300e62958c6676a14a2_hu7bd3807bcb59ca2798687ce57e12416d_147938_250x150_fill_q75_box_smart1.jpeg width=250 height=150 loading=lazy data-key data-hash="md5-ATbnm2oaYwDmKVjGZ2oUog=="></div><div class=article-details><h2 class=article-title>pod生命周期事件生成器</h2></div></a></article><article class=has-image><a href=/posts/audit-file/><div class=article-image><img src=/posts/audit-file/audit.81b9784a98bc1cccb03535bc42f7f0fb_hu9569bb820aed3f9fb44d2a8c45252134_264385_250x150_fill_q75_box_smart1.jpeg width=250 height=150 loading=lazy data-key data-hash="md5-gbl4Spi8HMywNTW8Qvfw+w=="></div><div class=article-details><h2 class=article-title>审计目录</h2></div></a></article><article class=has-image><a href=/posts/display-type-c/><div class=article-image><img src=/posts/display-type-c/physic-attack.3290fb7f3545722b1f1f052e38f35f7a_hu9224733f52b8c48201352fcf4d129bd0_19433_250x150_fill_q75_box_smart1.jpeg width=250 height=150 loading=lazy data-key data-hash="md5-MpD7fzVFcisfHwUuOPNfeg=="></div><div class=article-details><h2 class=article-title>记显示器坏了</h2></div></a></article><article class=has-image><a href=/posts/summary-of-2022/><div class=article-image><img src=/posts/summary-of-2022/abc.0bf98c0c1d32267804235515513751a1_huf65fe7975d9eacd17cf4d7a3d8ea4efd_84776_250x150_fill_q75_box_smart1.jpeg width=250 height=150 loading=lazy data-key data-hash="md5-C/mMDB0yJngEI1UVUTdRoQ=="></div><div class=article-details><h2 class=article-title>2022年终总结</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2006 -
2023 鬼画桃符</section><section class=powerby>豆腐炒糖</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#解决方案>解决方案</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>