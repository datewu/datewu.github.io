<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="自动化运维"><title>Expect自动化工具简介</title><link rel=canonical href=https://tab.deoops.com/posts/expect-interactive/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Expect自动化工具简介"><meta property="og:description" content="自动化运维"><meta property="og:url" content="https://tab.deoops.com/posts/expect-interactive/"><meta property="og:site_name" content="鬼画桃符"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="script"><meta property="article:tag" content="automation"><meta property="article:tag" content="unix"><meta property="article:published_time" content="2020-03-19T16:07:45+08:00"><meta property="article:modified_time" content="2020-03-19T16:07:45+08:00"><meta property="og:image" content="https://tab.deoops.com/posts/expect-interactive/automate.jpeg"><meta name=twitter:title content="Expect自动化工具简介"><meta name=twitter:description content="自动化运维"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tab.deoops.com/posts/expect-interactive/automate.jpeg"></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>返回</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/expect-interactive/><img src=/posts/expect-interactive/automate_hu0267170b9c80213022522221d5593617_95938_800x0_resize_q75_box.jpeg srcset="/posts/expect-interactive/automate_hu0267170b9c80213022522221d5593617_95938_800x0_resize_q75_box.jpeg 800w, /posts/expect-interactive/automate_hu0267170b9c80213022522221d5593617_95938_1600x0_resize_q75_box.jpeg 1600w" width=800 height=450 loading=lazy alt="Featured image of post Expect自动化工具简介"></a></div><div class=article-details><header class=article-category><a href=/categories/%E5%BC%80%E5%8F%91/ style=background-color:#2a9d8f;color:#fff>开发</a>
<a href=/categories/%E8%BF%90%E7%BB%B4/ style=background-color:#2a9d8f;color:#fff>运维</a></header><h2 class=article-title><a href=/posts/expect-interactive/>Expect自动化工具简介</a></h2><h3 class=article-subtitle>自动化运维</h3><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Mar 19, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 2 分钟</time></div></footer></div></header><section class=article-content><p>公司服务器使用了两层跳板机，外面的一台我们管它叫 <code>server A</code>， 另外一台 叫它 <code>server B</code>。</p><p>虽然我不知道这种双保险给公司带来了多少安全感，但是我知道我的运维效率降低了差不多90%吧 :>。</p><p><code>server A</code>被直接暴露在公网上， 我们不能使用 <code>ssh key</code> 只能使用 <code>password</code>认证<code>ssh</code>。</p><p>这还不算完，<code>server A</code>每3小时改一次自己的<code>root</code>密码。</p><p>后面的<code>server B</code>跳板机器的自我安全感就强多了，<code>server B</code>可以直接免密使用<code>ssh key</code>登陆所有的内网服务器，而且允许<code>server A</code>免密登陆到自己。</p><p>我决得这样两次登录很浪费时间，于是写了个脚本从外网一次性登陆到<code>server B</code>服务器上。</p><h2 id=expect-脚本>expect 脚本</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/usr/bin/expect -f
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># for anyone not familar with expect</span>
</span></span><span class=line><span class=cl><span class=c1># should read this awesome post</span>
</span></span><span class=line><span class=cl><span class=c1># https://www.pantz.org/software/expect/expect_examples_and_tips.html</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>set</span> timeout <span class=m>15</span>
</span></span><span class=line><span class=cl><span class=c1>### CHANGE pwd every 3h</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=nb>pwd</span> <span class=s2>&#34;mySuperSecretpwd123&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> nested_ssh <span class=s2>&#34;ssh server_B&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## for debug</span>
</span></span><span class=line><span class=cl><span class=c1># log_user 0</span>
</span></span><span class=line><span class=cl><span class=c1># exp_internal 1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>send_user <span class=s2>&#34;going to connected to server A\n&#34;</span>
</span></span><span class=line><span class=cl>spawn ssh -q -o <span class=nv>StrictHostKeyChecking</span><span class=o>=</span>no server_A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl>    timeout <span class=o>{</span> send_user <span class=s2>&#34;\ntimeout Failed to get password prompt, is VPN on?\n&#34;</span><span class=p>;</span> <span class=nb>exit</span> <span class=m>1</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    eof <span class=o>{</span> send_user <span class=s2>&#34;\nSSH failure for server A\n&#34;</span><span class=p>;</span> <span class=nb>exit</span> <span class=m>1</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;*assword:&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>send <span class=s2>&#34;</span><span class=nv>$pwd</span><span class=s2>\r&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl>    timeout <span class=o>{</span>send_user <span class=s2>&#34;\nSSH failure for server B\n&#34;</span><span class=p>;</span> <span class=nb>exit</span> <span class=m>1</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Last login:*&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>send <span class=s2>&#34;</span><span class=nv>$nested_ssh</span><span class=s2>\r&#34;</span>
</span></span><span class=line><span class=cl>interact
</span></span></code></pre></div><h3 id=基本语法>基本语法</h3><p>简单说下基本流程如下：</p><ol><li>set: 设置变量；</li><li>spawn: 给对象一个进程空间，让对象可以运行起来</li><li>expect: 模拟用户等待，<strong>期待</strong>对象输出字符串；</li><li>send: 模拟用户输入，给对象发送字符串；</li><li>send_user: 提示用户;</li><li>interact: 用户直接和对象通信，expect不再在中间传话了。</li></ol><p>因为<code>expect</code>语法继承自<code>Tcl</code>，所以变量赋值/初始化的方式和 <code>Bash</code>不同，需要使用<code>set</code>关键字。</p><p>注意第5点<code>send_user</code>命令是为了更好的用户交互，主要是给用户一下提示信息/反馈信息。</p><p>最后注意：<code>send "$pwd\r"</code>语句的<a class=link href=/posts/carrier-return/>转以符</a>是 <code>\r</code> 而不是<code>\r\n</code>。</p><h2 id=详细语法>详细语法</h2><p><code>expect</code>详细的语法和参数解释参考<a class=link href=https://www.pantz.org/software/expect/expect_examples_and_tips.html target=_blank rel=noopener>Expect examples and tips</a></p><blockquote><p>Expect is an automation and testing tool used to automate a process that receives interactive commands. If you can connect to any machine using ssh, telnet, ftp, etc then you can automate the process with an expect script. This works even with local programs where you would have to interact with a script or program on the command line.</p></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/script/>script</a>
<a href=/tags/automation/>automation</a>
<a href=/tags/unix/>unix</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>相关文章</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/posts/neutron-port/><div class=article-image><img src=/posts/neutron-port/_huba0c25ee44e1cb025e6838f746b91615_235376_0f8519d2522d80b6fc5afae2a6d5e9f8.png width=250 height=150 loading=lazy data-key data-hash="md5-MkCaJenF4NruQ1BFKjxBGA=="></div><div class=article-details><h2 class=article-title>Neutron小记</h2></div></a></article><article class=has-image><a href=/posts/bash-command/><div class=article-image><img src=/posts/bash-command/terminal.3d5715ab4fac1a152ddddcbd623152a8_hue2114e7452ea31417cca47ffc195f951_34424_250x150_fill_q75_box_smart1.jpeg width=250 height=150 loading=lazy data-key data-hash="md5-PVcVq0+sGhUt3dy9YjFSqA=="></div><div class=article-details><h2 class=article-title>bash简介</h2></div></a></article><article class=has-image><a href=/posts/explain-kubeconfig/><div class=article-image><img src=/posts/explain-kubeconfig/kubeconfig.8de483e194e9d703d6ade3fd9d8b3598_hu6b4ad2ec2bfdd2b8d356f680088de3f4_179870_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy data-key data-hash="md5-jeSD4ZTp1wPWreP9nYs1mA=="></div><div class=article-details><h2 class=article-title>细说kubeconfig</h2></div></a></article><article class=has-image><a href=/posts/k8s-certs/><div class=article-image><img src=/posts/k8s-certs/k8s.eecf4f46508db14e5515604412f82a89_hucdb5e2014b72ce09271c5c17f97648be_22078_250x150_fill_q75_h2_box_smart1_2.webp width=250 height=150 loading=lazy data-key data-hash="md5-7s9PRlCNsU5VFWBEEvgqiQ=="></div><div class=article-details><h2 class=article-title>替换k8s所有证书</h2></div></a></article><article class=has-image><a href=/posts/vscode-eslint/><div class=article-image><img src=/posts/vscode-eslint/eslint-airbnb.2f6cfa69959d62c46e4a9dc5039f8e50_hue35271ac4524df007877384f8b1c06a2_74499_250x150_fill_q75_box_smart1.jpeg width=250 height=150 loading=lazy data-key data-hash="md5-L2z6aZWdYsRuSp3FA5+OUA=="></div><div class=article-details><h2 class=article-title>配置vscode eslint</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2006 -
2023 鬼画桃符</section><section class=powerby>豆腐炒糖</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#expect-脚本>expect 脚本</a><ol><li><a href=#基本语法>基本语法</a></li></ol></li><li><a href=#详细语法>详细语法</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>