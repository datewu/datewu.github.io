<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="修改seLinux标签，放行http服务"><title>配置http selinux</title><link rel=canonical href=https://tab.deoops.com/posts/http-selinux/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="配置http selinux"><meta property="og:description" content="修改seLinux标签，放行http服务"><meta property="og:url" content="https://tab.deoops.com/posts/http-selinux/"><meta property="og:site_name" content="鬼画桃符"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="http"><meta property="article:tag" content="selinux"><meta property="article:tag" content="403"><meta property="article:tag" content="nginx"><meta property="article:published_time" content="2018-04-16T16:10:45+08:00"><meta property="article:modified_time" content="2018-04-16T16:10:45+08:00"><meta property="og:image" content="https://tab.deoops.com/posts/http-selinux/selinux.webp"><meta name=twitter:title content="配置http selinux"><meta name=twitter:description content="修改seLinux标签，放行http服务"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tab.deoops.com/posts/http-selinux/selinux.webp"></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>返回</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/http-selinux/><img src=/posts/http-selinux/selinux_hu2703889cd274f47cf99c8f755f05e2d0_11156_800x0_resize_q75_h2_box_2.webp srcset="/posts/http-selinux/selinux_hu2703889cd274f47cf99c8f755f05e2d0_11156_800x0_resize_q75_h2_box_2.webp 800w, /posts/http-selinux/selinux_hu2703889cd274f47cf99c8f755f05e2d0_11156_1600x0_resize_q75_h2_box_2.webp 1600w" width=800 height=450 loading=lazy alt="Featured image of post 配置http selinux"></a></div><div class=article-details><header class=article-category><a href=/categories/%E8%BF%90%E7%BB%B4/ style=background-color:#2a9d8f;color:#fff>运维</a></header><h2 class=article-title><a href=/posts/http-selinux/>配置http selinux</a></h2><h3 class=article-subtitle>修改seLinux标签，放行http服务</h3><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Apr 16, 2018</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 2 分钟</time></div></footer></div></header><section class=article-content><p>今天在<code>digitocean</code>一台新申请的主机上部署web应用。部署完成，打开浏览器发现报错403。</p><p>部署的web应用很简单，后端用nginx做了<a class=link href=/posts/nginx-proxy/>反向代理</a>，应该没啥大问题。</p><p>进一步打开chrome的console，发现对<code>static file</code>的访问报错<code>403</code>，还没到后端就已经报错了，
估计后面的 upstream socket也会报错。</p><p><code>ssh</code>登陆到服务器上看了下nginx的日志，发现是权限的问题。</p><p>进一步debug了之后发现虚拟机开启selinux，当时心头就一紧，估计要改selinux配置了，这是个麻烦事儿。</p><p>想简单点直接关闭selinux，转念一想<code>digitocean</code>的主机直接暴露在interner上，开着selinux 其实是个很好的保护。<code>digitocean</code>打开自有它打开的道理，我猜可能有很多vm被攻破沦为僵尸网络了。</p><p>google搜索了selinux的web server常用的配置，验证后，解决了<code>nginx 403</code>的问题。记录分享如下：</p><h2 id=check-selinux>check seLinux</h2><h3 id=查看系统状态>查看系统状态</h3><p><a class=link href=https://www.centos.org/docs/5/html/5.1/Deployment_Guide/sec-selinux-status-viewing.html target=_blank rel=noopener>查看selinux配置和状态</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@deo ~<span class=o>]</span><span class=c1># sestatus -v</span>
</span></span><span class=line><span class=cl>SELinux status:                 enabled
</span></span><span class=line><span class=cl>SELinuxfs mount:                /sys/fs/selinux
</span></span><span class=line><span class=cl>SELinux root directory:         /etc/selinux
</span></span><span class=line><span class=cl>Loaded policy name:             targeted
</span></span><span class=line><span class=cl>Current mode:                   enforcing
</span></span><span class=line><span class=cl>Mode from config file:          enforcing
</span></span><span class=line><span class=cl>Policy MLS status:              enabled
</span></span><span class=line><span class=cl>Policy deny_unknown status:     allowed
</span></span><span class=line><span class=cl>Max kernel policy version:      <span class=m>28</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Process contexts:
</span></span><span class=line><span class=cl>Current context:                unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</span></span><span class=line><span class=cl>Init context:                   system_u:system_r:init_t:s0
</span></span><span class=line><span class=cl>/usr/sbin/sshd                  system_u:system_r:sshd_t:s0-s0:c0.c1023
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>File contexts:
</span></span><span class=line><span class=cl>Controlling terminal:           unconfined_u:object_r:user_devpts_t:s0
</span></span><span class=line><span class=cl>/etc/passwd                     system_u:object_r:passwd_file_t:s0
</span></span><span class=line><span class=cl>/etc/shadow                     system_u:object_r:shadow_t:s0
</span></span><span class=line><span class=cl>/bin/bash                       system_u:object_r:shell_exec_t:s0
</span></span><span class=line><span class=cl>/bin/login                      system_u:object_r:login_exec_t:s0
</span></span><span class=line><span class=cl>/bin/sh                         system_u:object_r:bin_t:s0 -&gt; system_u:object_r:shell_exec_t:s0
</span></span><span class=line><span class=cl>/sbin/agetty                    system_u:object_r:getty_exec_t:s0
</span></span><span class=line><span class=cl>/sbin/init                      system_u:object_r:bin_t:s0 -&gt; system_u:object_r:init_exec_t:s0
</span></span><span class=line><span class=cl>/usr/sbin/sshd                  system_u:object_r:sshd_exec_t:s0
</span></span></code></pre></div><h3 id=查看文件目录的selinux-label>查看文件目录的selinux label</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@deo <span class=o>]</span><span class=c1># ls -Z /opt/todolist</span>
</span></span><span class=line><span class=cl>-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 index.html
</span></span><span class=line><span class=cl>drwxr-xr-x. root root unconfined_u:object_r:admin_home_t:s0 static
</span></span><span class=line><span class=cl><span class=o>[</span>root@deo <span class=o>]</span><span class=c1># ls -Z /usr/share/nginx/html</span>
</span></span><span class=line><span class=cl>-rw-r--r--. root root system_u:object_r:httpd_sys_content_t:s0 50x.html
</span></span><span class=line><span class=cl>-rw-r--r--. root root system_u:object_r:httpd_sys_content_t:s0 index.html
</span></span></code></pre></div><h2 id=meat>meat</h2><p>下面两种方法选一种就可以了</p><h3 id=label>label</h3><p>修改目录label使得selinux 放行nginx:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>chcon -Rt httpd_sys_content_t /opt/todolist/
</span></span><span class=line><span class=cl>ls -Z /opt/todolist/
</span></span><span class=line><span class=cl>-rw-r--r--. root root unconfined_u:object_r:httpd_sys_content_t:s0 index.html
</span></span><span class=line><span class=cl>drwxr-xr-x. root root unconfined_u:object_r:httpd_sys_content_t:s0 static
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>setsebool -P httpd_can_network_connect <span class=m>1</span> <span class=p>;</span> setsebool -P httpd_enable_homedirs on
</span></span><span class=line><span class=cl>chmod <span class=m>701</span> /home/dir
</span></span></code></pre></div><h3 id=semanage>semanage</h3><p>或者使用<code>semanage</code>命令修改<code>enforcement mode</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>~ <span class=o>[</span>root@jp ~<span class=o>]</span><span class=c1># cat fix_selinux_ng.sh</span>
</span></span><span class=line><span class=cl>semanage permissive -a httpd_tp
</span></span></code></pre></div><p><code>segmanage</code>语法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@jp ~<span class=o>]</span><span class=c1># semanage -h</span>
</span></span><span class=line><span class=cl>usage: semanage <span class=o>[</span>-h<span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>import,export,login,user,port,ibpkey,ibendport,interface,module,node,fcontext,boolean,permissive,dontaudit<span class=o>}</span>
</span></span><span class=line><span class=cl>                ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>semanage is used to configure certain elements of SELinux policy with-out
</span></span><span class=line><span class=cl>requiring modification to or recompilation from policy source.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>positional arguments:
</span></span><span class=line><span class=cl>  <span class=o>{</span>import,export,login,user,port,ibpkey,ibendport,interface,module,node,fcontext,boolean,permissive,dontaudit<span class=o>}</span>
</span></span><span class=line><span class=cl>    import              Import <span class=nb>local</span> customizations
</span></span><span class=line><span class=cl>    <span class=nb>export</span>              Output <span class=nb>local</span> customizations
</span></span><span class=line><span class=cl>    login               Manage login mappings between linux users and SELinux
</span></span><span class=line><span class=cl>                        confined users
</span></span><span class=line><span class=cl>    user                Manage SELinux confined users <span class=o>(</span>Roles and levels <span class=k>for</span> an
</span></span><span class=line><span class=cl>                        SELinux user<span class=o>)</span>
</span></span><span class=line><span class=cl>    port                Manage network port <span class=nb>type</span> definitions
</span></span><span class=line><span class=cl>    ibpkey              Manage infiniband ibpkey <span class=nb>type</span> definitions
</span></span><span class=line><span class=cl>    ibendport           Manage infiniband end port <span class=nb>type</span> definitions
</span></span><span class=line><span class=cl>    interface           Manage network interface <span class=nb>type</span> definitions
</span></span><span class=line><span class=cl>    module              Manage SELinux policy modules
</span></span><span class=line><span class=cl>    node                Manage network node <span class=nb>type</span> definitions
</span></span><span class=line><span class=cl>    fcontext            Manage file context mapping definitions
</span></span><span class=line><span class=cl>    boolean             Manage booleans to selectively <span class=nb>enable</span> functionality
</span></span><span class=line><span class=cl>    permissive          Manage process <span class=nb>type</span> enforcement mode
</span></span><span class=line><span class=cl>    dontaudit           Disable/Enable dontaudit rules in policy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>optional arguments:
</span></span><span class=line><span class=cl>  -h, --help            show this <span class=nb>help</span> message and <span class=nb>exit</span>
</span></span></code></pre></div><h2 id=参考>参考</h2><p><a class=link href=https://thecruskit.com/fixing-403-errors-when-using-nginx-with-selinux/ target=_blank rel=noopener>Fixing 403 errors when using nginx with SELinux</a></p><p><a class=link href=https://stackoverflow.com/questions/25995060/nginx-cannot-connect-to-jenkins-on-centos-7 target=_blank rel=noopener>NGinX cannot connect to Jenkins on CentOS 7</a></p><p><a class=link href=https://serverfault.com/questions/686732/nginx-refuses-to-read-new-directory-in-home target=_blank rel=noopener>Nginx refuses to read new directory in /home</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/http/>http</a>
<a href=/tags/selinux/>selinux</a>
<a href=/tags/403/>403</a>
<a href=/tags/nginx/>nginx</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>相关文章</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/posts/always-dns/><div class=article-image><img src=/posts/always-dns/dns.96e30a419e0076c2bdf363651931f400_hu3a5f0eb3ba473003614885c7370b7dc7_215054_250x150_fill_q75_box_smart1.jpeg width=250 height=150 loading=lazy data-key data-hash="md5-luMKQZ4AdsK982NlGTH0AA=="></div><div class=article-details><h2 class=article-title>It's ALWAYS DNS!</h2></div></a></article><article class=has-image><a href=/posts/install-moodle/><div class=article-image><img src=/posts/install-moodle/moodle.39c158f94e7efbc5ec4f66f09ad90a01_huc8bc81a9f0a50eb186d9f1a801c3ecb2_27882_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy data-key data-hash="md5-OcFY+U5++8XsT2bwmtkKAQ=="></div><div class=article-details><h2 class=article-title>部署moodle</h2></div></a></article><article class=has-image><a href=/posts/try-orange/><div class=article-image><img src=/posts/try-orange/orange.1b77bd4c5fa5799a6631f19bcc542507_huaf4bb76d1e84ff1eb3641c169af667d6_43273_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy data-key data-hash="md5-G3e9TF+leZpmMfGbzFQlBw=="></div><div class=article-details><h2 class=article-title>orange网关</h2></div></a></article><article class=has-image><a href=/posts/try-kong/><div class=article-image><img src=/posts/try-kong/kong.b1fbb6da333c72dc341ec0bf87107a2b_hu72b17c962d5d607193e13498b681225b_9130_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy data-key data-hash="md5-sfu22jM8ctw0HsC/hxB6Kw=="></div><div class=article-details><h2 class=article-title>kong网关</h2></div></a></article><article class=has-image><a href=/posts/nginx-proxy/><div class=article-image><img src=/posts/nginx-proxy/_hu8a37caf62bee1d6c91ad288e729da131_104181_75a1bcc3ecff71f68afea4a1641e7c6b.png width=250 height=150 loading=lazy data-key data-hash="md5-HQQsAv7Rao6/pEmb587Kwg=="></div><div class=article-details><h2 class=article-title>代理和反向代理</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2006 -
2023 鬼画桃符</section><section class=powerby>豆腐炒糖</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#check-selinux>check seLinux</a><ol><li><a href=#查看系统状态>查看系统状态</a></li><li><a href=#查看文件目录的selinux-label>查看文件目录的selinux label</a></li></ol></li><li><a href=#meat>meat</a><ol><li><a href=#label>label</a></li><li><a href=#semanage>semanage</a></li></ol></li><li><a href=#参考>参考</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>