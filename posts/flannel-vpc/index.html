<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="flannel vpc模式数据包流向"><title>VPC模式</title><link rel=canonical href=https://tab.deoops.com/posts/flannel-vpc/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="VPC模式"><meta property="og:description" content="flannel vpc模式数据包流向"><meta property="og:url" content="https://tab.deoops.com/posts/flannel-vpc/"><meta property="og:site_name" content="鬼画桃符"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="flannel"><meta property="article:tag" content="cni"><meta property="article:tag" content="k8s"><meta property="article:tag" content="network"><meta property="article:published_time" content="2018-09-11T10:07:04+08:00"><meta property="article:modified_time" content="2018-09-11T10:07:04+08:00"><meta property="og:image" content="https://tab.deoops.com/posts/flannel-vpc/flannel-vpc-mode.png"><meta name=twitter:title content="VPC模式"><meta name=twitter:description content="flannel vpc模式数据包流向"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tab.deoops.com/posts/flannel-vpc/flannel-vpc-mode.png"></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>返回</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/flannel-vpc/><img src=/posts/flannel-vpc/flannel-vpc-mode_hu2599b793831e4d2e2f689a3c7eb97256_31225_800x0_resize_box_3.png srcset="/posts/flannel-vpc/flannel-vpc-mode_hu2599b793831e4d2e2f689a3c7eb97256_31225_800x0_resize_box_3.png 800w, /posts/flannel-vpc/flannel-vpc-mode_hu2599b793831e4d2e2f689a3c7eb97256_31225_1600x0_resize_box_3.png 1600w" width=800 height=380 loading=lazy alt="Featured image of post VPC模式"></a></div><div class=article-details><header class=article-category><a href=/categories/%E8%BF%90%E7%BB%B4/ style=background-color:#2a9d8f;color:#fff>运维</a></header><h2 class=article-title><a href=/posts/flannel-vpc/>VPC模式</a></h2><h3 class=article-subtitle>flannel vpc模式数据包流向</h3><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Sep 11, 2018</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 2 分钟</time></div></footer></div></header><section class=article-content><p>之前写了一篇post <a class=link href=/posts/tx-flannel/>适配腾讯云backend</a> 的文章，从代码的角度简单记录了flannel
<code>vpc backend</code>实现过程。</p><p>这篇文章是对前面文章的补充，全局鸟瞰描绘了flannel <code>vpc backend</code>网络数据包的流动过程。</p><p>总体来看<code>vpc</code> 和 <code>host-gw</code> 模式是很类似的，理解<code>host-gateway</code>模式 对理解<code>vpc</code> 模式很有帮助。</p><h2 id=host-gw>host gw</h2><p>host gateway 模式：</p><blockquote><p>host-gw adds route table entries on hosts, so that host know how to traffic container network packets.</p></blockquote><blockquote><p>This works on L2, because it only concerns hosts, switches and containers. switches does not care IP and route, hosts know containers exists, and how to route to them, containers just send and receive data.</p></blockquote><blockquote><p>If hosts are at different networks, L3 is introduced, and routers are involved. routers have no idea that containers exists, and any containers packet will be dropped, making communication impossible.</p></blockquote><blockquote><p>Of course, you can add route table entries on routers, but that is out of control flannel.</p></blockquote><h3 id=l2>L2</h3><p>为什么host-gw模式下，二层网络一定要打通:</p><p>stackoverflow 上面已经有<a class=link href=https://stackoverflow.com/questions/45293321/why-host-gw-of-flannel-requires-direct-layer2-connectivity-between-hosts target=_blank rel=noopener>很好的回答</a>，我摘抄过来：</p><p>host-gw adds route table entires on each host. And the entries are as following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-s data-lang=s><span class=line><span class=cl><span class=n>Destination</span>     <span class=n>Gateway</span>         <span class=n>Genmask</span>         <span class=n>Flags</span> <span class=n>Metric</span> <span class=n>Ref</span>    <span class=n>Use</span> <span class=n>Iface</span>
</span></span><span class=line><span class=cl><span class=m>0.0.0.0</span>         <span class=m>10.110.110.1</span>    <span class=m>0.0.0.0</span>         <span class=n>UG</span>    <span class=m>100</span>    <span class=m>0</span>        <span class=m>0</span> <span class=n>eth0</span>
</span></span><span class=line><span class=cl><span class=m>10.100.14.0</span>     <span class=m>10.110.110.21</span>   <span class=m>255.255.255.0</span>   <span class=n>UG</span>    <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span> <span class=n>eth0</span>
</span></span><span class=line><span class=cl><span class=m>10.100.38.0</span>     <span class=m>0.0.0.0</span>         <span class=m>255.255.255.0</span>   <span class=n>U</span>     <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span> <span class=n>docker0</span>
</span></span><span class=line><span class=cl><span class=m>10.110.110.0</span>    <span class=m>0.0.0.0</span>         <span class=m>255.255.255.0</span>   <span class=n>U</span>     <span class=m>100</span>    <span class=m>0</span>        <span class=m>0</span> <span class=n>eth0</span>
</span></span><span class=line><span class=cl><span class=m>169.254.169.254</span> <span class=m>10.110.110.1</span>    <span class=m>255.255.255.255</span> <span class=n>UGH</span>   <span class=m>100</span>    <span class=m>0</span>        <span class=m>0</span> <span class=n>eth0</span>
</span></span></code></pre></div><blockquote><p>The most import item is the value of Gateway(10.110.110.21).</p></blockquote><p>The route table will change the destination mac address to the mac_address of node(10.110.110.21) which is connected L2 directly to 10.110.110.22(current node).</p><p>If not L2 connected, the packet can not be delivered to nodes(next-hop)</p><h2 id=vpc>vpc</h2><h3 id=数据包>数据包</h3><p><code>vpc backend</code>模式下网络数据包的流动过程如下：</p><ol><li>Flanneld 在每个node 节点创建一个 cni0 的网桥bridge设备，node里面的pod之间的通信走cni0网桥；</li><li>Node 和 在本机上的pod 通信通过node的route table 转发到cni0；</li><li>vpc backend适配器调用vpc sdk在vpc网络中维护了一个vpc route table；</li><li>Node 和其它node里面的pod通信，是先通过 vpc route table 找到 pod 子网 所对应node，然后再通过这个node把网络流量转发到pod；</li><li>跨node 的pod 通信通过这个route table找到pod网段所在的node，然后载通过 node 节点上的route table 转发到对应node 上cni0设备上然后找到对应的pod；</li><li>VPC上的普通vm(即，该vm不是k8s node)和 k8s pod之间的通信与 上面第4，5点 通信是一样的。</li></ol><h3 id=l2区别>L2区别</h3><p>host-gw mode 因为是在node 节点上 添加的 route 规则，所以所有的节点要二层switch打通，否则 下一跳(next-hop)跳不过去，没人帮忙转发二层数据包(frame)。</p><p>vpc backend mode 因为是在云厂商提供的外部router上添加的 route 规则，对vm做到了无感知，所以 vm之间无需打通 二层 switch。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/flannel/>flannel</a>
<a href=/tags/cni/>cni</a>
<a href=/tags/k8s/>k8s</a>
<a href=/tags/network/>network</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>相关文章</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/posts/tx-flannel/><div class=article-image><img src=/posts/tx-flannel/flannel-vpc.70b121c6d4931e45681e621f37edafd2_hue54105a7a72eb92cf36c8a151067b0c3_60319_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy data-key data-hash="md5-cLEhxtSTHkVoHmIfN+2v0g=="></div><div class=article-details><h2 class=article-title>flannel vpc</h2></div></a></article><article class=has-image><a href=/posts/always-dns/><div class=article-image><img src=/posts/always-dns/dns.96e30a419e0076c2bdf363651931f400_hu3a5f0eb3ba473003614885c7370b7dc7_215054_250x150_fill_q75_box_smart1.jpeg width=250 height=150 loading=lazy data-key data-hash="md5-luMKQZ4AdsK982NlGTH0AA=="></div><div class=article-details><h2 class=article-title>It's ALWAYS DNS!</h2></div></a></article><article class=has-image><a href=/posts/explain-kubeconfig/><div class=article-image><img src=/posts/explain-kubeconfig/kubeconfig.8de483e194e9d703d6ade3fd9d8b3598_hu6b4ad2ec2bfdd2b8d356f680088de3f4_179870_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy data-key data-hash="md5-jeSD4ZTp1wPWreP9nYs1mA=="></div><div class=article-details><h2 class=article-title>细说kubeconfig</h2></div></a></article><article class=has-image><a href=/posts/neutron-port/><div class=article-image><img src=/posts/neutron-port/_huba0c25ee44e1cb025e6838f746b91615_235376_0f8519d2522d80b6fc5afae2a6d5e9f8.png width=250 height=150 loading=lazy data-key data-hash="md5-MkCaJenF4NruQ1BFKjxBGA=="></div><div class=article-details><h2 class=article-title>Neutron小记</h2></div></a></article><article class=has-image><a href=/posts/macvlan-route/><div class=article-image><img src=/posts/macvlan-route/_hu61f53e93031289750fcd2806a2b8e722_10345_78566fb935f6ad5f35970480013f7ff9.png width=250 height=150 loading=lazy data-key data-hash="md5-HfaH7zq5UrrUjmmqqpzkMQ=="></div><div class=article-details><h2 class=article-title>Macvlan路由规则</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2006 -
2023 鬼画桃符</section><section class=powerby>豆腐炒糖</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#host-gw>host gw</a><ol><li><a href=#l2>L2</a></li></ol></li><li><a href=#vpc>vpc</a><ol><li><a href=#数据包>数据包</a></li><li><a href=#l2区别>L2区别</a></li></ol></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>